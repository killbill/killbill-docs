<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]--><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="Asciidoctor 2.0.16"><link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" /><link rel="stylesheet" href="https://cdn.staticaly.com/gh/afeld/bootstrap-toc/v1.0.0/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" /><title>Payment Plugin Overview</title><style>/*Default CSS*/

/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove the comments around the @import statement below when using this as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400";*/
/* @import "https://stylishthemes.github.io/Syntax-Themes/pygments/css-github/pygments-base16-monokai-dark.css"; */

article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
nav,
section,
summary {
  display: block;
}
audio,
canvas,
video {
  display: inline-block;
}
audio:not([controls]) {
  display: none;
  height: 0;
}
[hidden],
template {
  display: none;
}
script {
  display: none !important;
}
/* html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%} */
body {
  margin: 0;
}
a {
  background: transparent;
  text-decoration: none !important;
}
a:focus {
  outline: thin dotted;
}
a:active,
a:hover {
  outline: 0;
}
h1 {
  font-size: 2em;
  margin: 0.67em 0;
}
abbr[title] {
  border-bottom: 1px dotted;
}
b,
strong {
  font-weight: bold;
}
dfn {
  font-style: italic;
}
hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}
mark {
  background: #ff0;
  color: #000;
}
code,
kbd,
pre,
samp {
  font-family: monospace;
  font-size: 1em;
}
pre {
  white-space: pre-wrap;
}
q {
  quotes: "\201C" "\201D" "\2018" "\2019";
}
small {
  font-size: 80%;
}
sub,
sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}
sup {
  top: -0.5em;
}
sub {
  bottom: -0.25em;
}
img {
  border: 0;
}
svg:not(:root) {
  overflow: hidden;
}
figure {
  margin: 0;
}
fieldset {
  border: 1px solid silver;
  margin: 0 2px;
  padding: 0.35em 0.625em 0.75em;
}
legend {
  border: 0;
  padding: 0;
}
/* button,input,select,textarea{font-family:inherit;font-size:100%;margin:0} */
button,
input {
  line-height: normal;
}
button,
select {
  text-transform: none;
}
button,
html input[type="button"],
input[type="reset"],
input[type="submit"] {
  -webkit-appearance: button;
  cursor: pointer;
}
button[disabled],
html input[disabled] {
  cursor: default;
}
input[type="checkbox"],
input[type="radio"] {
  box-sizing: border-box;
  padding: 0;
}
input[type="search"] {
  -webkit-appearance: textfield;
  -moz-box-sizing: content-box;
  -webkit-box-sizing: content-box;
  box-sizing: content-box;
}
input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
  -webkit-appearance: none;
}
button::-moz-focus-inner,
input::-moz-focus-inner {
  border: 0;
  padding: 0;
}
textarea {
  overflow: auto;
  vertical-align: top;
}
table {
  border-collapse: collapse;
  border-spacing: 0;
}
*,
*:before,
*:after {
  -moz-box-sizing: border-box;
  -webkit-box-sizing: border-box;
  box-sizing: border-box;
}
html,
body {
  font-size: 100%;
}
/* body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto} */
a:hover {
  cursor: pointer;
}
img,
object,
embed {
  max-width: 100%;
  height: auto;
}
object,
embed {
  height: 100%;
}
img {
  -ms-interpolation-mode: bicubic;
}
#map_canvas img,
#map_canvas embed,
#map_canvas object,
.map_canvas img,
.map_canvas embed,
.map_canvas object {
  max-width: none !important;
}
.left {
  float: left !important;
}
.right {
  float: right !important;
}
.text-left {
  text-align: left !important;
}
.text-right {
  text-align: right !important;
}
.text-center {
  text-align: center !important;
}
.text-justify {
  text-align: justify !important;
}
.hide {
  display: none;
}
.antialiased,
body {
  -webkit-font-smoothing: antialiased;
}
img {
  display: inline-block;
  vertical-align: middle;
}
textarea {
  height: auto;
  min-height: 50px;
}
select {
  width: 100%;
}
p.lead,
.paragraph.lead > p,
#preamble > .sectionbody > .paragraph:first-of-type p {
  font-size: 1.21875em;
  line-height: 1.6;
}
.subheader,
.admonitionblock td.content > .title,
.audioblock > .title,
.exampleblock > .title,
.imageblock > .title,
.listingblock > .title,
.literalblock > .title,
.stemblock > .title,
.openblock > .title,
.paragraph > .title,
.quoteblock > .title,
table.tableblock > .title,
.verseblock > .title,
.videoblock > .title,
.dlist > .title,
.olist > .title,
.ulist > .title,
.qlist > .title,
.hdlist > .title {
  line-height: 1.45;
  color: #7a2518;
  font-weight: 400;
  margin-top: 0;
  margin-bottom: 0.25em;
}
div,
dl,
dt,
dd,
ul,
ol,
li,
h1,
h2,
h3,
#toctitle,
.sidebarblock > .content > .title,
h4,
h5,
h6,
pre,
form,
p,
blockquote,
th,
td {
  margin: 0;
  padding: 0;
  direction: ltr;
}
a {
  color: #2156a5;
  text-decoration: underline;
  line-height: inherit;
}
a:hover,
a:focus {
  color: #1d4b8f;
}
a img {
  border: none;
}
p {
  font-family: inherit;
  font-weight: 400;
  font-size: 1em;
  line-height: 1.6;
  margin-bottom: 1.25em;
  text-rendering: optimizeLegibility;
}
p aside {
  font-size: 0.875em;
  line-height: 1.35;
  font-style: italic;
}
h1,
h2,
h3,
#toctitle,
.sidebarblock > .content > .title,
h4,
h5,
h6 {
  font-family: "Open Sans", "DejaVu Sans", sans-serif;
  font-weight: 300;
  font-style: normal;
  color: #e44c3a;
  text-rendering: optimizeLegibility;
  margin-top: 1em;
  margin-bottom: 0.5em;
  line-height: 1.0125em;
}
h1 small,
h2 small,
h3 small,
#toctitle small,
.sidebarblock > .content > .title small,
h4 small,
h5 small,
h6 small {
  font-size: 60%;
  color: #e99b8f;
  line-height: 0;
}
h1 {
  font-size: 2.125em;
}
h2 {
  font-size: 1.6875em;
}
h3,
#toctitle,
.sidebarblock > .content > .title {
  font-size: 1.375em;
}
h4,
h5 {
  font-size: 1.125em;
}
h6 {
  font-size: 1em;
}
hr {
  border: solid #ddddd8;
  border-width: 1px 0 0;
  clear: both;
  margin: 1.25em 0 1.1875em;
  height: 0;
}
em,
i {
  font-style: italic;
  line-height: inherit;
}
strong,
b {
  font-weight: bold;
  line-height: inherit;
}
small {
  font-size: 60%;
  line-height: inherit;
}
code {
  font-family: "Droid Sans Mono", "DejaVu Sans Mono", monospace;
  font-weight: 400;
  color: rgba(0, 0, 0, 0.9);
}
ul,
ol,
dl {
  font-size: 1em;
  line-height: 1.6;
  margin-bottom: 1.25em;
  list-style-position: outside;
  font-family: inherit;
}
ul,
ol,
ul.no-bullet,
ol.no-bullet {
  margin-left: 1.5em;
}
ul li ul,
ul li ol {
  margin-left: 1.25em;
  margin-bottom: 0;
  font-size: 1em;
}
ul.square li ul,
ul.circle li ul,
ul.disc li ul {
  list-style: inherit;
}
ul.square {
  list-style-type: square;
}
ul.circle {
  list-style-type: circle;
}
ul.disc {
  list-style-type: disc;
}
ul.no-bullet {
  list-style: none;
}
ol li ul,
ol li ol {
  margin-left: 1.25em;
  margin-bottom: 0;
}
dl dt {
  margin-bottom: 0.3125em;
  font-weight: bold;
}
dl dd {
  margin-bottom: 1.25em;
}
abbr,
acronym {
  text-transform: uppercase;
  font-size: 90%;
  color: rgba(0, 0, 0, 0.8);
  border-bottom: 1px dotted #ddd;
  cursor: help;
}
abbr {
  text-transform: none;
}
blockquote {
  margin: 0 0 1.25em;
  padding: 0.5625em 1.25em 0 1.1875em;
  border-left: 1px solid #ddd;
}
blockquote cite {
  display: block;
  font-size: 0.9375em;
  color: rgba(0, 0, 0, 0.6);
}
blockquote cite:before {
  content: "\2014 \0020";
}
blockquote cite a,
blockquote cite a:visited {
  color: rgba(0, 0, 0, 0.6);
}
blockquote,
blockquote p {
  line-height: 1.6;
  color: rgba(0, 0, 0, 0.85);
}
@media only screen and (min-width: 768px) {
  h1,
  h2,
  h3,
  #toctitle,
  .sidebarblock > .content > .title,
  h4,
  h5,
  h6 {
    line-height: 1.2;
  }
  h1 {
    font-size: 2.75em;
  }
  h2 {
    font-size: 2.3125em;
  }
  h3,
  #toctitle,
  .sidebarblock > .content > .title {
    font-size: 1.6875em;
  }
  h4 {
    font-size: 1.4375em;
  }
}
table {
  /* background: #fff; */
  margin-bottom: 1.25em;
  /* border: solid 1px #dedede; */
}
table thead,
table tfoot {
  /* background: #f7f8f7; */
  font-weight: bold;
}
table thead tr th,
table thead tr td,
table tfoot tr th,
table tfoot tr td {
  padding: 0.5em 0.625em 0.625em;
  font-size: inherit;
  color: rgba(0, 0, 0, 0.8);
  text-align: left;
}
table tr th,
table tr td {
  padding: 0.5625em 0.625em;
  font-size: inherit;
  color: rgba(0, 0, 0, 0.8);
}
table tr.even,
table tr.alt,
table tr:nth-of-type(even) {
  background: #f8f8f7;
}
table thead tr th,
table tfoot tr th,
table tbody tr td,
table tr td,
table tfoot tr td {
  display: table-cell;
  line-height: 1.6;
}
h1,
h2,
h3,
#toctitle,
.sidebarblock > .content > .title,
h4,
h5,
h6 {
  line-height: 1.2;
  word-spacing: -0.05em;
}
h1 strong,
h2 strong,
h3 strong,
#toctitle strong,
.sidebarblock > .content > .title strong,
h4 strong,
h5 strong,
h6 strong {
  font-weight: 400;
}
.clearfix:before,
.clearfix:after,
.float-group:before,
.float-group:after {
  content: " ";
  display: table;
}
.clearfix:after,
.float-group:after {
  clear: both;
}
*:not(pre) > code {
  font-size: 0.9375em;
  font-style: normal !important;
  letter-spacing: 0;
  padding: 0.1em 0.5ex;
  word-spacing: -0.15em;
  /* background-color: #f7f7f8; */
  -webkit-border-radius: 4px;
  border-radius: 4px;
  line-height: 1.45;
  text-rendering: optimizeSpeed;
}
pre,
pre > code {
  line-height: 1.45;
  /* color: rgba(0, 0, 0, 0.9); */
  font-family: "Droid Sans Mono", "DejaVu Sans Mono", monospace;
  font-weight: 400;
  text-rendering: optimizeSpeed;
}
.keyseq {
  color: rgba(51, 51, 51, 0.8);
}
kbd {
  display: inline-block;
  color: rgba(0, 0, 0, 0.8);
  font-size: 0.75em;
  line-height: 1.4;
  background-color: #f7f7f7;
  border: 1px solid #ccc;
  -webkit-border-radius: 3px;
  border-radius: 3px;
  -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset;
  box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em #fff inset;
  margin: -0.15em 0.15em 0 0.15em;
  padding: 0.2em 0.6em 0.2em 0.5em;
  vertical-align: middle;
  white-space: nowrap;
}
.keyseq kbd:first-child {
  margin-left: 0;
}
.keyseq kbd:last-child {
  margin-right: 0;
}
.menuseq,
.menu {
  color: rgba(0, 0, 0, 0.8);
}
b.button:before,
b.button:after {
  position: relative;
  top: -1px;
  font-weight: 400;
}
b.button:before {
  content: "[";
  padding: 0 3px 0 2px;
}
b.button:after {
  content: "]";
  padding: 0 2px 0 3px;
}
p a > code:hover {
  color: rgba(0, 0, 0, 0.9);
}
#header,
#content,
#footnotes,
#footer {
  width: 100%;
  margin-left: auto;
  margin-right: auto;
  margin-top: 0;
  margin-bottom: 0;
  *zoom: 1;
  position: relative;
  padding-left: 0.9375em;
  padding-right: 0.9375em;
}
#header:before,
#header:after,
#content:before,
#content:after,
#footnotes:before,
#footnotes:after,
#footer:before,
#footer:after {
  content: " ";
  display: table;
}
#header:after,
#content:after,
#footnotes:after,
#footer:after {
  clear: both;
}
#content {
  margin-top: 1.25em;
}
#content:before {
  content: none;
}
#header > h1:first-child {
  color: rgba(0, 0, 0, 0.85);
  margin-top: 2.25rem;
  margin-bottom: 0;
}
#header > h1:first-child + #toc {
  margin-top: 8px;
  border-top: 1px solid #ddddd8;
}
#header > h1:only-child,
body.toc2 #header > h1:nth-last-child(2) {
  border-bottom: 1px solid #ddddd8;
  padding-bottom: 8px;
}
#header .details {
  border-bottom: 1px solid #ddddd8;
  line-height: 1.45;
  padding-top: 0.25em;
  padding-bottom: 0.25em;
  padding-left: 0.25em;
  color: rgba(0, 0, 0, 0.6);
  display: -ms-flexbox;
  display: -webkit-flex;
  display: flex;
  -ms-flex-flow: row wrap;
  -webkit-flex-flow: row wrap;
  flex-flow: row wrap;
}
#header .details span:first-child {
  margin-left: -0.125em;
}
#header .details span.email a {
  color: rgba(0, 0, 0, 0.85);
}
#header .details br {
  display: none;
}
#header .details br + span:before {
  content: "\00a0\2013\00a0";
}
#header .details br + span.author:before {
  content: "\00a0\22c5\00a0";
  color: rgba(0, 0, 0, 0.85);
}
#header .details br + span#revremark:before {
  content: "\00a0|\00a0";
}
#header #revnumber {
  text-transform: capitalize;
}
#header #revnumber:after {
  content: "\00a0";
}
#content > h1:first-child:not([class]) {
  color: rgba(0, 0, 0, 0.85);
  border-bottom: 1px solid #ddddd8;
  padding-bottom: 8px;
  margin-top: 0;
  padding-top: 1rem;
  margin-bottom: 1.25rem;
}
#toc {
  border-bottom: 1px solid #efefed;
  padding-bottom: 0.5em;
}
#toc > ul {
  margin-left: 0.125em;
}
#toc ul.sectlevel0 > li > a {
  font-style: italic;
}
#toc ul.sectlevel0 ul.sectlevel1 {
  margin: 0.5em 0;
}
#toc ul {
  font-family: "Open Sans", "DejaVu Sans", sans-serif;
  list-style-type: none;
}
#toc a {
  text-decoration: none;
}
#toc a:active {
  text-decoration: underline;
}
#toctitle {
  color: #7a2518;
  font-size: 1.2em;
}
@media only screen and (min-width: 768px) {
  #toctitle {
    font-size: 1.375em;
  }
  body.toc2 {
    padding-left: 15em;
    padding-right: 0;
  }
  #toc.toc2 {
    margin-top: 0 !important;
    background-color: #f8f8f7;
    position: fixed;
    width: 15em;
    left: 0;
    top: 0;
    border-right: 1px solid #efefed;
    border-top-width: 0 !important;
    border-bottom-width: 0 !important;
    z-index: 1000;
    padding: 1.25em 1em;
    height: 100%;
    overflow: auto;
  }
  #toc.toc2 #toctitle {
    margin-top: 0;
    font-size: 1.2em;
  }
  #toc.toc2 > ul {
    font-size: 0.9em;
    margin-bottom: 0;
  }
  #toc.toc2 ul ul {
    margin-left: 0;
    padding-left: 1em;
  }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 {
    padding-left: 0;
    margin-top: 0.5em;
    margin-bottom: 0.5em;
  }
  body.toc2.toc-right {
    padding-left: 0;
    padding-right: 15em;
  }
  body.toc2.toc-right #toc.toc2 {
    border-right-width: 0;
    border-left: 1px solid #efefed;
    left: auto;
    right: 0;
  }
}
@media only screen and (min-width: 1280px) {
  body.toc2 {
    padding-left: 20em;
    padding-right: 0;
  }
  #toc.toc2 {
    width: 20em;
  }
  #toc.toc2 #toctitle {
    font-size: 1.375em;
  }
  #toc.toc2 > ul {
    font-size: 0.95em;
  }
  #toc.toc2 ul ul {
    padding-left: 1.25em;
  }
  body.toc2.toc-right {
    padding-left: 0;
    padding-right: 20em;
  }
}
#content #toc {
  border-style: solid;
  border-width: 1px;
  border-color: #e0e0dc;
  margin-bottom: 1.25em;
  padding: 1.25em;
  background: #f8f8f7;
  -webkit-border-radius: 4px;
  border-radius: 4px;
}
#content #toc > :first-child {
  margin-top: 0;
}
#content #toc > :last-child {
  margin-bottom: 0;
}
#footer {
  max-width: 100%;
  background-color: #2e3336;
  padding: 1.25em;
}
#footer-text {
  color: rgba(255, 255, 255, 0.8);
  line-height: 1.44;
}
.sect1 {
  padding-bottom: 0.625em;
}
@media only screen and (min-width: 768px) {
  .sect1 {
    padding-bottom: 1.25em;
  }
}
.sect1 + .sect1 {
  border-top: 1px solid #efefed;
}
#content h1 > a.anchor,
h2 > a.anchor,
h3 > a.anchor,
#toctitle > a.anchor,
.sidebarblock > .content > .title > a.anchor,
h4 > a.anchor,
h5 > a.anchor,
h6 > a.anchor {
  position: absolute;
  z-index: 1001;
  width: 1.5ex;
  margin-left: -1.5ex;
  display: block;
  text-decoration: none !important;
  visibility: hidden;
  text-align: center;
  font-weight: 400;
}
#content h1 > a.anchor:before,
h2 > a.anchor:before,
h3 > a.anchor:before,
#toctitle > a.anchor:before,
.sidebarblock > .content > .title > a.anchor:before,
h4 > a.anchor:before,
h5 > a.anchor:before,
h6 > a.anchor:before {
  content: "\00A7";
  font-size: 0.85em;
  display: block;
  padding-top: 0.1em;
}
#content h1:hover > a.anchor,
#content h1 > a.anchor:hover,
h2:hover > a.anchor,
h2 > a.anchor:hover,
h3:hover > a.anchor,
#toctitle:hover > a.anchor,
.sidebarblock > .content > .title:hover > a.anchor,
h3 > a.anchor:hover,
#toctitle > a.anchor:hover,
.sidebarblock > .content > .title > a.anchor:hover,
h4:hover > a.anchor,
h4 > a.anchor:hover,
h5:hover > a.anchor,
h5 > a.anchor:hover,
h6:hover > a.anchor,
h6 > a.anchor:hover {
  visibility: visible;
}
#content h1 > a.link,
h2 > a.link,
h3 > a.link,
#toctitle > a.link,
.sidebarblock > .content > .title > a.link,
h4 > a.link,
h5 > a.link,
h6 > a.link {
  color: #e44c3a;
  text-decoration: none;
}
#content h1 > a.link:hover,
h2 > a.link:hover,
h3 > a.link:hover,
#toctitle > a.link:hover,
.sidebarblock > .content > .title > a.link:hover,
h4 > a.link:hover,
h5 > a.link:hover,
h6 > a.link:hover {
  color: #a53221;
}
.audioblock,
.imageblock,
.literalblock,
.listingblock,
.stemblock,
.videoblock {
  margin-bottom: 1.25em;
}
.admonitionblock td.content > .title,
.audioblock > .title,
.exampleblock > .title,
.imageblock > .title,
.listingblock > .title,
.literalblock > .title,
.stemblock > .title,
.openblock > .title,
.paragraph > .title,
.quoteblock > .title,
table.tableblock > .title,
.verseblock > .title,
.videoblock > .title,
.dlist > .title,
.olist > .title,
.ulist > .title,
.qlist > .title,
.hdlist > .title {
  text-rendering: optimizeLegibility;
  text-align: left;
  font-family: "Noto Serif", "DejaVu Serif", serif;
  font-size: 1rem;
  font-style: italic;
}
table.tableblock > caption.title {
  white-space: nowrap;
  overflow: visible;
  max-width: 0;
}
.paragraph.lead > p,
#preamble > .sectionbody > .paragraph:first-of-type p {
  color: rgba(0, 0, 0, 0.85);
}
table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p {
  font-size: inherit;
}
.admonitionblock > table {
  border-collapse: separate;
  border: 0;
  background: none;
  width: 100%;
}
.admonitionblock > table td.icon {
  text-align: center;
  width: 80px;
}
.admonitionblock > table td.icon img {
  max-width: none;
}
.admonitionblock > table td.icon .title {
  font-weight: bold;
  font-family: "Open Sans", "DejaVu Sans", sans-serif;
  text-transform: uppercase;
}
.admonitionblock > table td.content {
  padding-left: 1.125em;
  padding-right: 1.25em;
  border-left: 1px solid #ddddd8;
  color: rgba(0, 0, 0, 0.6);
}
.admonitionblock > table td.content > :last-child > :last-child {
  margin-bottom: 0;
}
.exampleblock > .content {
  border-style: solid;
  border-width: 1px;
  border-color: #e6e6e6;
  margin-bottom: 1.25em;
  padding: 1.25em;
  background: #fff;
  -webkit-border-radius: 4px;
  border-radius: 4px;
}
.exampleblock > .content > :first-child {
  margin-top: 0;
}
.exampleblock > .content > :last-child {
  margin-bottom: 0;
}
.sidebarblock {
  border-style: solid;
  border-width: 1px;
  border-color: #e0e0dc;
  margin-bottom: 1.25em;
  padding: 1.25em;
  background: #f8f8f7;
  -webkit-border-radius: 4px;
  border-radius: 4px;
}
.sidebarblock > :first-child {
  margin-top: 0;
}
.sidebarblock > :last-child {
  margin-bottom: 0;
}
.sidebarblock > .content > .title {
  color: #7a2518;
  margin-top: 0;
  text-align: center;
}
.exampleblock > .content > :last-child > :last-child,
.exampleblock > .content .olist > ol > li:last-child > :last-child,
.exampleblock > .content .ulist > ul > li:last-child > :last-child,
.exampleblock > .content .qlist > ol > li:last-child > :last-child,
.sidebarblock > .content > :last-child > :last-child,
.sidebarblock > .content .olist > ol > li:last-child > :last-child,
.sidebarblock > .content .ulist > ul > li:last-child > :last-child,
.sidebarblock > .content .qlist > ol > li:last-child > :last-child {
  margin-bottom: 0;
}
.literalblock pre,
.listingblock pre[class="highlight"],
.listingblock pre[class^="highlight "],
.listingblock pre.CodeRay,
.listingblock pre.prettyprint {
  background: #f7f7f8;
}
.sidebarblock .literalblock pre,
.sidebarblock .listingblock pre[class="highlight"],
.sidebarblock .listingblock pre[class^="highlight "],
.sidebarblock .listingblock pre.CodeRay,
.sidebarblock .listingblock pre.prettyprint {
  background: #f2f1f1;
}
.literalblock pre,
.literalblock pre[class],
.listingblock pre,
.listingblock pre[class] {
  -webkit-border-radius: 4px;
  border-radius: 4px;
  word-wrap: break-word;
  padding: 1em;
  font-size: 0.8125em;
}
.literalblock pre.nowrap,
.literalblock pre[class].nowrap,
.listingblock pre.nowrap,
.listingblock pre[class].nowrap {
  overflow-x: auto;
  white-space: pre;
  word-wrap: normal;
}
@media only screen and (min-width: 768px) {
  .literalblock pre,
  .literalblock pre[class],
  .listingblock pre,
  .listingblock pre[class] {
    font-size: 0.90625em;
  }
}
@media only screen and (min-width: 1280px) {
  .literalblock pre,
  .literalblock pre[class],
  .listingblock pre,
  .listingblock pre[class] {
    font-size: 1em;
  }
}
.literalblock.output pre {
  color: #f7f7f8;
  background-color: rgba(0, 0, 0, 0.9);
}
.listingblock pre.highlightjs {
  padding: 0;
}
.listingblock pre.highlightjs > code {
  padding: 1em;
  -webkit-border-radius: 4px;
  border-radius: 4px;
}
.listingblock pre.prettyprint {
  border-width: 0;
}
.listingblock > .content {
  position: relative;
}
.listingblock code[data-lang]:before {
  display: none;
  content: attr(data-lang);
  position: absolute;
  font-size: 0.75em;
  top: 0.425rem;
  right: 0.5rem;
  line-height: 1;
  text-transform: uppercase;
  color: #999;
}
.listingblock:hover code[data-lang]:before {
  display: block;
}
.listingblock.terminal pre .command:before {
  content: attr(data-prompt);
  padding-right: 0.5em;
  color: #999;
}
.listingblock.terminal pre .command:not([data-prompt]):before {
  content: "$";
}
table.pyhltable {
  border-collapse: separate;
  border: 0;
  margin-bottom: 0;
  background: none;
}
table.pyhltable td {
  vertical-align: top;
  padding-top: 0;
  padding-bottom: 0;
}
table.pyhltable td.code {
  padding-left: 0.75em;
  padding-right: 0;
}
pre.pygments .lineno,
table.pyhltable td:not(.code) {
  color: #999;
  padding-left: 0;
  padding-right: 0.5em;
  border-right: 1px solid #ddddd8;
}
pre.pygments .lineno {
  display: inline-block;
  margin-right: 0.25em;
}
table.pyhltable .linenodiv {
  background: none !important;
  padding-right: 0 !important;
}
.quoteblock {
  margin: 0 1em 1.25em 1.5em;
  display: table;
}
.quoteblock > .title {
  margin-left: -1.5em;
  margin-bottom: 0.75em;
}
.quoteblock blockquote,
.quoteblock blockquote p {
  color: rgba(0, 0, 0, 0.85);
  font-size: 1.15rem;
  line-height: 1.75;
  word-spacing: 0.1em;
  letter-spacing: 0;
  font-style: italic;
  text-align: justify;
}
.quoteblock blockquote {
  margin: 0;
  padding: 0;
  border: 0;
}
.quoteblock blockquote:before {
  content: "\201c";
  float: left;
  font-size: 2.75em;
  font-weight: bold;
  line-height: 0.6em;
  margin-left: -0.6em;
  color: #7a2518;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}
.quoteblock blockquote > .paragraph:last-child p {
  margin-bottom: 0;
}
.quoteblock .attribution {
  margin-top: 0.5em;
  margin-right: 0.5ex;
  text-align: right;
}
.quoteblock .quoteblock {
  margin-left: 0;
  margin-right: 0;
  padding: 0.5em 0;
  border-left: 3px solid rgba(0, 0, 0, 0.6);
}
.quoteblock .quoteblock blockquote {
  padding: 0 0 0 0.75em;
}
.quoteblock .quoteblock blockquote:before {
  display: none;
}
.verseblock {
  margin: 0 1em 1.25em 1em;
}
.verseblock pre {
  font-family: "Open Sans", "DejaVu Sans", sans;
  font-size: 1.15rem;
  color: rgba(0, 0, 0, 0.85);
  font-weight: 300;
  text-rendering: optimizeLegibility;
}
.verseblock pre strong {
  font-weight: 400;
}
.verseblock .attribution {
  margin-top: 1.25rem;
  margin-left: 0.5ex;
}
.quoteblock .attribution,
.verseblock .attribution {
  font-size: 0.9375em;
  line-height: 1.45;
  font-style: italic;
}
.quoteblock .attribution br,
.verseblock .attribution br {
  display: none;
}
.quoteblock .attribution cite,
.verseblock .attribution cite {
  display: block;
  letter-spacing: -0.05em;
  color: rgba(0, 0, 0, 0.6);
}
.quoteblock.abstract {
  margin: 0 0 1.25em 0;
  display: block;
}
.quoteblock.abstract blockquote,
.quoteblock.abstract blockquote p {
  text-align: left;
  word-spacing: 0;
}
.quoteblock.abstract blockquote:before,
.quoteblock.abstract blockquote p:first-of-type:before {
  display: none;
}
table.tableblock {
  max-width: 100%;
  border-collapse: separate;
}
table.tableblock td > .paragraph:last-child p > p:last-child,
table.tableblock th > p:last-child,
table.tableblock td > p:last-child {
  margin-bottom: 0;
}
table.spread {
  width: 100%;
}
table.tableblock,
th.tableblock,
td.tableblock {
  border: 0 solid #dedede;
}
table.grid-all th.tableblock,
table.grid-all td.tableblock {
  border-width: 0 1px 1px 0;
}
table.grid-all tfoot > tr > th.tableblock,
table.grid-all tfoot > tr > td.tableblock {
  border-width: 1px 1px 0 0;
}
table.grid-cols th.tableblock,
table.grid-cols td.tableblock {
  border-width: 0 1px 0 0;
}
table.grid-all * > tr > .tableblock:last-child,
table.grid-cols * > tr > .tableblock:last-child {
  border-right-width: 0;
}
table.grid-rows th.tableblock,
table.grid-rows td.tableblock {
  border-width: 0 0 1px 0;
}
table.grid-all tbody > tr:last-child > th.tableblock,
table.grid-all tbody > tr:last-child > td.tableblock,
table.grid-all thead:last-child > tr > th.tableblock,
table.grid-rows tbody > tr:last-child > th.tableblock,
table.grid-rows tbody > tr:last-child > td.tableblock,
table.grid-rows thead:last-child > tr > th.tableblock {
  border-bottom-width: 0;
}
table.grid-rows tfoot > tr > th.tableblock,
table.grid-rows tfoot > tr > td.tableblock {
  border-width: 1px 0 0 0;
}
table.frame-all {
  border-width: 1px;
}
table.frame-sides {
  border-width: 0 1px;
}
table.frame-topbot {
  border-width: 1px 0;
}
th.halign-left,
td.halign-left {
  text-align: left;
}
th.halign-right,
td.halign-right {
  text-align: right;
}
th.halign-center,
td.halign-center {
  text-align: center;
}
th.valign-top,
td.valign-top {
  vertical-align: top;
}
th.valign-bottom,
td.valign-bottom {
  vertical-align: bottom;
}
th.valign-middle,
td.valign-middle {
  vertical-align: middle;
}
table thead th,
table tfoot th {
  font-weight: bold;
}
tbody tr th {
  display: table-cell;
  line-height: 1.6;
  background: #f7f8f7;
}
tbody tr th,
tbody tr th p,
tfoot tr th,
tfoot tr th p {
  color: rgba(0, 0, 0, 0.8);
  font-weight: bold;
}
p.tableblock > code:only-child {
  background: none;
  padding: 0;
}
p.tableblock {
  font-size: 1em;
}
td > div.verse {
  white-space: pre;
}
ol {
  margin-left: 1.75em;
}
ul li ol {
  margin-left: 1.5em;
}
dl dd {
  margin-left: 1.125em;
}
dl dd:last-child,
dl dd:last-child > :last-child {
  margin-bottom: 0;
}
ol > li p,
ul > li p,
ul dd,
ol dd,
.olist .olist,
.ulist .ulist,
.ulist .olist,
.olist .ulist {
  margin-bottom: 0.625em;
}
ul.unstyled,
ol.unnumbered,
ul.checklist,
ul.none {
  list-style-type: none;
}
ul.unstyled,
ol.unnumbered,
ul.checklist {
  margin-left: 0.625em;
}
ul.checklist li > p:first-child > .fa-square-o:first-child,
ul.checklist li > p:first-child > .fa-check-square-o:first-child {
  width: 1em;
  font-size: 0.85em;
}
ul.checklist li > p:first-child > input[type="checkbox"]:first-child {
  width: 1em;
  position: relative;
  top: 1px;
}
ul.inline {
  margin: 0 auto 0.625em auto;
  margin-left: -1.375em;
  margin-right: 0;
  padding: 0;
  list-style: none;
  overflow: hidden;
}
ul.inline > li {
  list-style: none;
  float: left;
  margin-left: 1.375em;
  display: block;
}
ul.inline > li > * {
  display: block;
}
.unstyled dl dt {
  font-weight: 400;
  font-style: normal;
}
ol.arabic {
  list-style-type: decimal;
}
ol.decimal {
  list-style-type: decimal-leading-zero;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}
ol.lowergreek {
  list-style-type: lower-greek;
}
.hdlist > table,
.colist > table {
  border: 0;
  background: none;
}
.hdlist > table > tbody > tr,
.colist > table > tbody > tr {
  background: none;
}
td.hdlist1 {
  padding-right: 0.75em;
  font-weight: bold;
}
td.hdlist1,
td.hdlist2 {
  vertical-align: top;
}
.literalblock + .colist,
.listingblock + .colist {
  margin-top: -0.5em;
}
.colist > table tr > td:first-of-type {
  padding: 0 0.75em;
  line-height: 1;
}
.colist > table tr > td:last-of-type {
  padding: 0.25em 0;
}
.thumb,
.th {
  line-height: 0;
  display: inline-block;
  border: solid 4px #fff;
  -webkit-box-shadow: 0 0 0 1px #ddd;
  box-shadow: 0 0 0 1px #ddd;
}
.imageblock.left,
.imageblock[style*="float: left"] {
  margin: 0.25em 0.625em 1.25em 0;
}
.imageblock.right,
.imageblock[style*="float: right"] {
  margin: 0.25em 0 1.25em 0.625em;
}
.imageblock > .title {
  margin-bottom: 0;
}
.imageblock.thumb,
.imageblock.th {
  border-width: 6px;
}
.imageblock.thumb > .title,
.imageblock.th > .title {
  padding: 0 0.125em;
}
.image.left,
.image.right {
  margin-top: 0.25em;
  margin-bottom: 0.25em;
  display: inline-block;
  line-height: 0;
}
.image.left {
  margin-right: 0.625em;
}
.image.right {
  margin-left: 0.625em;
}
a.image {
  text-decoration: none;
}
span.footnote,
span.footnoteref {
  vertical-align: super;
  font-size: 0.875em;
}
span.footnote a,
span.footnoteref a {
  text-decoration: none;
}
span.footnote a:active,
span.footnoteref a:active {
  text-decoration: underline;
}
#footnotes {
  padding-top: 0.75em;
  padding-bottom: 0.75em;
  margin-bottom: 0.625em;
}
#footnotes hr {
  width: 20%;
  min-width: 6.25em;
  margin: -0.25em 0 0.75em 0;
  border-width: 1px 0 0 0;
}
#footnotes .footnote {
  padding: 0 0.375em;
  line-height: 1.3;
  font-size: 0.875em;
  margin-left: 1.2em;
  text-indent: -1.2em;
  margin-bottom: 0.2em;
}
#footnotes .footnote a:first-of-type {
  font-weight: bold;
  text-decoration: none;
}
#footnotes .footnote:last-of-type {
  margin-bottom: 0;
}
#content #footnotes {
  margin-top: -0.625em;
  margin-bottom: 0;
  padding: 0.75em 0;
}
.gist .file-data > table {
  border: 0;
  background: #fff;
  width: 100%;
  margin-bottom: 0;
}
.gist .file-data > table td.line-data {
  width: 99%;
}
div.unbreakable {
  page-break-inside: avoid;
}
.big {
  font-size: larger;
}
.small {
  font-size: smaller;
}
.underline {
  text-decoration: underline;
}
.overline {
  text-decoration: overline;
}
.line-through {
  text-decoration: line-through;
}
.aqua {
  color: #00bfbf;
}
.aqua-background {
  background-color: #00fafa;
}
.black {
  color: #000;
}
.black-background {
  background-color: #000;
}
.blue {
  color: #0000bf;
}
.blue-background {
  background-color: #0000fa;
}
.fuchsia {
  color: #bf00bf;
}
.fuchsia-background {
  background-color: #fa00fa;
}
.gray {
  color: #606060;
}
.gray-background {
  background-color: #7d7d7d;
}
.green {
  color: #006000;
}
.green-background {
  background-color: #007d00;
}
.lime {
  color: #00bf00;
}
.lime-background {
  background-color: #00fa00;
}
.maroon {
  color: #600000;
}
.maroon-background {
  background-color: #7d0000;
}
.navy {
  color: #000060;
}
.navy-background {
  background-color: #00007d;
}
.olive {
  color: #606000;
}
.olive-background {
  background-color: #7d7d00;
}
.purple {
  color: #600060;
}
.purple-background {
  background-color: #7d007d;
}
.red {
  color: #bf0000;
}
.red-background {
  background-color: #fa0000;
}
.silver {
  color: #909090;
}
.silver-background {
  background-color: #bcbcbc;
}
.teal {
  color: #006060;
}
.teal-background {
  background-color: #007d7d;
}
.white {
  color: #bfbfbf;
}
.white-background {
  background-color: #fafafa;
}
.yellow {
  color: #bfbf00;
}
.yellow-background {
  background-color: #fafa00;
}
span.icon > .fa {
  cursor: default;
}
.admonitionblock td.icon [class^="fa icon-"] {
  font-size: 2.5em;
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
  cursor: default;
}
.admonitionblock td.icon .icon-note:before {
  content: "\f05a";
  color: #19407c;
}
.admonitionblock td.icon .icon-tip:before {
  content: "\f0eb";
  text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8);
  color: #111;
}
.admonitionblock td.icon .icon-warning:before {
  content: "\f071";
  color: #bf6900;
}
.admonitionblock td.icon .icon-caution:before {
  content: "\f06d";
  color: #bf3400;
}
.admonitionblock td.icon .icon-important:before {
  content: "\f06a";
  color: #bf0000;
}
.conum[data-value] {
  display: inline-block;
  color: #fff !important;
  background-color: rgba(0, 0, 0, 0.8);
  -webkit-border-radius: 100px;
  border-radius: 100px;
  text-align: center;
  font-size: 0.75em;
  width: 1.67em;
  height: 1.67em;
  line-height: 1.67em;
  font-family: "Open Sans", "DejaVu Sans", sans-serif;
  font-style: normal;
  font-weight: bold;
}
.conum[data-value] * {
  color: #fff !important;
}
.conum[data-value] + b {
  display: none;
}
.conum[data-value]:after {
  content: attr(data-value);
}
pre .conum[data-value] {
  position: relative;
  top: -0.125em;
}
b.conum * {
  color: inherit !important;
}
.conum:not([data-value]):empty {
  display: none;
}
h1,
h2 {
  letter-spacing: -0.01em;
}
dt,
th.tableblock,
td.content {
  text-rendering: optimizeLegibility;
}
p,
td.content {
  letter-spacing: -0.01em;
}
p strong,
td.content strong {
  letter-spacing: -0.005em;
}
p,
blockquote,
dt,
td.content {
  font-size: 1.0625rem;
}
p {
  margin-bottom: 1.25rem;
}
.sidebarblock p,
.sidebarblock dt,
.sidebarblock td.content,
p.tableblock {
  font-size: 1em;
}
.exampleblock > .content {
  background-color: #fffef7;
  border-color: #e0e0dc;
  -webkit-box-shadow: 0 1px 4px #e0e0dc;
  box-shadow: 0 1px 4px #e0e0dc;
}
.print-only {
  display: none !important;
}
@media print {
  @page {
    margin: 1.25cm 0.75cm;
  }
  * {
    -webkit-box-shadow: none !important;
    box-shadow: none !important;
    text-shadow: none !important;
  }
  a {
    color: inherit !important;
    text-decoration: underline !important;
  }
  a.bare,
  a[href^="#"],
  a[href^="mailto:"] {
    text-decoration: none !important;
  }
  a[href^="http:"]:not(.bare):after,
  a[href^="https:"]:not(.bare):after {
    content: "(" attr(href) ")";
    display: inline-block;
    font-size: 0.875em;
    padding-left: 0.25em;
  }
  abbr[title]:after {
    content: " (" attr(title) ")";
  }
  pre,
  blockquote,
  tr,
  img {
    page-break-inside: avoid;
  }
  thead {
    display: table-header-group;
  }
  img {
    max-width: 100% !important;
  }
  p,
  blockquote,
  dt,
  td.content {
    font-size: 1em;
    orphans: 3;
    widows: 3;
  }
  h2,
  h3,
  #toctitle,
  .sidebarblock > .content > .title {
    page-break-after: avoid;
  }
  #toc,
  .sidebarblock,
  .exampleblock > .content {
    background: none !important;
  }
  #toc {
    border-bottom: 1px solid #ddddd8 !important;
    padding-bottom: 0 !important;
  }
  .sect1 {
    padding-bottom: 0 !important;
  }
  .sect1 + .sect1 {
    border: 0 !important;
  }
  #header > h1:first-child {
    margin-top: 1.25rem;
  }
  body.book #header {
    text-align: center;
  }
  body.book #header > h1:first-child {
    border: 0 !important;
    margin: 2.5em 0 1em 0;
  }
  body.book #header .details {
    border: 0 !important;
    display: block;
    padding: 0 !important;
  }
  body.book #header .details span:first-child {
    margin-left: 0 !important;
  }
  body.book #header .details br {
    display: block;
  }
  body.book #header .details br + span:before {
    content: none !important;
  }
  body.book #toc {
    border: 0 !important;
    text-align: left !important;
    padding: 0 !important;
    margin: 0 !important;
  }
  body.book #toc,
  body.book #preamble,
  body.book h1.sect0,
  body.book .sect1 > h2 {
    page-break-before: always;
  }
  .listingblock code[data-lang]:before {
    display: block;
  }
  #footer {
    background: none !important;
    padding: 0 0.9375em;
  }
  #footer-text {
    color: rgba(0, 0, 0, 0.6) !important;
    font-size: 0.9em;
  }
  .hide-on-print {
    display: none !important;
  }
  .print-only {
    display: block !important;
  }
  .hide-for-print {
    display: none !important;
  }
  .show-for-print {
    display: inherit !important;
  }
}

.pygments .highlight pre,
pre > code {
  color: #f8f8f2 !important;
}

/*Custom CSS*/
body {
  background: #f5f5f5;
}
#header-main-title {
  float: left;
}
#cards {
  clear: both;
}
#cards .btn-primary {
  background-color: #e44c3a;
  border-color: #e44c3a;
}
#asciinema-player-section {
  margin-bottom: 25px;
}
.logo {
  width: 70%;
  padding-top: 20px;
  padding-bottom: 10px;
}
#main-row {
  min-height: 100%;
  height: 100%;
}
#toc {
  border-bottom: none;
  overflow-y: auto;
  margin: 0;
  top: 0px;
  z-index: 9;
}

#toc .nav-link {
  font-size: 13px;
}
.toc {
  margin-top: 116px;
  word-break: break-all;
  max-width: 223px;
}
#toctitle {
  font-size: 1.2em;
}
#aws-link {
  width: 80%;
}
.sectlevel1 {
  padding-left: 7px;
}
/* .border-columns{ */
/* background-color: #2E3336; */
/* } */
.footer {
  display: block;
  bottom: 0;
  width: 75%;
  height: 40px;
  line-height: 40px;
  background-color: #2e3336;
  margin: 0 auto;
}
.footer > .container {
  padding-right: 15px;
  padding-left: 15px;
}
nav[data-toggle="toc"] .nav > li > a {
  display: block;
  padding: 4px 20px;
  font-size: 13px;
  font-weight: 500;
  color: rgba(0, 0, 0, 0.65);
}
nav[data-toggle="toc"] .nav > li > a:hover {
  background-color: #e44c3a;
  color: rgba(0, 0, 0, 0.65);
}
.text-muted {
  color: rgba(0, 0, 0, 0.65) !important;
}
nav[data-toggle="toc"] .nav .nav > li > a,
nav[data-toggle="toc"] .nav .nav > li > a:focus,
nav[data-toggle="toc"] .nav .nav > li > a:hover {
  padding-left: 10px;
}
nav[data-toggle="toc"] .nav .nav > li > .active,
nav[data-toggle="toc"] .nav .nav > li > .active:focus,
nav[data-toggle="toc"] .nav .nav > li > .active:hover,
nav[data-toggle="toc"] .nav-link.active,
nav[data-toggle="toc"] .nav-link.active:focus,
nav[data-toggle="toc"] .nav-link.active:hover {
  /* padding-left: 10px; */
  font-weight: 700;
  color: #e44c3a;
  background-color: transparent;
  border-left: 2px solid #e44c3a;
}
#toc > ul > li > ul {
  margin-left: 10px;
}

/* small screens */
@media (max-width: 767px) {
  /* override stickyness so that the navigation does not follow scrolling */
  nav[data-toggle="toc"] {
    margin-bottom: 42px;
  }
  nav[data-toggle="toc"] .nav .active .nav {
    display: none;
  }
  #aws-link {
    width: 50%;
    margin-bottom: 5px;
  }
  .border-right {
    border: none !important;
  }
}

html,
body {
  height: 100%;
}

/* Scrollbar styles */
#toc::-webkit-scrollbar {
  width: 3px;
}

/* Track */
#toc::-webkit-scrollbar-track {
  background: transparent;
}

/* Handle */
#toc::-webkit-scrollbar-thumb {
  background: rgb(182, 182, 182);
}

/* Handle on hover */
#toc::-webkit-scrollbar-thumb:hover {
  background: rgb(163, 163, 163);
}

/* Gernal styles */
.toggle-nav-btn {
  position: absolute;
  right: 30px;
  top: 34px;
}
.bd-sidebar {
  height: 100vh !important;
}
.bd-sidebar .nav > li > a {
  padding: 4px 20px;
  font-size: 13px;
  font-weight: 500;
  color: rgba(0, 0, 0, 0.65);
  padding-left: 12px;
}
.main-link {
  border-left: 2px solid #e44c3a;
  color: #ba3925 !important;
  cursor: pointer;
  font-weight: bold;
}

/* card styles */
.card-wrapper {
  height: min-content;
  -webkit-box-shadow: 0 0 30px rgba(0, 0, 0, 0.1); /* Safari 3-4, iOS 4.0.2 - 4.2, Android 2.3+ */
  -moz-box-shadow: 0 0 30px rgba(0, 0, 0, 0.1); /* Firefox 3.5 - 3.6 */
  box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
}
.card-wrapper .card-body {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}
.card-wrapper .content .card-text {
  margin-bottom: 12px;
}
.card-wrapper .card-body .card-title {
  color: #e44c3a;
  font-size: 22px;
  font-weight: 500;
}
.LogoAndToggle {
  border-bottom: 1px solid gainsboro;
  margin: 0px;
  display: block;
  padding-bottom: 12px;
  background: whitesmoke;
  padding-top: 4px;
}
/* media quires */
@media (max-width: 767px) {
  .bd-sidebar {
    height: 100px !important;
    border: 0;
  }

  #toc {
    min-width: 100%;
    padding-top: 15px;
  }
  #toc.show {
    border-bottom: none;
    left: 0;
    min-width: 100%;
    margin: 0;
    padding-top: 15px;
    box-shadow: 0px 7px 10px 2px #ababab3b;
  }
  .LogoAndToggle {
    display: flex;
    justify-content: space-around;
    width: 100%;
    margin: 0;
  }
  .bd-links {
    background: white;
    z-index: 9;
    position: relative;
    max-height: 300px;
    overflow-y: scroll;
    margin-top: -5px;
    border-bottom: 1px solid #d6d6d6;
  }
}
@media (min-width: 768px) {
  .bd-links {
    height: 100% !important;
    overflow-y: auto;
    display: block !important;
  }
  #toc {
    position: relative;
    top: 0;
    max-width: 100%;
    margin: 0;
    padding-left: 10px;
  }
  .toc {
    /* height: calc(100vh - 97px) !important; */
    height: calc(100vh - 160px) !important;
  }
  .bd-sidebar {
    padding-right: 20px;
    top: 0 !important;
  }
}

.bdr-right {
  border-right: 1px solid gainsboro;
}
.bdr-left {
  border-left: 1px solid gainsboro;
}

nav[data-toggle="toc"] .nav > li > a:focus,
nav[data-toggle="toc"] .nav > li > a:hover {
  border-left: 2px solid #e44c3a;
}
nav[data-toggle="toc"] .nav > li > a:hover {
  background-color: #ba39251a;
  color: rgba(0, 0, 0, 0.65);
}
/* pre.pygments .tok-n , pre.pygments .tok-p{
    color: rgba(0,0,0,.9) !important;
} */

table.linenotable {
  width: 100%;
}
.pygments code {
  width: max-content;
  overflow-x: auto;
  display: block;
  min-width: 100%;
}
.bd-search {
  padding: 0;
  margin: auto;
  padding-bottom: 10px;
  padding-top: 10px;
}
@media (max-width: 767px) {
  .bd-search {
    background-color: white;
    border-bottom: 1px solid #ddddd7;
  }
}
.bd-search .algolia-autocomplete {
  width: 100%;
}
.bd-search input {
  border-color: #3333331c;
  left: 0px;
  margin: auto;
  padding: 0;
  padding: 7px;
  width: 90%;
  max-width: 90%;
}

.bd-search .form-control:focus {
  border-color: #e44c3a61;
  box-shadow: 0 0 0 3px rgb(237 152 142 / 50%);
}
.bd-links {
  padding-top: 1rem;
}

/* Blue #167bb7 */
/* Green #29a9c9 */
/* Red #e44c3a */

#toc.right-side-menu ul li ul {
  padding: 0;
}
#toc.right-side-menu ul li ul {
  margin: 0;
}
#toc.right-side-menu ul li ul li a {
  padding-left: 30px !important;
  border-left: 2px solid #33333326;
}
#toc.right-side-menu ul li ul li a.active {
  padding-left: 30px !important;
  border-left: 2px solid #e44c3a;
  font-weight: 600 !important;
}

nav.right-side-menu .nav > li > a {
  display: block;
}
nav.right-side-menu > ul > li > a {
  color: #e44c3a;
  font-weight: 800 !important;
  background-color: transparent;
  border-left: 2px solid #33333326;
}
nav.right-side-menu > ul > li > a.active {
  color: #e44c3a;
  background-color: transparent;
  border-left: 2px solid #e44c3a;
}
nav[data-toggle="toc"].right-side-menu .nav-link + ul {
  display: block;
}

pre.pygments .tok-mf, pre.pygments .tok-mi{
  color: #f8f8f2 !important
}
</style>
<style>pre { line-height: 125%; }
td.linenos pre { color: #000000; background-color: #f0f0f0; padding-left: 5px; padding-right: 5px; }
span.linenos { color: #000000; background-color: #f0f0f0; padding-left: 5px; padding-right: 5px; }
td.linenos pre.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
pre.pygments .hll { background-color: #49483e }
pre.pygments { background: #272822; color: #f8f8f2 }
pre.pygments .tok-c { color: #75715e } /* Comment */
pre.pygments .tok-err { color: #960050; background-color: #1e0010 } /* Error */
pre.pygments .tok-k { color: #66d9ef } /* Keyword */
pre.pygments .tok-l { color: #ae81ff } /* Literal */
pre.pygments .tok-n { color: #f8f8f2 } /* Name */
pre.pygments .tok-o { color: #f92672 } /* Operator */
pre.pygments .tok-p { color: #f8f8f2 } /* Punctuation */
pre.pygments .tok-ch { color: #75715e } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #75715e } /* Comment.Multiline */
pre.pygments .tok-cp { color: #75715e } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #75715e } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #75715e } /* Comment.Single */
pre.pygments .tok-cs { color: #75715e } /* Comment.Special */
pre.pygments .tok-gd { color: #f92672 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-gi { color: #a6e22e } /* Generic.Inserted */
pre.pygments .tok-go { color: #66d9ef } /* Generic.Output */
pre.pygments .tok-gp { color: #f92672; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #75715e } /* Generic.Subheading */
pre.pygments .tok-kc { color: #66d9ef } /* Keyword.Constant */
pre.pygments .tok-kd { color: #66d9ef } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #f92672 } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #66d9ef } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #66d9ef } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #66d9ef } /* Keyword.Type */
pre.pygments .tok-ld { color: #e6db74 } /* Literal.Date */
pre.pygments .tok-m { color: #ae81ff } /* Literal.Number */
pre.pygments .tok-s { color: #e6db74 } /* Literal.String */
pre.pygments .tok-na { color: #a6e22e } /* Name.Attribute */
pre.pygments .tok-nb { color: #f8f8f2 } /* Name.Builtin */
pre.pygments .tok-nc { color: #a6e22e } /* Name.Class */
pre.pygments .tok-no { color: #66d9ef } /* Name.Constant */
pre.pygments .tok-nd { color: #a6e22e } /* Name.Decorator */
pre.pygments .tok-ni { color: #f8f8f2 } /* Name.Entity */
pre.pygments .tok-ne { color: #a6e22e } /* Name.Exception */
pre.pygments .tok-nf { color: #a6e22e } /* Name.Function */
pre.pygments .tok-nl { color: #f8f8f2 } /* Name.Label */
pre.pygments .tok-nn { color: #f8f8f2 } /* Name.Namespace */
pre.pygments .tok-nx { color: #a6e22e } /* Name.Other */
pre.pygments .tok-py { color: #f8f8f2 } /* Name.Property */
pre.pygments .tok-nt { color: #f92672 } /* Name.Tag */
pre.pygments .tok-nv { color: #f8f8f2 } /* Name.Variable */
pre.pygments .tok-ow { color: #f92672 } /* Operator.Word */
pre.pygments .tok-w { color: #f8f8f2 } /* Text.Whitespace */
pre.pygments .tok-mb { color: #ae81ff } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #ae81ff } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #ae81ff } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #ae81ff } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #ae81ff } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #e6db74 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #e6db74 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #e6db74 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #e6db74 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #e6db74 } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #e6db74 } /* Literal.String.Double */
pre.pygments .tok-se { color: #ae81ff } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #e6db74 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #e6db74 } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #e6db74 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #e6db74 } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #e6db74 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #e6db74 } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #f8f8f2 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #a6e22e } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #f8f8f2 } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #f8f8f2 } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #f8f8f2 } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #f8f8f2 } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #ae81ff } /* Literal.Number.Integer.Long */</style></head><body data-spy="scroll" data-target="#toc" class="book"><div class="container-fluid"><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 bd-sidebar sticky-top border-columns border-right p-0"><div class="mx-auto text-center LogoAndToggle"><a href="https://docs.killbill.io/"><img class="logo rounded mx-auto d-block img-fluid" src="https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/img/logo.png" /></a><button class="btn btn-link bd-search-docs-toggle d-md-none p-0 ml-3 toggle-nav-btn" type="button" data-toggle="collapse" data-target="#toc" aria-controls="toc" aria-expanded="false" aria-label="Toggle docs navigation"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30" width="30" height="30" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-miterlimit="10" d="M4 7h22M4 15h22M4 23h22"></path></svg></button></div><form role="search" class="bd-search d-flex align-items-center"><input type="search" class="form-control" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off" data-docs-version="4.4"></form><nav id="toc" class="collapse bd-links toc"><ul class="nav navbar-nav"><li><a class="bd-toc-link main-link">Getting started</a><ul class="nav navbar-nav"><li><a class="nav-link" href="https://docs.killbill.io/latest/what_is_kill_bill.html">What is Kill Bill?</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/getting_started.html">Quick start</a></li></ul></li></ul><ul class="nav navbar-nav"><li><a class="bd-toc-link main-link">Installation</a><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="https://docs.killbill.io/latest/aws.html">AWS Development</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/stripe_plugin.html">Kill Bill + Stripe DIY</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/userguide_deployment.html">Going to production</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/database_migrations.html">Database migrations</a></li><li><a class="nav-link" href="https://github.com/killbill/killbill/releases" onclick="getOutboundLink('https://github.com/killbill/killbill/releases'); return false;">Release&nbsp;notes</a></li></ul></li></ul><ul class="nav navbar-nav"><li><a class="bd-toc-link main-link ml-2">Manuals</a><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="https://docs.killbill.io/latest/userguide_subscription.html">Subscription&nbsp;Billing</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/userguide_payment.html">Payment processing</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/userguide_kaui.html">Kaui, the Administrative&nbsp;UI</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/email-notification-plugin.html">Email Notification plugin</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/custom-email-invoice-formatter.html">Custom Email Formatter</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/userguide_analytics.html">Analytics plugin</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/userguide_configuration.html">Kill Bill&nbsp;configuration</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/internationalization.html">Kill Bill&nbsp;internationalization</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/migration_guide.html">Migrating to Kill Bill</a></li></ul></li></ul><ul class="nav navbar-nav"><li><a class="bd-toc-link main-link">Tutorials</a><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="https://docs.killbill.io/latest/plan_alignment.html">Plans alignments</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/overdue.html">Overdue system</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/consumable_in_arrear.html">In Arrear UsageBilling</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/ha.html">Hierarchical Accounts</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/catalog-examples.html">Catalog Examples    </a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/invoice_templates.html">Invoice Templates  </a></li></ul></li></ul><ul class="nav navbar-nav"><li><a class="bd-toc-link main-link">Integration</a><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a href="http://killbill.github.io/slate" onclick="getOutboundLink('http://killbill.github.io/slate'); return false;">REST API reference</a></li><li><a href="https://docs.killbill.io/latest/swagger_documentation.html">Swagger UI Documentation</a></li><li><a href="https://docs.killbill.io/latest/postman.html">Postman Integration</a></li><li><a href="https://docs.killbill.io/latest/debugging.html">Debugging</a></li><li><a href="https://docs.killbill.io/latest/push_notifications.html">Push notifications</a></li><li><a href="https://docs.killbill.io/latest/kill_bill_events.html">Kill Bill Events</a></li></ul></li></ul><ul class="nav navbar-nav"><li><a class="bd-toc-link main-link">Plugin development</a><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a href="https://docs.killbill.io/latest/plugin_development.html">Plugin Development</a></li><li><a href="https://docs.killbill.io/latest/plugin_use_cases.html">Special Plugin Use Cases</a></li><li><a href="https://docs.killbill.io/latest/notification_plugin.html">Notification Plugins</a></li><li><a href="https://docs.killbill.io/latest/payment_plugin.html">Payment Plugins</a></li><li><a href="https://docs.killbill.io/latest/payment_control_plugin.html">Payment Control Plugins</a></li><li><a href="https://docs.killbill.io/latest/entitlement_plugin.html">Entitlement Plugins</a></li><li><a href="https://docs.killbill.io/latest/invoice_plugin.html">Invoice Plugins</a></li><li><a href="https://docs.killbill.io/latest/catalog_plugin.html">Catalog Plugins</a></li></ul></li></ul><ul class="nav navbar-nav"><li><a class="bd-toc-link main-link">Operational guides</a><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="https://docs.killbill.io/latest/deploy_to_kubernetes.html">Kubernetes (K8s) Deployment</a></li><li class="bd-sidenav-active"><a href="https://docs.killbill.io/latest/user_management.html">Users, Roles and Permissions</a></li><li><a href="https://docs.killbill.io/latest/plugin_management.html">Plugin Management</a></li></ul></li></ul><ul class="nav navbar-nav"><li><a class="bd-toc-link main-link">Client libraries</a><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a href="https://docs.killbill.io/latest/java_client.html">Java</a></li><li><a href="http://github.com/killbill/killbill-client-ruby" onclick="getOutboundLink('http://github.com/killbill/killbill-client-ruby'); return false;">Ruby</a></li><li><a href="http://github.com/killbill/killbill-client-php" onclick="getOutboundLink('http://github.com/killbill/killbill-client-php'); return false;">PHP</a></li><li><a href="http://github.com/killbill/killbill-client-js" onclick="getOutboundLink('http://github.com/killbill/killbill-client-js'); return false;">Node.js</a></li><li><a href="http://github.com/killbill/killbill-client-python" onclick="getOutboundLink('http://github.com/killbill/killbill-client-python'); return false;">Python</a></li><li><a href="http://github.com/killbill/kbcli" onclick="getOutboundLink('http://github.com/killbill/kbcli'); return false;">Go</a></li></ul></li></ul><ul class="nav navbar-nav"><li><a class="bd-toc-link main-link">About Kill Bill</a><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a href="https://docs.killbill.io/latest/demo.html">Demo</a></li><li><a href="https://docs.killbill.io/latest/features.html">Features list</a></li><li><a href="https://docs.killbill.io/latest/faq.html">FAQ</a></li><li><a href="https://docs.killbill.io/latest/Kill-Bill-Glossary.html">Glossary</a></li></ul></li></ul><ul class="nav navbar-nav"><li><a class="bd-toc-link main-link">Internal</a><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a href="https://docs.killbill.io/latest/internal_design.html">Internal design</a></li><li><a href="https://docs.killbill.io/latest/entitlement_subsystem.html">Entitlement Subsystem</a></li><li><a href="https://docs.killbill.io/latest/invoice_subsystem.html">Invoice Subsystem</a></li><li><a href="https://docs.killbill.io/latest/development.html">Development</a></li></ul></li></ul><ul class="nav navbar-nav"><li><a class="bd-toc-link main-link">References</a><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a href="https://github.com/killbill/killbill-docs/tree/v3/swagger" onclick="getOutboundLink('https://github.com/killbill/killbill-docs/tree/v3/swagger'); return false;">Swagger&nbsp;API schema</a></li><li><a href="https://docs.killbill.io/latest/catalog.xsd">Catalog XSD reference</a></li><li><a href="https://docs.killbill.io/latest/overdue.xsd">Overdue XSD reference</a></li></ul></li></ul></nav></div><div class="col-12 col-md-9 col-xl-8 border-right"><div id="header"><h1>Payment Plugin Overview</h1></div><div id="content"><div id="preamble"><div class="sectionbody"><div class="paragraph"><p>Payment plugins integrate Kill Bill with a specific gateway (i.e. payment processor), such as Stripe or Braintree. We already have many open-source payment plugins available on GitHub as follows:</p></div>
<div class="olist arabic"><ol class="arabic"><li><p><a href="https://github.com/killbill/killbill-stripe-plugin">killbill-stripe-plugin</a> - Plugin to use  <a href="https://stripe.com/">Stripe</a> as the payment gateway</p></li><li><p><a href="https://github.com/killbill/killbill-adyen-plugin">killbill-adyen-plugin</a> - Plugin to use <a href="https://www.adyen.com/">Adyen</a> as the payment gateway</p></li><li><p><a href="https://github.com/killbill/killbill-qualpay-plugin">killbill-qualpay-plugin</a> - Plugin to use <a href="https://www.qualpay.com/">QualPay</a> as the payment gateway</p></li></ol></div>
<div class="paragraph"><p>This guide will give you pointers in case you need to develop your own payment plugin.</p></div>
<div class="paragraph"><p>Before reading this guide, make sure to familiarize yourself with <a href="https://docs.killbill.io/latest/userguide_subscription.html#components-payment">payment components</a> and the <a href="https://docs.killbill.io/latest/userguide_payment.html">payment userguide</a>.</p></div></div></div>
<h1 id="_developing_a_payment_plugin" class="sect0">Developing a Payment Plugin</h1><div class="openblock partintro"><div class="content"><div class="paragraph"><p>We provide an interface called <a href="https://github.com/killbill/killbill-plugin-api/blob/master/payment/src/main/java/org/killbill/billing/payment/plugin/api/PaymentPluginApi.java">PaymentPluginApi</a>. This is the interface between Kill Bill and payment plugins. In order to create your own payment plugin, you need to create a class that implements this interface and implement the methods in this interface.</p></div>
<div class="paragraph"><p>We provide a <a href="https://github.com/killbill/killbill-plugin-framework-java">plugin framework</a> which has many classes that can be used out of the box for plugin development. We strongly encourage you to use this library.</p></div></div></div>
<div class="sect1"><h2 id="_getting_started">Getting Started</h2><div class="sectionbody"><div class="paragraph"><p>We provide a simple <a href="https://github.com/killbill/killbill-hello-world-java-plugin">Hello World Plugin</a> that can be used as the starting point to develop your payment plugin.
The <strong>Hello World Plugin</strong> already includes the plugin framework.</p></div>
<div class="paragraph"><p>In order to get started with your own payment plugin, you need to do the following:</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>Set up the <strong>Hello World Plugin</strong> as per our <a href="https://docs.killbill.io/latest/plugin_development.html#_development">plugin development</a> document.</p></li><li><p>Create a new Maven project similar to <strong>Hello World Plugin</strong></p></li><li><p>Create a class similar to <a href="https://github.com/killbill/killbill-hello-world-java-plugin/blob/719779b1ea25c14928e92996b6aa21cc9bf8d4fe/src/main/java/org/killbill/billing/plugin/helloworld/HelloWorldPaymentPluginApi.java">HelloWorldPaymentPluginApi.java</a>. This is a reference class that is included in the <strong>Hello World Plugin</strong>. It implements the <code>PaymentPluginApi</code> interface.</p></li><li><p>Implement the desired methods from the <code>PaymentPluginApi</code> interface within your class. These methods are explained in the <a href="#_paymentpluginapi_methods">[_paymentpluginapi_methods]</a> table below.</p></li><li><p>Create a class similar to <a href="https://github.com/killbill/killbill-hello-world-java-plugin/blob/719779b1ea25c14928e92996b6aa21cc9bf8d4fe/src/main/java/org/killbill/billing/plugin/helloworld/HelloWorldActivator.java">HelloWorldActivator</a>.  This class will be responsible for starting the plugin.</p></li></ol></div></div></div>
<div class="sect1"><h2 id="_paymentpluginapi_methods">PaymentPluginApi Methods</h2><div class="sectionbody"><div class="paragraph"><p>The following table lists the methods in <a href="https://github.com/killbill/killbill-plugin-api/blob/master/payment/src/main/java/org/killbill/billing/payment/plugin/api/PaymentPluginApi.java">PaymentPluginApi</a> interface. You can implement the desired methods in your plugin class.</p></div>
<table class="tableblock frame-all grid-all spread"><colgroup><col style="width: 50%;"><col style="width: 50%;"></colgroup><thead><tr><th class="tableblock halign-left valign-top">Method Name</th><th class="tableblock halign-left valign-top">Method Description</th></tr></thead><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">authorizePayment/ capturePayment</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Should trigger an <a href="https://en.wikipedia.org/wiki/Authorization_hold">authorization</a> and capture respectfully (applies to credit cards only)</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">purchasePayment</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Should trigger a generic payment (authorization with auto-capture for credit cards, ACH/SEPA, etc.)</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">voidPayment</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Should void an authorization (credit cards only)</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">creditPayment</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Should fund the payment method from your merchant account (similar to a refund, but no prior payment is required: this can be used to initiate an ACH for disbursement for instance)</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">refundPayment</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Should reverse an existing (settled) charge</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">getPaymentInfo</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Should return detailed information on the transactions for that payment (arbitrary properties can be populated in PaymentTransactionInfoPlugin#getProperties)</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">searchPayments</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Should return payment transactions matching the specified searchKey (the implementation is up to the plugin)</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">addPaymentMethod</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Should create the payment method in the gateway (e.g. store a token)</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">deletePaymentMethod</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Should delete the payment method in the gateway (e.g. revoke a token)</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">getPaymentMethodDetail</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Should return detailed information about the payment method (e.g. billing address)</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">setDefaultPaymentMethod</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Should mark the payment method as the default one in the gateway (if the associated account in the gateway has several payment methods)</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">getPaymentMethods</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Should list the payment methods in the gateway for that account (used by the refresh endpoint, when payment methods are added directly in the gateway, bypassing addPaymentMethod)</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">searchPaymentMethods</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Should return payment methods matching the specified searchKey (the implementation is up to the plugin)</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">resetPaymentMethods</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Called at the end of a refresh call, should associate to that account the payment methods specified (this is useful if Kill Bill knows payment methods that are not yet in the gateway)</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">buildFormDescriptor</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Should return enough metadata for the front-end to build a form or a redirect to a hosted payment page</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">processNotification</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Should process payloads from the gateway to transition payments states</p></td></tr></tbody></table>
<div class="paragraph"><p>A few pointers for implementing these methods:</p></div>
<div class="ulist"><ul><li><p>Almost all the <code>PaymentPluginApi</code> methods accept parameters like <strong>Kill Bill account Id</strong>, <strong>Kill Bill payment id</strong>, <strong>Kill Bill transaction id</strong>, etc which are self-explanatory. These may or may not be used by your plugin code. But you may need some of these values to populate the <a href="#_paymenttransactioninfoplugin">[_paymenttransactioninfoplugin]</a> object which is returned by most of the methods.</p></li><li><p>All the methods listed in the <code>PaymentPluginApi</code> also accept <code>Iterable&lt;PluginProperty&gt; properties</code> as a parameter. A <a href="https://github.com/killbill/killbill-api/blob/4ae1c343a593de937415e21feecb9f5405037fa3/src/main/java/org/killbill/billing/payment/api/PluginProperty.java">PluginProperty</a> consists of a <strong>key-value</strong> pair. It can be used to pass plugin specific properties to the plugin. For example, if your plugin requires properties like <strong>city=San Francisco</strong> and <strong>billing_address=abc</strong>, a client application can create two <code>PluginProperty</code> objects and pass a <code>List</code> of these objects.</p></li><li><p>All the methods listed in the <code>PaymentPluginApi</code> also accept as parameter either a <code>TenantContext</code> or a <code>CallContext</code>.  Read only operations (operations which retrieve some data from Kill Bill) like the <code>getPaymentInfo</code> accept a <code>TenantContext</code>. Read/write operations like <code>authorizePayment</code> accept a <code>CallContext</code>. Both these values can be used for auditing purposes.</p></li><li><p>It is quite possible that your plugin might not support some of the operations listed above. In such a case, the plugin can do one of the following:</p><div class="ulist"><ul><li><p>Return an <strong>empty list</strong> when the return type is a list</p></li><li><p>Return a transaction with status <strong>CANCELED</strong> if the return type is a <code>PaymentTransactionInfoPlugin</code></p></li><li><p>Return empty objects otherwise</p></li></ul></div></li></ul></div></div></div>
<div class="sect1"><h2 id="_paymenttransactioninfoplugin">PaymentTransactionInfoPlugin</h2><div class="sectionbody"><div class="paragraph"><p>Most of the methods in the <code>PaymentPluginApi</code> return a <a href="https://github.com/killbill/killbill-api/blob/4ae1c343a593de937415e21feecb9f5405037fa3/src/main/java/org/killbill/billing/payment/plugin/api/PaymentTransactionInfoPlugin.java">PaymentTransactionInfoPlugin</a> object. Again, the Kill Bill Plugin framework includes a class called <a href="https://github.com/killbill/killbill-plugin-framework-java/blob/46d94fbeb1cf089aa04e62cfecf751ca47032023/src/main/java/org/killbill/billing/plugin/api/payment/PluginPaymentTransactionInfoPlugin.java"> PluginPaymentTransactionInfoPlugin</a> which implements the <code>PaymentTransactionInfoPlugin</code>. You can create a class that extends this class and have the plugin methods return this object.</p></div>
<div class="paragraph"><p>The <code>PaymentTransactionInfoPlugin</code> has the following methods (Your plugin code needs to populate this information in the <code>PaymentTransactionInfoPlugin</code> object and a client application can then invoke these methods to retrieve this information):</p></div>
<table class="tableblock frame-all grid-all spread"><colgroup><col style="width: 50%;"><col style="width: 50%;"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Method Name</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Method Description</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">getKbPaymentId</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Returns Payment Id in Kill Bill</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">getKbTransactionPaymentId</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Returns Transaction Payment Id in Kill Bill</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">getTransactionType</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Returns the transaction type (<a href="https://github.com/killbill/killbill-api/blob/4ae1c343a593de937415e21feecb9f5405037fa3/src/main/java/org/killbill/billing/payment/api/TransactionType.java">TransactionType</a> object)</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">getAmount</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Returns the processed amount</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">getCurrency</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Returns the processed currency</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">getCreatedDate</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Returns the date when the payment was created</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">getEffectiveDate</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Returns the date when the payment is effective</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">getStatus</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Returns the payment status (<a href="https://github.com/killbill/killbill-api/blob/4ae1c343a593de937415e21feecb9f5405037fa3/src/main/java/org/killbill/billing/payment/plugin/api/PaymentPluginStatus.java">PaymentPluginStatus</a> object)</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">getGatewayError</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Returns the gateway error if any</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">getGatewayErrorCode</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Returns the gateway error code if any</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">getFirstPaymentReferenceId</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Returns gateway specific first payment id if any</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">getSecondPaymentReferenceId</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Returns gateway specific second payment id if any</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">getProperties</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Returns a <code>PluginProperty</code> List. This can be used to return plugin specific properties to the client API</p></td></tr></tbody></table>
<div class="paragraph"><p>It is very important to correctly populate the <a href="https://github.com/killbill/killbill-api/blob/4ae1c343a593de937415e21feecb9f5405037fa3/src/main/java/org/killbill/billing/payment/plugin/api/PaymentPluginStatus.java">PaymentPluginStatus</a>  in the <code>PaymentTransactionInfoPlugin</code> object. The following table elaborates how the status should be populated:</p></div>
<table class="tableblock frame-all grid-all spread"><colgroup><col style="width: 50%;"><col style="width: 50%;"></colgroup><thead><tr><th class="tableblock halign-left valign-top">Status</th><th class="tableblock halign-left valign-top">Status Description</th></tr></thead><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">PROCESSED</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Indicates that the payment is successful</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">ERROR</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Indicates that the payment is rejected by the gateway (insufficient funds, fails AVS check, fraud detected, etc.)</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">PENDING</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Indicates that the payment requires a completion step (3D-S verification, HPP, etc.)</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">CANCELED</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Indicates that the gateway wasn&#8217;t contacted (DNS error, SSL handshake error, socket connect timeout, etc.)</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">UNDEFINED</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Should be used for all other cases (socket read timeout, 500 returned, etc.)</p></td></tr></tbody></table>
<div class="paragraph"><p>Kill Bill has a <a href="https://docs.killbill.io/latest/userguide_payment.html#_janitor">Janitor</a> system in place that attempts to fix <strong>PENDING</strong> and <strong>UNKNOWN</strong> states . It polls the plugin via <code>PaymentPluginApi#getPaymentInfo</code> method. If the plugin subsequently returns <strong>PROCESSED</strong>, the Janitor updates the internal payment state as well as invoice balance, etc.) accordingly.</p></div>
<div class="paragraph"><p>The Janitor matches the internal transactions against plugin transactions via the <strong>transaction id</strong>, so make sure <code>PaymentTransactionInfoPlugin#getKbTransactionPaymentId</code> is correctly implemented.</p></div>
<div class="paragraph"><p>You should try to avoid <strong>UNDEFINED</strong> as much as possible, because it is the only case where Kill Bill cannot retry payments (since the payment may or may not have happened).</p></div></div></div>
<div class="sect1"><h2 id="_gocardless_plugin_tutorial">GoCardless Plugin Tutorial</h2><div class="sectionbody"><div class="paragraph"><p>In order to demonstrate creating a payment plugin, we will be creating a Kill Bill payment plugin for <a href="https://gocardless.com/">GoCardless</a>. GoCardless allows direct debit from customer&#8217;s bank accounts. It requires a customer to set up a <strong>mandate</strong> the first time. A <strong>mandate</strong> is an <strong>authorisation</strong> from a customer to take payments from their bank account. Once a mandate is set up, it directly collects payments against the mandate.</p></div>
<div class="paragraph"><p>GoCardless provides a <a href="https://developer.gocardless.com/getting-started/api/making-your-first-request/#setting-up-your-client-library">client library</a>. We will be using this library to integrate GoCardless with Kill Bill. For the sake of simplicity, we will be creating a very basic plugin that can only process payments. Refunds, credits and other plugin functionality will currently not be implemented.</p></div>
<div class="paragraph"><p>The complete code for this tutorial is available at <a href="https://github.com/killbill/killbill-gocardless-example-plugin">Github</a>.</p></div>
<div class="sect2"><h3 id="_how_gocardless_works">How GoCardless works</h3><div class="paragraph"><p>The first step in GoCardless would be adding a customer and setting up a payment mandate. GoCardless supports three ways to do this as explained <a href="https://developer.gocardless.com/getting-started/api/adding-your-first-customer/">here</a>. In this tutorial, we will be using the <strong>hosted payment page</strong> approach which is explained <a href="https://developer.gocardless.com/getting-started/api/adding-your-first-customer/#setting-up-direct-debit-mandates-using-hosted-payment-pages">here</a>.</p></div>
<div class="paragraph"><p>The diagram below explains the steps involved. We consider the following actors:</p></div>
<div class="paragraph"><p><strong>Browser</strong>: user sitting behind a browser and initiating the payment flow</p></div>
<div class="paragraph"><p><strong>Merchant Site</strong>: customer facing web site which receives the order</p></div>
<div class="paragraph"><p><strong>GoCardless</strong>: The GoCardless payment system</p></div>
<div class="paragraph"><p><strong>Bank</strong> - Customer&#8217;s bank which processes the payments</p></div>
<div class="paragraph"><p><span class="image"><img src="https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/img/payment-plugin/How-Go-Cardless-Works.png" alt="How Go Cardless Works"></span></p></div>
<div class="olist arabic"><ol class="arabic"><li><p>A user enters his/her payment details on a merchant site.</p></li><li><p>The merchant site <strong>initiates</strong> the <strong>GoCardless Redirect flow</strong> with the <strong>customer details</strong>  (optional) and a <strong>success page URL</strong>.</p></li><li><p><strong>GoCardless</strong> returns a <strong>redirect URL</strong>.</p></li><li><p>The merchant site redirects the user to this URL.</p></li><li><p>The user <strong>manually</strong>  enters bank details at this page.</p></li><li><p>If successful, GoCardless redirects the user to the <strong>success page URL</strong> sent to it in step 1.</p></li><li><p>The merchant site <strong>completes</strong> the <strong>GoCardless Redirect flow</strong> .</p></li><li><p>GoCardless then actually sets up the mandate with the customer&#8217;s bank.</p></li><li><p>If successful, it returns a <strong>mandate Id</strong> to the merchant site.</p></li><li><p>The merchant site then charges the customer against the <strong>mandate Id</strong> as required.</p></li></ol></div></div>
<div class="sect2"><h3 id="_using_gocardless_from_kill_bill">Using GoCardless from Kill Bill</h3><div class="paragraph"><p>In order to use GoCardless from Kill Bill, we will need to create a payment plugin corresponding to GoCardless. Since we are developing a very basic plugin that can only process payments, we only need to do the following:</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>Set up the mandate. This is a two step process as explained above where:</p><div class="olist loweralpha"><ol class="loweralpha" type="a"><li><p>Step 1 involves redirecting the user to a page to manually confirm setting up the mandate. This can be implemented via the <code>PaymentPluginApi#buildFormDescriptor</code> method</p></li><li><p>Step 2 involves completing the GoCardless flow and retrieving the mandate Id. This can be implemented via the <code>PaymentPluginApi#addPaymentMethod</code> method</p></li></ol></div></li><li><p>Implement the <code>PaymentPluginApi#purchasePayment</code> method to charge the customer</p></li></ol></div>
<div class="paragraph"><p>The diagram below explains the end-to-end flow. We consider the following actors:</p></div>
<div class="paragraph"><p><strong>Browser</strong>: user sitting behind a browser and initiating the payment flow</p></div>
<div class="paragraph"><p><strong>Merchant Site</strong>: customer facing web site which receives the order</p></div>
<div class="paragraph"><p><strong>Kill Bill</strong> - The Kill Bill system</p></div>
<div class="paragraph"><p><strong>Checkout Servlet</strong> - Servlet that initiates setting up the payment method. This is explained <a href="https://docs.killbill.io/latest/payment_plugin.html#_step_9_creating_gocardlesscheckoutservlet">further</a> in detail</p></div>
<div class="paragraph"><p><strong>GoCardless Plugin</strong>:  Payment plugin corresponding to GoCardless that can process payments using the GoCardless system</p></div>
<div class="paragraph"><p><strong>GoCardless</strong>: The GoCardless payment system</p></div>
<div class="paragraph"><p><span class="image"><img src="https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/img/payment-plugin/Using-GoCardless-From-KillBill.png" alt="Using GoCardless From KillBill"></span></p></div>
<div class="olist arabic"><ol class="arabic"><li><p>A user enters his/her payment details on a merchant site.</p></li><li><p>The merchant site invokes the <code>Checkout Servlet</code>.</p></li><li><p>The <code>Checkout Servlet</code> invokes the <code>GoCarldessPlugin#buildFormDescriptor</code>.</p></li><li><p>The <code>GoCarldessPlugin#buildFormDescriptor</code> method invokes the <code>redirectFlows().create()</code>. This <strong>initiates</strong> the <strong>GoCardless redirect flow</strong>  and returns the <strong>redirect URL</strong> .</p></li><li><p>The merchant site redirects the user to this URL.</p></li><li><p>The user manually enters bank details on this page.</p></li><li><p>GoCardless redirects the user to the <strong>success page</strong>.</p></li><li><p>The merchant site invokes the <code>KillBill#addPaymentMethod</code> which in turn invokes <code>GoCardlessPlugin#addPaymentMethod</code>.</p></li><li><p>The <code>GoCarldessPlugin#addPaymentMethod</code> invokes <code>redirectFlows().complete</code>. This <strong>completes</strong> the <strong>redirect flow</strong> and returns the <strong>mandate id</strong> which is saved in the Kill Bill database.</p></li><li><p>The merchant site can then invoke <code>KillBill#purchasePayment</code> as required. This in turn invokes <code>GoCardlessPlugin#purchasePayment</code>.</p></li><li><p>The <code>GoCardlessPlugin#purchasePayment</code> invokes the <code>payments().create()</code> to charge the customer against the saved <strong>mandate id</strong>  as explained <a href="https://developer.gocardless.com/getting-started/api/taking-your-first-payment/">here</a>.</p></li></ol></div></div>
<div class="sect2"><h3 id="_creating_the_gocardless_plugin">Creating the GoCardless Plugin</h3><div class="paragraph"><p>Let us now understand how we can create a payment plugin for GoCardless.</p></div>
<div class="sect3"><h4 id="_step_1_initial_setup">Step 1 - Initial Setup</h4><div class="paragraph"><p>The first step in creating a payment plugin would be to create a new Maven project. For this we need to do the following:</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>Create a new Maven project</p></li><li><p>Copy the <a href="https://github.com/killbill/killbill-hello-world-java-plugin/blob/719779b1ea25c14928e92996b6aa21cc9bf8d4fe/pom.xml">Hello World Plugin pom.xml</a></p></li><li><p>Generate a GoCardless access token (<a class="bare" href="https://manage-sandbox.gocardless.com/developers">https://manage-sandbox.gocardless.com/developers</a>) and create an environment variable <strong>GC_ACCESS_TOKEN</strong> with this token</p></li></ol></div></div>
<div class="sect3"><h4 id="_step_2_creating_gocardlesspluginapi">Step 2 - Creating <a href="https://github.com/killbill/killbill-gocardless-example-plugin/blob/9522498ecde5849c940574c598ceb5ce088d32a7/src/main/java/org/killbill/billing/plugin/gocardless/GoCardlessPaymentPluginApi.java">GoCardlessPluginApi</a></h4><div class="paragraph"><p>We will first need to create a class similar to <code>HelloWorldPaymentPluginApi</code> that implements the <code>PaymentPluginApi</code> interface. We can create this class as follows:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight linenums"><code data-lang="java"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">GoCardlessPaymentPluginApi</span> <span class="tok-kd">implements</span> <span class="tok-n">PaymentPluginApi</span> <span class="tok-p">{</span>
	<span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-kd">final</span> <span class="tok-n">Logger</span> <span class="tok-n">logger</span> <span class="tok-o">=</span> <span class="tok-n">LoggerFactory</span><span class="tok-p">.</span><span class="tok-na">getLogger</span><span class="tok-p">(</span><span class="tok-n">GoCardlessPaymentPluginApi</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">);</span>
	<span class="tok-kd">private</span> <span class="tok-n">OSGIKillbillAPI</span> <span class="tok-n">killbillAPI</span><span class="tok-p">;</span>
	<span class="tok-kd">private</span> <span class="tok-n">Clock</span> <span class="tok-n">clock</span><span class="tok-p">;</span>
	<span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-n">String</span> <span class="tok-n">GC_ACCESS_TOKEN_PROPERTY</span> <span class="tok-o">=</span> <span class="tok-s">&quot;GC_ACCESS_TOKEN&quot;</span><span class="tok-p">;</span>
    <span class="tok-kd">private</span> <span class="tok-n">GoCardlessClient</span> <span class="tok-n">client</span><span class="tok-p">;</span>
    <span class="tok-kd">public</span> <span class="tok-nf">GoCardlessPaymentPluginApi</span><span class="tok-p">(</span><span class="tok-kd">final</span> <span class="tok-n">OSGIKillbillAPI</span> <span class="tok-n">killbillAPI</span><span class="tok-p">,</span><span class="tok-kd">final</span> <span class="tok-n">Clock</span> <span class="tok-n">clock</span><span class="tok-p">)</span> <span class="tok-p">{</span>
		<span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-na">killbillAPI</span> <span class="tok-o">=</span> <span class="tok-n">killbillAPI</span><span class="tok-p">;</span>
		<span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-na">clock</span> <span class="tok-o">=</span> <span class="tok-n">clock</span><span class="tok-p">;</span>
		<span class="tok-n">client</span> <span class="tok-o">=</span> <span class="tok-n">GoCardlessClient</span><span class="tok-p">.</span><span class="tok-na">newBuilder</span><span class="tok-p">(</span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">getenv</span><span class="tok-p">(</span><span class="tok-n">GC_ACCESS_TOKEN_PROPERTY</span><span class="tok-p">)).</span><span class="tok-na">withEnvironment</span><span class="tok-p">(</span><span class="tok-n">GoCardlessClient</span><span class="tok-p">.</span><span class="tok-na">Environment</span><span class="tok-p">.</span><span class="tok-na">SANDBOX</span><span class="tok-p">).</span><span class="tok-na">build</span><span class="tok-p">();</span>
	<span class="tok-p">}</span>
	<span class="tok-c1">//other methods</span>
<span class="tok-p">}</span>
</pre></td></tr></table></code></pre></div></div>
<div class="ulist"><ul><li><p>The <code>GoCardlessPaymentPluginApi</code> implements the <code>PaymentPluginApi</code> interface.</p></li><li><p>It declares the following fields:</p><div class="ulist"><ul><li><p><code>killbillAPI</code> - This is of type <a href="https://github.com/killbill/killbill-platform/blob/617d4b626ddd7c081d2927355c6f8cfe2cbd4bd5/osgi-bundles/libs/killbill/src/main/java/org/killbill/billing/osgi/libs/killbill/OSGIKillbillAPI.java">OSGIKillbillAPI</a>. The <code>OSGIKillBillAPI</code> is a Kill Bill class which exposes all of Kill Bills internal APIs.</p></li><li><p><code>GC_ACCESS_TOKEN_PROPERTY</code> - This is a String field that is required for accessing the GoCardless access token</p></li><li><p><code>clock</code> - This is of type <a href="https://github.com/killbill/killbill-commons/blob/aa83708f56377aabff8391c3ddc197817ad19ec2/clock/src/main/java/org/killbill/clock/Clock.java">Clock</a>. This is part of Kill Bill&#8217;s clock library.</p></li><li><p><code>client</code> This is of type <a href="http://gocardless.github.io/gocardless-pro-java/com/gocardless/GoCardlessClient.html">GoCardlessClient</a>. This is a GoCardless specific class that can be used to access the GoCardless API</p></li></ul></div></li><li><p>The constructor simply initializes the fields with the values passed in. In addition, it also creates a GoCardless client and initializes the <code>client</code> field</p></li></ul></div>
<div class="paragraph"><p>Within this class, we need to implement the <code>buildFormDescriptor</code>, <code>addPaymentMethod</code> and <code>purchasePayment</code> as explained in the <a href="#_using_gocardless_from_kill_bill">[_using_gocardless_from_kill_bill]</a> section above.</p></div></div>
<div class="sect3"><h4 id="_step_3_creating_gocardlesspaymenttransactioninfoplugin">Step 3 - Creating <a href="https://github.com/killbill/killbill-gocardless-example-plugin/blob/9522498ecde5849c940574c598ceb5ce088d32a7/src/main/java/org/killbill/billing/plugin/gocardless/GoCardlessPaymentTransactionInfoPlugin.java">GoCardlessPaymentTransactionInfoPlugin</a></h4><div class="paragraph"><p>As explained earlier, most of the <code>PaymentPluginApi</code> methods return a <a href="#_paymenttransactioninfoplugin">[_paymenttransactioninfoplugin]</a> object. Thus, we need to create a class corresponding to this as follows:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight linenums"><code data-lang="java"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">GoCardlessPaymentTransactionInfoPlugin</span> <span class="tok-kd">extends</span> <span class="tok-n">PluginPaymentTransactionInfoPlugin</span><span class="tok-p">{</span>
	<span class="tok-kd">public</span> <span class="tok-nf">GoCardlessPaymentTransactionInfoPlugin</span><span class="tok-p">(</span><span class="tok-n">UUID</span> <span class="tok-n">kbPaymentId</span><span class="tok-p">,</span> <span class="tok-n">UUID</span> <span class="tok-n">kbTransactionPaymentPaymentId</span><span class="tok-p">,</span>
			<span class="tok-n">TransactionType</span> <span class="tok-n">transactionType</span><span class="tok-p">,</span> <span class="tok-n">BigDecimal</span> <span class="tok-n">amount</span><span class="tok-p">,</span> <span class="tok-n">Currency</span> <span class="tok-n">currency</span><span class="tok-p">,</span> <span class="tok-n">PaymentPluginStatus</span> <span class="tok-n">pluginStatus</span><span class="tok-p">,</span>
			<span class="tok-n">String</span> <span class="tok-n">gatewayError</span><span class="tok-p">,</span> <span class="tok-n">String</span> <span class="tok-n">gatewayErrorCode</span><span class="tok-p">,</span> <span class="tok-n">String</span> <span class="tok-n">firstPaymentReferenceId</span><span class="tok-p">,</span>
			<span class="tok-n">String</span> <span class="tok-n">secondPaymentReferenceId</span><span class="tok-p">,</span> <span class="tok-n">DateTime</span> <span class="tok-n">createdDate</span><span class="tok-p">,</span> <span class="tok-n">DateTime</span> <span class="tok-n">effectiveDate</span><span class="tok-p">,</span>
			<span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">PluginProperty</span><span class="tok-o">&gt;</span> <span class="tok-n">properties</span><span class="tok-p">)</span> <span class="tok-p">{</span>
		<span class="tok-kd">super</span><span class="tok-p">(</span><span class="tok-n">kbPaymentId</span><span class="tok-p">,</span> <span class="tok-n">kbTransactionPaymentPaymentId</span><span class="tok-p">,</span> <span class="tok-n">transactionType</span><span class="tok-p">,</span> <span class="tok-n">amount</span><span class="tok-p">,</span> <span class="tok-n">currency</span><span class="tok-p">,</span> <span class="tok-n">pluginStatus</span><span class="tok-p">,</span> <span class="tok-n">gatewayError</span><span class="tok-p">,</span>
				<span class="tok-n">gatewayErrorCode</span><span class="tok-p">,</span> <span class="tok-n">firstPaymentReferenceId</span><span class="tok-p">,</span> <span class="tok-n">secondPaymentReferenceId</span><span class="tok-p">,</span> <span class="tok-n">createdDate</span><span class="tok-p">,</span> <span class="tok-n">effectiveDate</span><span class="tok-p">,</span> <span class="tok-n">properties</span><span class="tok-p">);</span>
	<span class="tok-p">}</span>
</pre></td></tr></table></code></pre></div></div>
<div class="paragraph"><p>}</p></div>
<div class="ulist"><ul><li><p>The <code>GoCardlessPaymentTransactionInfoPlugin</code> extends the <a href="https://github.com/killbill/killbill-plugin-framework-java/blob/46d94fbeb1cf089aa04e62cfecf751ca47032023/src/main/java/org/killbill/billing/plugin/api/payment/PluginPaymentTransactionInfoPlugin.java">PluginPaymentTransactionInfoPlugin</a> from the <a href="https://github.com/killbill/killbill-plugin-framework-java">Kill Bill plugin framework</a>. This class in turn implements the <a href="#_paymenttransactioninfoplugin">[_paymenttransactioninfoplugin]</a> interface</p></li><li><p>The <code>GoCardlessPaymentTransactionInfoPlugin</code> constructor accepts parameters corresponding to the data to be returned by <a href="#_paymenttransactioninfoplugin">[_paymenttransactioninfoplugin]</a>. It simply invokes the superclass constructor with these parameters</p></li></ul></div></div>
<div class="sect3"><h4 id="_step_4_implementing_gocardlesspaymentpluginapibuildformdescriptor">Step 4 - Implementing <a href="https://github.com/killbill/killbill-gocardless-example-plugin/blob/9522498ecde5849c940574c598ceb5ce088d32a7/src/main/java/org/killbill/billing/plugin/gocardless/GoCardlessPaymentPluginApi.java#L293">GoCardlessPaymentPluginApi#buildFormDescriptor</a></h4><div class="paragraph"><p>The <code>buildFormDesciptor</code> is typically used for <a href="https://docs.killbill.io/latest/userguide_payment.html#_hosted_payment_page_flow">hosted payment flows</a> to display a form where a user can enter his/her payment details. In the case of GoCardless, we will be using it to <strong>initiate</strong> the <strong>Gocardless redirect flow</strong> in GoCardless and obtain the <strong>redirect URL</strong>. This method can be implemented as follows:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight linenums"><code data-lang="java"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">public</span> <span class="tok-n">HostedPaymentPageFormDescriptor</span> <span class="tok-nf">buildFormDescriptor</span><span class="tok-p">(</span><span class="tok-n">UUID</span> <span class="tok-n">kbAccountId</span><span class="tok-p">,</span> <span class="tok-n">Iterable</span><span class="tok-o">&lt;</span><span class="tok-n">PluginProperty</span><span class="tok-o">&gt;</span> <span class="tok-n">customFields</span><span class="tok-p">,</span>
	<span class="tok-n">Iterable</span><span class="tok-o">&lt;</span><span class="tok-n">PluginProperty</span><span class="tok-o">&gt;</span> <span class="tok-n">properties</span><span class="tok-p">,</span> <span class="tok-n">CallContext</span> <span class="tok-n">context</span><span class="tok-p">)</span> <span class="tok-kd">throws</span> <span class="tok-n">PaymentPluginApiException</span> <span class="tok-p">{</span>
	<span class="tok-n">logger</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;buildFormDescriptor, kbAccountId=&quot;</span> <span class="tok-o">+</span> <span class="tok-n">kbAccountId</span><span class="tok-p">);</span>
	<span class="tok-c1">// retrieve properties</span>
	<span class="tok-n">String</span> <span class="tok-n">successRedirectUrl</span> <span class="tok-o">=</span> <span class="tok-n">PluginProperties</span><span class="tok-p">.</span><span class="tok-na">findPluginPropertyValue</span><span class="tok-p">(</span><span class="tok-s">&quot;success_redirect_url&quot;</span><span class="tok-p">,</span> <span class="tok-n">properties</span><span class="tok-p">);</span> <span class="tok-c1">// &quot;https://developer.gocardless.com/example-redirect-uri/&quot;; - this is the URL to which GoCardless will redirect after users set up the  mandate</span>
	<span class="tok-n">String</span> <span class="tok-n">redirectFlowDescription</span> <span class="tok-o">=</span> <span class="tok-n">PluginProperties</span><span class="tok-p">.</span><span class="tok-na">findPluginPropertyValue</span><span class="tok-p">(</span><span class="tok-s">&quot;redirect_flow_description&quot;</span><span class="tok-p">,</span><span class="tok-n">properties</span><span class="tok-p">);</span>
	<span class="tok-n">String</span> <span class="tok-n">sessionToken</span> <span class="tok-o">=</span> <span class="tok-n">PluginProperties</span><span class="tok-p">.</span><span class="tok-na">findPluginPropertyValue</span><span class="tok-p">(</span><span class="tok-s">&quot;session_token&quot;</span><span class="tok-p">,</span> <span class="tok-n">properties</span><span class="tok-p">);</span> <span class="tok-n">PrefilledCustomer</span> <span class="tok-n">customer</span> <span class="tok-o">=</span> <span class="tok-n">buildCustomer</span><span class="tok-p">(</span><span class="tok-n">customFields</span><span class="tok-p">);</span><span class="tok-c1">// build a PrefilledCuctomer object from custom fields if present</span>
	<span class="tok-n">RedirectFlow</span> <span class="tok-n">redirectFlow</span> <span class="tok-o">=</span> <span class="tok-n">client</span><span class="tok-p">.</span><span class="tok-na">redirectFlows</span><span class="tok-p">().</span><span class="tok-na">create</span><span class="tok-p">().</span><span class="tok-na">withDescription</span><span class="tok-p">(</span><span class="tok-n">redirectFlowDescription</span><span class="tok-p">)</span>
			<span class="tok-p">.</span><span class="tok-na">withSessionToken</span><span class="tok-p">(</span><span class="tok-n">sessionToken</span><span class="tok-p">)</span>
			<span class="tok-p">.</span><span class="tok-na">withSuccessRedirectUrl</span><span class="tok-p">(</span><span class="tok-n">successRedirectUrl</span><span class="tok-p">).</span><span class="tok-na">withPrefilledCustomer</span><span class="tok-p">(</span><span class="tok-n">customer</span><span class="tok-p">).</span><span class="tok-na">execute</span><span class="tok-p">();</span>
	<span class="tok-n">logger</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;RedirectFlow Id&quot;</span><span class="tok-p">,</span> <span class="tok-n">redirectFlow</span><span class="tok-p">.</span><span class="tok-na">getId</span><span class="tok-p">());</span>
	<span class="tok-n">logger</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;RedirectFlow URL&quot;</span><span class="tok-p">,</span> <span class="tok-n">redirectFlow</span><span class="tok-p">.</span><span class="tok-na">getRedirectUrl</span><span class="tok-p">());</span>
	<span class="tok-n">PluginHostedPaymentPageFormDescriptor</span> <span class="tok-n">pluginHostedPaymentPageFormDescriptor</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">PluginHostedPaymentPageFormDescriptor</span><span class="tok-p">(</span>
			<span class="tok-n">kbAccountId</span><span class="tok-p">,</span> <span class="tok-n">redirectFlow</span><span class="tok-p">.</span><span class="tok-na">getRedirectUrl</span><span class="tok-p">());</span>
	<span class="tok-k">return</span> <span class="tok-n">pluginHostedPaymentPageFormDescriptor</span><span class="tok-p">;</span>
<span class="tok-p">}</span>
</pre></td></tr></table></code></pre></div></div>
<div class="ulist"><ul><li><p>The <code>buildFormDescriptor</code> method accepts  <code>Iterable&lt;PluginProperty&gt; properties</code> as a parameter. As explained above, a <code>PluginProperty</code> can be used to pass a plugin specific key-value pair to a plugin.</p></li><li><p>The code first retrieves the <code>successRedirectUrl</code>, <code>redirectFlowDescription</code> and <code>sessionToken</code> sent by the client application from the <code>properties</code> passed in. These are required by GoCardless and are as explained below:</p><div class="ulist"><ul><li><p><code>successRedirectUrl</code> - Indicates the page to which the user should be redirected after setting up the mandate successfully.</p></li><li><p><code>redirectFlowDescription</code> -  is a description that is displayed on the payment page (page where the user is redirected to set up the mandate)</p></li><li><p><code>sessionToken</code> - is something that identifies the users session on the client application. GoCardless requires this to be supplied while <strong>creating the redirect flow</strong> (now, while invoking the <code>buildFormDescriptor</code> method), and while <strong>completing the redirect flow</strong> (when the <code>addPaymentMethod</code> is invoked) it at the end. Supplying this token twice makes sure that the person who completed the redirect flow is the person who initiated it.</p></li></ul></div></li><li><p>Next, the <code>client.redirectFlows().create()</code> is invoked with the <code>successRedirectUrl</code>, <code>redirectFlowDescription</code> and <code>sessionToken</code>. This returns  a <code>RedirectFlow</code> object. The <code>RedirectFlow</code> object contains the <strong>redirect URL</strong>.</p></li><li><p>Finally, a <code>HostedPaymentPageFormDescriptor</code> object is created using the <strong>redirect URL</strong> and the <strong>Kill Bill Account Id</strong>. This is then returned to the client application.</p></li></ul></div></div>
<div class="sect3"><h4 id="_step_5_implementing_gocardlesspaymentpluginapiaddpaymentmethod">Step 5 - Implementing <a href="https://github.com/killbill/killbill-gocardless-example-plugin/blob/9522498ecde5849c940574c598ceb5ce088d32a7/src/main/java/org/killbill/billing/plugin/gocardless/GoCardlessPaymentPluginApi.java#L223">GoCardlessPaymentPluginApi#addPaymentMethod</a></h4><div class="paragraph"><p>The <code>addPaymentMethod</code> is typically used to add a payment method in Kill Bill corresponding to a customer/account. In the case of GoCardless, we will be using it to <strong>complete</strong> the <strong>redirect flow</strong>. So, this method can be implemented as follows:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight linenums"><code data-lang="java"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">addPaymentMethod</span><span class="tok-p">(</span><span class="tok-n">UUID</span> <span class="tok-n">kbAccountId</span><span class="tok-p">,</span> <span class="tok-n">UUID</span> <span class="tok-n">kbPaymentMethodId</span><span class="tok-p">,</span> <span class="tok-n">PaymentMethodPlugin</span> <span class="tok-n">paymentMethodProps</span><span class="tok-p">,</span>
		<span class="tok-kt">boolean</span> <span class="tok-n">setDefault</span><span class="tok-p">,</span> <span class="tok-n">Iterable</span><span class="tok-o">&lt;</span><span class="tok-n">PluginProperty</span><span class="tok-o">&gt;</span> <span class="tok-n">properties</span><span class="tok-p">,</span> <span class="tok-n">CallContext</span> <span class="tok-n">context</span><span class="tok-p">)</span>
		<span class="tok-kd">throws</span> <span class="tok-n">PaymentPluginApiException</span> <span class="tok-p">{</span>
	<span class="tok-n">logger</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;addPaymentMethod, kbAccountId=&quot;</span> <span class="tok-o">+</span> <span class="tok-n">kbAccountId</span><span class="tok-p">);</span>
	<span class="tok-kd">final</span> <span class="tok-n">Iterable</span><span class="tok-o">&lt;</span><span class="tok-n">PluginProperty</span><span class="tok-o">&gt;</span> <span class="tok-n">allProperties</span> <span class="tok-o">=</span> <span class="tok-n">PluginProperties</span><span class="tok-p">.</span><span class="tok-na">merge</span><span class="tok-p">(</span><span class="tok-n">paymentMethodProps</span><span class="tok-p">.</span><span class="tok-na">getProperties</span><span class="tok-p">(),</span>
			<span class="tok-n">properties</span><span class="tok-p">);</span>
	<span class="tok-n">String</span> <span class="tok-n">redirectFlowId</span> <span class="tok-o">=</span> <span class="tok-n">PluginProperties</span><span class="tok-p">.</span><span class="tok-na">findPluginPropertyValue</span><span class="tok-p">(</span><span class="tok-s">&quot;redirect_flow_id&quot;</span><span class="tok-p">,</span> <span class="tok-n">allProperties</span><span class="tok-p">);</span>  <span class="tok-c1">//retrieve the redirect flow id</span>
	<span class="tok-n">String</span> <span class="tok-n">sessionToken</span> <span class="tok-o">=</span> <span class="tok-n">PluginProperties</span><span class="tok-p">.</span><span class="tok-na">findPluginPropertyValue</span><span class="tok-p">(</span><span class="tok-s">&quot;session_token&quot;</span><span class="tok-p">,</span> <span class="tok-n">allProperties</span><span class="tok-p">);</span>
	<span class="tok-k">try</span> <span class="tok-p">{</span>
		<span class="tok-c1">//Use the redirect flow id to &quot;complete&quot; the GoCardless flow</span>
		<span class="tok-n">RedirectFlow</span> <span class="tok-n">redirectFlow</span> <span class="tok-o">=</span> <span class="tok-n">client</span><span class="tok-p">.</span><span class="tok-na">redirectFlows</span><span class="tok-p">().</span><span class="tok-na">complete</span><span class="tok-p">(</span><span class="tok-n">redirectFlowId</span><span class="tok-p">).</span><span class="tok-na">withSessionToken</span><span class="tok-p">(</span><span class="tok-n">sessionToken</span><span class="tok-p">).</span><span class="tok-na">execute</span><span class="tok-p">();</span>
		<span class="tok-n">String</span> <span class="tok-n">mandateId</span> <span class="tok-o">=</span> <span class="tok-n">redirectFlow</span><span class="tok-p">.</span><span class="tok-na">getLinks</span><span class="tok-p">().</span><span class="tok-na">getMandate</span><span class="tok-p">();</span> <span class="tok-c1">//obtain mandate id from the redirect flow</span>
		<span class="tok-n">logger</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;MandateId:&quot;</span><span class="tok-p">,</span> <span class="tok-n">mandateId</span><span class="tok-p">);</span>
		<span class="tok-k">try</span> <span class="tok-p">{</span>
			<span class="tok-c1">//save Mandate id in the Kill Bill database</span>
			<span class="tok-n">killbillAPI</span><span class="tok-p">.</span><span class="tok-na">getCustomFieldUserApi</span><span class="tok-p">().</span><span class="tok-na">addCustomFields</span><span class="tok-p">(</span><span class="tok-n">ImmutableList</span><span class="tok-p">.</span><span class="tok-na">of</span><span class="tok-p">(</span><span class="tok-k">new</span> <span class="tok-n">PluginCustomField</span><span class="tok-p">(</span><span class="tok-n">kbAccountId</span><span class="tok-p">,</span>
					<span class="tok-n">ObjectType</span><span class="tok-p">.</span><span class="tok-na">ACCOUNT</span><span class="tok-p">,</span> <span class="tok-s">&quot;GOCARDLESS_MANDATE_ID&quot;</span><span class="tok-p">,</span> <span class="tok-n">mandateId</span><span class="tok-p">,</span> <span class="tok-n">clock</span><span class="tok-p">.</span><span class="tok-na">getUTCNow</span><span class="tok-p">())),</span> <span class="tok-n">context</span><span class="tok-p">);</span>
		<span class="tok-p">}</span> <span class="tok-k">catch</span> <span class="tok-p">(</span><span class="tok-n">CustomFieldApiException</span> <span class="tok-n">e</span><span class="tok-p">)</span> <span class="tok-p">{</span>
			<span class="tok-n">logger</span><span class="tok-p">.</span><span class="tok-na">warn</span><span class="tok-p">(</span><span class="tok-s">&quot;Error occured while saving mandate id&quot;</span><span class="tok-p">,</span> <span class="tok-n">e</span><span class="tok-p">);</span>
			<span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-n">PaymentPluginApiException</span><span class="tok-p">(</span><span class="tok-s">&quot;Error occured while saving mandate id&quot;</span><span class="tok-p">,</span> <span class="tok-n">e</span><span class="tok-p">);</span>
		<span class="tok-p">}</span>
	<span class="tok-p">}</span> <span class="tok-k">catch</span> <span class="tok-p">(</span><span class="tok-n">GoCardlessApiException</span> <span class="tok-n">e</span><span class="tok-p">)</span> <span class="tok-p">{</span>
		<span class="tok-n">logger</span><span class="tok-p">.</span><span class="tok-na">warn</span><span class="tok-p">(</span><span class="tok-s">&quot;Error occured while completing the GoCardless flow&quot;</span><span class="tok-p">,</span> <span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-na">getType</span><span class="tok-p">(),</span> <span class="tok-n">e</span><span class="tok-p">);</span>
		<span class="tok-k">throw</span> <span class="tok-k">new</span> <span class="tok-n">PaymentPluginApiException</span><span class="tok-p">(</span><span class="tok-s">&quot;Error occured while completing the GoCardless flow&quot;</span><span class="tok-p">,</span> <span class="tok-n">e</span><span class="tok-p">);</span>
	<span class="tok-p">}</span>
<span class="tok-p">}</span>
</pre></td></tr></table></code></pre></div></div>
<div class="ulist"><ul><li><p>Like other methods, the <code>addPaymentMethod</code> method also accepts  <code>Iterable&lt;PluginProperty&gt; properties</code> as a parameter.</p></li><li><p>In addition, it also accepts <code>PaymentMethodPlugin paymentMethodProps</code> as a parameter.</p></li><li><p><code>PaymentMethodPlugin</code> is a generic object that represents a payment method (creditcard, bank account, etc.). It has a <code>getProperties</code> method that returns a <code>List&lt;PluginProperty&gt;</code>.</p></li><li><p>The <code>properties</code> parameter is typically used to pass properties which are related to the specific method call (<code>addPaymentMethod</code> in this case) while the <code>PaymentMethodPlugin#getProperties</code>  typically refers to non-standard generic information about the payment method itself.</p></li><li><p>A client application can use either of these to pass in the GoCardless properties. The code above (like other plugins) is lenient and accepts both ways. So, it first invokes <code>PluginProperties.merge</code> to merge both properties and stores them into a merged <code>allProperties</code> list</p></li><li><p>It then retrieves the <code>redirectFlowId</code> and <code>sessionToken</code> from <code>allProperties</code>. These are required by GoCardless and are as explained below:</p><div class="ulist"><ul><li><p><code>redirectFlowId</code> - If you recall, the <code>redirectFlowId</code> is sent to a client application after the <code>buildFormDescriptor</code> method call. A client application needs to send this back.</p></li><li><p><code>sessionToken</code> - As explained earlier, a client application needs to send the same <code>sessionToken</code> that was sent at the time of  <strong>creating the redirect flow</strong> (when the <code>buildFormDescriptor</code> method was invoked) to ensure that the person who <strong>completes the redirect flow</strong> is the person who initiated it.</p></li></ul></div></li><li><p>Next, the <code>client.redirectFlows().complete</code> is invoked with the <code>redirectFlowId</code> and the <code>sessionToken</code>. This returns a <code>RedirectFlow</code> object which contains the <strong>mandate Id</strong>.</p></li><li><p>Finally, the <strong>mandateId</strong> is stored in the Kill Bill database. Normally, each plugin has its own plugin specific tables. However, since we are not creating a full-fledged GoCardless plugin, we are storing the <strong>mandateId</strong> in the <strong>custom_fields</strong> table.  The  <strong>custom_fields</strong> table can be used to store arbitrary key/value pairs in the Kill Bill database.</p></li><li><p>In case an error occurs in any of the steps, the code throws a <a href="https://github.com/killbill/killbill-plugin-api/blob/d9eca5af0e37541069b1c608f95e100dbe13b301/payment/src/main/java/org/killbill/billing/payment/plugin/api/PaymentPluginApiException.java">PaymentPluginApiException</a></p></li></ul></div></div>
<div class="sect3"><h4 id="_step_6_implementing_gocardlesspaymentpluginapipurchasepayment">Step 6 - Implementing <a href="https://github.com/killbill/killbill-gocardless-example-plugin/blob/9522498ecde5849c940574c598ceb5ce088d32a7/src/main/java/org/killbill/billing/plugin/gocardless/GoCardlessPaymentPluginApi.java#L94">GoCardlessPaymentPluginApi#purchasePayment</a></h4><div class="paragraph"><p>The <code>purchasePayment</code> is used to charge a customer against a payment method. So, once a user sets up a payment method as done above, the <code>purchasePayment</code> method can be used by a client application to trigger payments against a <strong>mandateId</strong>. So, this method can be implemented as follows:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight linenums"><code data-lang="java"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">public</span> <span class="tok-n">PaymentTransactionInfoPlugin</span> <span class="tok-nf">purchasePayment</span><span class="tok-p">(</span><span class="tok-n">UUID</span> <span class="tok-n">kbAccountId</span><span class="tok-p">,</span> <span class="tok-n">UUID</span> <span class="tok-n">kbPaymentId</span><span class="tok-p">,</span> <span class="tok-n">UUID</span> <span class="tok-n">kbTransactionId</span><span class="tok-p">,</span>
		<span class="tok-n">UUID</span> <span class="tok-n">kbPaymentMethodId</span><span class="tok-p">,</span> <span class="tok-n">BigDecimal</span> <span class="tok-n">amount</span><span class="tok-p">,</span> <span class="tok-n">Currency</span> <span class="tok-n">currency</span><span class="tok-p">,</span> <span class="tok-n">Iterable</span><span class="tok-o">&lt;</span><span class="tok-n">PluginProperty</span><span class="tok-o">&gt;</span> <span class="tok-n">properties</span><span class="tok-p">,</span>
		<span class="tok-n">CallContext</span> <span class="tok-n">context</span><span class="tok-p">)</span> <span class="tok-kd">throws</span> <span class="tok-n">PaymentPluginApiException</span> <span class="tok-p">{</span>
	<span class="tok-n">logger</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;purchasePayment, kbAccountId=&quot;</span> <span class="tok-o">+</span> <span class="tok-n">kbAccountId</span><span class="tok-p">);</span>
	<span class="tok-n">PaymentTransactionInfoPlugin</span> <span class="tok-n">paymentTransactionInfoPlugin</span><span class="tok-p">;</span>
	<span class="tok-n">String</span> <span class="tok-n">mandate</span> <span class="tok-o">=</span> <span class="tok-n">getMandateId</span><span class="tok-p">(</span><span class="tok-n">kbAccountId</span><span class="tok-p">,</span> <span class="tok-n">context</span><span class="tok-p">);</span> <span class="tok-c1">// retrieve mandateId from Kill Bill tables</span>
	<span class="tok-n">logger</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;MandateId=&quot;</span><span class="tok-o">+</span><span class="tok-n">mandate</span><span class="tok-p">);</span>
	<span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">mandate</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span><span class="tok-p">)</span> <span class="tok-p">{</span>
		<span class="tok-n">logger</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;Processing payment&quot;</span><span class="tok-p">);</span>
		<span class="tok-k">try</span> <span class="tok-p">{</span>
			<span class="tok-n">String</span> <span class="tok-n">idempotencyKey</span> <span class="tok-o">=</span> <span class="tok-n">PluginProperties</span><span class="tok-p">.</span><span class="tok-na">findPluginPropertyValue</span><span class="tok-p">(</span><span class="tok-s">&quot;idempotencykey&quot;</span><span class="tok-p">,</span> <span class="tok-n">properties</span><span class="tok-p">);</span>
			<span class="tok-n">com</span><span class="tok-p">.</span><span class="tok-na">gocardless</span><span class="tok-p">.</span><span class="tok-na">services</span><span class="tok-p">.</span><span class="tok-na">PaymentService</span><span class="tok-p">.</span><span class="tok-na">PaymentCreateRequest</span><span class="tok-p">.</span><span class="tok-na">Currency</span> <span class="tok-n">goCardlessCurrency</span> <span class="tok-o">=</span> <span class="tok-n">convertKillBillCurrencyToGoCardlessCurrency</span><span class="tok-p">(</span>
					<span class="tok-n">currency</span><span class="tok-p">);</span>
			<span class="tok-n">Payment</span> <span class="tok-n">payment</span> <span class="tok-o">=</span> <span class="tok-n">client</span><span class="tok-p">.</span><span class="tok-na">payments</span><span class="tok-p">().</span><span class="tok-na">create</span><span class="tok-p">()</span>
					<span class="tok-p">.</span><span class="tok-na">withAmount</span><span class="tok-p">(</span><span class="tok-n">Math</span><span class="tok-p">.</span><span class="tok-na">toIntExact</span><span class="tok-p">(</span><span class="tok-n">KillBillMoney</span><span class="tok-p">.</span><span class="tok-na">toMinorUnits</span><span class="tok-p">(</span><span class="tok-n">currency</span><span class="tok-p">.</span><span class="tok-na">toString</span><span class="tok-p">(),</span> <span class="tok-n">amount</span><span class="tok-p">)))</span>
					<span class="tok-p">.</span><span class="tok-na">withCurrency</span><span class="tok-p">(</span><span class="tok-n">goCardlessCurrency</span><span class="tok-p">).</span><span class="tok-na">withLinksMandate</span><span class="tok-p">(</span><span class="tok-n">mandate</span><span class="tok-p">).</span><span class="tok-na">withIdempotencyKey</span><span class="tok-p">(</span><span class="tok-n">idempotencyKey</span><span class="tok-p">)</span>
					<span class="tok-p">.</span><span class="tok-na">withMetadata</span><span class="tok-p">(</span><span class="tok-s">&quot;kbPaymentId&quot;</span><span class="tok-p">,</span> <span class="tok-n">kbPaymentId</span><span class="tok-p">.</span><span class="tok-na">toString</span><span class="tok-p">()).</span><span class="tok-na">withMetadata</span><span class="tok-p">(</span><span class="tok-s">&quot;kbTransactionId&quot;</span><span class="tok-p">,</span> <span class="tok-n">kbTransactionId</span><span class="tok-p">.</span><span class="tok-na">toString</span><span class="tok-p">())</span> <span class="tok-c1">//added for getPaymentInfo</span>
					<span class="tok-p">.</span><span class="tok-na">execute</span><span class="tok-p">();</span>
			<span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">PluginProperty</span><span class="tok-o">&gt;</span> <span class="tok-n">outputProperties</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">ArrayList</span><span class="tok-o">&lt;</span><span class="tok-n">PluginProperty</span><span class="tok-o">&gt;</span><span class="tok-p">();</span>
			<span class="tok-n">outputProperties</span><span class="tok-p">.</span><span class="tok-na">add</span><span class="tok-p">(</span><span class="tok-k">new</span> <span class="tok-n">PluginProperty</span><span class="tok-p">(</span><span class="tok-s">&quot;paymentId&quot;</span><span class="tok-p">,</span> <span class="tok-n">payment</span><span class="tok-p">.</span><span class="tok-na">getId</span><span class="tok-p">(),</span> <span class="tok-kc">false</span><span class="tok-p">));</span>
			<span class="tok-n">paymentTransactionInfoPlugin</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">GoCardlessPaymentTransactionInfoPlugin</span><span class="tok-p">(</span><span class="tok-n">kbPaymentId</span><span class="tok-p">,</span> <span class="tok-n">kbTransactionId</span><span class="tok-p">,</span>
					<span class="tok-n">TransactionType</span><span class="tok-p">.</span><span class="tok-na">PURCHASE</span><span class="tok-p">,</span> <span class="tok-n">amount</span><span class="tok-p">,</span> <span class="tok-n">currency</span><span class="tok-p">,</span> <span class="tok-n">PaymentPluginStatus</span><span class="tok-p">.</span><span class="tok-na">PROCESSED</span><span class="tok-p">,</span> <span class="tok-kc">null</span><span class="tok-p">,</span> <span class="tok-kc">null</span><span class="tok-p">,</span>
					<span class="tok-n">String</span><span class="tok-p">.</span><span class="tok-na">valueOf</span><span class="tok-p">(</span><span class="tok-n">payment</span><span class="tok-p">.</span><span class="tok-na">getId</span><span class="tok-p">()),</span> <span class="tok-kc">null</span><span class="tok-p">,</span> <span class="tok-k">new</span> <span class="tok-n">DateTime</span><span class="tok-p">(),</span> <span class="tok-k">new</span> <span class="tok-n">DateTime</span><span class="tok-p">(</span><span class="tok-n">payment</span><span class="tok-p">.</span><span class="tok-na">getCreatedAt</span><span class="tok-p">()),</span>
					<span class="tok-n">outputProperties</span><span class="tok-p">);</span>
			<span class="tok-n">logger</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;Payment processed, PaymentId=&quot;</span><span class="tok-o">+</span><span class="tok-n">payment</span><span class="tok-p">.</span><span class="tok-na">getId</span><span class="tok-p">());</span>
		<span class="tok-p">}</span> <span class="tok-k">catch</span> <span class="tok-p">(</span><span class="tok-n">GoCardlessApiException</span> <span class="tok-n">e</span><span class="tok-p">)</span> <span class="tok-p">{</span>
			<span class="tok-n">paymentTransactionInfoPlugin</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">GoCardlessPaymentTransactionInfoPlugin</span><span class="tok-p">(</span><span class="tok-n">kbPaymentId</span><span class="tok-p">,</span> <span class="tok-n">kbTransactionId</span><span class="tok-p">,</span>
					<span class="tok-n">TransactionType</span><span class="tok-p">.</span><span class="tok-na">PURCHASE</span><span class="tok-p">,</span> <span class="tok-n">amount</span><span class="tok-p">,</span> <span class="tok-n">currency</span><span class="tok-p">,</span> <span class="tok-n">PaymentPluginStatus</span><span class="tok-p">.</span><span class="tok-na">ERROR</span><span class="tok-p">,</span> <span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-na">getErrorMessage</span><span class="tok-p">(),</span>
					<span class="tok-n">String</span><span class="tok-p">.</span><span class="tok-na">valueOf</span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-na">getCode</span><span class="tok-p">()),</span> <span class="tok-kc">null</span><span class="tok-p">,</span> <span class="tok-kc">null</span><span class="tok-p">,</span> <span class="tok-k">new</span> <span class="tok-n">DateTime</span><span class="tok-p">(),</span> <span class="tok-kc">null</span><span class="tok-p">,</span> <span class="tok-kc">null</span><span class="tok-p">);</span>
			<span class="tok-n">logger</span><span class="tok-p">.</span><span class="tok-na">warn</span><span class="tok-p">(</span><span class="tok-s">&quot;Error occured in purchasePayment&quot;</span><span class="tok-p">,</span> <span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-na">getType</span><span class="tok-p">(),</span> <span class="tok-n">e</span><span class="tok-p">);</span>
		<span class="tok-p">}</span>
	<span class="tok-p">}</span> <span class="tok-k">else</span> <span class="tok-p">{</span>
		<span class="tok-n">logger</span><span class="tok-p">.</span><span class="tok-na">warn</span><span class="tok-p">(</span><span class="tok-s">&quot;Unable to fetch mandate, so cannot process payment&quot;</span><span class="tok-p">);</span>
		<span class="tok-n">paymentTransactionInfoPlugin</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">GoCardlessPaymentTransactionInfoPlugin</span><span class="tok-p">(</span><span class="tok-n">kbPaymentId</span><span class="tok-p">,</span> <span class="tok-n">kbTransactionId</span><span class="tok-p">,</span>
				<span class="tok-n">TransactionType</span><span class="tok-p">.</span><span class="tok-na">PURCHASE</span><span class="tok-p">,</span> <span class="tok-n">amount</span><span class="tok-p">,</span> <span class="tok-n">currency</span><span class="tok-p">,</span> <span class="tok-n">PaymentPluginStatus</span><span class="tok-p">.</span><span class="tok-na">CANCELED</span><span class="tok-p">,</span> <span class="tok-kc">null</span><span class="tok-p">,</span>
				<span class="tok-kc">null</span><span class="tok-p">,</span> <span class="tok-kc">null</span><span class="tok-p">,</span> <span class="tok-kc">null</span><span class="tok-p">,</span> <span class="tok-k">new</span> <span class="tok-n">DateTime</span><span class="tok-p">(),</span> <span class="tok-kc">null</span><span class="tok-p">,</span> <span class="tok-kc">null</span><span class="tok-p">);</span>
	<span class="tok-p">}</span>
	<span class="tok-k">return</span> <span class="tok-n">paymentTransactionInfoPlugin</span><span class="tok-p">;</span>
<span class="tok-p">}</span>
</pre></td></tr></table></code></pre></div></div>
<div class="ulist"><ul><li><p>Like the other methods, the <code>purchasePayment</code> method accepts  <code>Iterable&lt;PluginProperty&gt; properties</code> as a parameter.</p></li><li><p>In addition, it also accepts parameters corresponding to <code>amount</code> (specifies the amount to charge the customer) and <code>currency</code> (specifies the currency to be used)</p></li><li><p>If you recall, the <code>addPaymentMethod</code> stores the <strong>mandate id</strong> in the Kill Bill database. This is first retrieved and assigned to <code>mandate</code></p></li><li><p>Next, the <code>idempotencyKey</code> is retrieved from the <code>properties</code> passed in. The  <code>idempotencyKey</code> is a GoCardless specific value. As per the GoCardless documentation, their API will ensure this payment is only ever created once per <code>idempotencyKey</code>. So a client application could specify <code>kbPaymentId</code> as the <code>idempotencyKey</code> to ensure at most a single payment is created per <code>kbPaymentId</code>.</p></li><li><p>The <code>currency</code> object passed in is of type <code>org.killbill.billing.catalog.api.Currency</code>. This is then converted to a <strong>GoCardless Currency object</strong> (of type <code>com.gocardless.services.PaymentService.PaymentCreateRequest.Currency</code>). Most payment plugins have code similar to this to convert Kill Bill objects to compatible objects in the plugin&#8217;s client library.</p></li><li><p>Finally, the <code>client.payments().create()</code> is invoked with the <code>idempotencyKey</code>,<code>amount</code> and <code>currency</code> values. This returns a <code>Payment</code> object which contains a <code>paymentId</code>. Additionally, the <code>kbPaymentId</code> and <code>kbTransactionId</code> are sent as <strong>metadata</strong> to GoCardless in this call. GoCardless <strong>metadata</strong> allows an application to send custom key value pairs to GoCardless. These can then be retrieved later on as required.  In our case, the <code>kbPaymentId</code> and <code>kbTransactionId</code> are required for the <code>getPaymentInfo</code> call which will be explained further.</p></li><li><p>The <code>purchasePayment</code> method returns a <code>PaymentTransactionInfoPlugin</code> object.  The <a href="#_paymenttransactioninfoplugin">[_paymenttransactioninfoplugin]</a> section above explaind this interface in detail. We have already created a <a href="https://github.com/killbill/killbill-gocardless-example-plugin/blob/9522498ecde5849c940574c598ceb5ce088d32a7/src/main/java/org/killbill/billing/plugin/gocardless/GoCardlessPaymentTransactionInfoPlugin.java">GoCardlessPaymentTransactionInfoPlugin</a> class above.</p></li><li><p>If the payment is successful, the <code>GoCardlessPaymentTransactionInfoPlugin</code> object is created with the following values:</p><div class="ulist"><ul><li><p><strong>kbPaymentId</strong> - Set to <code>kbPaymentId</code>. It corresponds to the Kill Bill payment id.</p></li><li><p><strong>kbTransactionId</strong> - Set to <code>kbTransactionId</code>. It corresponds to the Kill Bill transaction id.</p></li><li><p><strong>TransactionType</strong> - Set to <code>TransactionType.PURCHASE</code> since this is a purchase transaction</p></li><li><p><strong>amount</strong> - Set to <code>amount</code>. It corresponds to the amount with which the customer is charged</p></li><li><p><strong>currency</strong> - Set to <code>currency</code>. It corresponds to the currency in which the customer is charged</p></li><li><p><strong>PaymentPluginStatus</strong> - Set to <code>PaymentPluginStatus.PROCESSED</code> since the payment is processed successfully</p></li><li><p><strong>gatewayError</strong> - Set to <code>null</code> since there is no error</p></li><li><p><strong>gatewayErrorCode</strong> - set to <code>null</code> since there is no error</p></li><li><p><strong>firstPaymentReferenceId</strong> - Set to the <strong>payment Id</strong> returned by GoCardless</p></li><li><p><strong>secondPaymentReferenceId</strong> - set to <code>null</code> since GoCardless does not have a secondPaymentReferenceId. Other payment plugins might use this parameter if required.</p></li><li><p><strong>createdDate</strong> - Set to the current date</p></li><li><p><strong>effectiveDate</strong> - Set to the date when the payment was created. This is retrieved from the <code>payment</code> object returned by GoCardless</p></li><li><p><strong>properties</strong> - Set to a <code>List&lt;PluginProperty&gt;</code> called <code>outputProperties</code> which contains the GoCardless <strong>payment Id</strong>. The client API can use the <code>properties</code> as desired.</p></li></ul></div></li><li><p>If there is an exception while processing the payment,  the <code>GoCardlessPaymentTransactionInfoPlugin</code> object is created with the following values :</p><div class="ulist"><ul><li><p><strong>PaymentPluginStatus</strong> - Set to <code>PaymentPluginStatus.ERROR</code> since there is an error in the payment</p></li><li><p><strong>gatewayError</strong> - Set to the <strong>error message</strong> from the exception</p></li><li><p><strong>gatewayErrorCode</strong> - Set to the <strong>error code</strong> from the exception</p></li><li><p><strong>firstPaymentReferenceId</strong> - Set to <code>null</code> since the payment failed</p></li><li><p><strong>effectiveDate</strong> - Set to <code>null</code> since the payment failed</p></li><li><p><strong>properties</strong> - Set to <code>null</code> since the payment failed</p></li></ul></div></li><li><p>If the code is unable to retrieve the <code>mandateId</code> from the Kill Bill database, the <code>GoCardlessPaymentTransactionInfoPlugin</code> object is created with the following values:</p><div class="ulist"><ul><li><p><strong>PaymentPluginStatus</strong> - Set to <code>PaymentPluginStatus.CANCELED</code> since the gateway was not contacted as the plugin was unable to retrieve the <code>mandateId</code></p></li><li><p><strong>gatewayError</strong> - Set to <code>null</code> since there is no error</p></li><li><p><strong>gatewayErrorCode</strong> - set to <code>null</code> since there is no error</p></li><li><p><strong>firstPaymentReferenceId</strong> - Set to <code>null</code> since the payment was not processed</p></li><li><p><strong>effectiveDate</strong> - Set to <code>null</code> since the payment was not processed</p></li><li><p><strong>properties</strong> - Set to <code>null</code> since the payment was not processed</p></li></ul></div></li></ul></div></div>
<div class="sect3"><h4 id="_step_7_implementing_gocardlesspaymentpluginapigetpaymentinfo">Step 7 - Implementing <a href="https://github.com/killbill/killbill-gocardless-example-plugin/blob/9522498ecde5849c940574c598ceb5ce088d32a7/src/main/java/org/killbill/billing/plugin/gocardless/GoCardlessPaymentPluginApi.java#L211">GoCardlessPaymentPluginApi#getPaymentInfo</a></h4><div class="paragraph"><p>As explained earlier, the Kill Bill Janitor system attempts to fix <strong>PENDING</strong> and <strong>UNKNOWN</strong> states by  polling the plugin via <code>PaymentPluginApi#getPaymentInfo</code> method. So, this method can be implemented as follows:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight linenums"><code data-lang="java"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">public</span> <span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">PaymentTransactionInfoPlugin</span><span class="tok-o">&gt;</span> <span class="tok-nf">getPaymentInfo</span><span class="tok-p">(</span><span class="tok-n">UUID</span> <span class="tok-n">kbAccountId</span><span class="tok-p">,</span> <span class="tok-n">UUID</span> <span class="tok-n">kbPaymentId</span><span class="tok-p">,</span>
	<span class="tok-n">Iterable</span><span class="tok-o">&lt;</span><span class="tok-n">PluginProperty</span><span class="tok-o">&gt;</span> <span class="tok-n">properties</span><span class="tok-p">,</span> <span class="tok-n">TenantContext</span> <span class="tok-n">context</span><span class="tok-p">)</span> <span class="tok-kd">throws</span> <span class="tok-n">PaymentPluginApiException</span> <span class="tok-p">{</span>
	<span class="tok-n">logger</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;getPaymentInfo&quot;</span><span class="tok-p">);</span>
	<span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">PaymentTransactionInfoPlugin</span><span class="tok-o">&gt;</span> <span class="tok-n">paymentTransactionInfoPluginList</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">ArrayList</span><span class="tok-o">&lt;&gt;</span><span class="tok-p">();</span>
	<span class="tok-n">String</span> <span class="tok-n">mandateId</span> <span class="tok-o">=</span> <span class="tok-n">getMandateId</span><span class="tok-p">(</span><span class="tok-n">kbAccountId</span><span class="tok-p">,</span> <span class="tok-n">context</span><span class="tok-p">)</span> <span class="tok-p">;</span>
	<span class="tok-n">logger</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;Mandate=&quot;</span><span class="tok-o">+</span><span class="tok-n">mandateId</span><span class="tok-p">);</span>
	<span class="tok-n">Mandate</span> <span class="tok-n">mandate</span> <span class="tok-o">=</span> <span class="tok-n">client</span><span class="tok-p">.</span><span class="tok-na">mandates</span><span class="tok-p">().</span><span class="tok-na">get</span><span class="tok-p">(</span><span class="tok-n">mandateId</span><span class="tok-p">).</span><span class="tok-na">execute</span><span class="tok-p">();</span> <span class="tok-c1">//get GoCardless Mandate object</span>
	<span class="tok-n">String</span> <span class="tok-n">customerId</span> <span class="tok-o">=</span> <span class="tok-n">mandate</span><span class="tok-p">.</span><span class="tok-na">getLinks</span><span class="tok-p">().</span><span class="tok-na">getCustomer</span><span class="tok-p">();</span> <span class="tok-c1">//retrieve customer id from mandate</span>
	<span class="tok-n">logger</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;CustomerId=&quot;</span><span class="tok-o">+</span><span class="tok-n">customerId</span><span class="tok-p">);</span>
	<span class="tok-n">Iterable</span><span class="tok-o">&lt;</span><span class="tok-n">Payment</span><span class="tok-o">&gt;</span> <span class="tok-n">payments</span> <span class="tok-o">=</span> <span class="tok-n">client</span><span class="tok-p">.</span><span class="tok-na">payments</span><span class="tok-p">().</span><span class="tok-na">all</span><span class="tok-p">().</span><span class="tok-na">withCustomer</span><span class="tok-p">(</span><span class="tok-n">customerId</span><span class="tok-p">).</span><span class="tok-na">execute</span><span class="tok-p">();</span> <span class="tok-c1">//get all payments related to customer</span>
	<span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">Payment</span> <span class="tok-n">payment</span> <span class="tok-p">:</span> <span class="tok-n">payments</span><span class="tok-p">)</span> <span class="tok-p">{</span>
		<span class="tok-n">String</span> <span class="tok-n">kbPaymentIdFromPayment</span> <span class="tok-o">=</span> <span class="tok-n">payment</span><span class="tok-p">.</span><span class="tok-na">getMetadata</span><span class="tok-p">().</span><span class="tok-na">get</span><span class="tok-p">(</span><span class="tok-s">&quot;kbPaymentId&quot;</span><span class="tok-p">);</span> <span class="tok-c1">//get kbPaymentId from metadata in payment</span>
		<span class="tok-n">logger</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;kbPaymentIdFromPayment=&quot;</span><span class="tok-o">+</span><span class="tok-n">kbPaymentIdFromPayment</span><span class="tok-p">);</span>
		<span class="tok-k">if</span><span class="tok-p">(</span><span class="tok-n">kbPaymentIdFromPayment</span> <span class="tok-o">!=</span> <span class="tok-kc">null</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-n">kbPaymentId</span><span class="tok-p">.</span><span class="tok-na">toString</span><span class="tok-p">().</span><span class="tok-na">equals</span><span class="tok-p">(</span><span class="tok-n">kbPaymentIdFromPayment</span><span class="tok-p">))</span> <span class="tok-p">{</span>
			<span class="tok-n">logger</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;Found matching payment&quot;</span><span class="tok-p">);</span>
			<span class="tok-n">Currency</span> <span class="tok-n">killBillCurrency</span> <span class="tok-o">=</span> <span class="tok-n">convertGoCardlessCurrencyToKillBillCurrency</span><span class="tok-p">(</span><span class="tok-n">payment</span><span class="tok-p">.</span><span class="tok-na">getCurrency</span><span class="tok-p">());</span>
			<span class="tok-n">logger</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;payment_status=&quot;</span><span class="tok-o">+</span><span class="tok-n">payment</span><span class="tok-p">.</span><span class="tok-na">getStatus</span><span class="tok-p">());</span>
			<span class="tok-n">PaymentPluginStatus</span> <span class="tok-n">status</span> <span class="tok-o">=</span> <span class="tok-n">convertGoCardlessToKillBillStatus</span><span class="tok-p">(</span><span class="tok-n">payment</span><span class="tok-p">.</span><span class="tok-na">getStatus</span><span class="tok-p">());</span>
			<span class="tok-n">String</span> <span class="tok-n">kbTransactionPaymentIdStr</span> <span class="tok-o">=</span> <span class="tok-n">payment</span><span class="tok-p">.</span><span class="tok-na">getMetadata</span><span class="tok-p">().</span><span class="tok-na">get</span><span class="tok-p">(</span><span class="tok-s">&quot;kbTransactionId&quot;</span><span class="tok-p">);</span>
			<span class="tok-n">UUID</span> <span class="tok-n">kbTransactionPaymentId</span> <span class="tok-o">=</span> <span class="tok-n">kbTransactionPaymentIdStr</span> <span class="tok-o">!=</span><span class="tok-kc">null</span><span class="tok-o">?</span><span class="tok-n">UUID</span><span class="tok-p">.</span><span class="tok-na">fromString</span><span class="tok-p">(</span><span class="tok-n">kbTransactionPaymentIdStr</span><span class="tok-p">):</span><span class="tok-kc">null</span><span class="tok-p">;</span>
			<span class="tok-n">logger</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;kbTransactionPaymentId=&quot;</span><span class="tok-o">+</span><span class="tok-n">kbTransactionPaymentId</span><span class="tok-p">);</span>
			<span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">PluginProperty</span><span class="tok-o">&gt;</span> <span class="tok-n">outputProperties</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">ArrayList</span><span class="tok-o">&lt;</span><span class="tok-n">PluginProperty</span><span class="tok-o">&gt;</span><span class="tok-p">();</span>
			<span class="tok-n">outputProperties</span><span class="tok-p">.</span><span class="tok-na">add</span><span class="tok-p">(</span><span class="tok-k">new</span> <span class="tok-n">PluginProperty</span><span class="tok-p">(</span><span class="tok-s">&quot;mandateId&quot;</span><span class="tok-p">,</span><span class="tok-n">mandateId</span><span class="tok-p">,</span><span class="tok-kc">false</span><span class="tok-p">));</span> <span class="tok-c1">//arbitrary data to be returned to the caller</span>
			<span class="tok-n">outputProperties</span><span class="tok-p">.</span><span class="tok-na">add</span><span class="tok-p">(</span><span class="tok-k">new</span> <span class="tok-n">PluginProperty</span><span class="tok-p">(</span><span class="tok-s">&quot;customerId&quot;</span><span class="tok-p">,</span><span class="tok-n">customerId</span><span class="tok-p">,</span><span class="tok-kc">false</span><span class="tok-p">));</span>  <span class="tok-c1">//arbitrary data to be returned to the caller</span>
			<span class="tok-n">GoCardlessPaymentTransactionInfoPlugin</span> <span class="tok-n">paymentTransactionInfoPlugin</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">GoCardlessPaymentTransactionInfoPlugin</span><span class="tok-p">(</span>
					<span class="tok-n">kbPaymentId</span><span class="tok-p">,</span> <span class="tok-n">kbTransactionPaymentId</span><span class="tok-p">,</span> <span class="tok-n">TransactionType</span><span class="tok-p">.</span><span class="tok-na">PURCHASE</span><span class="tok-p">,</span> <span class="tok-k">new</span> <span class="tok-n">BigDecimal</span><span class="tok-p">(</span><span class="tok-n">payment</span><span class="tok-p">.</span><span class="tok-na">getAmount</span><span class="tok-p">()),</span> <span class="tok-n">killBillCurrency</span><span class="tok-p">,</span>
					<span class="tok-n">status</span><span class="tok-p">,</span> <span class="tok-kc">null</span><span class="tok-p">,</span> <span class="tok-kc">null</span><span class="tok-p">,</span> <span class="tok-n">String</span><span class="tok-p">.</span><span class="tok-na">valueOf</span><span class="tok-p">(</span><span class="tok-n">payment</span><span class="tok-p">.</span><span class="tok-na">getId</span><span class="tok-p">()),</span> <span class="tok-kc">null</span><span class="tok-p">,</span> <span class="tok-k">new</span> <span class="tok-n">DateTime</span><span class="tok-p">(),</span>
					<span class="tok-k">new</span> <span class="tok-n">DateTime</span><span class="tok-p">(</span><span class="tok-n">payment</span><span class="tok-p">.</span><span class="tok-na">getCreatedAt</span><span class="tok-p">()),</span> <span class="tok-n">outputProperties</span><span class="tok-p">);</span>
			<span class="tok-n">paymentTransactionInfoPluginList</span><span class="tok-p">.</span><span class="tok-na">add</span><span class="tok-p">(</span><span class="tok-n">paymentTransactionInfoPlugin</span><span class="tok-p">);</span>
		<span class="tok-p">}</span>
	<span class="tok-p">}</span>
	<span class="tok-k">return</span> <span class="tok-n">paymentTransactionInfoPluginList</span><span class="tok-p">;</span>
<span class="tok-p">}</span>
</pre></td></tr></table></code></pre></div></div>
<div class="ulist"><ul><li><p>If you recall, the <code>addPaymentMethod</code> stores the <strong>mandate id</strong> in the Kill Bill database in the <strong>custom_fields</strong> table. This is first retrieved and assigned to <code>mandateId</code>.</p></li><li><p>Next, the GoCardless Mandate object is retrieved via <code>client.mandates().get(mandateId)</code> as explained <a href="https://developer.gocardless.com/api-reference/#mandates-get-a-single-mandate">here</a>.</p></li><li><p>Next, the <code>customerId</code> associated with the mandate is retrieved and all the <code>payments</code> associated with the customer are retrieved via <code>client.payments().all().withCustomer(customerId)</code> as explained <a href="https://developer.gocardless.com/api-reference/#payments-list-payments">here</a>.</p></li><li><p>The code then iterates through the <code>payment</code> objects and obtains the <code>Payment</code> object corresponding to the <code>kbPaymentId</code> passed in. If you recall, the <code>purchasePayment</code> method sends <code>kbPaymentId</code> and <code>kbTransactionId</code> to GoCardless as metadata fields. Thus, the <code>kbPaymentId</code> is retrieved from the metadata of each <code>Payment</code> object and compared with the <code>kbPaymentId</code> passed in.</p></li><li><p>The code then creates a <code>GoCardlessPaymentTransactionInfoPlugin</code> corresponding to a matching `Payment`using the following:</p><div class="ulist"><ul><li><p><strong>killBillCurrency</strong>  - The <strong>GoCardless currency</strong> (<code>com.gocardless.resources.Payment.Currency</code>) is retrieved from the <code>payment</code> object and converted to <strong>Kill Bill currency</strong> (<code>org.killbill.billing.catalog.api.Currency</code>).</p></li><li><p><strong>status</strong> - The <strong>GoCardless status</strong> (<code>com.gocardless.resources.Payment.Status</code>) is retrieved from the <code>payment</code> object and converted to <strong>Kill Bill status</strong> (<code>org.killbill.billing.payment.plugin.api.PaymentPluginStatus</code>).</p></li><li><p><strong>kbTransactionId</strong> - This is retrieved from the payment metadata. This step is very important because, the Janitor uses the <strong>transaction id</strong> to match the internal transactions with the plugin transactions as explained earlier.</p></li><li><p><strong>outputProperties</strong> - This is a List of <code>PluginProperty</code> objects. Some <code>PluginProperty</code> objects are created and added to the <code>outputProperties</code> List. Any arbitrary key-value pairs which need to be returned to the caller can be specified here.</p></li></ul></div></li><li><p>The List of <code>GoCardlessPaymentTransactionInfoPlugin</code> object is returned back.</p></li><li><p>The Janitor then updates the internal payment state as well as invoice balance, etc. based on the information in the <code>GoCardlessPaymentTransactionInfoPlugin</code> object.</p></li><li><p>In addition to the Janitor, the <code>getPaymentInfo</code> can also be used used on the merchant website (or in Kaui) to display the payment details to the customer. In such cases, it is invoked via an API call as specified <a href="https://killbill.github.io/slate/#payment-retrieve-a-payment-using-paymentid">here</a>. An important point to note is that the actual plugin method (<code>GoCardlessPluginApi#getPaymentInfo</code>) is invoked only when the <code>withPluginInfo=true</code> is specified in the API call. If <code>withPluginInfo=false</code> is specified, the plugin method is not invoked and Kill Bill just returns the payment information from the Kill Bill database.</p></li></ul></div></div>
<div class="sect3"><h4 id="_step_8_creating_gocardlesscheckoutservlet">Step 8 - Creating <a href="https://github.com/killbill/killbill-gocardless-example-plugin/blob/9522498ecde5849c940574c598ceb5ce088d32a7/src/main/java/org/killbill/billing/plugin/gocardless/GoCardlessCheckoutServlet.java">GoCardlessCheckoutServlet</a></h4><div class="paragraph"><p>In the case of GoCardless, we need to create an additional servlet that invokes the <code>GoCardlessPluginApi#buildFormDescriptor</code> method. Normally, a client API invokes <code>buildFormDescriptor</code> via the
<a href="https://github.com/killbill/killbill-api/blob/4ae1c343a593de937415e21feecb9f5405037fa3/src/main/java/org/killbill/billing/payment/api/PaymentGatewayApi.java">PaymentGatewayApi</a> interface. If you take a look at the <a href="https://github.com/killbill/killbill-api/blob/4ae1c343a593de937415e21feecb9f5405037fa3/src/main/java/org/killbill/billing/payment/api/PaymentGatewayApi.java#L43">PaymentGatewayApi#buildFormDescriptor</a> method, you will notice that it accepts a <code>UUID paymentMethodId</code> as a parameter. Thus, this method assumes that a <strong>payment method</strong> already exists. (You can read the <a href="https://docs.killbill.io/latest/userguide_payment.html#_payment_methods">payment user guide</a> to know more about payment methods). However, in the case of GoCardless, we are using <code>GoCardlessPluginApi#buildFormDescriptor</code> to create a form where a user sets up a mandate. Thus, the <strong>payment method</strong> will not exist in Kill Bill at the time of invoking the <code>PaymentGatewayApi#buildFormDescriptor</code> method. So, this method cannot directly invoke the <code>GoCardlessPlugin#buildFormDescriptor</code> method. To work around this, we need to create a servlet and invoke the <code>GoCardlessPlugin#buildFormDescriptor</code> method from this servlet. The client application can invoke this servlet and not the <code>PaymentGatewayApi#buildFormDescriptor</code> method</p></div>
<div class="paragraph"><p>This servlet can be created as follows:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight linenums"><code data-lang="java"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><pre><span></span><span class="tok-nd">@Singleton</span>
<span class="tok-c1">// Handle /plugins/killbill-gocardless/checkout</span>
<span class="tok-nd">@Path</span><span class="tok-p">(</span><span class="tok-s">&quot;/checkout&quot;</span><span class="tok-p">)</span>
<span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">GoCardlessCheckoutServlet</span> <span class="tok-p">{</span>
    <span class="tok-kd">private</span> <span class="tok-kd">final</span> <span class="tok-n">OSGIKillbillClock</span> <span class="tok-n">clock</span><span class="tok-p">;</span>
    <span class="tok-kd">private</span> <span class="tok-kd">final</span> <span class="tok-n">GoCardlessPaymentPluginApi</span> <span class="tok-n">goCardlessPaymentPluginApi</span><span class="tok-p">;</span>
    <span class="tok-kd">private</span> <span class="tok-kd">static</span> <span class="tok-kd">final</span> <span class="tok-n">Logger</span> <span class="tok-n">logger</span> <span class="tok-o">=</span> <span class="tok-n">LoggerFactory</span><span class="tok-p">.</span><span class="tok-na">getLogger</span><span class="tok-p">(</span><span class="tok-n">GoCardlessCheckoutServlet</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">);</span>
    <span class="tok-nd">@Inject</span>
    <span class="tok-kd">public</span> <span class="tok-nf">GoCardlessCheckoutServlet</span><span class="tok-p">(</span><span class="tok-kd">final</span> <span class="tok-n">OSGIKillbillClock</span> <span class="tok-n">clock</span><span class="tok-p">,</span>
                                     <span class="tok-kd">final</span> <span class="tok-n">GoCardlessPaymentPluginApi</span> <span class="tok-n">goCardlessPaymentPluginApi</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-na">clock</span> <span class="tok-o">=</span> <span class="tok-n">clock</span><span class="tok-p">;</span>
        <span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-na">goCardlessPaymentPluginApi</span> <span class="tok-o">=</span> <span class="tok-n">goCardlessPaymentPluginApi</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>
    <span class="tok-c1">// Setting up Direct Debit mandates using Hosted Payment Pages, before a payment method has been added to the account</span>
    <span class="tok-nd">@POST</span>
    <span class="tok-kd">public</span> <span class="tok-n">Result</span> <span class="tok-nf">createSession</span><span class="tok-p">(</span><span class="tok-nd">@Named</span><span class="tok-p">(</span><span class="tok-s">&quot;kbAccountId&quot;</span><span class="tok-p">)</span> <span class="tok-kd">final</span> <span class="tok-n">UUID</span> <span class="tok-n">kbAccountId</span><span class="tok-p">,</span>
                                <span class="tok-nd">@Named</span><span class="tok-p">(</span><span class="tok-s">&quot;success_redirect_url&quot;</span><span class="tok-p">)</span> <span class="tok-kd">final</span> <span class="tok-n">Optional</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;</span> <span class="tok-n">successUrl</span><span class="tok-p">,</span>
                                <span class="tok-nd">@Named</span><span class="tok-p">(</span><span class="tok-s">&quot;redirect_flow_description&quot;</span><span class="tok-p">)</span> <span class="tok-kd">final</span> <span class="tok-n">Optional</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;</span> <span class="tok-n">description</span><span class="tok-p">,</span>
                                <span class="tok-nd">@Named</span><span class="tok-p">(</span><span class="tok-s">&quot;lineItemName&quot;</span><span class="tok-p">)</span> <span class="tok-kd">final</span> <span class="tok-n">Optional</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-o">&gt;</span> <span class="tok-n">token</span><span class="tok-p">,</span>
                                <span class="tok-nd">@Local</span> <span class="tok-nd">@Named</span><span class="tok-p">(</span><span class="tok-s">&quot;killbill_tenant&quot;</span><span class="tok-p">)</span> <span class="tok-kd">final</span> <span class="tok-n">Tenant</span> <span class="tok-n">tenant</span><span class="tok-p">)</span> <span class="tok-kd">throws</span> <span class="tok-n">PaymentPluginApiException</span> <span class="tok-p">{</span>
    	<span class="tok-n">logger</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;Inside createSession&quot;</span><span class="tok-p">);</span>
        <span class="tok-kd">final</span> <span class="tok-n">CallContext</span> <span class="tok-n">context</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">PluginCallContext</span><span class="tok-p">(</span><span class="tok-n">GoCardlessActivator</span><span class="tok-p">.</span><span class="tok-na">PLUGIN_NAME</span><span class="tok-p">,</span> <span class="tok-n">clock</span><span class="tok-p">.</span><span class="tok-na">getClock</span><span class="tok-p">().</span><span class="tok-na">getUTCNow</span><span class="tok-p">(),</span> <span class="tok-n">kbAccountId</span><span class="tok-p">,</span> <span class="tok-n">tenant</span><span class="tok-p">.</span><span class="tok-na">getId</span><span class="tok-p">());</span>
        <span class="tok-kd">final</span> <span class="tok-n">ImmutableList</span><span class="tok-o">&lt;</span><span class="tok-n">PluginProperty</span><span class="tok-o">&gt;</span> <span class="tok-n">properties</span> <span class="tok-o">=</span> <span class="tok-n">ImmutableList</span><span class="tok-p">.</span><span class="tok-na">of</span><span class="tok-p">(</span>
                <span class="tok-k">new</span> <span class="tok-n">PluginProperty</span><span class="tok-p">(</span><span class="tok-s">&quot;success_redirect_url&quot;</span><span class="tok-p">,</span> <span class="tok-n">successUrl</span><span class="tok-p">.</span><span class="tok-na">orElse</span><span class="tok-p">(</span><span class="tok-s">&quot;https://developer.gocardless.com/example-redirect-uri/&quot;</span><span class="tok-p">),</span> <span class="tok-kc">false</span><span class="tok-p">),</span>
                <span class="tok-k">new</span> <span class="tok-n">PluginProperty</span><span class="tok-p">(</span><span class="tok-s">&quot;redirect_flow_description&quot;</span><span class="tok-p">,</span> <span class="tok-n">description</span><span class="tok-p">.</span><span class="tok-na">orElse</span><span class="tok-p">(</span><span class="tok-s">&quot;Kill Bill payment&quot;</span><span class="tok-p">),</span> <span class="tok-kc">false</span><span class="tok-p">),</span>
                <span class="tok-k">new</span> <span class="tok-n">PluginProperty</span><span class="tok-p">(</span><span class="tok-s">&quot;session_token&quot;</span><span class="tok-p">,</span> <span class="tok-n">token</span><span class="tok-p">.</span><span class="tok-na">orElse</span><span class="tok-p">(</span><span class="tok-s">&quot;killbill_token&quot;</span><span class="tok-p">),</span> <span class="tok-kc">false</span><span class="tok-p">));</span>
        <span class="tok-kd">final</span> <span class="tok-n">HostedPaymentPageFormDescriptor</span> <span class="tok-n">hostedPaymentPageFormDescriptor</span> <span class="tok-o">=</span> <span class="tok-n">goCardlessPaymentPluginApi</span><span class="tok-p">.</span><span class="tok-na">buildFormDescriptor</span><span class="tok-p">(</span><span class="tok-n">kbAccountId</span><span class="tok-p">,</span>
                <span class="tok-n">ImmutableList</span><span class="tok-p">.</span><span class="tok-na">of</span><span class="tok-p">(),</span>
                <span class="tok-n">properties</span><span class="tok-p">,</span>
                <span class="tok-n">context</span><span class="tok-p">);</span>
        <span class="tok-k">return</span> <span class="tok-n">Results</span><span class="tok-p">.</span><span class="tok-na">with</span><span class="tok-p">(</span><span class="tok-n">hostedPaymentPageFormDescriptor</span><span class="tok-p">,</span> <span class="tok-n">Status</span><span class="tok-p">.</span><span class="tok-na">CREATED</span><span class="tok-p">)</span>
                <span class="tok-p">.</span><span class="tok-na">type</span><span class="tok-p">(</span><span class="tok-n">MediaType</span><span class="tok-p">.</span><span class="tok-na">json</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>
<span class="tok-p">}</span>
</pre></td></tr></table></code></pre></div></div>
<div class="ulist"><ul><li><p>The servlet is mapped to the <code>/checkout</code> path. Thus, a client application needs to make a request to this path to invoke the servlet</p></li><li><p>The <code>createSession</code> accepts properties corresponding to <code>clock</code> and <code>goCardlessPaymentPluginApi</code>. These are injected via the <code>GoCardlessActivator</code> class as explained below</p></li><li><p>It then creates <code>PluginProperty</code> objects corresponding to the values passed in as parameters</p></li><li><p>Finally, it invokes the <code>GoCardlessPlugin#buildFormDescriptor</code> method</p></li></ul></div></div>
<div class="sect3"><h4 id="_step_9_creating_gocardlessactivator">Step 9 - Creating <a href="https://github.com/killbill/killbill-gocardless-example-plugin/blob/9522498ecde5849c940574c598ceb5ce088d32a7/src/main/java/org/killbill/billing/plugin/gocardless/GoCardlessActivator.java">GoCardlessActivator</a></h4><div class="paragraph"><p>We also need to create a class similar to <code>HelloWorldActivator</code> that starts the plugin. We can create this class as follows:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight linenums"><code data-lang="java"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">public</span> <span class="tok-kd">class</span> <span class="tok-nc">GoCardlessActivator</span> <span class="tok-kd">extends</span> <span class="tok-n">KillbillActivatorBase</span><span class="tok-p">{</span>
<span class="tok-c1">//This is the plugin name and is used by Kill Bill to route payment to the appropriate payment plugin</span>
	<span class="tok-kd">public</span> <span class="tok-kd">static</span> <span class="tok-kd">final</span> <span class="tok-n">String</span> <span class="tok-n">PLUGIN_NAME</span> <span class="tok-o">=</span> <span class="tok-s">&quot;killbill-gocardless&quot;</span><span class="tok-p">;</span>
	<span class="tok-nd">@Override</span>
    <span class="tok-kd">public</span> <span class="tok-kt">void</span> <span class="tok-nf">start</span><span class="tok-p">(</span><span class="tok-kd">final</span> <span class="tok-n">BundleContext</span> <span class="tok-n">context</span><span class="tok-p">)</span> <span class="tok-kd">throws</span> <span class="tok-n">Exception</span> <span class="tok-p">{</span>
        <span class="tok-kd">super</span><span class="tok-p">.</span><span class="tok-na">start</span><span class="tok-p">(</span><span class="tok-n">context</span><span class="tok-p">);</span>
        <span class="tok-kd">final</span> <span class="tok-n">GoCardlessPaymentPluginApi</span> <span class="tok-n">pluginApi</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">GoCardlessPaymentPluginApi</span><span class="tok-p">(</span><span class="tok-n">killbillAPI</span><span class="tok-p">,</span><span class="tok-n">clock</span><span class="tok-p">.</span><span class="tok-na">getClock</span><span class="tok-p">());</span>
        <span class="tok-n">registerPaymentPluginApi</span><span class="tok-p">(</span><span class="tok-n">context</span><span class="tok-p">,</span> <span class="tok-n">pluginApi</span><span class="tok-p">);</span>
        <span class="tok-c1">// Register the servlet, which is used as the entry point to generate the Hosted Payment Pages redirect url</span>
        <span class="tok-kd">final</span> <span class="tok-n">PluginApp</span> <span class="tok-n">pluginApp</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">PluginAppBuilder</span><span class="tok-p">(</span><span class="tok-n">PLUGIN_NAME</span><span class="tok-p">,</span> <span class="tok-n">killbillAPI</span><span class="tok-p">,</span> <span class="tok-n">dataSource</span><span class="tok-p">,</span> <span class="tok-kd">super</span><span class="tok-p">.</span><span class="tok-na">clock</span><span class="tok-p">,</span> <span class="tok-n">configProperties</span><span class="tok-p">)</span>
                <span class="tok-p">.</span><span class="tok-na">withRouteClass</span><span class="tok-p">(</span><span class="tok-n">GoCardlessCheckoutServlet</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">)</span>
                <span class="tok-p">.</span><span class="tok-na">withService</span><span class="tok-p">(</span><span class="tok-n">pluginApi</span><span class="tok-p">)</span>
                <span class="tok-p">.</span><span class="tok-na">withService</span><span class="tok-p">(</span><span class="tok-n">clock</span><span class="tok-p">)</span>
                <span class="tok-p">.</span><span class="tok-na">build</span><span class="tok-p">();</span>
        <span class="tok-kd">final</span> <span class="tok-n">HttpServlet</span> <span class="tok-n">goCardlessServlet</span> <span class="tok-o">=</span> <span class="tok-n">PluginApp</span><span class="tok-p">.</span><span class="tok-na">createServlet</span><span class="tok-p">(</span><span class="tok-n">pluginApp</span><span class="tok-p">);</span>
        <span class="tok-n">registerServlet</span><span class="tok-p">(</span><span class="tok-n">context</span><span class="tok-p">,</span> <span class="tok-n">goCardlessServlet</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>
    <span class="tok-kd">private</span> <span class="tok-kt">void</span> <span class="tok-nf">registerPaymentPluginApi</span><span class="tok-p">(</span><span class="tok-kd">final</span> <span class="tok-n">BundleContext</span> <span class="tok-n">context</span><span class="tok-p">,</span> <span class="tok-kd">final</span> <span class="tok-n">PaymentPluginApi</span> <span class="tok-n">api</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-kd">final</span> <span class="tok-n">Hashtable</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-p">,</span> <span class="tok-n">String</span><span class="tok-o">&gt;</span> <span class="tok-n">props</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Hashtable</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-p">,</span> <span class="tok-n">String</span><span class="tok-o">&gt;</span><span class="tok-p">();</span>
        <span class="tok-n">props</span><span class="tok-p">.</span><span class="tok-na">put</span><span class="tok-p">(</span><span class="tok-n">OSGIPluginProperties</span><span class="tok-p">.</span><span class="tok-na">PLUGIN_NAME_PROP</span><span class="tok-p">,</span> <span class="tok-n">PLUGIN_NAME</span><span class="tok-p">);</span>
        <span class="tok-n">registrar</span><span class="tok-p">.</span><span class="tok-na">registerService</span><span class="tok-p">(</span><span class="tok-n">context</span><span class="tok-p">,</span> <span class="tok-n">PaymentPluginApi</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">,</span> <span class="tok-n">api</span><span class="tok-p">,</span> <span class="tok-n">props</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>
    <span class="tok-kd">private</span> <span class="tok-kt">void</span> <span class="tok-nf">registerServlet</span><span class="tok-p">(</span><span class="tok-kd">final</span> <span class="tok-n">BundleContext</span> <span class="tok-n">context</span><span class="tok-p">,</span> <span class="tok-kd">final</span> <span class="tok-n">HttpServlet</span> <span class="tok-n">servlet</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-kd">final</span> <span class="tok-n">Hashtable</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-p">,</span> <span class="tok-n">String</span><span class="tok-o">&gt;</span> <span class="tok-n">props</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-n">Hashtable</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-p">,</span> <span class="tok-n">String</span><span class="tok-o">&gt;</span><span class="tok-p">();</span>
        <span class="tok-n">props</span><span class="tok-p">.</span><span class="tok-na">put</span><span class="tok-p">(</span><span class="tok-n">OSGIPluginProperties</span><span class="tok-p">.</span><span class="tok-na">PLUGIN_NAME_PROP</span><span class="tok-p">,</span> <span class="tok-n">PLUGIN_NAME</span><span class="tok-p">);</span>
        <span class="tok-n">registrar</span><span class="tok-p">.</span><span class="tok-na">registerService</span><span class="tok-p">(</span><span class="tok-n">context</span><span class="tok-p">,</span> <span class="tok-n">Servlet</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">,</span> <span class="tok-n">servlet</span><span class="tok-p">,</span> <span class="tok-n">props</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>
<span class="tok-p">}</span>
</pre></td></tr></table></code></pre></div></div>
<div class="ulist"><ul><li><p>The <code>GoCardlessActivator</code> class defines a static field called <code>PLUGIN_NAME</code> with the value <code>killbill-gocardless</code>. This is the name of the plugin and will be used by Kill Bill to route payment to the appropriate plugin as explained in our <a href="https://docs.killbill.io/latest/userguide_payment.html#_payment_methods_and_plugin_names">Payment User Guide</a></p></li><li><p>The <code>start</code> method creates a new <code>GoCardlessPaymentPluginApi</code> object</p></li><li><p>It then invokes the <code>registerPaymentPluginApi</code> method which registers the plugin with the <code>PLUGIN_NAME</code>. This code is pretty standard across all plugins and can be used as it is</p></li><li><p>In the case of GoCardless, we need to create a checkout servlet as explained above. The <code>start</code> method creates this servlet via <code>PluginAppBuilder</code> as follows:</p><div class="ulist"><ul><li><p><code>withRouteClass</code> specifies the name of the servlet, in this case <code>GoCardlessCheckoutServlet</code></p></li><li><p><code>withService</code> specifies <code>pluginApi</code>. Since the <code>GoCardlessCheckoutServlet</code> accepts a parameter corresponding to <code>GoCardlessPaymentPluginApi</code>, this is injected via <code>withService</code></p></li><li><p>Similarly, since <code>GoCardlessPaymentPluginApi</code> accepts a parameter corresponding to <code>OSGIKillbillClock</code>, a <code>clock</code> object is injected via <code>withService</code></p></li><li><p>Any other values that need to be passed to the servlet can be injected similarly</p></li><li><p>The <code>build</code> method is invoked which creates <code>pluginApp</code></p></li><li><p>Finally, the servlet is created via <code>PluginApp.createServlet</code></p></li></ul></div></li><li><p>The <code>registerServlet</code> method is then invoked which registers the servlet</p></li></ul></div></div>
<div class="sect3"><h4 id="_step_10_build_and_deployment">Step 10 - Build and Deployment</h4><div class="paragraph"><p>The GoCardless plugin can be built and deployed as per the build and deployment instructions specified in our <a href="https://docs.killbill.io/latest/plugin_development.html#_build">plugin development document</a>.</p></div></div>
<div class="sect3"><h4 id="_step_11_testing">Step 11 - Testing</h4><div class="paragraph"><p>Once the plugin is deployed successfully, it can be tested using <code>curl</code> commands as specified <a href="https://github.com/killbill/killbill-gocardless-example-plugin/">here</a>.</p></div></div></div></div></div></div></div><div class="col-12 col-md-3 col-xl-2 bd-sidebar sticky-top border-columns border-right p-0"><nav class="collapse bd-links toc right-side-menu" id="toc" data-toggle="toc"></nav></div></div></div><div class="container-fluid"><div class="row"><div class="col-12 border-columns"></div><div id="footer"><div id="footer-text">Last updated 2021-11-09 07:13:28 UTC</div><script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
          ga('create','UA-32705710-3','auto');
          ga('send','pageview');
          var getOutboundLink = function(url) {
            ga('send', {
              hitType: 'event',
              eventCategory: 'outbound',
              eventAction: 'click',
              eventLabel: url,
              hitCallback: function(){document.location = url;}
            });
          }
          </script></div><script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script><script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script><script src="https://cdn.staticaly.com/gh/afeld/bootstrap-toc/v1.0.0/dist/bootstrap-toc.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script><script type="text/javascript">docsearch({apiKey: '9d2f6d24a05863f83c8844f6e7492c66',indexName: 'killbill',inputSelector: '#search-input', debug: false, algoliaOptions: {hitsPerPage: 10}});</script></body></html>