<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]--><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="Asciidoctor 2.0.13"><link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" /><link rel="stylesheet" href="https://cdn.staticaly.com/gh/afeld/bootstrap-toc/v1.0.0/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" /><title>Kill Bill subscription guide</title><style>/*Default CSS*/

/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove the comments around the @import statement below when using this as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400";*/
/* @import "https://stylishthemes.github.io/Syntax-Themes/pygments/css-github/pygments-base16-monokai-dark.css"; */

article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
nav,
section,
summary {
  display: block;
}
audio,
canvas,
video {
  display: inline-block;
}
audio:not([controls]) {
  display: none;
  height: 0;
}
[hidden],
template {
  display: none;
}
script {
  display: none !important;
}
/* html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%} */
body {
  margin: 0;
}
a {
  background: transparent;
  text-decoration: none !important;
}
a:focus {
  outline: thin dotted;
}
a:active,
a:hover {
  outline: 0;
}
h1 {
  font-size: 2em;
  margin: 0.67em 0;
}
abbr[title] {
  border-bottom: 1px dotted;
}
b,
strong {
  font-weight: bold;
}
dfn {
  font-style: italic;
}
hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}
mark {
  background: #ff0;
  color: #000;
}
code,
kbd,
pre,
samp {
  font-family: monospace;
  font-size: 1em;
}
pre {
  white-space: pre-wrap;
}
q {
  quotes: "\201C" "\201D" "\2018" "\2019";
}
small {
  font-size: 80%;
}
sub,
sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}
sup {
  top: -0.5em;
}
sub {
  bottom: -0.25em;
}
img {
  border: 0;
}
svg:not(:root) {
  overflow: hidden;
}
figure {
  margin: 0;
}
fieldset {
  border: 1px solid silver;
  margin: 0 2px;
  padding: 0.35em 0.625em 0.75em;
}
legend {
  border: 0;
  padding: 0;
}
/* button,input,select,textarea{font-family:inherit;font-size:100%;margin:0} */
button,
input {
  line-height: normal;
}
button,
select {
  text-transform: none;
}
button,
html input[type="button"],
input[type="reset"],
input[type="submit"] {
  -webkit-appearance: button;
  cursor: pointer;
}
button[disabled],
html input[disabled] {
  cursor: default;
}
input[type="checkbox"],
input[type="radio"] {
  box-sizing: border-box;
  padding: 0;
}
input[type="search"] {
  -webkit-appearance: textfield;
  -moz-box-sizing: content-box;
  -webkit-box-sizing: content-box;
  box-sizing: content-box;
}
input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
  -webkit-appearance: none;
}
button::-moz-focus-inner,
input::-moz-focus-inner {
  border: 0;
  padding: 0;
}
textarea {
  overflow: auto;
  vertical-align: top;
}
table {
  border-collapse: collapse;
  border-spacing: 0;
}
*,
*:before,
*:after {
  -moz-box-sizing: border-box;
  -webkit-box-sizing: border-box;
  box-sizing: border-box;
}
html,
body {
  font-size: 100%;
}
/* body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto} */
a:hover {
  cursor: pointer;
}
img,
object,
embed {
  max-width: 100%;
  height: auto;
}
object,
embed {
  height: 100%;
}
img {
  -ms-interpolation-mode: bicubic;
}
#map_canvas img,
#map_canvas embed,
#map_canvas object,
.map_canvas img,
.map_canvas embed,
.map_canvas object {
  max-width: none !important;
}
.left {
  float: left !important;
}
.right {
  float: right !important;
}
.text-left {
  text-align: left !important;
}
.text-right {
  text-align: right !important;
}
.text-center {
  text-align: center !important;
}
.text-justify {
  text-align: justify !important;
}
.hide {
  display: none;
}
.antialiased,
body {
  -webkit-font-smoothing: antialiased;
}
img {
  display: inline-block;
  vertical-align: middle;
}
textarea {
  height: auto;
  min-height: 50px;
}
select {
  width: 100%;
}
p.lead,
.paragraph.lead > p,
#preamble > .sectionbody > .paragraph:first-of-type p {
  font-size: 1.21875em;
  line-height: 1.6;
}
.subheader,
.admonitionblock td.content > .title,
.audioblock > .title,
.exampleblock > .title,
.imageblock > .title,
.listingblock > .title,
.literalblock > .title,
.stemblock > .title,
.openblock > .title,
.paragraph > .title,
.quoteblock > .title,
table.tableblock > .title,
.verseblock > .title,
.videoblock > .title,
.dlist > .title,
.olist > .title,
.ulist > .title,
.qlist > .title,
.hdlist > .title {
  line-height: 1.45;
  color: #7a2518;
  font-weight: 400;
  margin-top: 0;
  margin-bottom: 0.25em;
}
div,
dl,
dt,
dd,
ul,
ol,
li,
h1,
h2,
h3,
#toctitle,
.sidebarblock > .content > .title,
h4,
h5,
h6,
pre,
form,
p,
blockquote,
th,
td {
  margin: 0;
  padding: 0;
  direction: ltr;
}
a {
  color: #2156a5;
  text-decoration: underline;
  line-height: inherit;
}
a:hover,
a:focus {
  color: #1d4b8f;
}
a img {
  border: none;
}
p {
  font-family: inherit;
  font-weight: 400;
  font-size: 1em;
  line-height: 1.6;
  margin-bottom: 1.25em;
  text-rendering: optimizeLegibility;
}
p aside {
  font-size: 0.875em;
  line-height: 1.35;
  font-style: italic;
}
h1,
h2,
h3,
#toctitle,
.sidebarblock > .content > .title,
h4,
h5,
h6 {
  font-family: "Open Sans", "DejaVu Sans", sans-serif;
  font-weight: 300;
  font-style: normal;
  color: #e44c3a;
  text-rendering: optimizeLegibility;
  margin-top: 1em;
  margin-bottom: 0.5em;
  line-height: 1.0125em;
}
h1 small,
h2 small,
h3 small,
#toctitle small,
.sidebarblock > .content > .title small,
h4 small,
h5 small,
h6 small {
  font-size: 60%;
  color: #e99b8f;
  line-height: 0;
}
h1 {
  font-size: 2.125em;
}
h2 {
  font-size: 1.6875em;
}
h3,
#toctitle,
.sidebarblock > .content > .title {
  font-size: 1.375em;
}
h4,
h5 {
  font-size: 1.125em;
}
h6 {
  font-size: 1em;
}
hr {
  border: solid #ddddd8;
  border-width: 1px 0 0;
  clear: both;
  margin: 1.25em 0 1.1875em;
  height: 0;
}
em,
i {
  font-style: italic;
  line-height: inherit;
}
strong,
b {
  font-weight: bold;
  line-height: inherit;
}
small {
  font-size: 60%;
  line-height: inherit;
}
code {
  font-family: "Droid Sans Mono", "DejaVu Sans Mono", monospace;
  font-weight: 400;
  color: rgba(0, 0, 0, 0.9);
}
ul,
ol,
dl {
  font-size: 1em;
  line-height: 1.6;
  margin-bottom: 1.25em;
  list-style-position: outside;
  font-family: inherit;
}
ul,
ol,
ul.no-bullet,
ol.no-bullet {
  margin-left: 1.5em;
}
ul li ul,
ul li ol {
  margin-left: 1.25em;
  margin-bottom: 0;
  font-size: 1em;
}
ul.square li ul,
ul.circle li ul,
ul.disc li ul {
  list-style: inherit;
}
ul.square {
  list-style-type: square;
}
ul.circle {
  list-style-type: circle;
}
ul.disc {
  list-style-type: disc;
}
ul.no-bullet {
  list-style: none;
}
ol li ul,
ol li ol {
  margin-left: 1.25em;
  margin-bottom: 0;
}
dl dt {
  margin-bottom: 0.3125em;
  font-weight: bold;
}
dl dd {
  margin-bottom: 1.25em;
}
abbr,
acronym {
  text-transform: uppercase;
  font-size: 90%;
  color: rgba(0, 0, 0, 0.8);
  border-bottom: 1px dotted #ddd;
  cursor: help;
}
abbr {
  text-transform: none;
}
blockquote {
  margin: 0 0 1.25em;
  padding: 0.5625em 1.25em 0 1.1875em;
  border-left: 1px solid #ddd;
}
blockquote cite {
  display: block;
  font-size: 0.9375em;
  color: rgba(0, 0, 0, 0.6);
}
blockquote cite:before {
  content: "\2014 \0020";
}
blockquote cite a,
blockquote cite a:visited {
  color: rgba(0, 0, 0, 0.6);
}
blockquote,
blockquote p {
  line-height: 1.6;
  color: rgba(0, 0, 0, 0.85);
}
@media only screen and (min-width: 768px) {
  h1,
  h2,
  h3,
  #toctitle,
  .sidebarblock > .content > .title,
  h4,
  h5,
  h6 {
    line-height: 1.2;
  }
  h1 {
    font-size: 2.75em;
  }
  h2 {
    font-size: 2.3125em;
  }
  h3,
  #toctitle,
  .sidebarblock > .content > .title {
    font-size: 1.6875em;
  }
  h4 {
    font-size: 1.4375em;
  }
}
table {
  /* background: #fff; */
  margin-bottom: 1.25em;
  /* border: solid 1px #dedede; */
}
table thead,
table tfoot {
  /* background: #f7f8f7; */
  font-weight: bold;
}
table thead tr th,
table thead tr td,
table tfoot tr th,
table tfoot tr td {
  padding: 0.5em 0.625em 0.625em;
  font-size: inherit;
  color: rgba(0, 0, 0, 0.8);
  text-align: left;
}
table tr th,
table tr td {
  padding: 0.5625em 0.625em;
  font-size: inherit;
  color: rgba(0, 0, 0, 0.8);
}
table tr.even,
table tr.alt,
table tr:nth-of-type(even) {
  background: #f8f8f7;
}
table thead tr th,
table tfoot tr th,
table tbody tr td,
table tr td,
table tfoot tr td {
  display: table-cell;
  line-height: 1.6;
}
h1,
h2,
h3,
#toctitle,
.sidebarblock > .content > .title,
h4,
h5,
h6 {
  line-height: 1.2;
  word-spacing: -0.05em;
}
h1 strong,
h2 strong,
h3 strong,
#toctitle strong,
.sidebarblock > .content > .title strong,
h4 strong,
h5 strong,
h6 strong {
  font-weight: 400;
}
.clearfix:before,
.clearfix:after,
.float-group:before,
.float-group:after {
  content: " ";
  display: table;
}
.clearfix:after,
.float-group:after {
  clear: both;
}
*:not(pre) > code {
  font-size: 0.9375em;
  font-style: normal !important;
  letter-spacing: 0;
  padding: 0.1em 0.5ex;
  word-spacing: -0.15em;
  /* background-color: #f7f7f8; */
  -webkit-border-radius: 4px;
  border-radius: 4px;
  line-height: 1.45;
  text-rendering: optimizeSpeed;
}
pre,
pre > code {
  line-height: 1.45;
  /* color: rgba(0, 0, 0, 0.9); */
  font-family: "Droid Sans Mono", "DejaVu Sans Mono", monospace;
  font-weight: 400;
  text-rendering: optimizeSpeed;
}
.keyseq {
  color: rgba(51, 51, 51, 0.8);
}
kbd {
  display: inline-block;
  color: rgba(0, 0, 0, 0.8);
  font-size: 0.75em;
  line-height: 1.4;
  background-color: #f7f7f7;
  border: 1px solid #ccc;
  -webkit-border-radius: 3px;
  border-radius: 3px;
  -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset;
  box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em #fff inset;
  margin: -0.15em 0.15em 0 0.15em;
  padding: 0.2em 0.6em 0.2em 0.5em;
  vertical-align: middle;
  white-space: nowrap;
}
.keyseq kbd:first-child {
  margin-left: 0;
}
.keyseq kbd:last-child {
  margin-right: 0;
}
.menuseq,
.menu {
  color: rgba(0, 0, 0, 0.8);
}
b.button:before,
b.button:after {
  position: relative;
  top: -1px;
  font-weight: 400;
}
b.button:before {
  content: "[";
  padding: 0 3px 0 2px;
}
b.button:after {
  content: "]";
  padding: 0 2px 0 3px;
}
p a > code:hover {
  color: rgba(0, 0, 0, 0.9);
}
#header,
#content,
#footnotes,
#footer {
  width: 100%;
  margin-left: auto;
  margin-right: auto;
  margin-top: 0;
  margin-bottom: 0;
  *zoom: 1;
  position: relative;
  padding-left: 0.9375em;
  padding-right: 0.9375em;
}
#header:before,
#header:after,
#content:before,
#content:after,
#footnotes:before,
#footnotes:after,
#footer:before,
#footer:after {
  content: " ";
  display: table;
}
#header:after,
#content:after,
#footnotes:after,
#footer:after {
  clear: both;
}
#content {
  margin-top: 1.25em;
}
#content:before {
  content: none;
}
#header > h1:first-child {
  color: rgba(0, 0, 0, 0.85);
  margin-top: 2.25rem;
  margin-bottom: 0;
}
#header > h1:first-child + #toc {
  margin-top: 8px;
  border-top: 1px solid #ddddd8;
}
#header > h1:only-child,
body.toc2 #header > h1:nth-last-child(2) {
  border-bottom: 1px solid #ddddd8;
  padding-bottom: 8px;
}
#header .details {
  border-bottom: 1px solid #ddddd8;
  line-height: 1.45;
  padding-top: 0.25em;
  padding-bottom: 0.25em;
  padding-left: 0.25em;
  color: rgba(0, 0, 0, 0.6);
  display: -ms-flexbox;
  display: -webkit-flex;
  display: flex;
  -ms-flex-flow: row wrap;
  -webkit-flex-flow: row wrap;
  flex-flow: row wrap;
}
#header .details span:first-child {
  margin-left: -0.125em;
}
#header .details span.email a {
  color: rgba(0, 0, 0, 0.85);
}
#header .details br {
  display: none;
}
#header .details br + span:before {
  content: "\00a0\2013\00a0";
}
#header .details br + span.author:before {
  content: "\00a0\22c5\00a0";
  color: rgba(0, 0, 0, 0.85);
}
#header .details br + span#revremark:before {
  content: "\00a0|\00a0";
}
#header #revnumber {
  text-transform: capitalize;
}
#header #revnumber:after {
  content: "\00a0";
}
#content > h1:first-child:not([class]) {
  color: rgba(0, 0, 0, 0.85);
  border-bottom: 1px solid #ddddd8;
  padding-bottom: 8px;
  margin-top: 0;
  padding-top: 1rem;
  margin-bottom: 1.25rem;
}
#toc {
  border-bottom: 1px solid #efefed;
  padding-bottom: 0.5em;
}
#toc > ul {
  margin-left: 0.125em;
}
#toc ul.sectlevel0 > li > a {
  font-style: italic;
}
#toc ul.sectlevel0 ul.sectlevel1 {
  margin: 0.5em 0;
}
#toc ul {
  font-family: "Open Sans", "DejaVu Sans", sans-serif;
  list-style-type: none;
}
#toc a {
  text-decoration: none;
}
#toc a:active {
  text-decoration: underline;
}
#toctitle {
  color: #7a2518;
  font-size: 1.2em;
}
@media only screen and (min-width: 768px) {
  #toctitle {
    font-size: 1.375em;
  }
  body.toc2 {
    padding-left: 15em;
    padding-right: 0;
  }
  #toc.toc2 {
    margin-top: 0 !important;
    background-color: #f8f8f7;
    position: fixed;
    width: 15em;
    left: 0;
    top: 0;
    border-right: 1px solid #efefed;
    border-top-width: 0 !important;
    border-bottom-width: 0 !important;
    z-index: 1000;
    padding: 1.25em 1em;
    height: 100%;
    overflow: auto;
  }
  #toc.toc2 #toctitle {
    margin-top: 0;
    font-size: 1.2em;
  }
  #toc.toc2 > ul {
    font-size: 0.9em;
    margin-bottom: 0;
  }
  #toc.toc2 ul ul {
    margin-left: 0;
    padding-left: 1em;
  }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 {
    padding-left: 0;
    margin-top: 0.5em;
    margin-bottom: 0.5em;
  }
  body.toc2.toc-right {
    padding-left: 0;
    padding-right: 15em;
  }
  body.toc2.toc-right #toc.toc2 {
    border-right-width: 0;
    border-left: 1px solid #efefed;
    left: auto;
    right: 0;
  }
}
@media only screen and (min-width: 1280px) {
  body.toc2 {
    padding-left: 20em;
    padding-right: 0;
  }
  #toc.toc2 {
    width: 20em;
  }
  #toc.toc2 #toctitle {
    font-size: 1.375em;
  }
  #toc.toc2 > ul {
    font-size: 0.95em;
  }
  #toc.toc2 ul ul {
    padding-left: 1.25em;
  }
  body.toc2.toc-right {
    padding-left: 0;
    padding-right: 20em;
  }
}
#content #toc {
  border-style: solid;
  border-width: 1px;
  border-color: #e0e0dc;
  margin-bottom: 1.25em;
  padding: 1.25em;
  background: #f8f8f7;
  -webkit-border-radius: 4px;
  border-radius: 4px;
}
#content #toc > :first-child {
  margin-top: 0;
}
#content #toc > :last-child {
  margin-bottom: 0;
}
#footer {
  max-width: 100%;
  background-color: #2e3336;
  padding: 1.25em;
}
#footer-text {
  color: rgba(255, 255, 255, 0.8);
  line-height: 1.44;
}
.sect1 {
  padding-bottom: 0.625em;
}
@media only screen and (min-width: 768px) {
  .sect1 {
    padding-bottom: 1.25em;
  }
}
.sect1 + .sect1 {
  border-top: 1px solid #efefed;
}
#content h1 > a.anchor,
h2 > a.anchor,
h3 > a.anchor,
#toctitle > a.anchor,
.sidebarblock > .content > .title > a.anchor,
h4 > a.anchor,
h5 > a.anchor,
h6 > a.anchor {
  position: absolute;
  z-index: 1001;
  width: 1.5ex;
  margin-left: -1.5ex;
  display: block;
  text-decoration: none !important;
  visibility: hidden;
  text-align: center;
  font-weight: 400;
}
#content h1 > a.anchor:before,
h2 > a.anchor:before,
h3 > a.anchor:before,
#toctitle > a.anchor:before,
.sidebarblock > .content > .title > a.anchor:before,
h4 > a.anchor:before,
h5 > a.anchor:before,
h6 > a.anchor:before {
  content: "\00A7";
  font-size: 0.85em;
  display: block;
  padding-top: 0.1em;
}
#content h1:hover > a.anchor,
#content h1 > a.anchor:hover,
h2:hover > a.anchor,
h2 > a.anchor:hover,
h3:hover > a.anchor,
#toctitle:hover > a.anchor,
.sidebarblock > .content > .title:hover > a.anchor,
h3 > a.anchor:hover,
#toctitle > a.anchor:hover,
.sidebarblock > .content > .title > a.anchor:hover,
h4:hover > a.anchor,
h4 > a.anchor:hover,
h5:hover > a.anchor,
h5 > a.anchor:hover,
h6:hover > a.anchor,
h6 > a.anchor:hover {
  visibility: visible;
}
#content h1 > a.link,
h2 > a.link,
h3 > a.link,
#toctitle > a.link,
.sidebarblock > .content > .title > a.link,
h4 > a.link,
h5 > a.link,
h6 > a.link {
  color: #e44c3a;
  text-decoration: none;
}
#content h1 > a.link:hover,
h2 > a.link:hover,
h3 > a.link:hover,
#toctitle > a.link:hover,
.sidebarblock > .content > .title > a.link:hover,
h4 > a.link:hover,
h5 > a.link:hover,
h6 > a.link:hover {
  color: #a53221;
}
.audioblock,
.imageblock,
.literalblock,
.listingblock,
.stemblock,
.videoblock {
  margin-bottom: 1.25em;
}
.admonitionblock td.content > .title,
.audioblock > .title,
.exampleblock > .title,
.imageblock > .title,
.listingblock > .title,
.literalblock > .title,
.stemblock > .title,
.openblock > .title,
.paragraph > .title,
.quoteblock > .title,
table.tableblock > .title,
.verseblock > .title,
.videoblock > .title,
.dlist > .title,
.olist > .title,
.ulist > .title,
.qlist > .title,
.hdlist > .title {
  text-rendering: optimizeLegibility;
  text-align: left;
  font-family: "Noto Serif", "DejaVu Serif", serif;
  font-size: 1rem;
  font-style: italic;
}
table.tableblock > caption.title {
  white-space: nowrap;
  overflow: visible;
  max-width: 0;
}
.paragraph.lead > p,
#preamble > .sectionbody > .paragraph:first-of-type p {
  color: rgba(0, 0, 0, 0.85);
}
table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p {
  font-size: inherit;
}
.admonitionblock > table {
  border-collapse: separate;
  border: 0;
  background: none;
  width: 100%;
}
.admonitionblock > table td.icon {
  text-align: center;
  width: 80px;
}
.admonitionblock > table td.icon img {
  max-width: none;
}
.admonitionblock > table td.icon .title {
  font-weight: bold;
  font-family: "Open Sans", "DejaVu Sans", sans-serif;
  text-transform: uppercase;
}
.admonitionblock > table td.content {
  padding-left: 1.125em;
  padding-right: 1.25em;
  border-left: 1px solid #ddddd8;
  color: rgba(0, 0, 0, 0.6);
}
.admonitionblock > table td.content > :last-child > :last-child {
  margin-bottom: 0;
}
.exampleblock > .content {
  border-style: solid;
  border-width: 1px;
  border-color: #e6e6e6;
  margin-bottom: 1.25em;
  padding: 1.25em;
  background: #fff;
  -webkit-border-radius: 4px;
  border-radius: 4px;
}
.exampleblock > .content > :first-child {
  margin-top: 0;
}
.exampleblock > .content > :last-child {
  margin-bottom: 0;
}
.sidebarblock {
  border-style: solid;
  border-width: 1px;
  border-color: #e0e0dc;
  margin-bottom: 1.25em;
  padding: 1.25em;
  background: #f8f8f7;
  -webkit-border-radius: 4px;
  border-radius: 4px;
}
.sidebarblock > :first-child {
  margin-top: 0;
}
.sidebarblock > :last-child {
  margin-bottom: 0;
}
.sidebarblock > .content > .title {
  color: #7a2518;
  margin-top: 0;
  text-align: center;
}
.exampleblock > .content > :last-child > :last-child,
.exampleblock > .content .olist > ol > li:last-child > :last-child,
.exampleblock > .content .ulist > ul > li:last-child > :last-child,
.exampleblock > .content .qlist > ol > li:last-child > :last-child,
.sidebarblock > .content > :last-child > :last-child,
.sidebarblock > .content .olist > ol > li:last-child > :last-child,
.sidebarblock > .content .ulist > ul > li:last-child > :last-child,
.sidebarblock > .content .qlist > ol > li:last-child > :last-child {
  margin-bottom: 0;
}
.literalblock pre,
.listingblock pre[class="highlight"],
.listingblock pre[class^="highlight "],
.listingblock pre.CodeRay,
.listingblock pre.prettyprint {
  background: #f7f7f8;
}
.sidebarblock .literalblock pre,
.sidebarblock .listingblock pre[class="highlight"],
.sidebarblock .listingblock pre[class^="highlight "],
.sidebarblock .listingblock pre.CodeRay,
.sidebarblock .listingblock pre.prettyprint {
  background: #f2f1f1;
}
.literalblock pre,
.literalblock pre[class],
.listingblock pre,
.listingblock pre[class] {
  -webkit-border-radius: 4px;
  border-radius: 4px;
  word-wrap: break-word;
  padding: 1em;
  font-size: 0.8125em;
}
.literalblock pre.nowrap,
.literalblock pre[class].nowrap,
.listingblock pre.nowrap,
.listingblock pre[class].nowrap {
  overflow-x: auto;
  white-space: pre;
  word-wrap: normal;
}
@media only screen and (min-width: 768px) {
  .literalblock pre,
  .literalblock pre[class],
  .listingblock pre,
  .listingblock pre[class] {
    font-size: 0.90625em;
  }
}
@media only screen and (min-width: 1280px) {
  .literalblock pre,
  .literalblock pre[class],
  .listingblock pre,
  .listingblock pre[class] {
    font-size: 1em;
  }
}
.literalblock.output pre {
  color: #f7f7f8;
  background-color: rgba(0, 0, 0, 0.9);
}
.listingblock pre.highlightjs {
  padding: 0;
}
.listingblock pre.highlightjs > code {
  padding: 1em;
  -webkit-border-radius: 4px;
  border-radius: 4px;
}
.listingblock pre.prettyprint {
  border-width: 0;
}
.listingblock > .content {
  position: relative;
}
.listingblock code[data-lang]:before {
  display: none;
  content: attr(data-lang);
  position: absolute;
  font-size: 0.75em;
  top: 0.425rem;
  right: 0.5rem;
  line-height: 1;
  text-transform: uppercase;
  color: #999;
}
.listingblock:hover code[data-lang]:before {
  display: block;
}
.listingblock.terminal pre .command:before {
  content: attr(data-prompt);
  padding-right: 0.5em;
  color: #999;
}
.listingblock.terminal pre .command:not([data-prompt]):before {
  content: "$";
}
table.pyhltable {
  border-collapse: separate;
  border: 0;
  margin-bottom: 0;
  background: none;
}
table.pyhltable td {
  vertical-align: top;
  padding-top: 0;
  padding-bottom: 0;
}
table.pyhltable td.code {
  padding-left: 0.75em;
  padding-right: 0;
}
pre.pygments .lineno,
table.pyhltable td:not(.code) {
  color: #999;
  padding-left: 0;
  padding-right: 0.5em;
  border-right: 1px solid #ddddd8;
}
pre.pygments .lineno {
  display: inline-block;
  margin-right: 0.25em;
}
table.pyhltable .linenodiv {
  background: none !important;
  padding-right: 0 !important;
}
.quoteblock {
  margin: 0 1em 1.25em 1.5em;
  display: table;
}
.quoteblock > .title {
  margin-left: -1.5em;
  margin-bottom: 0.75em;
}
.quoteblock blockquote,
.quoteblock blockquote p {
  color: rgba(0, 0, 0, 0.85);
  font-size: 1.15rem;
  line-height: 1.75;
  word-spacing: 0.1em;
  letter-spacing: 0;
  font-style: italic;
  text-align: justify;
}
.quoteblock blockquote {
  margin: 0;
  padding: 0;
  border: 0;
}
.quoteblock blockquote:before {
  content: "\201c";
  float: left;
  font-size: 2.75em;
  font-weight: bold;
  line-height: 0.6em;
  margin-left: -0.6em;
  color: #7a2518;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}
.quoteblock blockquote > .paragraph:last-child p {
  margin-bottom: 0;
}
.quoteblock .attribution {
  margin-top: 0.5em;
  margin-right: 0.5ex;
  text-align: right;
}
.quoteblock .quoteblock {
  margin-left: 0;
  margin-right: 0;
  padding: 0.5em 0;
  border-left: 3px solid rgba(0, 0, 0, 0.6);
}
.quoteblock .quoteblock blockquote {
  padding: 0 0 0 0.75em;
}
.quoteblock .quoteblock blockquote:before {
  display: none;
}
.verseblock {
  margin: 0 1em 1.25em 1em;
}
.verseblock pre {
  font-family: "Open Sans", "DejaVu Sans", sans;
  font-size: 1.15rem;
  color: rgba(0, 0, 0, 0.85);
  font-weight: 300;
  text-rendering: optimizeLegibility;
}
.verseblock pre strong {
  font-weight: 400;
}
.verseblock .attribution {
  margin-top: 1.25rem;
  margin-left: 0.5ex;
}
.quoteblock .attribution,
.verseblock .attribution {
  font-size: 0.9375em;
  line-height: 1.45;
  font-style: italic;
}
.quoteblock .attribution br,
.verseblock .attribution br {
  display: none;
}
.quoteblock .attribution cite,
.verseblock .attribution cite {
  display: block;
  letter-spacing: -0.05em;
  color: rgba(0, 0, 0, 0.6);
}
.quoteblock.abstract {
  margin: 0 0 1.25em 0;
  display: block;
}
.quoteblock.abstract blockquote,
.quoteblock.abstract blockquote p {
  text-align: left;
  word-spacing: 0;
}
.quoteblock.abstract blockquote:before,
.quoteblock.abstract blockquote p:first-of-type:before {
  display: none;
}
table.tableblock {
  max-width: 100%;
  border-collapse: separate;
}
table.tableblock td > .paragraph:last-child p > p:last-child,
table.tableblock th > p:last-child,
table.tableblock td > p:last-child {
  margin-bottom: 0;
}
table.spread {
  width: 100%;
}
table.tableblock,
th.tableblock,
td.tableblock {
  border: 0 solid #dedede;
}
table.grid-all th.tableblock,
table.grid-all td.tableblock {
  border-width: 0 1px 1px 0;
}
table.grid-all tfoot > tr > th.tableblock,
table.grid-all tfoot > tr > td.tableblock {
  border-width: 1px 1px 0 0;
}
table.grid-cols th.tableblock,
table.grid-cols td.tableblock {
  border-width: 0 1px 0 0;
}
table.grid-all * > tr > .tableblock:last-child,
table.grid-cols * > tr > .tableblock:last-child {
  border-right-width: 0;
}
table.grid-rows th.tableblock,
table.grid-rows td.tableblock {
  border-width: 0 0 1px 0;
}
table.grid-all tbody > tr:last-child > th.tableblock,
table.grid-all tbody > tr:last-child > td.tableblock,
table.grid-all thead:last-child > tr > th.tableblock,
table.grid-rows tbody > tr:last-child > th.tableblock,
table.grid-rows tbody > tr:last-child > td.tableblock,
table.grid-rows thead:last-child > tr > th.tableblock {
  border-bottom-width: 0;
}
table.grid-rows tfoot > tr > th.tableblock,
table.grid-rows tfoot > tr > td.tableblock {
  border-width: 1px 0 0 0;
}
table.frame-all {
  border-width: 1px;
}
table.frame-sides {
  border-width: 0 1px;
}
table.frame-topbot {
  border-width: 1px 0;
}
th.halign-left,
td.halign-left {
  text-align: left;
}
th.halign-right,
td.halign-right {
  text-align: right;
}
th.halign-center,
td.halign-center {
  text-align: center;
}
th.valign-top,
td.valign-top {
  vertical-align: top;
}
th.valign-bottom,
td.valign-bottom {
  vertical-align: bottom;
}
th.valign-middle,
td.valign-middle {
  vertical-align: middle;
}
table thead th,
table tfoot th {
  font-weight: bold;
}
tbody tr th {
  display: table-cell;
  line-height: 1.6;
  background: #f7f8f7;
}
tbody tr th,
tbody tr th p,
tfoot tr th,
tfoot tr th p {
  color: rgba(0, 0, 0, 0.8);
  font-weight: bold;
}
p.tableblock > code:only-child {
  background: none;
  padding: 0;
}
p.tableblock {
  font-size: 1em;
}
td > div.verse {
  white-space: pre;
}
ol {
  margin-left: 1.75em;
}
ul li ol {
  margin-left: 1.5em;
}
dl dd {
  margin-left: 1.125em;
}
dl dd:last-child,
dl dd:last-child > :last-child {
  margin-bottom: 0;
}
ol > li p,
ul > li p,
ul dd,
ol dd,
.olist .olist,
.ulist .ulist,
.ulist .olist,
.olist .ulist {
  margin-bottom: 0.625em;
}
ul.unstyled,
ol.unnumbered,
ul.checklist,
ul.none {
  list-style-type: none;
}
ul.unstyled,
ol.unnumbered,
ul.checklist {
  margin-left: 0.625em;
}
ul.checklist li > p:first-child > .fa-square-o:first-child,
ul.checklist li > p:first-child > .fa-check-square-o:first-child {
  width: 1em;
  font-size: 0.85em;
}
ul.checklist li > p:first-child > input[type="checkbox"]:first-child {
  width: 1em;
  position: relative;
  top: 1px;
}
ul.inline {
  margin: 0 auto 0.625em auto;
  margin-left: -1.375em;
  margin-right: 0;
  padding: 0;
  list-style: none;
  overflow: hidden;
}
ul.inline > li {
  list-style: none;
  float: left;
  margin-left: 1.375em;
  display: block;
}
ul.inline > li > * {
  display: block;
}
.unstyled dl dt {
  font-weight: 400;
  font-style: normal;
}
ol.arabic {
  list-style-type: decimal;
}
ol.decimal {
  list-style-type: decimal-leading-zero;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}
ol.lowergreek {
  list-style-type: lower-greek;
}
.hdlist > table,
.colist > table {
  border: 0;
  background: none;
}
.hdlist > table > tbody > tr,
.colist > table > tbody > tr {
  background: none;
}
td.hdlist1 {
  padding-right: 0.75em;
  font-weight: bold;
}
td.hdlist1,
td.hdlist2 {
  vertical-align: top;
}
.literalblock + .colist,
.listingblock + .colist {
  margin-top: -0.5em;
}
.colist > table tr > td:first-of-type {
  padding: 0 0.75em;
  line-height: 1;
}
.colist > table tr > td:last-of-type {
  padding: 0.25em 0;
}
.thumb,
.th {
  line-height: 0;
  display: inline-block;
  border: solid 4px #fff;
  -webkit-box-shadow: 0 0 0 1px #ddd;
  box-shadow: 0 0 0 1px #ddd;
}
.imageblock.left,
.imageblock[style*="float: left"] {
  margin: 0.25em 0.625em 1.25em 0;
}
.imageblock.right,
.imageblock[style*="float: right"] {
  margin: 0.25em 0 1.25em 0.625em;
}
.imageblock > .title {
  margin-bottom: 0;
}
.imageblock.thumb,
.imageblock.th {
  border-width: 6px;
}
.imageblock.thumb > .title,
.imageblock.th > .title {
  padding: 0 0.125em;
}
.image.left,
.image.right {
  margin-top: 0.25em;
  margin-bottom: 0.25em;
  display: inline-block;
  line-height: 0;
}
.image.left {
  margin-right: 0.625em;
}
.image.right {
  margin-left: 0.625em;
}
a.image {
  text-decoration: none;
}
span.footnote,
span.footnoteref {
  vertical-align: super;
  font-size: 0.875em;
}
span.footnote a,
span.footnoteref a {
  text-decoration: none;
}
span.footnote a:active,
span.footnoteref a:active {
  text-decoration: underline;
}
#footnotes {
  padding-top: 0.75em;
  padding-bottom: 0.75em;
  margin-bottom: 0.625em;
}
#footnotes hr {
  width: 20%;
  min-width: 6.25em;
  margin: -0.25em 0 0.75em 0;
  border-width: 1px 0 0 0;
}
#footnotes .footnote {
  padding: 0 0.375em;
  line-height: 1.3;
  font-size: 0.875em;
  margin-left: 1.2em;
  text-indent: -1.2em;
  margin-bottom: 0.2em;
}
#footnotes .footnote a:first-of-type {
  font-weight: bold;
  text-decoration: none;
}
#footnotes .footnote:last-of-type {
  margin-bottom: 0;
}
#content #footnotes {
  margin-top: -0.625em;
  margin-bottom: 0;
  padding: 0.75em 0;
}
.gist .file-data > table {
  border: 0;
  background: #fff;
  width: 100%;
  margin-bottom: 0;
}
.gist .file-data > table td.line-data {
  width: 99%;
}
div.unbreakable {
  page-break-inside: avoid;
}
.big {
  font-size: larger;
}
.small {
  font-size: smaller;
}
.underline {
  text-decoration: underline;
}
.overline {
  text-decoration: overline;
}
.line-through {
  text-decoration: line-through;
}
.aqua {
  color: #00bfbf;
}
.aqua-background {
  background-color: #00fafa;
}
.black {
  color: #000;
}
.black-background {
  background-color: #000;
}
.blue {
  color: #0000bf;
}
.blue-background {
  background-color: #0000fa;
}
.fuchsia {
  color: #bf00bf;
}
.fuchsia-background {
  background-color: #fa00fa;
}
.gray {
  color: #606060;
}
.gray-background {
  background-color: #7d7d7d;
}
.green {
  color: #006000;
}
.green-background {
  background-color: #007d00;
}
.lime {
  color: #00bf00;
}
.lime-background {
  background-color: #00fa00;
}
.maroon {
  color: #600000;
}
.maroon-background {
  background-color: #7d0000;
}
.navy {
  color: #000060;
}
.navy-background {
  background-color: #00007d;
}
.olive {
  color: #606000;
}
.olive-background {
  background-color: #7d7d00;
}
.purple {
  color: #600060;
}
.purple-background {
  background-color: #7d007d;
}
.red {
  color: #bf0000;
}
.red-background {
  background-color: #fa0000;
}
.silver {
  color: #909090;
}
.silver-background {
  background-color: #bcbcbc;
}
.teal {
  color: #006060;
}
.teal-background {
  background-color: #007d7d;
}
.white {
  color: #bfbfbf;
}
.white-background {
  background-color: #fafafa;
}
.yellow {
  color: #bfbf00;
}
.yellow-background {
  background-color: #fafa00;
}
span.icon > .fa {
  cursor: default;
}
.admonitionblock td.icon [class^="fa icon-"] {
  font-size: 2.5em;
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
  cursor: default;
}
.admonitionblock td.icon .icon-note:before {
  content: "\f05a";
  color: #19407c;
}
.admonitionblock td.icon .icon-tip:before {
  content: "\f0eb";
  text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8);
  color: #111;
}
.admonitionblock td.icon .icon-warning:before {
  content: "\f071";
  color: #bf6900;
}
.admonitionblock td.icon .icon-caution:before {
  content: "\f06d";
  color: #bf3400;
}
.admonitionblock td.icon .icon-important:before {
  content: "\f06a";
  color: #bf0000;
}
.conum[data-value] {
  display: inline-block;
  color: #fff !important;
  background-color: rgba(0, 0, 0, 0.8);
  -webkit-border-radius: 100px;
  border-radius: 100px;
  text-align: center;
  font-size: 0.75em;
  width: 1.67em;
  height: 1.67em;
  line-height: 1.67em;
  font-family: "Open Sans", "DejaVu Sans", sans-serif;
  font-style: normal;
  font-weight: bold;
}
.conum[data-value] * {
  color: #fff !important;
}
.conum[data-value] + b {
  display: none;
}
.conum[data-value]:after {
  content: attr(data-value);
}
pre .conum[data-value] {
  position: relative;
  top: -0.125em;
}
b.conum * {
  color: inherit !important;
}
.conum:not([data-value]):empty {
  display: none;
}
h1,
h2 {
  letter-spacing: -0.01em;
}
dt,
th.tableblock,
td.content {
  text-rendering: optimizeLegibility;
}
p,
td.content {
  letter-spacing: -0.01em;
}
p strong,
td.content strong {
  letter-spacing: -0.005em;
}
p,
blockquote,
dt,
td.content {
  font-size: 1.0625rem;
}
p {
  margin-bottom: 1.25rem;
}
.sidebarblock p,
.sidebarblock dt,
.sidebarblock td.content,
p.tableblock {
  font-size: 1em;
}
.exampleblock > .content {
  background-color: #fffef7;
  border-color: #e0e0dc;
  -webkit-box-shadow: 0 1px 4px #e0e0dc;
  box-shadow: 0 1px 4px #e0e0dc;
}
.print-only {
  display: none !important;
}
@media print {
  @page {
    margin: 1.25cm 0.75cm;
  }
  * {
    -webkit-box-shadow: none !important;
    box-shadow: none !important;
    text-shadow: none !important;
  }
  a {
    color: inherit !important;
    text-decoration: underline !important;
  }
  a.bare,
  a[href^="#"],
  a[href^="mailto:"] {
    text-decoration: none !important;
  }
  a[href^="http:"]:not(.bare):after,
  a[href^="https:"]:not(.bare):after {
    content: "(" attr(href) ")";
    display: inline-block;
    font-size: 0.875em;
    padding-left: 0.25em;
  }
  abbr[title]:after {
    content: " (" attr(title) ")";
  }
  pre,
  blockquote,
  tr,
  img {
    page-break-inside: avoid;
  }
  thead {
    display: table-header-group;
  }
  img {
    max-width: 100% !important;
  }
  p,
  blockquote,
  dt,
  td.content {
    font-size: 1em;
    orphans: 3;
    widows: 3;
  }
  h2,
  h3,
  #toctitle,
  .sidebarblock > .content > .title {
    page-break-after: avoid;
  }
  #toc,
  .sidebarblock,
  .exampleblock > .content {
    background: none !important;
  }
  #toc {
    border-bottom: 1px solid #ddddd8 !important;
    padding-bottom: 0 !important;
  }
  .sect1 {
    padding-bottom: 0 !important;
  }
  .sect1 + .sect1 {
    border: 0 !important;
  }
  #header > h1:first-child {
    margin-top: 1.25rem;
  }
  body.book #header {
    text-align: center;
  }
  body.book #header > h1:first-child {
    border: 0 !important;
    margin: 2.5em 0 1em 0;
  }
  body.book #header .details {
    border: 0 !important;
    display: block;
    padding: 0 !important;
  }
  body.book #header .details span:first-child {
    margin-left: 0 !important;
  }
  body.book #header .details br {
    display: block;
  }
  body.book #header .details br + span:before {
    content: none !important;
  }
  body.book #toc {
    border: 0 !important;
    text-align: left !important;
    padding: 0 !important;
    margin: 0 !important;
  }
  body.book #toc,
  body.book #preamble,
  body.book h1.sect0,
  body.book .sect1 > h2 {
    page-break-before: always;
  }
  .listingblock code[data-lang]:before {
    display: block;
  }
  #footer {
    background: none !important;
    padding: 0 0.9375em;
  }
  #footer-text {
    color: rgba(0, 0, 0, 0.6) !important;
    font-size: 0.9em;
  }
  .hide-on-print {
    display: none !important;
  }
  .print-only {
    display: block !important;
  }
  .hide-for-print {
    display: none !important;
  }
  .show-for-print {
    display: inherit !important;
  }
}

.pygments .highlight pre,
pre > code {
  color: #f8f8f2 !important;
}

/*Custom CSS*/
body {
  background: #f5f5f5;
}
#header-main-title {
  float: left;
}
#cards {
  clear: both;
}
#cards .btn-primary {
  background-color: #e44c3a;
  border-color: #e44c3a;
}
#asciinema-player-section {
  margin-bottom: 25px;
}
.logo {
  width: 70%;
  padding-top: 20px;
  padding-bottom: 10px;
}
#main-row {
  min-height: 100%;
  height: 100%;
}
#toc {
  border-bottom: none;
  overflow-y: auto;
  margin: 0;
  top: 0px;
  z-index: 9;
}

#toc .nav-link {
  font-size: 13px;
}
.toc {
  margin-top: 116px;
  word-break: break-all;
  max-width: 223px;
}
#toctitle {
  font-size: 1.2em;
}
#aws-link {
  width: 80%;
}
.sectlevel1 {
  padding-left: 7px;
}
/* .border-columns{ */
/* background-color: #2E3336; */
/* } */
.footer {
  display: block;
  bottom: 0;
  width: 75%;
  height: 40px;
  line-height: 40px;
  background-color: #2e3336;
  margin: 0 auto;
}
.footer > .container {
  padding-right: 15px;
  padding-left: 15px;
}
nav[data-toggle="toc"] .nav > li > a {
  display: block;
  padding: 4px 20px;
  font-size: 13px;
  font-weight: 500;
  color: rgba(0, 0, 0, 0.65);
}
nav[data-toggle="toc"] .nav > li > a:hover {
  background-color: #e44c3a;
  color: rgba(0, 0, 0, 0.65);
}
.text-muted {
  color: rgba(0, 0, 0, 0.65) !important;
}
nav[data-toggle="toc"] .nav .nav > li > a,
nav[data-toggle="toc"] .nav .nav > li > a:focus,
nav[data-toggle="toc"] .nav .nav > li > a:hover {
  padding-left: 10px;
}
nav[data-toggle="toc"] .nav .nav > li > .active,
nav[data-toggle="toc"] .nav .nav > li > .active:focus,
nav[data-toggle="toc"] .nav .nav > li > .active:hover,
nav[data-toggle="toc"] .nav-link.active,
nav[data-toggle="toc"] .nav-link.active:focus,
nav[data-toggle="toc"] .nav-link.active:hover {
  /* padding-left: 10px; */
  font-weight: 700;
  color: #e44c3a;
  background-color: transparent;
  border-left: 2px solid #e44c3a;
}
#toc > ul > li > ul {
  margin-left: 10px;
}

/* small screens */
@media (max-width: 767px) {
  /* override stickyness so that the navigation does not follow scrolling */
  nav[data-toggle="toc"] {
    margin-bottom: 42px;
  }
  nav[data-toggle="toc"] .nav .active .nav {
    display: none;
  }
  #aws-link {
    width: 50%;
    margin-bottom: 5px;
  }
  .border-right {
    border: none !important;
  }
}

html,
body {
  height: 100%;
}

/* Scrollbar styles */
#toc::-webkit-scrollbar {
  width: 3px;
}

/* Track */
#toc::-webkit-scrollbar-track {
  background: transparent;
}

/* Handle */
#toc::-webkit-scrollbar-thumb {
  background: rgb(182, 182, 182);
}

/* Handle on hover */
#toc::-webkit-scrollbar-thumb:hover {
  background: rgb(163, 163, 163);
}

/* Gernal styles */
.toggle-nav-btn {
  position: absolute;
  right: 30px;
  top: 34px;
}
.bd-sidebar {
  height: 100vh !important;
}
.bd-sidebar .nav > li > a {
  padding: 4px 20px;
  font-size: 13px;
  font-weight: 500;
  color: rgba(0, 0, 0, 0.65);
  padding-left: 12px;
}
.main-link {
  border-left: 2px solid #e44c3a;
  color: #ba3925 !important;
  cursor: pointer;
  font-weight: bold;
}

/* card styles */
.card-wrapper {
  height: min-content;
  -webkit-box-shadow: 0 0 30px rgba(0, 0, 0, 0.1); /* Safari 3-4, iOS 4.0.2 - 4.2, Android 2.3+ */
  -moz-box-shadow: 0 0 30px rgba(0, 0, 0, 0.1); /* Firefox 3.5 - 3.6 */
  box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
}
.card-wrapper .card-body {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}
.card-wrapper .content .card-text {
  margin-bottom: 12px;
}
.card-wrapper .card-body .card-title {
  color: #e44c3a;
  font-size: 22px;
  font-weight: 500;
}
.LogoAndToggle {
  border-bottom: 1px solid gainsboro;
  margin: 0px;
  display: block;
  padding-bottom: 12px;
  background: whitesmoke;
  padding-top: 4px;
}
/* media quires */
@media (max-width: 767px) {
  .bd-sidebar {
    height: 100px !important;
    border: 0;
  }

  #toc {
    min-width: 100%;
    padding-top: 15px;
  }
  #toc.show {
    border-bottom: none;
    left: 0;
    min-width: 100%;
    margin: 0;
    padding-top: 15px;
    box-shadow: 0px 7px 10px 2px #ababab3b;
  }
  .LogoAndToggle {
    display: flex;
    justify-content: space-around;
    width: 100%;
    margin: 0;
  }
  .bd-links {
    background: white;
    z-index: 9;
    position: relative;
    max-height: 300px;
    overflow-y: scroll;
    margin-top: -5px;
    border-bottom: 1px solid #d6d6d6;
  }
}
@media (min-width: 768px) {
  .bd-links {
    height: 100% !important;
    overflow-y: auto;
    display: block !important;
  }
  #toc {
    position: relative;
    top: 0;
    max-width: 100%;
    margin: 0;
    padding-left: 10px;
  }
  .toc {
    /* height: calc(100vh - 97px) !important; */
    height: calc(100vh - 160px) !important;
  }
  .bd-sidebar {
    padding-right: 20px;
    top: 0 !important;
  }
}

.bdr-right {
  border-right: 1px solid gainsboro;
}
.bdr-left {
  border-left: 1px solid gainsboro;
}

nav[data-toggle="toc"] .nav > li > a:focus,
nav[data-toggle="toc"] .nav > li > a:hover {
  border-left: 2px solid #e44c3a;
}
nav[data-toggle="toc"] .nav > li > a:hover {
  background-color: #ba39251a;
  color: rgba(0, 0, 0, 0.65);
}
/* pre.pygments .tok-n , pre.pygments .tok-p{
    color: rgba(0,0,0,.9) !important;
} */

table.linenotable {
  width: 100%;
}
.pygments code {
  width: max-content;
  overflow-x: auto;
  display: block;
  min-width: 100%;
}
.bd-search {
  padding: 0;
  margin: auto;
  padding-bottom: 10px;
  padding-top: 10px;
}
@media (max-width: 767px) {
  .bd-search {
    background-color: white;
    border-bottom: 1px solid #ddddd7;
  }
}
.bd-search .algolia-autocomplete {
  width: 100%;
}
.bd-search input {
  border-color: #3333331c;
  left: 0px;
  margin: auto;
  padding: 0;
  padding: 7px;
  width: 90%;
  max-width: 90%;
}

.bd-search .form-control:focus {
  border-color: #e44c3a61;
  box-shadow: 0 0 0 3px rgb(237 152 142 / 50%);
}
.bd-links {
  padding-top: 1rem;
}

/* Blue #167bb7 */
/* Green #29a9c9 */
/* Red #e44c3a */

#toc.right-side-menu ul li ul {
  padding: 0;
}
#toc.right-side-menu ul li ul {
  margin: 0;
}
#toc.right-side-menu ul li ul li a {
  padding-left: 30px !important;
  border-left: 2px solid #33333326;
}
#toc.right-side-menu ul li ul li a.active {
  padding-left: 30px !important;
  border-left: 2px solid #e44c3a;
  font-weight: 600 !important;
}

nav.right-side-menu .nav > li > a {
  display: block;
}
nav.right-side-menu > ul > li > a {
  color: #e44c3a;
  font-weight: 800 !important;
  background-color: transparent;
  border-left: 2px solid #33333326;
}
nav.right-side-menu > ul > li > a.active {
  color: #e44c3a;
  background-color: transparent;
  border-left: 2px solid #e44c3a;
}
nav[data-toggle="toc"].right-side-menu .nav-link + ul {
  display: block;
}

pre.pygments .tok-mf, pre.pygments .tok-mi{
  color: #f8f8f2 !important
}
</style>
<style>pre { line-height: 125%; }
td.linenos pre { color: #000000; background-color: #f0f0f0; padding-left: 5px; padding-right: 5px; }
span.linenos { color: #000000; background-color: #f0f0f0; padding-left: 5px; padding-right: 5px; }
td.linenos pre.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
pre.pygments .hll { background-color: #49483e }
pre.pygments { background: #272822; color: #f8f8f2 }
pre.pygments .tok-c { color: #75715e } /* Comment */
pre.pygments .tok-err { color: #960050; background-color: #1e0010 } /* Error */
pre.pygments .tok-k { color: #66d9ef } /* Keyword */
pre.pygments .tok-l { color: #ae81ff } /* Literal */
pre.pygments .tok-n { color: #f8f8f2 } /* Name */
pre.pygments .tok-o { color: #f92672 } /* Operator */
pre.pygments .tok-p { color: #f8f8f2 } /* Punctuation */
pre.pygments .tok-ch { color: #75715e } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #75715e } /* Comment.Multiline */
pre.pygments .tok-cp { color: #75715e } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #75715e } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #75715e } /* Comment.Single */
pre.pygments .tok-cs { color: #75715e } /* Comment.Special */
pre.pygments .tok-gd { color: #f92672 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-gi { color: #a6e22e } /* Generic.Inserted */
pre.pygments .tok-go { color: #66d9ef } /* Generic.Output */
pre.pygments .tok-gp { color: #f92672; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #75715e } /* Generic.Subheading */
pre.pygments .tok-kc { color: #66d9ef } /* Keyword.Constant */
pre.pygments .tok-kd { color: #66d9ef } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #f92672 } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #66d9ef } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #66d9ef } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #66d9ef } /* Keyword.Type */
pre.pygments .tok-ld { color: #e6db74 } /* Literal.Date */
pre.pygments .tok-m { color: #ae81ff } /* Literal.Number */
pre.pygments .tok-s { color: #e6db74 } /* Literal.String */
pre.pygments .tok-na { color: #a6e22e } /* Name.Attribute */
pre.pygments .tok-nb { color: #f8f8f2 } /* Name.Builtin */
pre.pygments .tok-nc { color: #a6e22e } /* Name.Class */
pre.pygments .tok-no { color: #66d9ef } /* Name.Constant */
pre.pygments .tok-nd { color: #a6e22e } /* Name.Decorator */
pre.pygments .tok-ni { color: #f8f8f2 } /* Name.Entity */
pre.pygments .tok-ne { color: #a6e22e } /* Name.Exception */
pre.pygments .tok-nf { color: #a6e22e } /* Name.Function */
pre.pygments .tok-nl { color: #f8f8f2 } /* Name.Label */
pre.pygments .tok-nn { color: #f8f8f2 } /* Name.Namespace */
pre.pygments .tok-nx { color: #a6e22e } /* Name.Other */
pre.pygments .tok-py { color: #f8f8f2 } /* Name.Property */
pre.pygments .tok-nt { color: #f92672 } /* Name.Tag */
pre.pygments .tok-nv { color: #f8f8f2 } /* Name.Variable */
pre.pygments .tok-ow { color: #f92672 } /* Operator.Word */
pre.pygments .tok-w { color: #f8f8f2 } /* Text.Whitespace */
pre.pygments .tok-mb { color: #ae81ff } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #ae81ff } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #ae81ff } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #ae81ff } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #ae81ff } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #e6db74 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #e6db74 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #e6db74 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #e6db74 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #e6db74 } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #e6db74 } /* Literal.String.Double */
pre.pygments .tok-se { color: #ae81ff } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #e6db74 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #e6db74 } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #e6db74 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #e6db74 } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #e6db74 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #e6db74 } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #f8f8f2 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #a6e22e } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #f8f8f2 } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #f8f8f2 } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #f8f8f2 } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #f8f8f2 } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #ae81ff } /* Literal.Number.Integer.Long */</style></head><body data-spy="scroll" data-target="#toc" class="book"><div class="container-fluid"><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 bd-sidebar sticky-top border-columns border-right p-0"><div class="mx-auto text-center LogoAndToggle"><a href="https://docs.killbill.io/"><img class="logo rounded mx-auto d-block img-fluid" src="https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/img/logo.png" /></a><button class="btn btn-link bd-search-docs-toggle d-md-none p-0 ml-3 toggle-nav-btn" type="button" data-toggle="collapse" data-target="#toc" aria-controls="toc" aria-expanded="false" aria-label="Toggle docs navigation"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30" width="30" height="30" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-miterlimit="10" d="M4 7h22M4 15h22M4 23h22"></path></svg></button></div><form role="search" class="bd-search d-flex align-items-center"><input type="search" class="form-control" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off" data-docs-version="4.4"></form><nav id="toc" class="collapse bd-links toc"><ul class="nav navbar-nav"><li><a class="bd-toc-link main-link">Getting started</a><ul class="nav navbar-nav"><li><a class="nav-link" href="https://docs.killbill.io/latest/what_is_kill_bill.html">What is Kill Bill?</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/getting_started.html">Quick start</a></li></ul></li></ul><ul class="nav navbar-nav"><li><a class="bd-toc-link main-link">Installation</a><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="https://docs.killbill.io/latest/aws.html">AWS Development</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/stripe_plugin.html">Kill Bill + Stripe DIY</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/userguide_deployment.html">Going to production</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/database_migrations.html">Database migrations</a></li><li><a class="nav-link" href="https://github.com/killbill/killbill/releases" onclick="getOutboundLink('https://github.com/killbill/killbill/releases'); return false;">Release&nbsp;notes</a></li></ul></li></ul><ul class="nav navbar-nav"><li><a class="bd-toc-link main-link ml-2">Manuals</a><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="https://docs.killbill.io/latest/userguide_subscription.html">Subscription&nbsp;Billing</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/userguide_payment.html">Payment processing</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/userguide_kaui.html">Kaui, the Administrative&nbsp;UI</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/userguide_analytics.html">Analytics plugin</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/userguide_configuration.html">Kill Bill&nbsp;configuration</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/internationalization.html">Kill Bill&nbsp;internationalization</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/migration_guide.html">Migrating to Kill Bill</a></li></ul></li></ul><ul class="nav navbar-nav"><li><a class="bd-toc-link main-link">Tutorials</a><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="https://docs.killbill.io/latest/plan_alignment.html">Plans alignments</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/overdue.html">Overdue system</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/consumable_in_arrear.html">In Arrear UsageBilling</a></li><li><a class="nav-link" href="https://docs.killbill.io/latest/ha.html">Hierarchical Accounts</a></li></ul></li></ul><ul class="nav navbar-nav"><li><a class="bd-toc-link main-link">Integration</a><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a href="http://killbill.github.io/slate" onclick="getOutboundLink('http://killbill.github.io/slate'); return false;">REST API reference</a></li><li><a href="https://docs.killbill.io/latest/swagger_documentation.html">Swagger UI Documentation           </a></li><li><a href="https://docs.killbill.io/latest/postman.html">Postman Integration</a></li><li><a href="https://docs.killbill.io/latest/debugging.html">Debugging</a></li><li><a href="https://docs.killbill.io/latest/push_notifications.html">Push notifications</a></li></ul></li></ul><ul class="nav navbar-nav"><li><a class="bd-toc-link main-link">Plugin development</a><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a href="https://docs.killbill.io/latest/plugin_development.html">Plugin Development</a></li><li><a href="https://docs.killbill.io/latest/plugin_use_cases.html">Special Plugin Use Cases</a></li><li><a href="https://docs.killbill.io/latest/notification_plugin.html">Notification Plugins</a></li><li><a href="https://docs.killbill.io/latest/payment_plugin.html">Payment Plugins</a></li><li><a href="https://docs.killbill.io/latest/payment_control_plugin.html">Payment Control Plugins</a></li><li><a href="https://docs.killbill.io/latest/invoice_plugin.html">Invoice Plugins</a></li><li><a href="https://docs.killbill.io/latest/catalog_plugin.html">Catalog Plugins</a></li></ul></li></ul><ul class="nav navbar-nav"><li><a class="bd-toc-link main-link">Operational guides</a><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a href="https://docs.killbill.io/latest/user_management.html">Users, Roles and Permissions</a></li><li><a href="https://docs.killbill.io/latest/plugin_management.html">Plugin Management</a></li></ul></li></ul><ul class="nav navbar-nav"><li><a class="bd-toc-link main-link">Client libraries</a><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a href="https://docs.killbill.io/latest/java_client.html">Java</a></li><li><a href="http://github.com/killbill/killbill-client-ruby" onclick="getOutboundLink('http://github.com/killbill/killbill-client-ruby'); return false;">Ruby</a></li><li><a href="http://github.com/killbill/killbill-client-php" onclick="getOutboundLink('http://github.com/killbill/killbill-client-php'); return false;">PHP</a></li><li><a href="http://github.com/killbill/killbill-client-js" onclick="getOutboundLink('http://github.com/killbill/killbill-client-js'); return false;">Node.js</a></li><li><a href="http://github.com/killbill/killbill-client-python" onclick="getOutboundLink('http://github.com/killbill/killbill-client-python'); return false;">Python</a></li><li><a href="http://github.com/killbill/kbcli" onclick="getOutboundLink('http://github.com/killbill/kbcli'); return false;">Go</a></li></ul></li></ul><ul class="nav navbar-nav"><li><a class="bd-toc-link main-link">About Kill Bill</a><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a href="https://docs.killbill.io/latest/demo.html"> Demo</a></li><li><a href="https://docs.killbill.io/latest/features.html">Features list</a></li><li><a href="https://docs.killbill.io/latest/faq.html"> FAQ</a></li></ul></li></ul><ul class="nav navbar-nav"><li><a class="bd-toc-link main-link">Internal</a><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a href="https://docs.killbill.io/latest/internal_design.html">Internal design</a></li><li><a href="https://docs.killbill.io/latest/entitlement_subsystem.html">Entitlement Subsystem</a></li><li><a href="https://docs.killbill.io/latest/invoice_subsystem.html">Invoice Subsystem</a></li><li><a href="https://docs.killbill.io/latest/development.html">Development</a></li></ul></li></ul><ul class="nav navbar-nav"><li><a class="bd-toc-link main-link">References</a><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a href="https://github.com/killbill/killbill-docs/tree/v3/swagger" onclick="getOutboundLink('https://github.com/killbill/killbill-docs/tree/v3/swagger'); return false;">Swagger&nbsp;API schema</a></li><li><a href="https://docs.killbill.io/latest/catalog.xsd">Catalog XSD reference</a></li><li><a href="https://docs.killbill.io/latest/overdue.xsd">Overdue XSD reference</a></li></ul></li></ul></nav></div><div class="col-12 col-md-9 col-xl-8 border-right"><div id="header"><h1>Kill Bill subscription guide</h1></div><div id="content"><div id="preamble"><div class="sectionbody"><div class="paragraph"><p>This is the reference guide to get started with Kill Bill Subscription Billing.</p></div></div></div>
<div class="sect1"><h2 id="intro">Introduction</h2><div class="sectionbody"><div class="paragraph"><p>Kill Bill, as a system, is composed of several components:</p></div>
<div class="ulist"><ul><li><p>The core billing platform itself, which is embedded in a web server and offers a REST api. When we refer to Kill Bill in the documentation, this is what we are referring to, unless explicitly specified</p></li><li><p>KAUI, the Kill Bill Admin UI, which is a Rails mountable engine, and communicates with the core billing platform using the REST api</p></li><li><p>A set of client libraries (Java, Ruby, PHP, Node.js, &#8230;&#8203;)</p></li></ul></div>
<div class="paragraph"><p>Let&#8217;s consider some common web-based use cases for Kill Bill. Each of these cases combines Kill Bill with custom code to implement the specific business logic required. Kill Bill solves the billing problem but not the custom flow required around the billing platform. This must be handled by the custom code, which should support the following functions:</p></div>
<div class="ulist"><ul><li><p>Offer a way for customers to select a plan from the Kill Bill catalog, which would result in the creation of a subscription</p></li><li><p>Offer a form for customers to enter their payment information, using a credit card or any other payment method. The flow will differ depending on the payment gateway and PCI compliance needs</p></li><li><p>Offer a way for customers to review and change their subscriptions</p></li><li><p>Offer a way for customers to review and change their payment methods</p></li></ul></div>
<div class="paragraph"><p>The first option is to create a custom web app, containing the application-specific business logic, that interacts with Kill Bill using the REST API.</p></div>
<div class="paragraph"><p>The second option is to embed the application-specific code inside Kill Bill. In this case no separate app is required.</p></div>
<div class="paragraph"><p>The final option would be to create a custom web app and embed Kill Bill into it. Kill Bill offers a set of Java APIs below the REST API, so it is possible to use Kill Bill as a billing library.</p></div>
<div class="sect2"><h3 id="_preliminary_requirements">Preliminary Requirements</h3><div class="paragraph"><p>Before beginning this guide, you should perform the following preliminary steps:</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>Review the <a href="https://docs.killbill.io/latest/getting_started.html">Getting started tutorial</a>.</p></li><li><p>Using the tutorial, get MySQL, Kill Bill and Kaui set up and running in Docker containers.</p></li><li><p>Set up a tenant configured with API key <code>bob</code> and API secret <code>lazar</code>.</p></li><li><p>Ensure that you have <a href="http://curl.haxx.se/">cURL</a> installed. This is only to be able to run the setup steps and examples from this documentation. In practice, your application will use one of our <a href="https://killbill.github.io/slate/">client libraries</a>.</p></li></ol></div></div></div></div>
<div class="sect1"><h2 id="components-catalog">Catalog</h2><div class="sectionbody"><div class="sect2"><h3 id="components-catalog-overview">Overview</h3><div class="paragraph"><p>The catalog is the central configuration object of Kill Bill for all of your Business rules. It contains what the customer buys (products), how the customer pays for a product (plans), change rules, prices, etc.</p></div>
<div class="paragraph"><p>In practice, the catalog is an XML file: <a href="https://github.com/killbill/killbill/blob/45fe9209ed2419b639d3472fc24dae87637d84b5/profiles/killbill/src/test/resources/org/killbill/billing/server/SpyCarBasic.xml">here</a> is a basic example we use in most of our tests and tutorials. We also have a few other examples to get you started <a href="https://github.com/killbill/killbill-docs/tree/v3/catalogs">here</a>.</p></div>
<div class="paragraph"><p>Please refer to the Catalog Configuration documentation to make Kill Bill use your own catalog.</p></div>
<div class="paragraph"><p>The catalog is one of the most complex yet powerful tools provided by Kill Bill.</p></div>
<div class="paragraph"><p>If you want to validate your catalog, you can use the catalog load-tool (where x.y.z is your current Kill Bill version):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Download the tool from maven central:</span>
curl -L -O <span class="tok-s1">&#39;http://search.maven.org/remotecontent?filepath=org/kill-bill/billing/killbill-catalog/x.y.z/killbill-catalog-x.y.z-load-tool.jar&#39;</span>
<span class="tok-c1"># Run the command</span>
java -jar killbill-catalog-*-load-tool.jar /path/to/catalog.xml</code></pre></div></div>
<div class="paragraph"><p>If you see "Success: Catalog loads!", the catalog is valid.</p></div>
<div class="paragraph"><p>Also, if you need an xsd file, you can find one <a href="http://docs.killbill.io/latest/catalog.xsd">here</a> or generate one using the catalog xsd-tool:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Download the tool from maven central:</span>
curl -L -O <span class="tok-s1">&#39;http://search.maven.org/remotecontent?filepath=org/kill-bill/billing/killbill-catalog/x.y.z/killbill-catalog-x.y.z-xsd-tool.jar&#39;</span>
<span class="tok-c1"># Run the command</span>
java -jar killbill-catalog-*-xsd-tool.jar schema.xsd</code></pre></div></div></div>
<div class="sect2"><h3 id="components-catalog-introduction">Introduction</h3><div class="paragraph"><p><span class="image"><img src="https://drive.google.com/uc?&amp;id=0Bw8rymjWckBHcU9DbnVkY1FhR2M&amp;w=960&amp;h=480" alt="uc?&amp;id=0Bw8rymjWckBHcU9DbnVkY1FhR2M&amp;w=960&amp;h=480"></span></p></div>
<div class="paragraph"><p>The Catalog is a data model that captures the core configuration of the billing system. This model is at the heart of the billing system.
It is very important that all the business logic associated with the billing behaviour of your system is captured in the billing system.
If your billing system is not capable of capturing all of the business logic it ends up being put in multiple places such as your purchase flow, Admin UI, human process etc. It becomes very difficult to keep all these places consistent, and very difficult to make changes when they are needed.</p></div>
<div class="paragraph"><p>Kill Bill provides a very powerful catalog that, unlike other billing systems, allows the administrator to set up sophisticated business rules around cancellation and plan changes.
For example, Kill Bill can just be told to Cancel a plan and it will know when to perform the cancel, based on things like the type of plan, or whether it is in trial.</p></div>
<div class="paragraph"><p>The things you can configure with the Kill Bill catalog include:</p></div>
<div class="ulist"><ul><li><p>Trials and discount phases - plans can be configured with trial and discount phases so that they move automatically between different pricing schemes</p></li><li><p>Cancellation - business rules to determine when a cancellation should happen.</p></li><li><p>Plan Change - business rules to determine when to apply upgrades and downgrades.</p></li><li><p>Which add-ons are available with which product types, so that when the customer upgrades or downgrades, add-ons that are not available are automatically cancelled</p></li><li><p>Billing Alignment - rules to determine if a Plan should be billed independently or on the account billing date.</p></li><li><p>Catalog change - ways to specify how and when catalog changes apply to new and existing subscriptions</p></li></ul></div>
<div class="paragraph"><p>Kill Bill also supports the concept of a Price List, which is a grouping of (usually discounted) plans that can be offered to a customer.</p></div>
<div class="paragraph"><p>Of course, any catalog can only support a limited number of options. When you need to go further, and many people do, you can write plugins to implement pretty much anything you need.</p></div>
<div class="sect3"><h4 id="_concepts">Concepts</h4><div class="paragraph"><p>In this section we outline some key pieces of terminology that you will need to understand. A complete Glossary is given at the end of this document.
Different billing systems use these same words to mean subtly different things so, even if you are familiar with the language, it is worth looking through exactly how we use the terms in Kill Bill.</p></div>
<div class="sect4"><h5 id="_background_concepts">Background Concepts</h5><div class="ulist"><ul><li><p><strong>Customer</strong>  someone who buys your product</p></li><li><p><strong>Administrator</strong> (or <strong>Admin</strong>)  the person who can use the Kill Bill UI to view and modify customer accounts</p></li><li><p><strong>Kill Bill Administrator</strong> (or <strong>Kill Bill Admin</strong>) - the person responsible for installing or configuring Kill Bill</p></li><li><p><strong>Account</strong>  a customer account. It represents what Kill Bill knows about a customer.</p></li><li><p><strong>Subscription</strong>  a contract between you and a customer to purchase a particular product with particular terms. In the system it associates a Plan (see below) with an Account and a start date.</p></li><li><p><strong>Subscription Bundle</strong> (or just <strong>Bundle</strong>)  a collection of subscriptions that are associated with a particular instance of a product. For example, you might have a voice plan, a data plan and a text plan for your mobile phone. In Kill Bill each plan would have its own subscription and we would represent the fact that they are associated with a single phone by grouping them in a Subscription Bundle. Of course an account might have multiple phones associated with it and a Kill Bill Account can have multiple Bundles associated with it.</p></li></ul></div></div></div>
<div class="sect3"><h4 id="_whats_in_a_catalog">Whats in a Catalog?</h4><div class="paragraph"><p>A Kill Bill Catalog includes the following sections:</p></div>
<div class="ulist"><ul><li><p><strong>Products</strong> - The things that the customer actually buys (or rents). In the example depicted at the start of the chapter, the product available for rent is a Spy Car, which is available in three different versions: <code>Standard</code>, <code>Sports</code> and <code>Super</code>.</p></li><li><p><strong>Plans</strong> - Specifications for the terms of the Subscription contract. In particular, plans define how much a customer pays for a product, and how often they pay it. For example, we could offer the Standard Spy Car product at $100 per month.</p></li><li><p><strong>Plan Phases</strong> (or just <strong>Phases</strong>) - Time periods within a subscription during which certain rules apply. Kill Bill plans can have multiple phases and each phase can have a different price and payment term. In this way, we can have plans with built in trials or discount phases. Kill Bill automatically handles the transitions between phases. In our example above the plans have two phases: they start with a 30 day trial which is free, and then move to a recurring phase at $100 per month.</p></li><li><p><strong>Price List</strong> - A collection of plans. Price Lists are normally used to group discount plans that are associated with a particular customer group. For example, MI6 might have special rental terms for their Spy Cars with the CIA. In this case they would create a CIA Price List that grouped plans with those special terms together. When CIA agents would come to the rental site, they would see plans from that price list. More importantly if they change plans, for example if they upgrade from Sports to Super to meet the needs of a particularly difficult mission, they will upgrade to the Sports plan within the CIA Price List.</p></li><li><p><strong>Billing Period</strong> - The period for which the customer is billed (e.g <code>MONTHLY</code>, <code>ANNUAL</code>, &#8230;&#8203;)</p></li><li><p><strong>Rules</strong> - The rules that determine how Kill Bill should behave when a plan is created, cancelled or changed.</p></li></ul></div></div>
<div class="sect3"><h4 id="_how_is_the_catalog_used_inside_kill_bill">How is the Catalog Used Inside Kill Bill?</h4><div class="paragraph"><p>The catalog is first used by Kill Bill at the time the user creates a subscription, then subsequently if there is a change of <code>Plan</code> (upgrade or downgrade), and then finally when the user cancels the subscription. During such operations, catalog information is retrieved to make sure the system builds the right subscription (e.g. maybe there is a <code>TRIAL</code> phase to start). Information about <strong>how</strong> to perform such operations is configured in the catalog through the <a href="http://docs.killbill.io/latest/userguide_subscription.html#_subscription_alignment_rules">Subscription Alignment Rules</a>. Examples of these rules include:</p></div>
<div class="ulist"><ul><li><p><strong>Plan Cancellation Timing</strong> - Should the customer get a pro-ration credit when the subscription is cancelled before its next renewal date?</p></li><li><p><strong>Plan Change Timing</strong> - Should a customer downgrading to a lower (paid) plan be active immediately or should the system wait for the next renewal date?</p></li></ul></div>
<div class="paragraph"><p>The catalog is also used by the invoicing system to make sure each customer is billed at the right time and for the right amount. Information about <strong>how</strong> the customer is billed and <strong>when</strong> the customer is billed is also defined in the catalog using alignments and their associated rules.</p></div>
<div class="paragraph"><p>Catalog configuration allows the Kill Bill Administrator to define whether all subscriptions attached to a customer should be invoiced at the same time, or if they should be billed separately on their own schedule. There could also be a mix of both where some are grouped together on the same invoice and others are invoiced independently. In the simplest case, the customer gets one invoice per billing period. Note that grouping subscriptions together may by default lead to some proration for a new subscription, to align it with the billing period. For further discussion of this topic see <a href="http://docs.killbill.io/latest/userguide_subscription.html#_billing_alignment_rules">Billing Alignment Rules</a>.</p></div></div>
<div class="sect3"><h4 id="_creating_the_catalog">Creating the Catalog</h4><div class="paragraph"><p>Most Kill Bill catalogs have the form of XML documents. Complex catalogs may need to be created by Java programs using a custom plugin (see <a href="http://docs.killbill.io/latest/catalog_plugin.html">Developing a Catalog Plugin</a>), while simple catalogs can be generated directly by the Kaui interface (see <a href="http://docs.killbill.io/latest/getting_started.html#_modifying_the_catalog">the Kaui Catalog Interface</a>). This section describes how to create a catalog configured to your particular needs. For this discussion we assume the catalog is an XML document.</p></div>
<div class="paragraph"><p>The XML document starts in a standard way. The main tag is <code>&lt;catalog&gt;</code>. Within the <code>catalog</code> tag you should specify the schema location.
You can use the standard schema location, as shown in the example. This schema can be found at <a href="http://docs.killbill.io/latest/catalog.xsd">XSD schema</a>.</p></div>
<div class="paragraph"><p>In most cases this schema will meet your needs. If not you can have the code generate the current schema by executing the tool killbill-catalog-x.y.z-xsd-tool.jar, where <code>x.y.z</code> is replaced by the appropriate version of Kill Bill. The tool for version <code>0.22.0</code> can be found <a href="http://search.maven.org/remotecontent?filepath=org/kill-bill/billing/killbill-catalog/0.22.0/killbill-catalog-0.22.0-xsd-tool.jar">here</a>. After downloading this tool, the schema can be generated by the following command:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span></span>java -jar killbill-catalog-x.y.z-xsd-tool.jar &lt;output_filename&gt;</code></pre></div></div>
<div class="paragraph"><p>The <strong>order of content information in the catalog is important</strong>. The first tag should be the effectiveDate (when the catalog becomes effective), then catalogName and then currencies, as shown below. Further, the catalog requires <strong>all attribute strings to be unique</strong>, and those strings <strong>cannot contain spaces</strong>.</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="xml"><span></span><span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;</span>
<span class="tok-nt">&lt;catalog</span> <span class="tok-na">xmlns:xsi=</span><span class="tok-s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
         <span class="tok-na">xsi:noNamespaceSchemaLocation=</span><span class="tok-s">&quot;https://docs.killbill.io/latest/catalog.xsd&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;effectiveDate&gt;</span>2013-02-08T00:00:00+00:00<span class="tok-nt">&lt;/effectiveDate&gt;</span>
        <span class="tok-nt">&lt;catalogName&gt;</span>SpyCarBasic<span class="tok-nt">&lt;/catalogName&gt;</span>
        <span class="tok-nt">&lt;currencies&gt;</span>
                <span class="tok-nt">&lt;currency&gt;</span>USD<span class="tok-nt">&lt;/currency&gt;</span>
                <span class="tok-nt">&lt;currency&gt;</span>GBP<span class="tok-nt">&lt;/currency&gt;</span>
        <span class="tok-nt">&lt;/currencies&gt;</span>
        ...
<span class="tok-nt">&lt;/catalog&gt;</span></code></pre></div></div>
<div class="paragraph"><p>We have now described the heading information for the catalog. The following discussions explain in depth the catalog sections that correspond to the concepts described above.</p></div></div></div>
<div class="sect2"><h3 id="_products">Products</h3><div class="paragraph"><p><span class="image"><img src="https://drive.google.com/uc?&amp;id=0Bw8rymjWckBHT3dKd0U3a1RfcUE&amp;w=960&amp;h=480" alt="uc?&amp;id=0Bw8rymjWckBHT3dKd0U3a1RfcUE&amp;w=960&amp;h=480"></span></p></div>
<div class="paragraph"><p>The Product is a representation of the thing the customer is actually buying. Specifying a Product is very straightforward. The product is described by the following parameters:</p></div>
<div class="ulist"><ul><li><p>Name - a string that is used to refer to the Product elsewhere in the catalog. For example Super.</p></li><li><p>Category - a descriptor that determines how Kill Bill allows the combining of this product with others within a bundle. The options are BASE, ADD_ON and STANDALONE. These options are explained below.</p></li><li><p>Inclusion/Exclusion lists (optional) - Lists that determine which addons can be purchased with a given base plan.</p></li></ul></div></div>
<div class="sect2"><h3 id="_plans">Plans</h3><div class="paragraph"><p><span class="image"><img src="https://drive.google.com/uc?&amp;id=0Bw8rymjWckBHcl9mb2ZDMG12LXc&amp;w=960&amp;h=480" alt="uc?&amp;id=0Bw8rymjWckBHcl9mb2ZDMG12LXc&amp;w=960&amp;h=480"></span></p></div>
<div class="paragraph"><p>Plans specify the terms of a subscription contract. Each Plan has a name and refers to the purchase of a single product. The details of a Plan are arranged by phase.
In the illustration above we are showing a Plan with a 30 day Trial followed by an unlimited recurring or "evergreen" phase.
For each phase of the Plan we need to specify:</p></div>
<div class="ulist"><ul><li><p>Phase Type - can be one of TRIAL, DISCOUNT, FIXEDTERM, EVERGREEN</p></li><li><p>Duration - the length of the phase in days, months, years or UNLIMITED</p></li><li><p>Billing Period - how frequently do we want to invoice for this phase. Can be DAILY, WEEKLY, BIWEEKLY, THIRTY_DAYS, MONTHLY, QUARTERLY, BIANNUAL, ANNUAL, BIENNIAL or NO_BILLING_PERIOD</p></li><li><p>Recurring Price - the recurring price that needs to be paid every billing period (unless no billing period was specified). The price needs to specify numeric values for every currency that the catalog supports.</p></li><li><p>Fixed Price - a fixed price charged at the beginning of the period in addition to the recurring price. This is also a multi currency price and must be specified for all currencies.</p></li><li><p>Usage Sections - these are optional and outside the scope of this tutorial.</p></li></ul></div>
<div class="paragraph"><p>Plan, Phase and Usage sections can have a <code>prettyName</code> element which would correspond to the display name (such information is subsequently available on invoice items). This is useful for instance if a product is rebranded to a new name in a subsequent version. Plan names don&#8217;t need to be updated.</p></div>
<div class="paragraph"><p>Note that unlike <code>prettyName</code>, the <code>name</code> elements need to be globally unique in the catalog and must conform to the XML <code>NCName</code> definition. This means that they cannot contain symbol characters like <code>:, @, $, %, &amp;, /, +, ,, ;,</code>, whitespace characters or parentheses, and they cannot begin with a number, dot or minus character.</p></div>
<div class="paragraph"><p>For our Spy Car catalog example we specify three plans with two phases:</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>The first phase is of type TRIAL and it has a duration of 30 days and a Billing Period set to NO_BILLING_PERIOD. There is no recurring price specified, and the fixed price is given as 0/$0.</p></li><li><p>The second phase is of type EVERGREEN. It has a Duration of UNLIMITED, a Billing Period of MONTHLY, and a recurring price of 75/$100 (or whatever is appropriate for the Product).</p></li></ol></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="xml"><span></span><span class="tok-nt">&lt;plans&gt;</span>
     <span class="tok-nt">&lt;plan</span> <span class="tok-na">name=</span><span class="tok-s">&quot;standard-monthly&quot;</span><span class="tok-nt">&gt;</span>
         <span class="tok-nt">&lt;product&gt;</span>Standard<span class="tok-nt">&lt;/product&gt;</span>
         <span class="tok-nt">&lt;initialPhases&gt;</span>
             <span class="tok-nt">&lt;phase</span> <span class="tok-na">type=</span><span class="tok-s">&quot;TRIAL&quot;</span><span class="tok-nt">&gt;</span>
                 <span class="tok-nt">&lt;duration&gt;</span>
                     <span class="tok-nt">&lt;unit&gt;</span>DAYS<span class="tok-nt">&lt;/unit&gt;</span>
                     <span class="tok-nt">&lt;number&gt;</span>30<span class="tok-nt">&lt;/number&gt;</span>
                 <span class="tok-nt">&lt;/duration&gt;</span>
                 <span class="tok-nt">&lt;billingPeriod&gt;</span>NO_BILLING_PERIOD<span class="tok-nt">&lt;/billingPeriod&gt;</span>
                 <span class="tok-nt">&lt;fixedPrice&gt;</span> <span class="tok-c">&lt;!-- empty price implies $0 --&gt;</span>
                 <span class="tok-nt">&lt;/fixedPrice&gt;</span>
             <span class="tok-nt">&lt;/phase&gt;</span>
         <span class="tok-nt">&lt;/initialPhases&gt;</span>
         <span class="tok-nt">&lt;finalPhase</span> <span class="tok-na">type=</span><span class="tok-s">&quot;EVERGREEN&quot;</span><span class="tok-nt">&gt;</span>
             <span class="tok-nt">&lt;duration&gt;</span>
                 <span class="tok-nt">&lt;unit&gt;</span>UNLIMITED<span class="tok-nt">&lt;/unit&gt;</span>
             <span class="tok-nt">&lt;/duration&gt;</span>
             <span class="tok-nt">&lt;billingPeriod&gt;</span>MONTHLY<span class="tok-nt">&lt;/billingPeriod&gt;</span>
             <span class="tok-nt">&lt;recurringPrice&gt;</span>
                 <span class="tok-nt">&lt;price&gt;</span>
                      <span class="tok-nt">&lt;currency&gt;</span>GBP<span class="tok-nt">&lt;/currency&gt;</span>
                      <span class="tok-nt">&lt;value&gt;</span>75.00<span class="tok-nt">&lt;/value&gt;</span>
                 <span class="tok-nt">&lt;/price&gt;</span>
                 <span class="tok-nt">&lt;price&gt;</span>
                      <span class="tok-nt">&lt;currency&gt;</span>USD<span class="tok-nt">&lt;/currency&gt;</span>
                      <span class="tok-nt">&lt;value&gt;</span>100.00<span class="tok-nt">&lt;/value&gt;</span>
                  <span class="tok-nt">&lt;/price&gt;</span>
             <span class="tok-nt">&lt;/recurringPrice&gt;</span>
         <span class="tok-nt">&lt;/finalPhase&gt;</span>
     <span class="tok-nt">&lt;/plan&gt;</span>
     ...
<span class="tok-nt">&lt;/plans&gt;</span></code></pre></div></div></div>
<div class="sect2"><h3 id="_product_categories">Product Categories</h3><div class="paragraph"><p>As noted above, Kill Bill supports three categories of products:</p></div>
<div class="ulist"><ul><li><p>Base Products</p></li><li><p>Add-On Products</p></li><li><p>Standalone Products</p></li></ul></div>
<div class="paragraph"><p>The terms BASE, ADD_ON, and STANDALONE represent plans that are associated with these three types of product respectively. Having an explicit representation of Add-On products allows Kill Bill to be configured to only allow purchases of add-ons with particular base plans, and to trigger appropriate cancellations automatically when the base plan changes or is cancelled.</p></div>
<div class="paragraph"><p>A Subscription Bundle is a collection of subscriptions that correspond to an individual product instance, such as all the subscriptions associated with a single cell phone, or, in our example catalog, all the subscriptions associated with the rental of a Spy Car. Subscription Bundles can either consist of a collection of subscriptions to stand-alone plans or a single Base Plan subscription with zero or more Add-On Plan subscriptions.</p></div>
<div class="paragraph"><p>The Kill Bill catalog allows you to specify the inclusion and availability of Add-On Products with associated Base Products. For example, suppose that we create some add-on products for our example catalog. Let&#8217;s add an <code>OilSlick</code> Product and a <code>RemoteControl</code> Product. Now, let&#8217;s discuss the availability and inclusion of these:</p></div>
<div class="ulist"><ul><li><p>Neither product is available in the <code>Standard</code> Plan, meaning that you cant purchase either of these add-ons if you are on <code>Standard</code>.</p></li><li><p>Both products are available on the <code>Sport</code> Plan.</p></li><li><p>RemoteControl is available on the <code>Super</code> Plan, but as we can see from the original Plan definition, <code>OilSlick</code> is already included in the <code>Super</code> Plan.</p></li></ul></div>
<div class="paragraph"><p>If we have this specified in the catalog then Kill Bill knows to disallow certain purchases, e.g. it will not allow the purchase of an <code>OilSlick</code> add-on in a Bundle with a <code>Standard</code> Base Plan.
Similarly if the Base Plan in a Bundle containing <code>Super</code> and <code>RemoteControl</code> is downgraded to <code>Standard</code>, Kill Bill knows to automatically cancel the <code>RemoteControl</code> Add-On since it is no longer available.
Finally, if the Base Plan of a Bundle containing <code>Sports</code> and <code>OilSlick</code> is upgraded to <code>Super</code>, Kill Bill knows to cancel the <code>OilSlick</code> Plan because its features are already included, by default, in the new Base Plan.</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="xml"><span></span><span class="tok-nt">&lt;products&gt;</span>
    <span class="tok-nt">&lt;product</span> <span class="tok-na">name=</span><span class="tok-s">&quot;Standard&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;category&gt;</span>BASE<span class="tok-nt">&lt;/category&gt;</span>
    <span class="tok-nt">&lt;/product&gt;</span>
    <span class="tok-nt">&lt;product</span> <span class="tok-na">name=</span><span class="tok-s">&quot;Sports&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;category&gt;</span>BASE<span class="tok-nt">&lt;/category&gt;</span>
        <span class="tok-nt">&lt;available&gt;</span>
            <span class="tok-nt">&lt;addonProduct&gt;</span>OilSlick<span class="tok-nt">&lt;/addonProduct&gt;</span>
            <span class="tok-nt">&lt;addonProduct&gt;</span>RemoteControl<span class="tok-nt">&lt;/addonProduct&gt;</span>
        <span class="tok-nt">&lt;/available&gt;</span>
    <span class="tok-nt">&lt;/product&gt;</span>
    <span class="tok-nt">&lt;product</span> <span class="tok-na">name=</span><span class="tok-s">&quot;Super&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;category&gt;</span>BASE<span class="tok-nt">&lt;/category&gt;</span>
        <span class="tok-nt">&lt;included&gt;</span>
            <span class="tok-nt">&lt;addonProduct&gt;</span>OilSlick<span class="tok-nt">&lt;/addonProduct&gt;</span>
        <span class="tok-nt">&lt;/included&gt;</span>
        <span class="tok-nt">&lt;available&gt;</span>
            <span class="tok-nt">&lt;addonProduct&gt;</span>RemoteControl<span class="tok-nt">&lt;/addonProduct&gt;</span>
        <span class="tok-nt">&lt;/available&gt;</span>
    <span class="tok-nt">&lt;/product&gt;</span>
    <span class="tok-nt">&lt;product</span> <span class="tok-na">name=</span><span class="tok-s">&quot;OilSlick&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;category&gt;</span>ADD_ON<span class="tok-nt">&lt;/category&gt;</span>
    <span class="tok-nt">&lt;/product&gt;</span>
    <span class="tok-nt">&lt;product</span> <span class="tok-na">name=</span><span class="tok-s">&quot;RemoteControl&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;category&gt;</span>ADD_ON<span class="tok-nt">&lt;/category&gt;</span>
    <span class="tok-nt">&lt;/product&gt;</span>
<span class="tok-nt">&lt;/products&gt;</span></code></pre></div></div></div>
<div class="sect2"><h3 id="_price_lists">Price lists</h3><div class="paragraph"><p><span class="image"><img src="https://drive.google.com/uc?&amp;id=0Bw8rymjWckBHTXcwbHNjTXBnYkE&amp;w=960&amp;h=480" alt="uc?&amp;id=0Bw8rymjWckBHTXcwbHNjTXBnYkE&amp;w=960&amp;h=480"></span></p></div>
<div class="paragraph"><p>Price Lists are collections of Plans, usually associated with a promotion or discount package.</p></div>
<div class="paragraph"><p>For example, we might offer special rates on our Spy Car rental package for CIA Agents, which offers 33% off for the first 3 months of hire.
To do this, we create plans similar to the ones we have already. They should have the same trial phase and the same evergreen phase, but we insert a new discount phase which, for 3 months, charges the appropriate discount.</p></div>
<div class="paragraph"><p>In this example we consider only the first of the three additional plans.</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="xml"><span></span><span class="tok-nt">&lt;plan</span> <span class="tok-na">name=</span><span class="tok-s">&quot;discount-standard-monthly&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;product&gt;</span>Standard<span class="tok-nt">&lt;/product&gt;</span>
    <span class="tok-nt">&lt;initialPhases&gt;</span>
        <span class="tok-nt">&lt;phase</span> <span class="tok-na">type=</span><span class="tok-s">&quot;TRIAL&quot;</span><span class="tok-nt">&gt;</span>
            <span class="tok-nt">&lt;duration&gt;</span>
                <span class="tok-nt">&lt;unit&gt;</span>DAYS<span class="tok-nt">&lt;/unit&gt;</span>
                <span class="tok-nt">&lt;number&gt;</span>30<span class="tok-nt">&lt;/number&gt;</span>
            <span class="tok-nt">&lt;/duration&gt;</span>
        <span class="tok-nt">&lt;billingPeriod&gt;</span>NO_BILLING_PERIOD<span class="tok-nt">&lt;/billingPeriod&gt;</span>
            <span class="tok-nt">&lt;fixedPrice&gt;</span> <span class="tok-c">&lt;!-- empty price implies $0 --&gt;</span>
            <span class="tok-nt">&lt;/fixedPrice&gt;</span>
        <span class="tok-nt">&lt;/phase&gt;</span>
        <span class="tok-nt">&lt;phase</span> <span class="tok-na">type=</span><span class="tok-s">&quot;DISCOUNT&quot;</span><span class="tok-nt">&gt;</span>
            <span class="tok-nt">&lt;duration&gt;</span>
                <span class="tok-nt">&lt;unit&gt;</span>MONTHS<span class="tok-nt">&lt;/unit&gt;</span>
                <span class="tok-nt">&lt;number&gt;</span>3<span class="tok-nt">&lt;/number&gt;</span>
            <span class="tok-nt">&lt;/duration&gt;</span>
            <span class="tok-nt">&lt;billingPeriod&gt;</span>MONTHLY<span class="tok-nt">&lt;/billingPeriod&gt;</span>
            <span class="tok-nt">&lt;recurringPrice&gt;</span>
                <span class="tok-nt">&lt;price&gt;</span>
                    <span class="tok-nt">&lt;currency&gt;</span>GBP<span class="tok-nt">&lt;/currency&gt;</span>
                    <span class="tok-nt">&lt;value&gt;</span>50.00<span class="tok-nt">&lt;/value&gt;</span>
                <span class="tok-nt">&lt;/price&gt;</span>
                <span class="tok-nt">&lt;price&gt;</span>
                    <span class="tok-nt">&lt;currency&gt;</span>USD<span class="tok-nt">&lt;/currency&gt;</span>
                    <span class="tok-nt">&lt;value&gt;</span>66.00<span class="tok-nt">&lt;/value&gt;</span>
                <span class="tok-nt">&lt;/price&gt;</span>
            <span class="tok-nt">&lt;/recurringPrice&gt;</span>
        <span class="tok-nt">&lt;/phase&gt;</span>
    <span class="tok-nt">&lt;/initialPhases&gt;</span>
    <span class="tok-nt">&lt;finalPhase</span> <span class="tok-na">type=</span><span class="tok-s">&quot;EVERGREEN&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;duration&gt;</span>
            <span class="tok-nt">&lt;unit&gt;</span>UNLIMITED<span class="tok-nt">&lt;/unit&gt;</span>
        <span class="tok-nt">&lt;/duration&gt;</span>
        <span class="tok-nt">&lt;billingPeriod&gt;</span>MONTHLY<span class="tok-nt">&lt;/billingPeriod&gt;</span>
        <span class="tok-nt">&lt;recurringPrice&gt;</span>
            <span class="tok-nt">&lt;price&gt;</span>
                <span class="tok-nt">&lt;currency&gt;</span>GBP<span class="tok-nt">&lt;/currency&gt;</span>
                <span class="tok-nt">&lt;value&gt;</span>75.00<span class="tok-nt">&lt;/value&gt;</span>
            <span class="tok-nt">&lt;/price&gt;</span>
            <span class="tok-nt">&lt;price&gt;</span>
                <span class="tok-nt">&lt;currency&gt;</span>USD<span class="tok-nt">&lt;/currency&gt;</span>
                <span class="tok-nt">&lt;value&gt;</span>100.00<span class="tok-nt">&lt;/value&gt;</span>
            <span class="tok-nt">&lt;/price&gt;</span>
        <span class="tok-nt">&lt;/recurringPrice&gt;</span>
    <span class="tok-nt">&lt;/finalPhase&gt;</span>
<span class="tok-nt">&lt;/plan&gt;</span></code></pre></div></div>
<div class="paragraph"><p>Once our additional plans have been created, we can add the new pricelist, after the default price list:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="xml"><span></span><span class="tok-nt">&lt;priceLists&gt;</span>
    <span class="tok-nt">&lt;defaultPriceList</span> <span class="tok-na">name=</span><span class="tok-s">&quot;DEFAULT&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;plans&gt;</span>
            <span class="tok-nt">&lt;plan&gt;</span>standard-monthly<span class="tok-nt">&lt;/plan&gt;</span>
            <span class="tok-nt">&lt;plan&gt;</span>sports-monthly<span class="tok-nt">&lt;/plan&gt;</span>
            <span class="tok-nt">&lt;plan&gt;</span>super-monthly<span class="tok-nt">&lt;/plan&gt;</span>
        <span class="tok-nt">&lt;/plans&gt;</span>
    <span class="tok-nt">&lt;/defaultPriceList&gt;</span>
    <span class="tok-nt">&lt;childPriceList</span> <span class="tok-na">name=</span><span class="tok-s">&quot;CIA&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;plans&gt;</span>
            <span class="tok-nt">&lt;plan&gt;</span>discount-standard-monthly<span class="tok-nt">&lt;/plan&gt;</span>
            <span class="tok-nt">&lt;plan&gt;</span>discount-sports-monthly<span class="tok-nt">&lt;/plan&gt;</span>
            <span class="tok-nt">&lt;plan&gt;</span>discount-super-monthly<span class="tok-nt">&lt;/plan&gt;</span>
        <span class="tok-nt">&lt;/plans&gt;</span>
    <span class="tok-nt">&lt;/childPriceList&gt;</span>
<span class="tok-nt">&lt;/priceLists&gt;</span></code></pre></div></div>
<div class="paragraph"><p>The alignment and price list change rules can be used to specify the behaviour to use when changing pricelists.
In the example above, we would expect customers to be able to upgrade and downgrade within the discount phase of the subscription and stay in the discounted price list.
We refer to this as a sticky price list. Kill Bill can also support non-sticky price lists, in which plan changes cause the customer to drop out of the pricelist that they are in and move to a different one (usually the Default).
In the section on rules we explain how to configure these properties.</p></div></div>
<div class="sect2"><h3 id="_rules">Rules</h3><div class="paragraph"><p>There are several different <strong>Rules</strong> that can be configured in the Kill Bill Catalog. Each Rule answers a specific question.
For example, one of the Rules answers the question "When should this plan change be applied?".
Suppose Kill Bill receives a request for a subscription to have its plan upgraded, Kill Bill will check the rules, and based on the current plan, the phase it is in, the new plan etc. Kill Bill can determine whether the transition should happen immediately, or be deferred until later.</p></div>
<div class="paragraph"><p>Rules consist of a series of Cases. Each Case is represented by a Predicate and a Result.
Rules are evaluated against a Context. Each Case is examined in order, and the Predicate for that Case is compared to the Context.
If the Predicate is satisfied by the Context, then the Result of that Case is applied.</p></div>
<div class="paragraph"><p>For example, consider the following rule for the timing of applying a plan change:</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>Predicate: phaseType=TRIAL ; Result: IMMEDIATE</p></li><li><p>Predicate: phaseType=Evergreen AND fromProduct=Sports AND toProduct=Standard ; Result: END_OF_TERM</p></li><li><p>Predicate: ; Result: END_OF_TERM</p></li></ol></div>
<div class="paragraph"><p>In this example there are three cases. The cases are evaluated from first to last and the first case for which the predicate matches the context is the one that is successful.</p></div>
<div class="paragraph"><p>Consider the following Context:</p></div>
<table class="tableblock frame-all grid-all spread"><colgroup><col style="width: 50%;"><col style="width: 50%;"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">phaseType</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">EVERGREEN</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">fromProduct</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Sports</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">fromProductCategory</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">BASE</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">fromBillingPeriod</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">MONTHLY</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">fromPriceList</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">DEFAULT</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">toProduct</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Standard</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">toProductCategory</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">BASE</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">toBillingPeriod</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">MONTHLY</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">toPriceList</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">DEFAULT</p></td></tr></tbody></table>
<div class="paragraph"><p>To evaluate the Rule against this Context, we start by considering Case 1.
The predicate in Case 1 requires that PhaseType=TRIAL, but the first line of our context has phaseType set to EVERGREEN, so Case 1 fails.
However, when we consider Case 2, all the predicate clauses are satisfied by the above context: phaseType=Evergreen, fromProduct=Sports and toProduct=Standard.
So, Case 2 succeeds and the Rule evaluates to "END_OF_TERM".</p></div>
<div class="paragraph"><p>Notice that the predicates only need to specify the values of some of the fields in the context. Fields that are omitted in a predicate can take any value. For this reason Case 3 is a catch-all Case.
It always succeeds because the predicate has no clauses so it will succeed with any Context.</p></div>
<div class="paragraph"><p>The XML for the above rules is given below:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="xml"><span></span><span class="tok-nt">&lt;rules&gt;</span>
...
    <span class="tok-nt">&lt;changePolicy&gt;</span>
        <span class="tok-nt">&lt;changePolicyCase&gt;</span>
            <span class="tok-nt">&lt;phaseType&gt;</span>TRIAL<span class="tok-nt">&lt;/phaseType&gt;</span>
            <span class="tok-nt">&lt;policy&gt;</span>IMMEDIATE<span class="tok-nt">&lt;/policy&gt;</span>
        <span class="tok-nt">&lt;/changePolicyCase&gt;</span>
        <span class="tok-nt">&lt;changePolicyCase&gt;</span>
            <span class="tok-nt">&lt;phaseType&gt;</span>EVERGREEN<span class="tok-nt">&lt;/phaseType&gt;</span>
            <span class="tok-nt">&lt;fromProduct&gt;</span>Sports<span class="tok-nt">&lt;/fromProduct&gt;</span>
            <span class="tok-nt">&lt;toProduct&gt;</span>Standard<span class="tok-nt">&lt;/toProduct&gt;</span>
            <span class="tok-nt">&lt;policy&gt;</span>END_OF_TERM<span class="tok-nt">&lt;/policy&gt;</span>
        <span class="tok-nt">&lt;/changePolicyCase&gt;</span>
        <span class="tok-nt">&lt;changePolicyCase&gt;</span>
            <span class="tok-nt">&lt;policy&gt;</span>END_OF_TERM<span class="tok-nt">&lt;/policy&gt;</span>
        <span class="tok-nt">&lt;/changePolicyCase&gt;</span>
    <span class="tok-nt">&lt;/changePolicy&gt;</span>
...
<span class="tok-nt">&lt;/rules&gt;</span></code></pre></div></div>
<div class="paragraph"><p>There are three types of Context:</p></div>
<div class="ulist"><ul><li><p>Creation Context - provides the context for a new subscription</p></li><li><p>Subscription Context - provides the context of an existing subscription, including details of the plan, phase, pricelist, product etc.</p></li><li><p>Change Context - provides the context not only about the phase of the current subscription but also details of the new target plan. This is used in the event of a plan change.</p></li></ul></div>
<table class="tableblock frame-all grid-all spread"><colgroup><col style="width: 33.3333%;"><col style="width: 33.3333%;"><col style="width: 33.3334%;"></colgroup><thead><tr><th class="tableblock halign-left valign-top">Creation Context</th><th class="tableblock halign-left valign-top">Subscription Context</th><th class="tableblock halign-left valign-top">Change Context</th></tr></thead><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">product</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">product</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">phaseType</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">productCategory</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">productCategory</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">fromProduct</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">billingPeriod</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">billingPeriod</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">fromProductCategory</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">priceList</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">priceList</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">fromBillingPeriod</p></td></tr><tr><td class="tableblock halign-left valign-top"></td><td class="tableblock halign-left valign-top"><p class="tableblock">phaseType</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">fromPriceList</p></td></tr><tr><td class="tableblock halign-left valign-top"></td><td class="tableblock halign-left valign-top"></td><td class="tableblock halign-left valign-top"><p class="tableblock">toProduct</p></td></tr><tr><td class="tableblock halign-left valign-top"></td><td class="tableblock halign-left valign-top"></td><td class="tableblock halign-left valign-top"><p class="tableblock">toProductCategory</p></td></tr><tr><td class="tableblock halign-left valign-top"></td><td class="tableblock halign-left valign-top"></td><td class="tableblock halign-left valign-top"><p class="tableblock">toBillingPeriod</p></td></tr><tr><td class="tableblock halign-left valign-top"></td><td class="tableblock halign-left valign-top"></td><td class="tableblock halign-left valign-top"><p class="tableblock">toPriceList</p></td></tr></tbody></table>
<div class="paragraph"><p>In the remainder of this section we illustrate each type of rule supported by the system.</p></div></div>
<div class="sect2"><h3 id="_billing_alignment_rules">Billing Alignment Rules</h3><div class="paragraph"><p>Billing alignment is concerned with specifying the day on which a particular subscription is to be billed. If an account has multiple subscriptions it is often desirable that they be billed on the same day.</p></div>
<div class="paragraph"><p>If the billing period for a subscription is MONTHLY or a multiple of MONTHLY (such as QUARTERLY, ANNUAL, etc.) then we define the Bill Cycle Day (BCD). This is the date on which the billing occurs for that subscription each month. If multiple subscriptions have the same BCD, they may be billed on the same invoice. However, if the BCD for a new subscription differs from its start date, then the initial bill will have to be prorated. This will also occur anytime the BCD for a subscription is changed.</p></div>
<div class="paragraph"><p>If a BCD falls on a date past the end of a given month, such as April 31, it will be set to the last day of that month.</p></div>
<div class="paragraph"><p>The Billing Alignment Rules specify the policy for billing alignment for the current subscription. There are three kinds of alignment available:</p></div>
<div class="ulist"><ul><li><p>ACCOUNT - this alignment means that the billing cycle of the subscription will be lined up with the BCD of the account. If a day value is not specified, the system will generate one using the first recurring bill date of all subscriptions with an <code>ACCOUNT</code> billing alignment. In some cases this is undesirable, because it means that the bill amount will need to be prorated on the first billing to line up the cycles.</p></li><li><p>SUBSCRIPTION - this alignment will cause the subscription&#8217;s bill cycle to line up with the first bill day of the subscription plan. For example, if the subscription starts on January 3rd and has a 15 day free trial, the first billed day will be January 18th, and the BCD for the subscription will be set to 18.</p></li><li><p>BUNDLE - this alignment sets the BCD to the same day the base plan is using. This may be useful for add-ons.</p></li></ul></div>
<div class="paragraph"><p>For example, suppose we have a MONTHLY subscription, billed on the 15th of the month, and we add an ANNUAL subscription.
If we start the ANNUAL on the 8th, we have 2 choices:</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>We can use an ACCOUNT alignement, so everything gets invoiced on the 15th. This would require an initial proration for the ANNUAL subscription from the 8th to the 15th, to align it with the MONTHLY subscription.</p></li><li><p>We can use a SUBSCRIPTION alignment and keep the ANNUAL on its own invoice, once a year on the 8th. This avoids any leading proration, but requires separate invoices.</p></li></ol></div>
<div class="paragraph"><p>The next example will align addons with the base plan, monthlies to the Account bill cycle day and annuals to their first billed day. Anything else is aligned with the Account.</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="xml"><span></span><span class="tok-nt">&lt;billingAlignment&gt;</span>
    <span class="tok-nt">&lt;billingAlignmentCase&gt;</span>
        <span class="tok-nt">&lt;productCategory&gt;</span>ADD_ON<span class="tok-nt">&lt;/productCategory&gt;</span>
        <span class="tok-nt">&lt;alignment&gt;</span>BUNDLE<span class="tok-nt">&lt;/alignment&gt;</span>
    <span class="tok-nt">&lt;/billingAlignmentCase&gt;</span>
    <span class="tok-nt">&lt;billingAlignmentCase&gt;</span>
        <span class="tok-nt">&lt;billingPeriod&gt;</span>MONTHLY<span class="tok-nt">&lt;/billingPeriod&gt;</span>
        <span class="tok-nt">&lt;alignment&gt;</span>ACCOUNT<span class="tok-nt">&lt;/alignment&gt;</span>
    <span class="tok-nt">&lt;/billingAlignmentCase&gt;</span>
    <span class="tok-nt">&lt;billingAlignmentCase&gt;</span>
        <span class="tok-nt">&lt;billingPeriod&gt;</span>ANNUAL<span class="tok-nt">&lt;/billingPeriod&gt;</span>
        <span class="tok-nt">&lt;alignment&gt;</span>SUBSCRIPTION<span class="tok-nt">&lt;/alignment&gt;</span>
    <span class="tok-nt">&lt;/billingAlignmentCase&gt;</span>
    <span class="tok-nt">&lt;billingAlignmentCase&gt;</span>
        <span class="tok-nt">&lt;alignment&gt;</span>ACCOUNT<span class="tok-nt">&lt;/alignment&gt;</span>
    <span class="tok-nt">&lt;/billingAlignmentCase&gt;</span>
<span class="tok-nt">&lt;/billingAlignment&gt;</span></code></pre></div></div></div>
<div class="sect2"><h3 id="_subscription_alignment_rules">Subscription Alignment Rules</h3><div class="sect3"><h4 id="_plan_creation_add_on_phase_alignment">Plan Creation Add-On Phase Alignment</h4><div class="paragraph"><p>This rule also uses the Creation Context and determines how the phases of an Add-On plan align with an existing subscription.</p></div>
<div class="paragraph"><p><span class="image"><img src="https://drive.google.com/uc?&amp;id=0Bw8rymjWckBHaDN0Y0NIbTFCaU0&amp;w=960&amp;h=480" alt="uc?&amp;id=0Bw8rymjWckBHaDN0Y0NIbTFCaU0&amp;w=960&amp;h=480"></span></p></div>
<div class="paragraph"><p>There are two choices (illustrated above):</p></div>
<div class="ulist"><ul><li><p>START_OF_BUNDLE - causes the phases of the add-on to start on the date when the base plan was first created. This is useful, for instance, if you want to allow add-on trials during the trial phase of the base plan only. The add-on plans must have a trial of the same length as the base plan, so the trials will expire at the same time whenever the add-on is created.</p></li><li><p>START_OF_SUBSCRIPTION - this causes the phases of the add-on to start when the add-on subscription is created. This is useful, for instance, if you want to allow add-ons to have trials that occur independently of the base plan.</p></li></ul></div>
<div class="paragraph"><p>Example:</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>Predicate: product=OilSlick ; Result: START_OF_BUNDLE</p></li><li><p>Predicate: product=RemoteControl ; Result: START_OF_SUBSCRIPTION</p></li><li><p>Predicate: ; Result: START_OF_BUNDLE</p></li></ol></div>
<div class="paragraph"><p>In this example the product <code>OilSlick</code> is aligned to the START_OF_BUNDLE and the product <code>RemoteControl</code> is aligned to START_OF_SUBSCRIPTION. The default for anything else is START_OF_BUNDLE.</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="xml"><span></span><span class="tok-nt">&lt;createAlignment&gt;</span>
    <span class="tok-nt">&lt;createAlignmentCase&gt;</span>
        <span class="tok-nt">&lt;product&gt;</span>OilSlick<span class="tok-nt">&lt;/product&gt;</span>
        <span class="tok-nt">&lt;alignment&gt;</span>START_OF_BUNDLE<span class="tok-nt">&lt;/alignment&gt;</span>
    <span class="tok-nt">&lt;/createAlignmentCase&gt;</span>
    <span class="tok-nt">&lt;createAlignmentCase&gt;</span>
        <span class="tok-nt">&lt;product&gt;</span>RemoteControl<span class="tok-nt">&lt;/product&gt;</span>
        <span class="tok-nt">&lt;alignment&gt;</span>START_OF_SUBSCRIPTION<span class="tok-nt">&lt;/alignment&gt;</span>
    <span class="tok-nt">&lt;/createAlignmentCase&gt;</span>
    <span class="tok-nt">&lt;createAlignmentCase&gt;</span>
        <span class="tok-nt">&lt;alignment&gt;</span>START_OF_BUNDLE<span class="tok-nt">&lt;/alignment&gt;</span>
    <span class="tok-nt">&lt;/createAlignmentCase&gt;</span>
<span class="tok-nt">&lt;/createAlignment&gt;</span></code></pre></div></div>
<div class="paragraph"><p>For more information on <code>Plan Creation Phase Alignment</code>, and in particular to understand how that works with apis (Subscription Create or Subscription Change Plan) that specify a target <code>PhaseType</code>, you can also refer to this <a href="http://docs.killbill.io/latest/plan_alignment.html">documentation</a>.</p></div></div>
<div class="sect3"><h4 id="_plan_cancellation_timing">Plan Cancellation Timing</h4><div class="paragraph"><p>This rule uses the Phase Context and is used to specify when a cancellation should occur.</p></div>
<div class="paragraph"><p><span class="image"><img src="https://drive.google.com/uc?&amp;id=0Bw8rymjWckBHTjRMVkZjbUZ3OFE&amp;w=960&amp;h=480" alt="uc?&amp;id=0Bw8rymjWckBHTjRMVkZjbUZ3OFE&amp;w=960&amp;h=480"></span></p></div>
<div class="paragraph"><p>There are two options (illustrated above):</p></div>
<div class="ulist"><ul><li><p>END_OF_TERM - means that the cancellation will be applied at the end of the billed period. This is typical in a situation where we want to avoid generating credits.</p></li><li><p>IMMEDIATE - means that the cancellation will be applied immediately and the customer credited with the balance of the subscription that they have paid for but not yet used.</p></li></ul></div>
<div class="paragraph"><p>Example:</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>Predicate: productCategory=BASE ; Result: END_OF_TERM</p></li><li><p>Predicate: productCategory=ADD_ON ; Result: IMMEDIATE</p></li><li><p>Predicate: ; Result: END_OF_TERM</p></li></ol></div>
<div class="paragraph"><p>In this example base plans are cancelled at the end of their term, while add-on plans are cancelled immediately.</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="xml"><span></span><span class="tok-nt">&lt;cancelPolicy&gt;</span>
    <span class="tok-nt">&lt;cancelPolicyCase&gt;</span>
        <span class="tok-nt">&lt;productCategory&gt;</span>BASE<span class="tok-nt">&lt;/productCategory&gt;</span>
        <span class="tok-nt">&lt;policy&gt;</span>END_OF_TERM<span class="tok-nt">&lt;/policy&gt;</span>
    <span class="tok-nt">&lt;/cancelPolicyCase&gt;</span>
    <span class="tok-nt">&lt;cancelPolicyCase&gt;</span>
        <span class="tok-nt">&lt;productCategory&gt;</span>ADD_ON<span class="tok-nt">&lt;/productCategory&gt;</span>
        <span class="tok-nt">&lt;policy&gt;</span>IMMEDIATE<span class="tok-nt">&lt;/policy&gt;</span>
    <span class="tok-nt">&lt;/cancelPolicyCase&gt;</span>
    <span class="tok-nt">&lt;cancelPolicyCase&gt;</span>
        <span class="tok-nt">&lt;policy&gt;</span>END_OF_TERM<span class="tok-nt">&lt;/policy&gt;</span>
    <span class="tok-nt">&lt;/cancelPolicyCase&gt;</span>
<span class="tok-nt">&lt;/cancelPolicy&gt;</span></code></pre></div></div></div>
<div class="sect3"><h4 id="_plan_change_timing">Plan Change Timing</h4><div class="paragraph"><p>This rule uses the Change Context and, like the cancellation rule above, specifies when a plan change should occur.</p></div>
<div class="paragraph"><p><span class="image"><img src="https://drive.google.com/uc?&amp;id=0Bw8rymjWckBHV2huVmFqSlkwQ1E&amp;w=960&amp;h=480" alt="uc?&amp;id=0Bw8rymjWckBHV2huVmFqSlkwQ1E&amp;w=960&amp;h=480"></span></p></div>
<div class="paragraph"><p>There are three options (two of which are illustrated above):</p></div>
<div class="ulist"><ul><li><p>END_OF_TERM - specifies that the change should happen at the end of the current billed period.</p></li><li><p>IMMEDIATE - specifies that the change should happen when requested.</p></li><li><p>ILLEGAL - plan change is not allowed (not illustrated).</p></li></ul></div>
<div class="paragraph"><p>Example:</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>Predicate: phaseType=TRIAL ; Result: IMMEDIATE</p></li><li><p>Predicate: fromProduct=Standard AND toProduct=Sports ; Result: IMMEDIATE</p></li><li><p>Predicate: toProduct=Super ; Result: IMMEDIATE</p></li><li><p>Predicate: ; Result: END_OF_TERM</p></li></ol></div>
<div class="paragraph"><p>In this example we specify that trials and upgrades occur immediately, anything else is to occur at end of term.</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="xml"><span></span><span class="tok-nt">&lt;changePolicy&gt;</span>
    <span class="tok-nt">&lt;changePolicyCase&gt;</span>
        <span class="tok-nt">&lt;phaseType&gt;</span>TRIAL<span class="tok-nt">&lt;/phaseType&gt;</span>
        <span class="tok-nt">&lt;policy&gt;</span>IMMEDIATE<span class="tok-nt">&lt;/policy&gt;</span>
    <span class="tok-nt">&lt;/changePolicyCase&gt;</span>
    <span class="tok-nt">&lt;changePolicyCase&gt;</span>
        <span class="tok-nt">&lt;fromProduct&gt;</span>Standard<span class="tok-nt">&lt;/fromProduct&gt;</span>
        <span class="tok-nt">&lt;toProduct&gt;</span>Sports<span class="tok-nt">&lt;/toProduct&gt;</span>
        <span class="tok-nt">&lt;policy&gt;</span>IMMEDIATE<span class="tok-nt">&lt;/policy&gt;</span>
    <span class="tok-nt">&lt;/changePolicyCase&gt;</span>
    <span class="tok-nt">&lt;changePolicyCase&gt;</span>
        <span class="tok-nt">&lt;toProduct&gt;</span>Super<span class="tok-nt">&lt;/toProduct&gt;</span>
        <span class="tok-nt">&lt;policy&gt;</span>IMMEDIATE<span class="tok-nt">&lt;/policy&gt;</span>
    <span class="tok-nt">&lt;/changePolicyCase&gt;</span>
    <span class="tok-nt">&lt;changePolicyCase&gt;</span>
        <span class="tok-nt">&lt;policy&gt;</span>END_OF_TERM<span class="tok-nt">&lt;/policy&gt;</span>
    <span class="tok-nt">&lt;/changePolicyCase&gt;</span>
<span class="tok-nt">&lt;/changePolicy&gt;</span></code></pre></div></div></div>
<div class="sect3"><h4 id="_plan_change_phase_alignment">Plan Change Phase Alignment</h4><div class="paragraph"><p>In the section "Plan Creation Add-on Phase Alignment" above, we specified how to align the phases of an add-on with a base plan. This rule, which uses the Change Context, specifies how the phases of a new plan should align with the phases of the existing plan when a plan is changed.</p></div>
<div class="paragraph"><p>There are four options:</p></div>
<div class="ulist"><ul><li><p>START_OF_SUBSCRIPTION - The plan phases start with the start of the subscription. This is the most common alignment and applies in most situations.</p></li><li><p>START_OF_BUNDLE - The plan phases align with the start of the base subscription. This is only meaningful for addons.</p></li><li><p>CHANGE_OF_PLAN - The plan phases start at the time of the change</p></li><li><p>CHANGE_OF_PRICELIST - The plan phases start at the time of the last change of price list</p></li></ul></div>
<div class="paragraph"><p>Example:</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>Predicate: toProductCategory=ADD_ON ; Result: START_OF_BUNDLE</p></li><li><p>Predicate: toPriceList=SpecialDiscount ; Result: CHANGE_OF_PRICELIST</p></li><li><p>Predicate: ; Result: START_OF_SUBSCRIPTION</p></li></ol></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="xml"><span></span><span class="tok-nt">&lt;changeAlignment&gt;</span>
    <span class="tok-nt">&lt;changeAlignmentCase&gt;</span>
        <span class="tok-nt">&lt;toProductCategory&gt;</span>ADD_ON<span class="tok-nt">&lt;/toProductCategory&gt;</span>
        <span class="tok-nt">&lt;alignment&gt;</span>START_OF_BUNDLE<span class="tok-nt">&lt;/alignment&gt;</span>
    <span class="tok-nt">&lt;/changeAlignmentCase&gt;</span>
    <span class="tok-nt">&lt;changeAlignmentCase&gt;</span>
        <span class="tok-nt">&lt;fromPriceList&gt;</span>SpecialDiscount<span class="tok-nt">&lt;/fromPriceList&gt;</span>
        <span class="tok-nt">&lt;toPriceList&gt;</span>SpecialDiscount<span class="tok-nt">&lt;/toPriceList&gt;</span>
        <span class="tok-nt">&lt;alignment&gt;</span>CHANGE_OF_PRICELIST<span class="tok-nt">&lt;/alignment&gt;</span>
    <span class="tok-nt">&lt;/changeAlignmentCase&gt;</span>
    <span class="tok-nt">&lt;changeAlignmentCase&gt;</span>
        <span class="tok-nt">&lt;alignment&gt;</span>START_OF_SUBSCRIPTION<span class="tok-nt">&lt;/alignment&gt;</span>
    <span class="tok-nt">&lt;/changeAlignmentCase&gt;</span>
<span class="tok-nt">&lt;/changeAlignment&gt;</span></code></pre></div></div>
<div class="paragraph"><p>In this example, add-on changes are aligned to the start of the bundle, changes to the <code>SpecialDiscount</code> price list are aligned to that change, and everything else aligns to the start of the subscription.</p></div>
<div class="paragraph"><p>For more information on <code>Plan Change Phase Alignment</code>, and in particular to understand how that works with apis (Subscription create or Subscription Change Plan) that specify a target <code>PhaseType</code>, you can also refer to this <a href="http://docs.killbill.io/latest/plan_alignment.html">documentation</a>.</p></div></div>
<div class="sect3"><h4 id="_plan_change_price_list_choice">Plan Change Price List Choice</h4><div class="paragraph"><p>This rule uses the Change Context and specifies which pricelist should be chosen for specific changes. The rule allows us to configure whether a price list is "sticky" or not.</p></div>
<div class="paragraph"><p>For example, suppose we have an affiliate pricelist with special prices for members of the CIA for Spy Car rental. Let&#8217;s say that this price list offers a 30% discount for the first 3 months of rental.</p></div>
<div class="paragraph"><p>Now, Special Agent Mills from the CIA subscribes to a <code>Sports</code> product on that price list. However, 1 month after renting the car his daughter is kidnapped and he needs additional capabilities and decides to upgrade to a <code>Super</code>.
Since he bought the original subscription on a special offer that still has two months to run we would expect the upgrade to put him into the corresponding 30% off <code>Super</code> plan and give him a further 2 months at that price. This is a sticky price list.</p></div>
<div class="paragraph"><p>Alternatively, consider long term customer 003 who has been renting the <code>Super</code> for the last 4 years but decides that she wants to save money and calls to downgrade her plan. Our representative offers her a special Rescue Pricing plan that gives her 40% off for the next year and she decides to take it.
However, a month later she changes her mind and decides to downgrade anyway. In this situation we want her to downgrade to the default price plan. This is a "non-sticky" price list.</p></div>
<div class="paragraph"><p>Example:</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>Predicate: fromPriceList=CIA ; Result: CIA</p></li><li><p>Predicate: fromPriceList=SpecialDiscount ; Result: DEFAULT</p></li><li><p>Predicate: ; Result: DEFAULT</p></li></ol></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="xml"><span></span><span class="tok-nt">&lt;priceList&gt;</span>
   <span class="tok-nt">&lt;priceListCase&gt;</span>
        <span class="tok-nt">&lt;fromPriceList&gt;</span>SpecialDiscount<span class="tok-nt">&lt;/fromPriceList&gt;</span>
        <span class="tok-nt">&lt;toPriceList&gt;</span>DEFAULT<span class="tok-nt">&lt;/toPriceList&gt;</span>
    <span class="tok-nt">&lt;/priceListCase&gt;</span>
   <span class="tok-nt">&lt;priceListCase&gt;</span>
        <span class="tok-nt">&lt;fromPriceList&gt;</span>CIA<span class="tok-nt">&lt;/fromPriceList&gt;</span>
        <span class="tok-nt">&lt;toPriceList&gt;</span>CIA<span class="tok-nt">&lt;/toPriceList&gt;</span>
    <span class="tok-nt">&lt;/priceListCase&gt;</span>
   <span class="tok-nt">&lt;priceListCase&gt;</span>
        <span class="tok-nt">&lt;toPriceList&gt;</span>DEFAULT<span class="tok-nt">&lt;/toPriceList&gt;</span>
    <span class="tok-nt">&lt;/priceListCase&gt;</span>
<span class="tok-nt">&lt;/priceList&gt;</span></code></pre></div></div></div></div>
<div class="sect2"><h3 id="_catalog_versions">Catalog Versions</h3><div class="paragraph"><p>This far in the discussion we have been considering single stand-alone catalogs, but Kill Bill allows the catalog to be modified over time. This is done by creating a set of catalogs, one XML file for each version; the system will rank such files based on their <code>effectiveDate</code> to create the various versions. There is no version number proper; the <code>effectiveDate</code> associated with each catalog XML constitutes the version and each catalog is superseded by the next. In this way we can change prices, add new Plans, Products, Price Lists etc, retire Plans, Products, Price Lists, etc.</p></div>
<div class="paragraph"><p>Note that it is possible to remove entries in subsequent catalog versions. For example, removing a <code>Plan</code> in a new catalog version would prevent future customers from subscribing to that <code>Plan</code>. However existing subscriptions may still refer to it.</p></div>
<div class="sect3"><h4 id="_deferred_price_change">Deferred Price Change</h4><div class="paragraph"><p>Kill Bill supports the ability to make a price change to a plan that applies based on the catalog effective date for new purchases, but which is deferred for existing subscriptions.
It is often the case that existing customers will need a notice period before prices are changed but you need to deliver the new prices to new purchases as soon as the change is announced.</p></div>
<div class="paragraph"><p>This feature uses the field <code>effectiveDateForExistingSubscriptions</code> that is included on Plans.
The semantics is simply that the changes to that plan will only take effect for existing subscriptions, after that date, but new subscription would use the new price immediately.</p></div>
<div class="paragraph"><p>The drawing below summarizes how the system would apply the change for an existing subscription:</p></div>
<div class="paragraph"><p><span class="image"><img src="https://drive.google.com/uc?&amp;id=0Bw8rymjWckBHZGlqWGpGRnVDeVE&amp;w=960&amp;h=480" alt="uc?&amp;id=0Bw8rymjWckBHZGlqWGpGRnVDeVE&amp;w=960&amp;h=480"></span></p></div></div></div>
<div class="sect2"><h3 id="components-catalog-usage">Usage Billing</h3><div class="sect3"><h4 id="_usage_modes">Usage Modes</h4><div class="paragraph"><p>Kill Bill supports billing customers based on their usage data, and the pricing schemes for this billing are defined in the Kill Bill catalog.
The <code>Plan</code> section of the catalog can contain one or several <code>usage</code> section(s) to define how customers will be billed.
These sections can be defined in addition to other, non usage based, billing schemes, such as fixed or recurring price.</p></div>
<div class="paragraph"><p>Each usage section will need to specify a <code>billingMode</code>.
The only billing mode supported today is the <code>IN_ARREAR</code> mode, which allows customers to be billed based on usage data from previous periods.
We plan to add the <code>IN_ADVANCE</code> mode in the future to support prepaid scenarios such as toll bridge pass, where the customer purchases a
certain number of units <strong>in advance</strong> and such units are decremented as the customer uses the service.</p></div>
<div class="paragraph"><p>Each usage section will also need to specify a <code>usageType</code> and along with it, specify the <code>unit</code> (types) for which the customer is being billed, such as cell phone/minutes.
The usage type can be one of the following:</p></div>
<div class="ulist"><ul><li><p><code>CONSUMABLE</code> : This is used for defining prices that are based on the number of units (of a certain types) being consumed&#8201;&#8212;&#8201;e.g water consumed in the last period.</p></li><li><p><code>CAPACITY</code> : This is used for defining prices that are based on rates or upper bound values. In this scheme, we bill based on the maximum value that was seen over the period&#8201;&#8212;&#8201;e.g MBytes/sec</p></li></ul></div>
<div class="paragraph"><p>The following <a href="http://killbill.io/blog/usage-billing"> blog post</a> provides additional context about these use cases.</p></div>
<div class="paragraph"><p>For each usage section, we support defining pricing <strong>tiers</strong>, allowing customers to be billed differently based on their usage.
These tiers work differently depending on the usage type, <code>CONSUMABLE</code> or <code>CAPACITY</code>.</p></div>
<div class="paragraph"><p>Each usage section also needs to define the <code>billingPeriod</code>&#8201;&#8212;&#8201;e.g <code>MONTHLY</code>&#8201;&#8212;&#8201;to define how often and for which period consumers are being billed.</p></div>
<div class="sect4"><h5 id="_consumable_in_arrear_mode">Consumable In Arrear Mode</h5><div class="paragraph"><p>In this mode, each <code>tier</code> definition contains a <code>tieredBlock</code> that defines the limits and price associated with a particular <code>unit</code> type. We support two <code>TierBlockPolicy</code> policies:</p></div>
<div class="ulist"><ul><li><p><code>ALL_TIER</code>: This policy charges users across each tier based on their usage. Higher prices are charged to the less preferred tier. This may be a lower tier, e.g for cloud usage where we want to reward users who consume more, or a higher tier, e.g for an electric bill where we want to encourage users to consume less.</p></li><li><p><code>TOP_TIER</code>: With this policy we still go through each tier, but everything is charged at the top tier pricing. Here it makes sense to offer lower pricing for the top tier, since this is a rewarding model.</p></li></ul></div></div>
<div class="sect4"><h5 id="_consumable_in_arrear_mode_all_tier">Consumable In Arrear Mode: <code>ALL_TIER</code></h5><div class="paragraph"><p>To demonstate the <code>ALL_TIER</code> policy, let&#8217;s start with an example of a <code>tieredBlock</code> definition. The following tier block section defines the pricing for the <code>cell-phone-minutes</code> unit, and can be understood the following way:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span></span>&lt;tieredBlock&gt;
    &lt;unit&gt;cell-phone-minutes&lt;/unit&gt;
    &lt;size&gt;10&lt;/size&gt;
    &lt;prices&gt;
        &lt;price&gt;
            &lt;currency&gt;EUR&lt;/currency&gt;
            &lt;value&gt;1.00&lt;/value&gt;
        &lt;/price&gt;
    &lt;/prices&gt;
    &lt;max&gt;100&lt;/max&gt;
&lt;/tieredBlock&gt;</code></pre></div></div>
<div class="ulist"><ul><li><p>This defines a block of size <code>10</code>, where each block is priced at 1.00 EUR</p></li><li><p>The first <code>100</code> blocks of this size will be priced at 1.00 EUR</p></li><li><p>If a consumer uses more than <code>100</code> blocks of this size, he will be charged at the price of the next tier.</p></li></ul></div>
<div class="paragraph"><p>As mentioned previously, each usage section can contain multiple tiers and also charge for multiple unit types.
The following section shows the defintion for 2 units, <strong>cell-phone-minutes</strong> and <strong>Mbytes</strong>, and defines two tiers.
The <code>max</code> value for the last tier is defined with <strong>-1</strong> which represents an unbounded value:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span></span>&lt;tiers&gt;
    &lt;tier&gt;
        &lt;blocks&gt;
            &lt;tieredBlock&gt;
                &lt;unit&gt;cell-phone-minutes&lt;/unit&gt;
                &lt;size&gt;10&lt;/size&gt;
                &lt;prices&gt;
                    &lt;price&gt;
                        &lt;currency&gt;EUR&lt;/currency&gt;
                        &lt;value&gt;1.00&lt;/value&gt;
                    &lt;/price&gt;
                &lt;/prices&gt;
                &lt;max&gt;100&lt;/max&gt;
            &lt;/tieredBlock&gt;
            &lt;tieredBlock&gt;
                &lt;unit&gt;Mbytes&lt;/unit&gt;
                &lt;size&gt;1&lt;/size&gt;
                &lt;prices&gt;
                    &lt;price&gt;
                        &lt;currency&gt;EUR&lt;/currency&gt;
                        &lt;value&gt;0.5&lt;/value&gt;
                    &lt;/price&gt;
                &lt;/prices&gt;
                &lt;max&gt;1024&lt;/max&gt;
            &lt;/tieredBlock&gt;
        &lt;/blocks&gt;
    &lt;/tier&gt;
    &lt;tier&gt;
        &lt;blocks&gt;
            &lt;tieredBlock&gt;
                &lt;unit&gt;cell-phone-minutes&lt;/unit&gt;
                &lt;size&gt;10&lt;/size&gt;
                &lt;prices&gt;
                    &lt;price&gt;
                        &lt;currency&gt;EUR&lt;/currency&gt;
                        &lt;value&gt;0.50&lt;/value&gt;
                    &lt;/price&gt;
                &lt;/prices&gt;
                &lt;max&gt;-1&lt;/max&gt;
            &lt;/tieredBlock&gt;
            &lt;tieredBlock&gt;
                &lt;unit&gt;Mbytes&lt;/unit&gt;
                &lt;size&gt;1&lt;/size&gt;
                &lt;prices&gt;
                    &lt;price&gt;
                        &lt;currency&gt;EUR&lt;/currency&gt;
                        &lt;value&gt;0.1&lt;/value&gt;
                    &lt;/price&gt;
                &lt;/prices&gt;
                &lt;max&gt;-1&lt;/max&gt;
            &lt;/tieredBlock&gt;
        &lt;/blocks&gt;
    &lt;/tier&gt;
&lt;/tiers&gt;</code></pre></div></div>
<div class="paragraph"><p>In the <code>CONSUMABLE</code> mode, when defining a usage section with multiple unit (types), it is important to realize that the consumer <strong>is charged independently
for each unit</strong>. For example, with the definition provided above, and given the following usage data for the period:</p></div>
<div class="ulist"><ul><li><p>1500 cell-phone-minutes</p></li><li><p>2048 Mbytes</p></li></ul></div>
<div class="paragraph"><p>The total amount would be 739.4. This is calculated as follows:</p></div>
<div class="paragraph"><p>cell-phone-minutes:</p></div>
<div class="ulist"><ul><li><p>Tier 1: 100 blocks of size 10 at 1 EUR &#8658; 100 EUR</p></li><li><p>Tier 2: 50 blocks of size 10 at 0.5 EUR &#8658; 25 EUR</p></li></ul></div>
<div class="paragraph"><p>Mbytes</p></div>
<div class="ulist"><ul><li><p>Tier 1: 1024 blocks of size 1 at 0.5 EUR &#8658; 512</p></li><li><p>Tier 2: 1024 blocks of size 1 at 0.1 EUR &#8658; 102.4</p></li></ul></div>
<div class="paragraph"><p>Total: 100 + 25 + 512 + 102.4 = 739.4</p></div>
<div class="paragraph"><p>For more information on this model, see our <a href="http://docs.killbill.io/latest/consumable_in_arrear.html">tutorial</a>.</p></div></div>
<div class="sect4"><h5 id="_consumable_in_arrear_mode_top_tier">Consumable In Arrear Mode: <code>TOP_TIER</code></h5><div class="paragraph"><p>Using the same example from the previous section with the <code>TOP_TIER</code> policy would lead to a different result, since all charges would be calculated at the higher tier:</p></div>
<div class="ulist"><ul><li><p>cell-phone-minutes: 150 blocks of size 10 at 0.50 EUR = 150 * 0.5 = 75</p></li><li><p>Mbytes: 2048 blocks of size 1 at 0.10 EUR = 2048 * 0.1 = 204.8</p></li></ul></div>
<div class="paragraph"><p>So the total amount would be 279.8.</p></div></div>
<div class="sect4"><h5 id="_capacity_in_arrear_mode">Capacity In Arrear Mode</h5><div class="paragraph"><p>In the <code>CAPACITY</code> mode, each <code>tier</code> definition contains a list of <code>limit</code>, specifying the maximum value for this tier for each <code>unit</code> (type). <strong>In contrast to the <code>CONSUMABLE</code> mode, the billing happens across the units</strong>. Let&#8217;s assume the following definition for one tier, with 2 different types of units, <code>bandwith-meg-sec</code> and <code>members</code>:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span></span>&lt;tier&gt;
   &lt;limits&gt;
       &lt;limit&gt;
           &lt;unit&gt;bandwith-meg-sec&lt;/unit&gt;
           &lt;max&gt;100&lt;/max&gt;
       &lt;/limit&gt;
       &lt;limit&gt;
           &lt;unit&gt;members&lt;/unit&gt;
           &lt;max&gt;500&lt;/max&gt;
       &lt;/limit&gt;
   &lt;/limits&gt;
   &lt;recurringPrice&gt;
       &lt;price&gt;
           &lt;currency&gt;EUR&lt;/currency&gt;
           &lt;value&gt;5.00&lt;/value&gt;
       &lt;/price&gt;
   &lt;/recurringPrice&gt;
&lt;/tier&gt;</code></pre></div></div>
<div class="paragraph"><p>Given the following usage data for the period:</p></div>
<div class="ulist"><ul><li><p><code>bandwith-meg-sec</code>: A peak of 50 in the period</p></li><li><p><code>members</code>: A peak of 350 active members in the period</p></li></ul></div>
<div class="paragraph"><p>The user would be charged 5.00 EUR.</p></div>
<div class="paragraph"><p>However if the <code>members</code> peak data was 501, this would move to the next tier&#8201;&#8212;&#8201;not shown for simplicity.</p></div>
<div class="paragraph"><p>So, in this model, the peak data for each unit is used to <strong>define which tier to use</strong>, and based on the tier we simply apply the pricing defined.</p></div></div></div></div></div></div>
<div class="sect1"><h2 id="components-entitlement">Subscription and Entitlement</h2><div class="sectionbody"><div class="sect2"><h3 id="_overview">Overview</h3><div class="paragraph"><p>The Kill Bill entitlement system offers an API for users to manage their subscriptions.
The API allows a user to subscribe to a new product, change to a different product, pause, resume or cancel a subscription.
Upon each of those API calls, there are two distinct sets of operations that occur in the system:</p></div>
<div class="ulist"><ul><li><p>When an <strong>entitlement change</strong> occurs, for instance upon creation, the user <strong>gains access</strong> to what she subscribed for.
The primary goal of that API is to give great flexibility through the use of dates or entitlement policies as to when things should start or stop.</p></li><li><p>As a consequence of the entitlement operation, the system will also compute the changes that should occur on the <strong>billing side</strong>.
It is important to understand that the entitlement operation has an impact on billing, so the two are connected, but they are not necessarily aligned.</p></li></ul></div>
<div class="paragraph"><p>The philosophy behind that API is that the user (of the API) should be able to configure the entitlement so that it matches their needs exactly, and let the system compute the billing aspect based on the policies that were configured in the catalog.</p></div>
<div class="paragraph"><p>Example:</p></div>
<div class="ulist"><ul><li><p>First an administrator sets up Kill Bill to always perform the cancellation END_OF_TERM, which will result in never generating a credit for a particular product 'P'.</p></li><li><p>A customer comes in, subscribes to that product 'P', and gets invoiced.</p></li><li><p>At a later date the customer decides that he no longer wants to use the product 'P', and decides to cancel that subscription immediately. From an entitlement point of view, the end date is now. So as soon as the call returns, the customer loses access to the product.</p></li><li><p>From a billing point of view, however, because the administrator decided to configure the system that way, the end date will be computed by the system to match the end date of the last period invoiced, also referred to as charged through date (CTD). Thus there is no generated credit for that cancellation.</p></li></ul></div>
<div class="paragraph"><p>As a general rule, then, the administrator deals with the billing policies, and the user of the API controls the details of its entitlement(s).
The entitlement system exposes abstractions that reflect that model:</p></div>
<div class="ulist"><ul><li><p>Entitlement: An entitlement is an abstraction which provides the answer to the following question: Is the user allowed (entitled) to use this service or product at a given time? It provides information about the dates when that service started, ended, or was paused and resumed, along with the specifics about the type of service or product.</p></li><li><p>Subscription: A Subscription is an abstraction that encapsulates the information contained in the entitlement but also adds additional billing information, such as the dates at which the billing started and ended. When the system is configured to bill in advance, it also provides the date up to which the customer was invoiced (ChargeThroughDate).</p></li><li><p>SubscriptionBundle: Subscriptions are always part of a SubscriptionBundle. This allows Subscriptions to be grouped together so that specific operations&#8201;&#8212;&#8201;cancellation, change of plan-- on one Subscription may have an impact on the other Subscriptions in the same SubscriptionBundle. There can be at most one Subscription attached to a BASE Category in a SubscriptionBundle but there can be multiple ADD_ON Subscriptions in that same SubscriptionBundle. Typically, a BASE Category is used to make sure that any operation on the BASE Subscription will be reflected on the ADD_ON Susbcriptions in the same SubscriptionBundle.</p></li></ul></div>
<div class="paragraph"><p>Previously we laid out the general case where the user of the API controls the entitlement and Kill Bill manages the billing aspect based on configuration policies. Some specific entitlement APIs also allow you to override the billing policies on a per call basis.</p></div></div>
<div class="sect2"><h3 id="_alignments">Alignments</h3><div class="paragraph"><p>The table below shows the possible combinations that the API supports. The columns represent the various entitlement (ENT) policies: Immediate, End of Term, or specific date. The rows represent the possible billing policies, which have the same three choices.</p></div>
<div class="paragraph"><p><span class="image"><img src="https://drive.google.com/uc?&amp;id=0Bw8rymjWckBHR3h5VXpnQXI1YXM&amp;w=960&amp;h=480" alt="Entitlement Matrix Policy"></span></p></div>
<div class="paragraph"><p>The diagrams below illustrate each entry in the table, for the case when a cancellation occurs on a subscription that was billed <strong>in advance</strong>:</p></div>
<div class="ulist"><ul><li><p>The green line shows the entitlement, and the red cross on that line shows the cancellation as seen by the customer; that is, once we hit the red cross the customer loses access to its entitlement.</p></li><li><p>The red portion below shows the current invoice; by default the customer was invoiced from the start of the period to the end of the period, also referred to as the charged through date (CTD).</p></li></ul></div>
<div class="paragraph"><p>We can see that in all cases, cancelling a subscription has both an impact on the entitlement and the billing side, but we also see that those two are not necessarily aligned:</p></div>
<div class="paragraph"><p><span class="image"><img src="https://drive.google.com/uc?&amp;id=0Bw8rymjWckBHX2V1N3gzeWxOdkU&amp;w=960&amp;h=480" alt="Entitlement policy scenarii"></span></p></div></div></div></div>
<div class="sect1"><h2 id="components-invoicing">Invoicing</h2><div class="sectionbody"><div class="sect2"><h3 id="components-invoicing-overview">Overview</h3><div class="paragraph"><p>Most billing system are batch oriented: Invoice calculation occurs at certain specific times (often configurable), and the system goes through all accounts and generate the missing invoices.
Kill Bill, on the other hand, generates new invoices as soon as there is a change in the system that requires such a new invoice. This may occur, for example:</p></div>
<div class="ulist"><ul><li><p>when there is a change to a subscription (creation, change of plan, cancellation, etc.)</p></li><li><p>when the system detects a recurring charge is due (e.g. monthly recurring subscriptions)</p></li><li><p>when an operator creates an external charge, adjusts a past invoice or triggers a future invoice</p></li></ul></div>
<div class="paragraph"><p>After an invoice has been generated, its balance is positive or zero.
If it is positive, the customer owes money and needs to pay the balance.
Each time an invoice would become negative, the system automatically inserts a special item, called credit balance adjustment (CBA), to bring the balance back to zero.
That credit is automatically added to the account and used on future invoices.
If the invoice is paid, a payment is added against that invoice.
If the invoice is adjusted later on, a CBA item will be automatically generated and appear on the invoice.
Kill Bill invoices are for the most part static, with the exceptions of manual changes (manual credit, charge added on a specific invoice after generation).</p></div>
<div class="paragraph"><p>An invoice is composed of invoice items. The various types of invoice items are:</p></div>
<div class="ulist"><ul><li><p>RECURRING: Recurring charge. Used for items with a billing period. This item is always positive or zero</p></li><li><p>FIXED: Fixed (one-time) charge. Used for items without a billing period (non recurring phase, e.g. trials). This item is always positive or zero</p></li><li><p>EXTERNAL_CHARGE: Fixed (one-time) external charge, for items not in the catalog. This item is always positive</p></li><li><p>USAGE: Usage charge. This item is always positive or zero.</p></li><li><p>TAX: Tax item. This item is not added by the core system, but is added by tax plugins&#8201;&#8212;&#8201;when such plugins exist.</p></li><li><p>ITEM_ADJ: Invoice item adjustment, generated by an operator (often associated with a refund). This item is always negative</p></li><li><p>CREDIT_ADJ: Invoice level adjustment (credits), either at the account level (on its own invoice) or against an existing invoice. This item is always negative</p></li><li><p>REPAIR_ADJ: Internal adjustment, generated automatically by the system for an invoice on which the subscription was modified (immediate cancellation or change). The items is always negative</p></li><li><p>CBA_ADJ: Internal adjustment, generated automatically by the system for an invoice which became negative (account level credits). Positive when generating credits, negative when consuming account level credits. The sum of CBA items for an account should always be positive or zero</p></li></ul></div>
<div class="paragraph"><p>Recurring invoice items start and end on the same day of the month.
For example, a monthly subscription starting on the 21st will have items for the service period 2012-08-21 to 2012-09-21, 2012-09-21 to 2012-10-21, etc.
Fixed items only have a start date and never get prorated.</p></div>
<div class="sect3"><h4 id="_invoice_and_account_balance">Invoice and Account Balance</h4><div class="paragraph"><p>The invoice balance is computed by adding all the charges, subtracting credits and adjustments, and then subtracting the amount paid.</p></div>
<div class="ulist"><ul><li><p>The charge amount is computed from the following items: FIXED, RECURRING, EXTERNAL_CHARGE, REPAIR_ADJ, ITEM_ADJ, USAGE, TAX.</p></li><li><p>The resulting paid amount is equal to the original paid amount after subtracting any refund amount.</p></li></ul></div>
<div class="paragraph"><p>The invoice balance is zero in the following cases:</p></div>
<div class="ulist"><ul><li><p>When the invoice was tagged with the WRITTEN_OFF tag.</p></li><li><p>When the invoice is in DRAFT mode.</p></li><li><p>When this is a migration invoice (imported in the system).</p></li><li><p>When this is a child invoice for which the parent summary invoice has been fully paid (HA feature).</p></li></ul></div>
<div class="paragraph"><p>The account balance is the sum of all the invoice balances after subtracting any account credit. For example, if all invoices were fully paid, and if there was a $10 account credit, the account balance would be negative and equal to -$10.</p></div></div></div>
<div class="sect2"><h3 id="components-invoice-items">Invoice Items</h3><div class="sect3"><h4 id="_fixed_item">Fixed Item</h4><div class="paragraph"><p>An invoice for a subscription on a fixed phase of $0 (trial phase for example) would look like:</p></div>
<table class="tableblock frame-all grid-all spread"><colgroup><col style="width: 16.6666%;"><col style="width: 16.6666%;"><col style="width: 16.6666%;"><col style="width: 16.6666%;"><col style="width: 16.6666%;"><col style="width: 16.667%;"></colgroup><thead><tr><th class="tableblock halign-left valign-top">Invoice #</th><th class="tableblock halign-left valign-top">Type</th><th class="tableblock halign-left valign-top">Description</th><th class="tableblock halign-left valign-top">Amount</th><th class="tableblock halign-left valign-top">Start date</th><th class="tableblock halign-left valign-top">End date</th></tr></thead><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">1028</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">FIXED</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Silver trial</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">$0</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">2013-03-10</p></td><td class="tableblock halign-left valign-top"></td></tr></tbody></table></div>
<div class="sect3"><h4 id="_recurring_item">Recurring Item</h4><div class="paragraph"><p>An invoice for a subscription on a recurring phase of $20 would look like:</p></div>
<table class="tableblock frame-all grid-all spread"><colgroup><col style="width: 16.6666%;"><col style="width: 16.6666%;"><col style="width: 16.6666%;"><col style="width: 16.6666%;"><col style="width: 16.6666%;"><col style="width: 16.667%;"></colgroup><thead><tr><th class="tableblock halign-left valign-top">Invoice #</th><th class="tableblock halign-left valign-top">Type</th><th class="tableblock halign-left valign-top">Description</th><th class="tableblock halign-left valign-top">Amount</th><th class="tableblock halign-left valign-top">Start date</th><th class="tableblock halign-left valign-top">End date</th></tr></thead><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">1029</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">RECURRING</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Silver monthly</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">$20</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">2013-04-11</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">2013-05-11</p></td></tr></tbody></table></div>
<div class="sect3"><h4 id="_plan_changes">Plan Changes</h4><div class="paragraph"><p>In a case where invoicing occurs in advance, a user gets charged for the upcoming period.
For instance a user that subscribed to a monthly plan on 2013-04-11, would get a first invoice, charging for that month.
Assuming he paid his invoice, his balance is now 0. Let&#8217;s assume he decides to upgrade on 2013-04-26:</p></div>
<div class="paragraph"><p>Previous invoice:</p></div>
<table class="tableblock frame-all grid-all spread"><colgroup><col style="width: 16.6666%;"><col style="width: 16.6666%;"><col style="width: 16.6666%;"><col style="width: 16.6666%;"><col style="width: 16.6666%;"><col style="width: 16.667%;"></colgroup><thead><tr><th class="tableblock halign-left valign-top">Invoice #</th><th class="tableblock halign-left valign-top">Type</th><th class="tableblock halign-left valign-top">Description</th><th class="tableblock halign-left valign-top">Amount</th><th class="tableblock halign-left valign-top">Start date</th><th class="tableblock halign-left valign-top">End date</th></tr></thead><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">1029</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">RECURRING</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Silver monthly</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">$20</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">2013-04-11</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">2013-05-11</p></td></tr></tbody></table>
<div class="paragraph"><p>On the new invoice, the system will generate a REPAIR_ADJ item for the part of the subscription on the old plan that was not used, and a new
RECURRING item for the new plan on the remaining period.</p></div>
<table class="tableblock frame-all grid-all spread"><colgroup><col style="width: 16.6666%;"><col style="width: 16.6666%;"><col style="width: 16.6666%;"><col style="width: 16.6666%;"><col style="width: 16.6666%;"><col style="width: 16.667%;"></colgroup><thead><tr><th class="tableblock halign-left valign-top">Invoice #</th><th class="tableblock halign-left valign-top">Type</th><th class="tableblock halign-left valign-top">Description</th><th class="tableblock halign-left valign-top">Amount</th><th class="tableblock halign-left valign-top">Start date</th><th class="tableblock halign-left valign-top">End date</th></tr></thead><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">1030</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">RECURRING</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Gold monthly</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">$15</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">2013-04-26</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">2013-05-11</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">1029</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">REPAIR_ADJ</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Silver monthly</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">$-10</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">2013-04-26</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">2013-05-11</p></td></tr></tbody></table>
<div class="paragraph"><p>Note that if the absolute value of the amount of the REPAIR_ADJ had been greater than the amount of the new RECURRING item, the system would have generated a CBA_ADJ item
whose purpose would have been to bring the balance to 0, and provide the customer some credit that would have been used on subsequent invoices.</p></div></div>
<div class="sect3"><h4 id="_invoice_item_adjustment">Invoice Item Adjustment</h4><div class="paragraph"><p>An invoice item adjustment would look like (assuming the invoice wasn&#8217;t paid, otherwise a CBA_ADJ item would be added):</p></div>
<table class="tableblock frame-all grid-all spread"><colgroup><col style="width: 16.6666%;"><col style="width: 16.6666%;"><col style="width: 16.6666%;"><col style="width: 16.6666%;"><col style="width: 16.6666%;"><col style="width: 16.667%;"></colgroup><thead><tr><th class="tableblock halign-left valign-top">Invoice #</th><th class="tableblock halign-left valign-top">Type</th><th class="tableblock halign-left valign-top">Description</th><th class="tableblock halign-left valign-top">Amount</th><th class="tableblock halign-left valign-top">Start date</th><th class="tableblock halign-left valign-top">End date</th></tr></thead><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">1029</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">RECURRING</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Silver monthly</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">$20</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">2013-04-11</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">2013-05-11</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">1029</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">ITEM_ADJ</p></td><td class="tableblock halign-left valign-top"></td><td class="tableblock halign-left valign-top"><p class="tableblock">$-20</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">2013-04-20</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">2013-04-20</p></td></tr></tbody></table></div>
<div class="sect3"><h4 id="_credit">Credit</h4><div class="paragraph"><p>Note that CREDIT_ADJ items are also used to represent credits created by the user (via APIs). In this case, a dummy invoice is created with a negative amount for the CREDIT_ADJ item. This makes the system generate a CBA_ADJ automatically, which in turn can be used as account credits. For example, here is how a $20 credit would be represented:</p></div>
<table class="tableblock frame-all grid-all spread"><colgroup><col style="width: 16.6666%;"><col style="width: 16.6666%;"><col style="width: 16.6666%;"><col style="width: 16.6666%;"><col style="width: 16.6666%;"><col style="width: 16.667%;"></colgroup><thead><tr><th class="tableblock halign-left valign-top">Invoice #</th><th class="tableblock halign-left valign-top">Type</th><th class="tableblock halign-left valign-top">Description</th><th class="tableblock halign-left valign-top">Amount</th><th class="tableblock halign-left valign-top">Start date</th><th class="tableblock halign-left valign-top">End date</th></tr></thead><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">1029</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">CREDIT_ADJ</p></td><td class="tableblock halign-left valign-top"></td><td class="tableblock halign-left valign-top"><p class="tableblock">$-20</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">2013-04-20</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">2013-04-20</p></td></tr></tbody></table></div></div>
<div class="sect2"><h3 id="invoicing-dry-run">Invoice Dry Run</h3><div class="sect3"><h4 id="_dry_run_modes">Dry Run Modes</h4><div class="paragraph"><p>In some situations, it is necessary to preview what a given customer will be invoiced for at a given date or after making a subscription change.
Kill Bill provides dry-run invoice apis to accomplish such a goal, and there are a few flavours for different use cases:</p></div>
<div class="ulist"><ul><li><p>Next upcoming invoice: When is the next upcoming invoice for a given customer, and what will this invoice contain (items, amount, date, &#8230;&#8203;)?</p></li><li><p>Next upcoming invoice associated with a given subscription or bundle: When is the next upcoming invoice for a given subscription/bundle, and what will this invoice contain (items, amount, date, &#8230;&#8203;)?</p></li><li><p>Given a targetDate, what invoice will the system generate ?</p></li><li><p>Subscription modification: Given a change in a subscription (new subscription, change of plan, cancellation, &#8230;&#8203;), what invoice will the system generate ?</p></li></ul></div>
<div class="paragraph"><p>Let&#8217;s assume a scenario where we created 2 annual subscriptions, the first one <code>261fe7b1-ff09-49c8-bbef-61d6e3ab876b</code> aligned
on July 25 and the second one <code>06b826ad-73e6-4bdd-92fe-c9770a1ba30a</code> aligned on July 27.
If we look at the existing invoice items we see the following:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span></span>*************************** <span class="tok-m">1</span>. row ***************************
             id: 079e572e-a26c-42e4-8676-7213ad542af3
     account_id: 704b1a30-e5b9-4d01-b2b8-e9403a0ed0e3
     invoice_id: 5725c77f-44af-409c-a32a-e36ed3c57283
subscription_id: 261fe7b1-ff09-49c8-bbef-61d6e3ab876b
           type: RECURRING
         amount: <span class="tok-m">10000</span>.000000000
     start_date: <span class="tok-m">2017</span>-07-25
       end_date: <span class="tok-m">2018</span>-07-25
*************************** <span class="tok-m">2</span>. row ***************************
             id: 1674c034-fcbe-46bb-9c04-f8825671f93f
     account_id: 704b1a30-e5b9-4d01-b2b8-e9403a0ed0e3
     invoice_id: 65c5b4b8-67e6-4066-8699-70b0f49ee6df
subscription_id: 06b826ad-73e6-4bdd-92fe-c9770a1ba30a
           type: RECURRING
         amount: <span class="tok-m">10000</span>.000000000
     start_date: <span class="tok-m">2017</span>-07-27
       end_date: <span class="tok-m">2018</span>-07-27</code></pre></div></div>
<div class="paragraph"><p>From this scenario, let&#8217;s now look at various use cases for dry-run options:</p></div></div>
<div class="sect3"><h4 id="_next_upcoming_invoice">Next Upcoming Invoice</h4><div class="paragraph"><p>Let&#8217;s start with a dry-run invoice with <code>UPCOMING_INVOICE</code>, to see the next invoice that the system will generate for this account:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span></span>curl  <span class="tok-se">\</span>
-X POST <span class="tok-se">\</span>
-u admin:password <span class="tok-se">\</span>
-H <span class="tok-s2">&quot;X-Killbill-ApiKey: bob&quot;</span> <span class="tok-se">\</span>
-H <span class="tok-s2">&quot;X-Killbill-ApiSecret: lazar&quot;</span> <span class="tok-se">\</span>
-H <span class="tok-s2">&quot;X-Killbill-CreatedBy: demo&quot;</span> <span class="tok-se">\</span>
-H <span class="tok-s2">&quot;Content-Type: application/json&quot;</span> <span class="tok-se">\</span>
--data-binary <span class="tok-s1">&#39;{&quot;dryRunType&quot;:&quot;UPCOMING_INVOICE&quot;}&#39;</span> <span class="tok-se">\</span>
<span class="tok-s1">&#39;http://127.0.0.1:8080/1.0/kb/invoices/dryRun?accountId=704b1a30-e5b9-4d01-b2b8-e9403a0ed0e3&#39;</span></code></pre></div></div>
<div class="paragraph"><p>This will result in the following dry-run invoice. As expected, we only see the item for the first subscription aligned on the 25th:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-o">{</span>
  <span class="tok-s2">&quot;amount&quot;</span>: <span class="tok-m">10000</span>,
  <span class="tok-s2">&quot;currency&quot;</span>: <span class="tok-s2">&quot;USD&quot;</span>,
  <span class="tok-s2">&quot;status&quot;</span>: <span class="tok-s2">&quot;COMMITTED&quot;</span>,
  <span class="tok-s2">&quot;creditAdj&quot;</span>: <span class="tok-m">0</span>,
  <span class="tok-s2">&quot;refundAdj&quot;</span>: <span class="tok-m">0</span>,
  <span class="tok-s2">&quot;invoiceId&quot;</span>: <span class="tok-s2">&quot;3bbd33da-39c7-4748-a5a8-94d53e40cadc&quot;</span>,
  <span class="tok-s2">&quot;invoiceDate&quot;</span>: <span class="tok-s2">&quot;2017-12-14&quot;</span>,
  <span class="tok-s2">&quot;targetDate&quot;</span>: <span class="tok-s2">&quot;2018-07-25&quot;</span>,
  <span class="tok-s2">&quot;invoiceNumber&quot;</span>: null,
  <span class="tok-s2">&quot;balance&quot;</span>: <span class="tok-m">10000</span>,
  <span class="tok-s2">&quot;accountId&quot;</span>: <span class="tok-s2">&quot;704b1a30-e5b9-4d01-b2b8-e9403a0ed0e3&quot;</span>,
  <span class="tok-s2">&quot;bundleKeys&quot;</span>: null,
  <span class="tok-s2">&quot;credits&quot;</span>: null,
  <span class="tok-s2">&quot;items&quot;</span>: <span class="tok-o">[</span>
    <span class="tok-o">{</span>
      <span class="tok-s2">&quot;invoiceItemId&quot;</span>: <span class="tok-s2">&quot;937ac911-b51c-48a8-a004-4789bd3e0726&quot;</span>,
      <span class="tok-s2">&quot;invoiceId&quot;</span>: <span class="tok-s2">&quot;3bbd33da-39c7-4748-a5a8-94d53e40cadc&quot;</span>,
      <span class="tok-s2">&quot;linkedInvoiceItemId&quot;</span>: null,
      <span class="tok-s2">&quot;accountId&quot;</span>: <span class="tok-s2">&quot;704b1a30-e5b9-4d01-b2b8-e9403a0ed0e3&quot;</span>,
      <span class="tok-s2">&quot;childAccountId&quot;</span>: null,
      <span class="tok-s2">&quot;bundleId&quot;</span>: <span class="tok-s2">&quot;54c2d76e-e84d-412d-8eac-afb6d0ea1a35&quot;</span>,
      <span class="tok-s2">&quot;subscriptionId&quot;</span>: <span class="tok-s2">&quot;261fe7b1-ff09-49c8-bbef-61d6e3ab876b&quot;</span>,
      <span class="tok-s2">&quot;planName&quot;</span>: <span class="tok-s2">&quot;basic-annual&quot;</span>,
      <span class="tok-s2">&quot;phaseName&quot;</span>: <span class="tok-s2">&quot;basic-annual-evergreen&quot;</span>,
      <span class="tok-s2">&quot;usageName&quot;</span>: null,
      <span class="tok-s2">&quot;itemType&quot;</span>: <span class="tok-s2">&quot;RECURRING&quot;</span>,
      <span class="tok-s2">&quot;description&quot;</span>: <span class="tok-s2">&quot;basic-annual-evergreen&quot;</span>,
      <span class="tok-s2">&quot;startDate&quot;</span>: <span class="tok-s2">&quot;2018-07-25&quot;</span>,
      <span class="tok-s2">&quot;endDate&quot;</span>: <span class="tok-s2">&quot;2019-07-25&quot;</span>,
      <span class="tok-s2">&quot;amount&quot;</span>: <span class="tok-m">10000</span>,
      <span class="tok-s2">&quot;currency&quot;</span>: <span class="tok-s2">&quot;USD&quot;</span>,
      <span class="tok-s2">&quot;childItems&quot;</span>: null,
      <span class="tok-s2">&quot;auditLogs&quot;</span>: null
    <span class="tok-o">}</span>
  <span class="tok-o">]</span>,
  <span class="tok-s2">&quot;isParentInvoice&quot;</span>: false,
  <span class="tok-s2">&quot;auditLogs&quot;</span>: null
<span class="tok-o">}</span></code></pre></div></div></div>
<div class="sect3"><h4 id="_next_upcoming_invoice_for_a_given_subscription">Next Upcoming Invoice for a Given Subscription</h4><div class="paragraph"><p>Let&#8217;s now do a dry-run invoice with <code>UPCOMING_INVOICE</code> but with a filter on the subscription <code>06b826ad-73e6-4bdd-92fe-c9770a1ba30a</code>:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span></span>curl  <span class="tok-se">\</span>
-X POST <span class="tok-se">\</span>
-u admin:password <span class="tok-se">\</span>
-H <span class="tok-s2">&quot;X-Killbill-ApiKey: bob&quot;</span> <span class="tok-se">\</span>
-H <span class="tok-s2">&quot;X-Killbill-ApiSecret: lazar&quot;</span> <span class="tok-se">\</span>
-H <span class="tok-s2">&quot;X-Killbill-CreatedBy: demo&quot;</span> <span class="tok-se">\</span>
-H <span class="tok-s2">&quot;Content-Type: application/json&quot;</span> <span class="tok-se">\</span>
--data-binary <span class="tok-s1">&#39;{&quot;dryRunType&quot;:&quot;UPCOMING_INVOICE&quot;, &quot;subscriptionId&quot;:&quot;06b826ad-73e6-4bdd-92fe-c9770a1ba30a&quot;}&#39;</span> <span class="tok-se">\</span>
<span class="tok-s1">&#39;http://127.0.0.1:8080/1.0/kb/invoices/dryRun?accountId=704b1a30-e5b9-4d01-b2b8-e9403a0ed0e3&#39;</span></code></pre></div></div>
<div class="paragraph"><p>This will result in the following dry-run invoice. This time, as expected, we only see the item for the second subscription <code>06b826ad-73e6-4bdd-92fe-c9770a1ba30a</code>:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-o">{</span>
  <span class="tok-s2">&quot;amount&quot;</span>: <span class="tok-m">10000</span>,
  <span class="tok-s2">&quot;currency&quot;</span>: <span class="tok-s2">&quot;USD&quot;</span>,
  <span class="tok-s2">&quot;status&quot;</span>: <span class="tok-s2">&quot;COMMITTED&quot;</span>,
  <span class="tok-s2">&quot;creditAdj&quot;</span>: <span class="tok-m">0</span>,
  <span class="tok-s2">&quot;refundAdj&quot;</span>: <span class="tok-m">0</span>,
  <span class="tok-s2">&quot;invoiceId&quot;</span>: <span class="tok-s2">&quot;25fbf3f9-2b5b-4389-a940-84864fe5cd88&quot;</span>,
  <span class="tok-s2">&quot;invoiceDate&quot;</span>: <span class="tok-s2">&quot;2017-12-14&quot;</span>,
  <span class="tok-s2">&quot;targetDate&quot;</span>: <span class="tok-s2">&quot;2018-07-27&quot;</span>,
  <span class="tok-s2">&quot;invoiceNumber&quot;</span>: null,
  <span class="tok-s2">&quot;balance&quot;</span>: <span class="tok-m">10000</span>,
  <span class="tok-s2">&quot;accountId&quot;</span>: <span class="tok-s2">&quot;704b1a30-e5b9-4d01-b2b8-e9403a0ed0e3&quot;</span>,
  <span class="tok-s2">&quot;bundleKeys&quot;</span>: null,
  <span class="tok-s2">&quot;credits&quot;</span>: null,
  <span class="tok-s2">&quot;items&quot;</span>: <span class="tok-o">[</span>
    <span class="tok-o">{</span>
      <span class="tok-s2">&quot;invoiceItemId&quot;</span>: <span class="tok-s2">&quot;a4f525c4-014b-474b-85a9-6ccf4742fe5e&quot;</span>,
      <span class="tok-s2">&quot;invoiceId&quot;</span>: <span class="tok-s2">&quot;25fbf3f9-2b5b-4389-a940-84864fe5cd88&quot;</span>,
      <span class="tok-s2">&quot;linkedInvoiceItemId&quot;</span>: null,
      <span class="tok-s2">&quot;accountId&quot;</span>: <span class="tok-s2">&quot;704b1a30-e5b9-4d01-b2b8-e9403a0ed0e3&quot;</span>,
      <span class="tok-s2">&quot;childAccountId&quot;</span>: null,
      <span class="tok-s2">&quot;bundleId&quot;</span>: <span class="tok-s2">&quot;c056fac0-1564-46cd-9e2a-d97e49e30177&quot;</span>,
      <span class="tok-s2">&quot;subscriptionId&quot;</span>: <span class="tok-s2">&quot;06b826ad-73e6-4bdd-92fe-c9770a1ba30a&quot;</span>,
      <span class="tok-s2">&quot;planName&quot;</span>: <span class="tok-s2">&quot;basic-annual&quot;</span>,
      <span class="tok-s2">&quot;phaseName&quot;</span>: <span class="tok-s2">&quot;basic-annual-evergreen&quot;</span>,
      <span class="tok-s2">&quot;usageName&quot;</span>: null,
      <span class="tok-s2">&quot;itemType&quot;</span>: <span class="tok-s2">&quot;RECURRING&quot;</span>,
      <span class="tok-s2">&quot;description&quot;</span>: <span class="tok-s2">&quot;basic-annual-evergreen&quot;</span>,
      <span class="tok-s2">&quot;startDate&quot;</span>: <span class="tok-s2">&quot;2018-07-27&quot;</span>,
      <span class="tok-s2">&quot;endDate&quot;</span>: <span class="tok-s2">&quot;2019-07-27&quot;</span>,
      <span class="tok-s2">&quot;amount&quot;</span>: <span class="tok-m">10000</span>,
      <span class="tok-s2">&quot;currency&quot;</span>: <span class="tok-s2">&quot;USD&quot;</span>,
      <span class="tok-s2">&quot;childItems&quot;</span>: null,
      <span class="tok-s2">&quot;auditLogs&quot;</span>: null
    <span class="tok-o">}</span>
  <span class="tok-o">]</span>,
  <span class="tok-s2">&quot;isParentInvoice&quot;</span>: false,
  <span class="tok-s2">&quot;auditLogs&quot;</span>: null
<span class="tok-o">}</span></code></pre></div></div></div>
<div class="sect3"><h4 id="_next_invoice_for_a_given_target_date">Next Invoice for a Given Target Date</h4><div class="paragraph"><p>Next, let&#8217;s run a dry-run invoice with <code>TARGET_DATE</code> set to <code>2018-07-27</code>:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span></span>curl  <span class="tok-se">\</span>
-X POST <span class="tok-se">\</span>
-u admin:password <span class="tok-se">\</span>
-H <span class="tok-s2">&quot;X-Killbill-ApiKey: bob&quot;</span> <span class="tok-se">\</span>
-H <span class="tok-s2">&quot;X-Killbill-ApiSecret: lazar&quot;</span> <span class="tok-se">\</span>
-H <span class="tok-s2">&quot;X-Killbill-CreatedBy: demo&quot;</span> <span class="tok-se">\</span>
-H <span class="tok-s2">&quot;Content-Type: application/json&quot;</span> <span class="tok-se">\</span>
--data-binary <span class="tok-s1">&#39;{&quot;dryRunType&quot;:&quot;TARGET_DATE&quot;}&#39;</span> <span class="tok-se">\</span>
<span class="tok-s1">&#39;http://127.0.0.1:8080/1.0/kb/invoices/dryRun?accountId=704b1a30-e5b9-4d01-b2b8-e9403a0ed0e3&amp;targetDate=2018-07-27&#39;</span></code></pre></div></div>
<div class="paragraph"><p>This will produce the following dry-run invoice, and we will see the same result as in the previous example. However, while the previous use case answered the question about the next upcoming invoice for subscription <code>06b826ad-73e6-4bdd-92fe-c9770a1ba30a</code>, in this scenario we answer a different question: Given a targetDate what will the system generate?</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-o">{</span>
  <span class="tok-s2">&quot;amount&quot;</span>: <span class="tok-m">10000</span>,
  <span class="tok-s2">&quot;currency&quot;</span>: <span class="tok-s2">&quot;USD&quot;</span>,
  <span class="tok-s2">&quot;status&quot;</span>: <span class="tok-s2">&quot;COMMITTED&quot;</span>,
  <span class="tok-s2">&quot;creditAdj&quot;</span>: <span class="tok-m">0</span>,
  <span class="tok-s2">&quot;refundAdj&quot;</span>: <span class="tok-m">0</span>,
  <span class="tok-s2">&quot;invoiceId&quot;</span>: <span class="tok-s2">&quot;d89d776a-b13e-4c53-baad-519bdd9ba6d0&quot;</span>,
  <span class="tok-s2">&quot;invoiceDate&quot;</span>: <span class="tok-s2">&quot;2017-12-14&quot;</span>,
  <span class="tok-s2">&quot;targetDate&quot;</span>: <span class="tok-s2">&quot;2018-07-27&quot;</span>,
  <span class="tok-s2">&quot;invoiceNumber&quot;</span>: null,
  <span class="tok-s2">&quot;balance&quot;</span>: <span class="tok-m">10000</span>,
  <span class="tok-s2">&quot;accountId&quot;</span>: <span class="tok-s2">&quot;704b1a30-e5b9-4d01-b2b8-e9403a0ed0e3&quot;</span>,
  <span class="tok-s2">&quot;bundleKeys&quot;</span>: null,
  <span class="tok-s2">&quot;credits&quot;</span>: null,
  <span class="tok-s2">&quot;items&quot;</span>: <span class="tok-o">[</span>
    <span class="tok-o">{</span>
      <span class="tok-s2">&quot;invoiceItemId&quot;</span>: <span class="tok-s2">&quot;9a872df2-1ab9-4250-8f34-8b2cf49ebbb9&quot;</span>,
      <span class="tok-s2">&quot;invoiceId&quot;</span>: <span class="tok-s2">&quot;d89d776a-b13e-4c53-baad-519bdd9ba6d0&quot;</span>,
      <span class="tok-s2">&quot;linkedInvoiceItemId&quot;</span>: null,
      <span class="tok-s2">&quot;accountId&quot;</span>: <span class="tok-s2">&quot;704b1a30-e5b9-4d01-b2b8-e9403a0ed0e3&quot;</span>,
      <span class="tok-s2">&quot;childAccountId&quot;</span>: null,
      <span class="tok-s2">&quot;bundleId&quot;</span>: <span class="tok-s2">&quot;c056fac0-1564-46cd-9e2a-d97e49e30177&quot;</span>,
      <span class="tok-s2">&quot;subscriptionId&quot;</span>: <span class="tok-s2">&quot;06b826ad-73e6-4bdd-92fe-c9770a1ba30a&quot;</span>,
      <span class="tok-s2">&quot;planName&quot;</span>: <span class="tok-s2">&quot;basic-annual&quot;</span>,
      <span class="tok-s2">&quot;phaseName&quot;</span>: <span class="tok-s2">&quot;basic-annual-evergreen&quot;</span>,
      <span class="tok-s2">&quot;usageName&quot;</span>: null,
      <span class="tok-s2">&quot;itemType&quot;</span>: <span class="tok-s2">&quot;RECURRING&quot;</span>,
      <span class="tok-s2">&quot;description&quot;</span>: <span class="tok-s2">&quot;basic-annual-evergreen&quot;</span>,
      <span class="tok-s2">&quot;startDate&quot;</span>: <span class="tok-s2">&quot;2018-07-27&quot;</span>,
      <span class="tok-s2">&quot;endDate&quot;</span>: <span class="tok-s2">&quot;2019-07-27&quot;</span>,
      <span class="tok-s2">&quot;amount&quot;</span>: <span class="tok-m">10000</span>,
      <span class="tok-s2">&quot;currency&quot;</span>: <span class="tok-s2">&quot;USD&quot;</span>,
      <span class="tok-s2">&quot;childItems&quot;</span>: null,
      <span class="tok-s2">&quot;auditLogs&quot;</span>: null
    <span class="tok-o">}</span>
  <span class="tok-o">]</span>,
  <span class="tok-s2">&quot;isParentInvoice&quot;</span>: false,
  <span class="tok-s2">&quot;auditLogs&quot;</span>: null
<span class="tok-o">}</span></code></pre></div></div></div>
<div class="sect3"><h4 id="_subscription_modification">Subscription Modification</h4><div class="paragraph"><p>Finally, we&#8217;ll generate a dry-run invoice associated with a change in the subscription. We want to see what kind of invoice would be generated if we were to change the billing period from <code>ANNUAL</code> to <code>MONTHLY</code>. Note that this change was made on 2018-01-24:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span></span>curl -X POST <span class="tok-se">\</span>
 -u admin:password <span class="tok-se">\</span>
 -H <span class="tok-s1">&#39;Content-Type: application/json&#39;</span> <span class="tok-se">\</span>
 -H <span class="tok-s1">&#39;X-Killbill-ApiKey: bob&#39;</span> <span class="tok-se">\</span>
 -H <span class="tok-s1">&#39;X-Killbill-ApiSecret: lazar&#39;</span> <span class="tok-se">\</span>
 -H <span class="tok-s1">&#39;X-Killbill-CreatedBy: demo&#39;</span> <span class="tok-se">\</span>
 -d <span class="tok-s1">&#39;{&quot;bundleId&quot;:&quot;c056fac0-1564-46cd-9e2a-d97e49e30177&quot;, &quot;dryRunType&quot;:&quot;SUBSCRIPTION_ACTION&quot;,  &quot;phaseType&quot;:&quot;EVERGREEN&quot;, &quot;productName&quot;:&quot;Basic&quot;, &quot;productCategory&quot;:&quot;BASE&quot;, &quot;billingPeriod&quot;:&quot;MONTHLY&quot;, &quot;priceListName&quot;:&quot;DEFAULT&quot;, &quot;subscriptionId&quot;:&quot;06b826ad-73e6-4bdd-92fe-c9770a1ba30a&quot;, &quot;billingPolicy&quot;:&quot;IMMEDIATE&quot;, &quot;dryRunAction&quot;:&quot;CHANGE&quot;}&#39;</span> <span class="tok-se">\</span>
 <span class="tok-s2">&quot;http://127.0.0.1:8080/1.0/kb/invoices/dryRun?accountId=704b1a30-e5b9-4d01-b2b8-e9403a0ed0e3&quot;</span></code></pre></div></div>
<div class="paragraph"><p>The result is an invoice with 3 items:</p></div>
<div class="ulist"><ul><li><p>A <code>RECURRING</code> item to invoice the next MONTHLY period</p></li><li><p>A <code>REPAIR_ADJ</code> item to generate a credit for the remaining part of the year</p></li><li><p>A`CBA_ADJ` item to bring the balance to 0 and generate the resulting account credit.</p></li></ul></div>
<div class="paragraph"><p>This invoice is shown below:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-o">{</span>
  <span class="tok-s2">&quot;amount&quot;</span>: -5008.84,
  <span class="tok-s2">&quot;currency&quot;</span>: <span class="tok-s2">&quot;USD&quot;</span>,
  <span class="tok-s2">&quot;status&quot;</span>: <span class="tok-s2">&quot;COMMITTED&quot;</span>,
  <span class="tok-s2">&quot;creditAdj&quot;</span>: <span class="tok-m">5008</span>.84,
  <span class="tok-s2">&quot;refundAdj&quot;</span>: <span class="tok-m">0</span>,
  <span class="tok-s2">&quot;invoiceId&quot;</span>: <span class="tok-s2">&quot;e85306e2-2753-4888-b7df-543c308c367c&quot;</span>,
  <span class="tok-s2">&quot;invoiceDate&quot;</span>: <span class="tok-s2">&quot;2018-01-24&quot;</span>,
  <span class="tok-s2">&quot;targetDate&quot;</span>: <span class="tok-s2">&quot;2018-01-24&quot;</span>,
  <span class="tok-s2">&quot;invoiceNumber&quot;</span>: null,
  <span class="tok-s2">&quot;balance&quot;</span>: <span class="tok-m">0</span>,
  <span class="tok-s2">&quot;accountId&quot;</span>: <span class="tok-s2">&quot;704b1a30-e5b9-4d01-b2b8-e9403a0ed0e3&quot;</span>,
  <span class="tok-s2">&quot;bundleKeys&quot;</span>: null,
  <span class="tok-s2">&quot;credits&quot;</span>: null,
  <span class="tok-s2">&quot;items&quot;</span>: <span class="tok-o">[</span>
    <span class="tok-o">{</span>
      <span class="tok-s2">&quot;invoiceItemId&quot;</span>: <span class="tok-s2">&quot;f2156511-0273-4ef0-9c11-410a3f6f3872&quot;</span>,
      <span class="tok-s2">&quot;invoiceId&quot;</span>: <span class="tok-s2">&quot;e85306e2-2753-4888-b7df-543c308c367c&quot;</span>,
      <span class="tok-s2">&quot;linkedInvoiceItemId&quot;</span>: null,
      <span class="tok-s2">&quot;accountId&quot;</span>: <span class="tok-s2">&quot;704b1a30-e5b9-4d01-b2b8-e9403a0ed0e3&quot;</span>,
      <span class="tok-s2">&quot;childAccountId&quot;</span>: null,
      <span class="tok-s2">&quot;bundleId&quot;</span>: <span class="tok-s2">&quot;c056fac0-1564-46cd-9e2a-d97e49e30177&quot;</span>,
      <span class="tok-s2">&quot;subscriptionId&quot;</span>: <span class="tok-s2">&quot;06b826ad-73e6-4bdd-92fe-c9770a1ba30a&quot;</span>,
      <span class="tok-s2">&quot;planName&quot;</span>: <span class="tok-s2">&quot;basic-monthly&quot;</span>,
      <span class="tok-s2">&quot;phaseName&quot;</span>: <span class="tok-s2">&quot;basic-monthly-evergreen&quot;</span>,
      <span class="tok-s2">&quot;usageName&quot;</span>: null,
      <span class="tok-s2">&quot;itemType&quot;</span>: <span class="tok-s2">&quot;RECURRING&quot;</span>,
      <span class="tok-s2">&quot;description&quot;</span>: <span class="tok-s2">&quot;basic-monthly-evergreen&quot;</span>,
      <span class="tok-s2">&quot;startDate&quot;</span>: <span class="tok-s2">&quot;2018-01-24&quot;</span>,
      <span class="tok-s2">&quot;endDate&quot;</span>: <span class="tok-s2">&quot;2018-01-25&quot;</span>,
      <span class="tok-s2">&quot;amount&quot;</span>: <span class="tok-m">32</span>.26,
      <span class="tok-s2">&quot;currency&quot;</span>: <span class="tok-s2">&quot;USD&quot;</span>,
      <span class="tok-s2">&quot;childItems&quot;</span>: null,
      <span class="tok-s2">&quot;auditLogs&quot;</span>: null
    <span class="tok-o">}</span>,
    <span class="tok-o">{</span>
      <span class="tok-s2">&quot;invoiceItemId&quot;</span>: <span class="tok-s2">&quot;f78a8843-3155-4f89-ae2a-ca4219936a2c&quot;</span>,
      <span class="tok-s2">&quot;invoiceId&quot;</span>: <span class="tok-s2">&quot;e85306e2-2753-4888-b7df-543c308c367c&quot;</span>,
      <span class="tok-s2">&quot;linkedInvoiceItemId&quot;</span>: <span class="tok-s2">&quot;1674c034-fcbe-46bb-9c04-f8825671f93f&quot;</span>,
      <span class="tok-s2">&quot;accountId&quot;</span>: <span class="tok-s2">&quot;704b1a30-e5b9-4d01-b2b8-e9403a0ed0e3&quot;</span>,
      <span class="tok-s2">&quot;childAccountId&quot;</span>: null,
      <span class="tok-s2">&quot;bundleId&quot;</span>: null,
      <span class="tok-s2">&quot;subscriptionId&quot;</span>: null,
      <span class="tok-s2">&quot;planName&quot;</span>: null,
      <span class="tok-s2">&quot;phaseName&quot;</span>: null,
      <span class="tok-s2">&quot;usageName&quot;</span>: null,
      <span class="tok-s2">&quot;itemType&quot;</span>: <span class="tok-s2">&quot;REPAIR_ADJ&quot;</span>,
      <span class="tok-s2">&quot;description&quot;</span>: <span class="tok-s2">&quot;Adjustment (subscription change)&quot;</span>,
      <span class="tok-s2">&quot;startDate&quot;</span>: <span class="tok-s2">&quot;2018-01-24&quot;</span>,
      <span class="tok-s2">&quot;endDate&quot;</span>: <span class="tok-s2">&quot;2018-07-27&quot;</span>,
      <span class="tok-s2">&quot;amount&quot;</span>: -5041.1,
      <span class="tok-s2">&quot;currency&quot;</span>: <span class="tok-s2">&quot;USD&quot;</span>,
      <span class="tok-s2">&quot;childItems&quot;</span>: null,
      <span class="tok-s2">&quot;auditLogs&quot;</span>: null
    <span class="tok-o">}</span>,
    <span class="tok-o">{</span>
      <span class="tok-s2">&quot;invoiceItemId&quot;</span>: <span class="tok-s2">&quot;4b13e745-eaa7-4fcd-bfc8-56a3ff3d5190&quot;</span>,
      <span class="tok-s2">&quot;invoiceId&quot;</span>: <span class="tok-s2">&quot;e85306e2-2753-4888-b7df-543c308c367c&quot;</span>,
      <span class="tok-s2">&quot;linkedInvoiceItemId&quot;</span>: null,
      <span class="tok-s2">&quot;accountId&quot;</span>: <span class="tok-s2">&quot;704b1a30-e5b9-4d01-b2b8-e9403a0ed0e3&quot;</span>,
      <span class="tok-s2">&quot;childAccountId&quot;</span>: null,
      <span class="tok-s2">&quot;bundleId&quot;</span>: null,
      <span class="tok-s2">&quot;subscriptionId&quot;</span>: null,
      <span class="tok-s2">&quot;planName&quot;</span>: null,
      <span class="tok-s2">&quot;phaseName&quot;</span>: null,
      <span class="tok-s2">&quot;usageName&quot;</span>: null,
      <span class="tok-s2">&quot;itemType&quot;</span>: <span class="tok-s2">&quot;CBA_ADJ&quot;</span>,
      <span class="tok-s2">&quot;description&quot;</span>: <span class="tok-s2">&quot;Adjustment (account credit)&quot;</span>,
      <span class="tok-s2">&quot;startDate&quot;</span>: <span class="tok-s2">&quot;2018-01-24&quot;</span>,
      <span class="tok-s2">&quot;endDate&quot;</span>: <span class="tok-s2">&quot;2018-01-24&quot;</span>,
      <span class="tok-s2">&quot;amount&quot;</span>: <span class="tok-m">5008</span>.84,
      <span class="tok-s2">&quot;currency&quot;</span>: <span class="tok-s2">&quot;USD&quot;</span>,
      <span class="tok-s2">&quot;childItems&quot;</span>: null,
      <span class="tok-s2">&quot;auditLogs&quot;</span>: null
    <span class="tok-o">}</span>
  <span class="tok-o">]</span>,
  <span class="tok-s2">&quot;isParentInvoice&quot;</span>: false,
  <span class="tok-s2">&quot;auditLogs&quot;</span>: null
<span class="tok-o">}</span></code></pre></div></div></div></div>
<div class="sect2"><h3 id="components-invoicing-usage">Usage Billing</h3><div class="sect3"><h4 id="_usage_invoice_items">Usage Invoice Items</h4><div class="paragraph"><p>As described in the section <a href="http://docs.killbill.io/latest/userguide_subscription.html#components-catalog-usage">Usage Billing</a>,
Kill Bill supports invoicing customers based on different usage types. The usage billing is always done on a per subscription
level and for a given billing period; in addition, if the active <code>Plan</code> associated with the subscription contains multiple usage
sections, each usage section is billed independently: As a result, we may see one or several <code>USAGE</code> invoice items per invoice,
each associated with a given subscription, usage section and billing period.</p></div>
<div class="paragraph"><p>Regardless of the usage type the following basic fields will always be seen:</p></div>
<div class="ulist"><ul><li><p><code>planName</code>: The name of the <code>Plan</code> in the catalog</p></li><li><p><code>phaseName</code>: The name of the <code>PlanPhase</code> in the catalog</p></li><li><p><code>subscriptionId</code>: The ID of the subscription</p></li><li><p><code>usageName</code>: The name of the usage section in the catalog</p></li><li><p><code>startDate</code>: The start date for the period being invoiced</p></li><li><p><code>endDate</code>: The end date for the period being invoiced</p></li></ul></div>
<div class="paragraph"><p>In addition, depending on the usage type for the usage section (e.g <code>CONSUMABLE</code>), and depending on the configuration of the system,
we may see additional information.</p></div></div>
<div class="sect3"><h4 id="_capacity_in_arrear_mode_2">Capacity In Arrear Mode</h4><div class="paragraph"><p>This mode bills based on actual usage, using a fixed price for the highest tier reached. For each capacity in arrear usage section, we will see some json in the field <code>itemDetails</code>, to provide additional information:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-o">{</span>
  <span class="tok-s2">&quot;tierDetails&quot;</span>: <span class="tok-o">[</span>
    <span class="tok-o">{</span>
      <span class="tok-s2">&quot;tier&quot;</span>: <span class="tok-m">2</span>,
      <span class="tok-s2">&quot;tierUnit&quot;</span>: <span class="tok-s2">&quot;bandwith-meg-sec&quot;</span>,
      <span class="tok-s2">&quot;tierPrice&quot;</span>: <span class="tok-m">10</span>,
      <span class="tok-s2">&quot;quantity&quot;</span>: <span class="tok-m">200</span>
    <span class="tok-o">}</span>,
    <span class="tok-o">{</span>
      <span class="tok-s2">&quot;tier&quot;</span>: <span class="tok-m">3</span>,
      <span class="tok-s2">&quot;tierUnit&quot;</span>: <span class="tok-s2">&quot;members&quot;</span>,
      <span class="tok-s2">&quot;tierPrice&quot;</span>: <span class="tok-m">100</span>,
      <span class="tok-s2">&quot;quantity&quot;</span>: <span class="tok-m">60</span>
    <span class="tok-o">}</span>
  <span class="tok-o">]</span>,
  <span class="tok-s2">&quot;amount&quot;</span>: <span class="tok-m">100</span>
<span class="tok-o">}</span></code></pre></div></div>
<div class="paragraph"><p>In this example we see that we were invoiced for 2 different units, and this shows the tier details for each unit, and the amount that will be charged.
Because unit <code>members</code> reached tier 3, the amount will be based on the pricing for this tier.</p></div></div>
<div class="sect3"><h4 id="_consumable_in_arrear_mode_2">Consumable In Arrear Mode</h4><div class="paragraph"><p>This mode bills for each unit based on actual usage, using a price determined by the tier(s) reached and by the policy. With the <code>ALL_TIER</code> policy, usage within each tier is charged according to the price for that tier. With the <code>TOP_TIER</code> policy, all usage is charged according to the price for the highest tier reached.</p></div>
<div class="paragraph"><p>We can configure the invoicing system to output one amount per tier (Detail Mode), or a single amount for all tiers (Aggregate Mode). The example below illustrates each mode for the <code>ALL_TIER</code> policy.</p></div></div>
<div class="sect3"><h4 id="_aggregate_mode">Aggregate Mode</h4><div class="paragraph"><p>In the aggregate mode, we will see one <code>USAGE</code> item with the aggregate amount across units and tiers. The <code>itemDetails</code> json will summarize the usage on a per tier basis and per unit basis:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-o">{</span>
  <span class="tok-s2">&quot;tierDetails&quot;</span>: <span class="tok-o">[</span>
    <span class="tok-o">{</span>
      <span class="tok-s2">&quot;tier&quot;</span>: <span class="tok-m">1</span>,
      <span class="tok-s2">&quot;tierUnit&quot;</span>: <span class="tok-s2">&quot;cell-phone-minutes&quot;</span>,
      <span class="tok-s2">&quot;tierPrice&quot;</span>: <span class="tok-m">2</span>,
      <span class="tok-s2">&quot;tierBlockSize&quot;</span>: <span class="tok-m">1</span>,
      <span class="tok-s2">&quot;quantity&quot;</span>: <span class="tok-m">20</span>,
      <span class="tok-s2">&quot;amount&quot;</span>: <span class="tok-m">40</span>
    <span class="tok-o">}</span>,
    <span class="tok-o">{</span>
      <span class="tok-s2">&quot;tier&quot;</span>: <span class="tok-m">2</span>,
      <span class="tok-s2">&quot;tierUnit&quot;</span>: <span class="tok-s2">&quot;cell-phone-minutes&quot;</span>,
      <span class="tok-s2">&quot;tierPrice&quot;</span>: <span class="tok-m">20</span>,
      <span class="tok-s2">&quot;tierBlockSize&quot;</span>: <span class="tok-m">1</span>,
      <span class="tok-s2">&quot;quantity&quot;</span>: <span class="tok-m">100</span>,
      <span class="tok-s2">&quot;amount&quot;</span>: <span class="tok-m">2000</span>
    <span class="tok-o">}</span>,
    <span class="tok-o">{</span>
      <span class="tok-s2">&quot;tier&quot;</span>: <span class="tok-m">1</span>,
      <span class="tok-s2">&quot;tierUnit&quot;</span>: <span class="tok-s2">&quot;Mbytes&quot;</span>,
      <span class="tok-s2">&quot;tierPrice&quot;</span>: <span class="tok-m">10</span>,
      <span class="tok-s2">&quot;tierBlockSize&quot;</span>: <span class="tok-m">1</span>,
      <span class="tok-s2">&quot;quantity&quot;</span>: <span class="tok-m">10</span>,
      <span class="tok-s2">&quot;amount&quot;</span>: <span class="tok-m">100</span>
    <span class="tok-o">}</span>
  <span class="tok-o">]</span>,
  <span class="tok-s2">&quot;amount&quot;</span>: <span class="tok-m">2140</span>
<span class="tok-o">}</span></code></pre></div></div>
<div class="paragraph"><p>In this example, we have billed for two unit types: <code>cell-phone-minutes</code> and <code>Mbytes</code>. For <code>cell-phone-minutes</code>, the quantity recorded for the period reached the maximum for tier 1 and extended into tier 2. Since we are using the <code>ALL_TIER</code> policy, the amount for each tier is computed separately, giving 40 for tier 1 and 2000 for tier 2. For the <code>Mbytes</code> units, all usage remained in tier 1, so a single amount, 100, is computed. The amount reported is the sum of the individual amounts: 40 + 2000 + 100 = 2140.</p></div>
<div class="paragraph"><p>If we were instead using the <code>TOP_TIER</code> policy, all usage of <code>cell-phone-minutes</code> would be billed at the tier 2 price (20) for a total of 2400, so the aggregate amount reported would be 2500.</p></div></div>
<div class="sect3"><h4 id="_detail_mode">Detail Mode</h4><div class="paragraph"><p>Sometimes it is desirable to output one <code>USAGE</code> item per unit type and tier, so in this case the detail for the billing is inside each
invoice item, and the aggregate amount is computed by summing all the amounts. In order to activate this mode, one needs to set
the system property <code>org.killbill.invoice.item.result.behavior.mode</code> to <code>DETAIL</code>.</p></div>
<div class="paragraph"><p>Each of the <code>USAGE</code> items will contain the following fields:</p></div>
<div class="ulist"><ul><li><p><code>quantity</code>: Quantity consumed for the unit (type) and on the given tier</p></li><li><p><code>rate</code>: The <code>rate</code> field normally reserved for the <code>RECURRING</code> type is used to output the price of the tier</p></li></ul></div>
<div class="paragraph"><p>Also, the <code>itemDetails</code> json field will provide some additional details:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-o">{</span>
  <span class="tok-s2">&quot;tier&quot;</span>: <span class="tok-m">1</span>,
  <span class="tok-s2">&quot;tierUnit&quot;</span>: <span class="tok-s2">&quot;cell-phone-minutes&quot;</span>,
  <span class="tok-s2">&quot;tierPrice&quot;</span>: <span class="tok-m">2</span>,
  <span class="tok-s2">&quot;tierBlockSize&quot;</span>: <span class="tok-m">1</span>,
  <span class="tok-s2">&quot;quantity&quot;</span>: <span class="tok-m">20</span>,
  <span class="tok-s2">&quot;amount&quot;</span>: <span class="tok-m">40</span>
<span class="tok-o">}</span></code></pre></div></div></div>
<div class="sect3"><h4 id="_past_usage_periods">Past Usage Periods</h4><div class="paragraph"><p>By default the system is configured to look at the past 2 billing periods, but this can be changed by using the configuration <code>org.killbill.invoice.readMaxRawUsagePreviousPeriod</code> (default=2). Let&#8217;s assume a MONTHLY subscription that was invoiced for the following periods:</p></div>
<div class="ulist"><ul><li><p><code>2018-01-01 - 2018-02-01</code></p></li><li><p><code>2018-02-01 - 2018-03-01</code></p></li><li><p><code>2018-03-01 - 2018-04-01</code></p></li></ul></div>
<div class="paragraph"><p>On <code>2018-05-01</code>, the system will by default look to invoice for the period <code>2018-04-01 - 2018-05-01</code>, but it will also recompute items for the past 2 periods, <code>2018-03-01 - 2018-04-01</code> and <code>2018-02-01 - 2018-03-01</code>.</p></div>
<div class="paragraph"><p>Late Usage Data:</p></div>
<div class="paragraph"><p>If for some reason, there is some late usage reported in these past 2 periods, the system will include this delta. Depending on the type of usage and mode (e.g <code>AGGREGATE</code>) we will see one or several <code>USAGE</code> item for this period to reflect this additional charge. If the late usage is older than these past 2 periods, it is simply ignored.</p></div>
<div class="paragraph"><p>Missing Usage Data:</p></div>
<div class="paragraph"><p>Currently it is considered an error to delete past usage data in these past 2 periods. If this occurs, the invoicing system throws an error and prevents invoicing from happening correctly. If the late missing data is older than these past 2 periods, it is simply ignored.</p></div>
<div class="paragraph"><p>One can set the system property&#8201;&#8212;&#8201;or per-tenant config&#8201;&#8212;&#8201;<code>org.killbill.invoice.readMaxRawUsagePreviousPeriod</code> to <code>0</code> to ignore any past data&#8201;&#8212;&#8201;late usage or missing data.</p></div></div></div>
<div class="sect2"><h3 id="components-invoice-payments">Invoice Payments</h3><div class="paragraph"><p>Payments can be made against existing invoices, either automatically by the system or manually using our apis. By default one payment is applied to pay one invoice in full. Kill Bill also allows multiple partial payments against a given invoice. Using one payment to pay multiple invoices is not (yet) supported.</p></div>
<div class="paragraph"><p>Payment in full against an invoice happens automatically provided the customer <code>Account</code> has a valid default payment method. However, This behavior will be disabled under the following conditions:</p></div>
<div class="ulist"><ul><li><p><code>Account</code> does not have a default payment method.</p></li><li><p><code>Account</code> has been tagged with one of the following:</p><div class="ulist"><ul><li><p><code>AUTO_PAY_OFF</code>: Prevent system from making automatic payments.</p></li><li><p><code>MANUAL_PAY</code>: Prevent system from making automatic payments because we expect those payments to happen outside of the Kill Bill system&#8201;&#8212;&#8201;e.g checks.</p></li></ul></div></li></ul></div>
<div class="paragraph"><p>Anytime an <code>Account</code> has a positive balance, i.e. at least one <code>Invoice</code> was not fully paid, one can use our apis to issue a manual payment against such invoices. Based on what we said earlier, this situation can occur if the system was configured to not make payments automatically, or in cases where a payment was issued but failed.</p></div>
<div class="paragraph"><p>The call below illustrates how to make a manual payment against an existing unpaid invoice:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span></span>curl -v <span class="tok-se">\</span>
-u admin:password <span class="tok-se">\</span>
-H <span class="tok-s2">&quot;Content-Type: application/json&quot;</span> <span class="tok-se">\</span>
-H <span class="tok-s2">&quot;X-Killbill-ApiKey: bob&quot;</span> <span class="tok-se">\</span>
-H <span class="tok-s2">&quot;X-Killbill-ApiSecret: lazar&quot;</span> <span class="tok-se">\</span>
-H <span class="tok-s1">&#39;X-Killbill-CreatedBy: demo&#39;</span> <span class="tok-se">\</span>
-X POST <span class="tok-se">\</span>
--data-binary <span class="tok-s1">&#39;{</span>
<span class="tok-s1">    &quot;accountId&quot;:  &quot;27cf01b3-ee14-4d7f-a63a-16ad632b7bbb&quot;,</span>
<span class="tok-s1">    &quot;paymentMethodId&quot;:  &quot;7cb5362a-ca9a-4ae0-9623-381201ded137&quot;,</span>
<span class="tok-s1">    &quot;targetInvoiceId&quot;:  &quot;99f91a42-a83f-4d59-b337-9df1b53f79b1&quot;,</span>
<span class="tok-s1">    &quot;purchasedAmount&quot;: 200.0</span>
<span class="tok-s1">}&#39;</span> <span class="tok-se">\</span>
<span class="tok-s1">&#39;http://127.0.0.1:8080/1.0/kb/invoices/99f91a42-a83f-4d59-b337-9df1b53f79b1/payments&#39;</span></code></pre></div></div>
<div class="paragraph"><p>Kill Bill keeps track of the mapping between invoices and payments, so that it can correctly compute the invoice balance, and also return the payment details associated with a given invoice. This mapping, <code>InvoicePayment</code>, is logically part of the invoice subsystem, and is returned when invoices are fetched.</p></div>
<div class="paragraph"><p>If an invoice doesn&#8217;t have a corresponding row in <code>invoice_payments</code>, this means the invoice isn&#8217;t paid (because either no payment was ever attempted, or the payment attempts were unsuccessful). There are three types of <code>InvoicePayment</code>: successful payment, payment followed by a refund, and payment fillowed by a chargeback. Each of these is described below.</p></div>
<div class="sect3"><h4 id="_successful_payment">Successful Payment</h4><div class="paragraph"><p>A successful payment against an invoice would have a single row (of type ATTEMPT):</p></div>
<table class="tableblock frame-all grid-all spread"><colgroup><col style="width: 25%;"><col style="width: 25%;"><col style="width: 25%;"><col style="width: 25%;"></colgroup><thead><tr><th class="tableblock halign-left valign-top">Invoice #</th><th class="tableblock halign-left valign-top">Type</th><th class="tableblock halign-left valign-top">Payment date</th><th class="tableblock halign-left valign-top">Amount</th></tr></thead><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">1029</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">ATTEMPT</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">2013-04-12 22:45:39</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">$20</p></td></tr></tbody></table></div>
<div class="sect3"><h4 id="_refund">Refund</h4><div class="paragraph"><p>A payment followed by a refund would look like this:</p></div>
<table class="tableblock frame-all grid-all spread"><colgroup><col style="width: 25%;"><col style="width: 25%;"><col style="width: 25%;"><col style="width: 25%;"></colgroup><thead><tr><th class="tableblock halign-left valign-top">Invoice #</th><th class="tableblock halign-left valign-top">Type</th><th class="tableblock halign-left valign-top">Payment date</th><th class="tableblock halign-left valign-top">Amount</th></tr></thead><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">1029</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">ATTEMPT</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">2013-04-12 22:45:39</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">$20</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">1029</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">REFUND</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">2013-04-18 10:23:11</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">$-20</p></td></tr></tbody></table></div>
<div class="sect3"><h4 id="_chargeback">Chargeback</h4><div class="paragraph"><p>Finally, a payment followed by a chargeback would look like this:</p></div>
<table class="tableblock frame-all grid-all spread"><colgroup><col style="width: 25%;"><col style="width: 25%;"><col style="width: 25%;"><col style="width: 25%;"></colgroup><thead><tr><th class="tableblock halign-left valign-top">Invoice #</th><th class="tableblock halign-left valign-top">Type</th><th class="tableblock halign-left valign-top">Payment date</th><th class="tableblock halign-left valign-top">Amount</th></tr></thead><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">1029</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">ATTEMPT</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">2013-04-12 22:45:39</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">$20</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">1029</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">CHARGED_BACK</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">2013-04-18 10:23:11</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">$-20</p></td></tr></tbody></table></div></div></div></div>
<div class="sect1"><h2 id="components-payment">Payment</h2><div class="sectionbody"><div class="sect2"><h3 id="_overview_2">Overview</h3><div class="paragraph"><p>Kill Bill provides a core payment system that is used in subscription billing to issue payment requests against the generated invoices.</p></div>
<div class="paragraph"><p>To accomodate that use case, the payment logic has been split into two pieces:</p></div>
<div class="paragraph"><p>First, there is a core payment system whose role is to manage the payment states and route the operation to the correct payment plugin, which in turn interracts with the third party payment gateway.
This core payment system is not specific to the subscription billing use case. It can be used also as a standalone system to provide a layer in front of various payment gateways.
For an overview of the payment system in Kill Bill, please check <a href="http://docs.killbill.io/latest/userguide_payment.html">the payment guide</a>.</p></div>
<div class="paragraph"><p>In order to support the subscription billing use case, and issue payments against existing invoices, there is a payment control plugin embedded into the Kill Bill core (see <a href="http://docs.killbill.io/latest/payment_control_plugin.html">payment control plugin guide</a>). The role of this plugin is to provide the necessary logic to coordinate the payments associated with an invoice:</p></div>
<div class="ulist"><ul><li><p>The plugin is called before the payment system attempts to make the payment call to provide the necessary sanity, such as verifying the invoice balance, checking whether the <code>Account</code> was tagged as <code>AUTO_PAY_OFF</code>, and interracting with the invoicing system to record the payment attempts.</p></li><li><p>The plugin is then called after the payment attempt to update the invoicing system about success or failure:</p><div class="ulist"><ul><li><p>In the case of success, this makes the invoice balance drops to zero.</p></li><li><p>In the the case of failure, this provides the plugin with the opportunity to schedule a payment retry.</p></li></ul></div></li></ul></div>
<div class="paragraph"><p>Note: The plugin linking the payment view to the invoice view is not a standalone plugin; instead it is part of the core Kill Bill source code. However, it acts as a plugin since it implements the <em>PaymentControlPluginApi</em>. It is possible to provide a standalone plugin that would override the behavior of the default plugin, but this should only be done for advanced use cases. Extra caution would be required to not break the contract between the invoicing and payment system.</p></div></div>
<div class="sect2"><h3 id="_payment_methods">Payment Methods</h3><div class="paragraph"><p>A <code>PaymentMethod</code> represents an abstraction to identify a way of making payments for a specific <code>Account</code>. Each consumer <code>Account</code> can have several payment methods to allow making payments using different schemes, such as credit cards, debit cards, or PayPal. In order to allow the system to automatically make payments against unpaid invoices, a <strong>default</strong> payment method must be specified.</p></div>
<div class="paragraph"><p>The payment method really has two functions:</p></div>
<div class="ulist"><ul><li><p>In the default use case, it allows the system to properly route the payment to the right Kill Bill plugin and to its associated third party payment gateway. Note however that the static configuration between the payment instrument&#8201;&#8212;&#8201;e.g the customer credit card&#8201;&#8212;&#8201;and the plugin can be overriden in a payment control plugin to provide <a href="http://docs.killbill.io/latest/payment_control_plugin.html#_payment_routing">payment routing capabilities</a>.</p></li><li><p>It allows enough details to be tracked to make the payment. For instance if the payment method is a credit card, the system would keep track of a credit card token that can be used to issue the payment. Often, some of this information is stored inside the payment plugin.</p></li></ul></div>
<div class="paragraph"><p>Kill Bill also allows the user to configure a special payment method, called <strong>external payment method</strong>, to allow recording payments that occured outside of the system. For example, a customer may be invoiced through Kill Bill, and later make payment by check. The payment needs to be recorded into the system to mark the invoice as being paid and to bring its balance to zero.</p></div>
<div class="paragraph"><p>A user would typically create a default external payment as shown below. Later, the returned <code>paymentMethodId</code> could be used to issue external payments against invoices (see <a href="http://docs.killbill.io/latest/userguide_subscription.html#components-invoice-payments">Invoice Payment section</a>).</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span></span>curl -v <span class="tok-se">\</span>
     -u admin:password <span class="tok-se">\</span>
     -H <span class="tok-s2">&quot;X-Killbill-ApiKey: bob&quot;</span> <span class="tok-se">\</span>
     -H <span class="tok-s2">&quot;X-Killbill-ApiSecret: lazar&quot;</span> <span class="tok-se">\</span>
     -H <span class="tok-s2">&quot;Content-Type: application/json&quot;</span> <span class="tok-se">\</span>
     -H <span class="tok-s2">&quot;X-Killbill-CreatedBy: demo&quot;</span> <span class="tok-se">\</span>
     -X POST <span class="tok-se">\</span>
     --data-binary <span class="tok-s1">&#39;{&quot;pluginName&quot;:&quot;__EXTERNAL_PAYMENT__&quot;,&quot;pluginInfo&quot;:{}}&#39;</span> <span class="tok-se">\</span>
     <span class="tok-s2">&quot;http://127.0.0.1:8080/1.0/kb/accounts/268983f2-5443-47e4-a967-b8962fc699c5/paymentMethods?isDefault=true&quot;</span></code></pre></div></div></div>
<div class="sect2"><h3 id="_payment_retries">Payment Retries</h3><div class="paragraph"><p>If a payment fails, the plugin may attempt a payment retry. There are two system properties that control the payment retry mechanism:</p></div>
<div class="ulist"><ul><li><p>Upon <em>PAYMENT_FAILURE</em>&#8201;&#8212;&#8201;when the payment plugin returns an <em>ERROR</em> status --, the payment system will look at the property <em>org.killbill.payment.retry.days</em>, and possibly schedule some retries based on that value. By default, this property is set with a default value of <em>8,8,8</em>, which means that a first retry would happen 8 days after the intial failure, and then if the first retry attempt failed, another attempt would be scheduled 8 days later and then finally a last one 8 days after that. If the last attempt fails, the payment remains in the <em>PAYMENT_FAILURE</em> state.</p></li><li><p>Upon <em>PLUGIN_FAILURE</em>&#8201;&#8212;&#8201;when the payment plugin returns a <em>CANCELED</em> status --,  the payment system will look at the property <em>org.killbill.payment.failure.retry.start.sec</em>, and possibly schedule some retries based on that value. By default, this property is set with a default value of <em>300</em>, which means that the payment would be scheduled to be retried one time 300 seconds&#8201;&#8212;&#8201;or 5 minutes&#8201;&#8212;&#8201;after the failure. <em>PLUGIN_FAILURE</em> is often linked to transient errors from third party gateways, so it makes sense to retry those fairly soon after the initial failure was seen. But of course, this all depends on the use case.</p></li></ul></div>
<div class="paragraph"><p>Payment retries in Kill Bill are implemented as payment transaction retries: For each retry attempt, the system will create a new <code>PaymentTransaction</code> associated with the same <code>Payment</code> object. Since the <code>paymentMethodId</code> is defined at the <code>Payment</code> level, it means that the same <code>paymentMethodId</code> will be used for each retry. If the goal is to retry with a new payment method, then one needs to create a new <code>Payment</code> associated with the different payment method. If there are ongoing retries scheduled, it is possible to cancel those but this is more for cleanliness, because once a payment has been successful, any other retry would be aborted; the system ensures that there cannot be any double payment.</p></div></div></div></div>
<div class="sect1"><h2 id="components-overdue">Overdue</h2><div class="sectionbody"><div class="sect2"><h3 id="components-overdue-overview">Overview</h3><div class="paragraph"><p>Kill Bill offers an <code>Overdue</code> feature, also referred to as Dunning, which is required when users don&#8217;t pay their bills. In those cases, the merchant needs to take some action and so the feature must be customizable. Note that the <code>Entitlement</code> and <code>Overdue</code> modules in Kill Bill are tied to each other and are there to manage the customer experience regarding her subscription(s):</p></div>
<div class="ulist"><ul><li><p>The <code>Entitlement</code> module defines the behavior of the system when the user starts or cancels a subscription or makes some change in an existing subscription. It controls the level of service received by the user (from no service at all to full service) after such an operation occurs.</p></li><li><p>The <code>Overdue</code> module is in charge of altering the customer experience when payments are not met. This alteration may include some degradation or even cancelation of the service. The overdue state is defined at the account level, which means that if a user has multiple subscriptions, and an invoice associated with one of them has not been paid, the behavior of the system with regard to the overdue state will be global for all subscriptions.</p></li></ul></div>
<div class="paragraph"><p>The Overdue module in Kill Bill relies on a configuration file which drives its behavior. The configuration can be specified at the tenant level, similarly to the catalog, or it can be specified globally for the system using the <code>org.killbill.overdue.uri</code> system property (e.g <code>org.killbill.overdue.uri=file:///&lt;path&gt;/overdue.xml</code>). This property specifies an overdue configuration file <code>overdue.xml</code>. For details on this file see  <a href="https://docs.killbill.io/latest/overdue.html">Overdue System</a>. If no file is specified, default values will be used.</p></div>
<div class="paragraph"><p>The Overdue module listens to payment events, then changes the overdue state for an account to the appropriate state based on the configuration. Whether the payment was a failure or not, the Overdue module will recompute the state associated with the account and potentially make the transition to another state.</p></div></div>
<div class="sect2"><h3 id="components-overdue-config">Configuration</h3><div class="paragraph"><p>The overdue configuration contains a list of the various states that a customer&#8217;s account may go through if the customer does not pay. Each state has a <code>name</code> and a <code>condition</code> which is evaluated by the <code>Overdue</code> module. Currently the condition to transition to a given state is based on the properties below, and the system will evaluate to true if all the parts of the conditions are true:</p></div>
<div class="ulist"><ul><li><p><code>numberOfUnpaidInvoicesEqualsOrExceeds</code></p></li><li><p><code>totalUnpaidInvoiceBalanceEqualsOrExceeds</code></p></li><li><p><code>timeSinceEarliestUnpaidInvoiceEqualsOrExceeds</code></p></li><li><p><code>responseForLastFailedPaymentIn</code>: (Not implemented)</p></li><li><p><code>controlTagInclusion</code></p></li><li><p><code>controlTagExclusion</code></p></li></ul></div>
<div class="paragraph"><p>Additionally, the definition of an overdue state will also specify some ways to alter the behavior of the system:</p></div>
<div class="ulist"><ul><li><p><code>subscriptionCancellationPolicy</code>: Specifies whether or not to cancel the subscriptions associated with the account (and the cancellation policy that should be used). The choices are (<code>NONE</code>, <code>IMMEDIATE</code>, <code>END_OF_TERM</code>).</p></li><li><p><code>blockChanges</code>: Specifies whether the customer is allowed to make any plan change on his subscriptions.</p></li><li><p><code>disableEntitlementAndChangesBlocked</code> :  The name is a bit misleading; it specifies whether the subscriptions are being paused, which means service (entitlement) will be disabled and billing will also be disabled. If the overdue state clears, both entitlement and billing would resume at the time of the clearance.</p></li></ul></div>
<div class="paragraph"><p>One can add an <code>externalMessage</code> which can be retrieved by plugins listening to Overdue events, and displayed to the user.</p></div>
<div class="paragraph"><p>Finally there is an additional property <code>autoReevaluationInterval</code> that tells the system when to re-evaluate the state when nothing happens in the system. When an account transitions to one of the overdue states specified by the xml file <code>overdue.xml</code>, two things can happen:</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>The user makes a payment OR the system retries previously failed payments</p></li><li><p>No payment attempt is being made</p></li></ol></div>
<div class="paragraph"><p>In the first case, the Overdue system will detect that a payment occurred and it will recompute the state, transitioning to a new state if required. In the second case, however, since there was no trigger, we need a way to tell the overdue system to re-evaluate the state every so often so it can advance into the next state if required. That is what the autoReevaluationInterval property is about.</p></div>
<div class="paragraph"><p>If you need an xsd file, you can find one <a href="http://docs.killbill.io/latest/overdue.xsd">here</a> or generate one using the overdue xsd-tool:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span></span>curl -O <span class="tok-s1">&#39;http://search.maven.org/remotecontent?filepath=org/kill-bill/billing/killbill-overdue/x.y.z/killbill-overdue-x.y.z-xsd-tool.jar&#39;</span>
java -jar killbill-overdue-*-xsd-tool.jar schema.xsd</code></pre></div></div></div></div></div>
<div class="sect1"><h2 id="components-tag">Tags</h2><div class="sectionbody"><div class="paragraph"><p>Kill Bill offers the ability to tag resources (account, invoice, payment, subscription, etc.) in the system. There are two main types of tags:</p></div>
<div class="ulist"><ul><li><p><code>User tags</code>: These tags are not interpreted by the system; they are a convenient way for admins or third party systems to annotate specific existing resources. For instance, the support team could tag account resources associated with a specific customer to group them.</p></li><li><p><code>Control tags</code>: These tags modify the behavior of the system. The following control tags can be associated with an account:</p><div class="ulist"><ul><li><p>AUTO_PAY_OFF: When this tag is set, the system will not attempt to trigger automatic payments from this account after invoices have been generated. When the tag is removed, the system will immediately attempt to issue the payments that were not made.</p></li><li><p>AUTO_INVOICING_OFF: When this tag is set, the system will not attempt to invoice the customer. When the tag is removed, the system will immediately attempt to issue invoices for the account.</p></li><li><p>OVERDUE_ENFORCEMENT_OFF: When this tag is set, the system will not attempt to change the account into an overdue state regardless of any potential failed payments. When the tag is removed, the system will immediately recompute the current overdue state.</p></li><li><p>MANUAL_PAY: When this tag is set, the system will not attempt to trigger automatic payments after invoices have been generated. The intent of this tag is to allow the customer to make his payment outside of Kill Bill.</p></li><li><p>TEST: This tag is used by the analytics plugin to prevent this account from being included in the set of accounts.</p></li><li><p>PARTNER: This tag is used by the analytics plugin so the account can be interpreted differently.</p></li></ul></div></li><li><p>The following control tag is associated with a specific invoice:</p><div class="ulist"><ul><li><p>WRITTEN_OFF: This tag indicates that the balance for this invoice should be ignored by the system.</p></li></ul></div></li></ul></div></div></div>
<div class="sect1"><h2 id="_glossary">Glossary</h2><div class="sectionbody"><div class="paragraph"><p><strong>Account</strong> - An object representing a customer account. It contains details about the customer such as name, address, email address, phone number, etc.</p></div>
<div class="paragraph"><p><strong>Bundle</strong> - A collection of subscriptions associated with a single service instance. For example, a customer might have a base subscription for her phone plus an addon that provides cheap international dialing. Because both Subscriptions are associated with the same phone, they are collected into a single Bundle. An account may own several Bundles, each with one or more Subscriptions.</p></div>
<div class="paragraph"><p><strong>Catalog</strong> - A description of the set of Products, Plans, Price Lists and Rules that are being made available to customers. A catalog lets Kill Bill know what is being offered for sale and how much to charge for it.</p></div>
<div class="paragraph"><p><strong>Payment Method</strong> - A record of the details required for Kill Bill to trigger a payment. Payment Methods represent things like credit cards, debit cards, or PayPal accounts. Each Account can have many Payment Methods and at most one Default Payment Method. Note that much of the representation of a Payment Method is plugin-specific and is actually stored by the Payment Plugin itself.</p></div>
<div class="paragraph"><p><strong>Plan</strong> - A Catalog object that defines how a Product is to be paid for. Plans can have multiple phases (e.g. trial, discount, evergreen). The phase specifies the frequency of payment and the prices in multiple currencies. Each phase can have fixed and recurring prices associated with it. Each Product can have multiple Plans specifying different ways that the Product can be purchased (e.g. a monthly Plan and an annual Plan).</p></div>
<div class="paragraph"><p><strong>Price list</strong> - A collection of Plans that might be associated with a particular program (e.g. an affiliate program or a discount program). A Plan can be in many Price Lists. There must be a default Price List that is used when no Price List is specified. When a Subscription changes Plans, Catalog Rules can be used to determine which Price List the new Plan should use.</p></div>
<div class="paragraph"><p><strong>Product</strong> - A product or service that the customer buys.</p></div>
<div class="paragraph"><p><strong>Subscription</strong> - A contract that associates an account with a Plan and a specific start date. The Subscription will trigger automated payments based on the terms of the Plan.</p></div>
<div class="paragraph"><p><strong>Tag</strong> - A property that can be added to Accounts, Bundles or Subscriptions. There are two kinds of Tags: System Tags and User Tags. System Tags can impact the behaviour of the system. Examples include AUTO_PAY_OFF or AUTO_BILLING_OFF. User Tags are informational only, and can be created through the admin UI. User Tags are used to identify collections of Users, Subscriptions or Bundles so that they can easily be found or reported on later.</p></div></div></div></div></div><div class="col-12 col-md-3 col-xl-2 bd-sidebar sticky-top border-columns border-right p-0"><nav class="collapse bd-links toc right-side-menu" id="toc" data-toggle="toc"></nav></div></div></div><div class="container-fluid"><div class="row"><div class="col-12 border-columns"></div><div id="footer"><div id="footer-text">Last updated 2021-04-16 07:23:16 UTC</div><script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
          ga('create','UA-32705710-3','auto');
          ga('send','pageview');
          var getOutboundLink = function(url) {
            ga('send', {
              hitType: 'event',
              eventCategory: 'outbound',
              eventAction: 'click',
              eventLabel: url,
              hitCallback: function(){document.location = url;}
            });
          }
          </script></div><script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script><script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script><script src="https://cdn.staticaly.com/gh/afeld/bootstrap-toc/v1.0.0/dist/bootstrap-toc.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script><script type="text/javascript">docsearch({apiKey: '9d2f6d24a05863f83c8844f6e7492c66',indexName: 'killbill',inputSelector: '#search-input',debug: false});</script></body></html>