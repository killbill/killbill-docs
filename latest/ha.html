<!DOCTYPE html><html lang="en"><head><title>Hierarchical Accounts Tutorial</title><style>pre.pygments .hll { background-color: #ffffcc }
pre.pygments { background: #f8f8f8; }
pre.pygments .tok-c { color: #3D7B7B; font-style: italic } /* Comment */
pre.pygments .tok-err { border: 1px solid #FF0000 } /* Error */
pre.pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
pre.pygments .tok-o { color: #666666 } /* Operator */
pre.pygments .tok-ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
pre.pygments .tok-cp { color: #9C6500 } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
pre.pygments .tok-cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
pre.pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-gr { color: #E40000 } /* Generic.Error */
pre.pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
pre.pygments .tok-gi { color: #008400 } /* Generic.Inserted */
pre.pygments .tok-go { color: #717171 } /* Generic.Output */
pre.pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
pre.pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
pre.pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
pre.pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #B00040 } /* Keyword.Type */
pre.pygments .tok-m { color: #666666 } /* Literal.Number */
pre.pygments .tok-s { color: #BA2121 } /* Literal.String */
pre.pygments .tok-na { color: #687822 } /* Name.Attribute */
pre.pygments .tok-nb { color: #008000 } /* Name.Builtin */
pre.pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
pre.pygments .tok-no { color: #880000 } /* Name.Constant */
pre.pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
pre.pygments .tok-ni { color: #717171; font-weight: bold } /* Name.Entity */
pre.pygments .tok-ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
pre.pygments .tok-nf { color: #0000FF } /* Name.Function */
pre.pygments .tok-nl { color: #767600 } /* Name.Label */
pre.pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
pre.pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
pre.pygments .tok-nv { color: #19177C } /* Name.Variable */
pre.pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
pre.pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
pre.pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #BA2121 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #BA2121 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
pre.pygments .tok-se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #008000 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #A45A77 } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #0000FF } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #19177C } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */</style><link rel="icon" type="image/x-icon" href="/stylesheets/images/favicon.ico"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3"><link rel="preconnect" href="https://S2ISXITURI-dsn.algolia.net"><link rel="stylesheet" href='stylesheets/bootstrap.min.css'><link rel="stylesheet" href='stylesheets/bootstrap-toc.min.css'><link rel="stylesheet" href="stylesheets/kb.css"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="description" content="Hierarchical Accounts Tutorial"></head><body data-spy="scroll" data-target="#myScrollspy" data-offset="100"><div class="loader-wrapper"><div id="loading"></div></div><header class="header sticky" id="header"><div class="header-wrapper"><div class="container-fluid"><div class="row flex-xl-nowrap justify-content-evenly"><div class="header-logo"><div class="logo"><a href="/"><img src="/stylesheets/images/logo/light-logo.svg" style="height:38px" alt="Kill Bill Docs" id="logo" height="38" width="146"></a></div><div class="switch"><input type="checkbox" aria-label="Search" name="theme-toggle" id="theme-toggle"><span class="slider round"></span></div></div><div class="nav-toggler sidebar-toggler"><svg class="hamburger" xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M20.75 7C20.75 7.41421 20.4142 7.75 20 7.75L4 7.75C3.58579 7.75 3.25 7.41421 3.25 7C3.25 6.58579 3.58579 6.25 4 6.25L20 6.25C20.4142 6.25 20.75 6.58579 20.75 7Z" fill=""/><path fill-rule="evenodd" clip-rule="evenodd" d="M20.75 12C20.75 12.4142 20.4142 12.75 20 12.75L4 12.75C3.58579 12.75 3.25 12.4142 3.25 12C3.25 11.5858 3.58579 11.25 4 11.25L20 11.25C20.4142 11.25 20.75 11.5858 20.75 12Z" fill=""/><path fill-rule="evenodd" clip-rule="evenodd" d="M20.75 17C20.75 17.4142 20.4142 17.75 20 17.75L4 17.75C3.58579 17.75 3.25 17.4142 3.25 17C3.25 16.5858 3.58579 16.25 4 16.25L20 16.25C20.4142 16.25 20.75 16.5858 20.75 17Z" fill=""/></svg></div><div class="header-search"><div class="search-form-wrapper"><div id="docsearch" style="height: 43px; display: flex; align-items: center; width: 100%;"></div></div></div></div></div></div></header><main class="main sidebar-show"><div class="container-fluid"><div class="row flex-xl-nowrap"><div class="sidebar-wrapper"><aside class="sidebar"><div class="sidebar__control"><svg width="8" height="12" viewBox="0 0 8 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6.33316 10.6665L1.6665 5.99992L6.33316 1.33325" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div><nav class="sidebar-nav"><ul class="nav navbar-nav"><li><div class="icon-title"><a class="bd-toc-link main-link" role="button">Getting Started</a><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li><a class="nav-link" href="/latest/what_is_kill_bill.html">What is Kill Bill?</a></li><li><a class="nav-link" href="/latest/getting_started.html">Getting Started (Installation)</a></li><li><a class="nav-link" href="/latest/quick_start_with_kaui.html">Quick Start with Kaui</a></li><li><a class="nav-link" href="/latest/quick_start_with_kb_api.html">Quick Start with the Kill Bill API</a></li></ul></li><li><div class="icon-title"><a class="bd-toc-link main-link" role="button">Installation</a><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/stripe_plugin.html">Kill Bill + Stripe DIY</a></li><li><a class="nav-link" href="/latest/userguide_deployment.html">Going to Production</a></li><li><a class="nav-link" href="/latest/how-to-upgrade-the-database.html">Database Migrations</a></li><li><a class="nav-link" href="/latest/PostgreSQL.html">PostgreSQL Setup</a></li><li><a class="nav-link" href="https://github.com/killbill/killbill/releases" onclick="getOutboundLink('https://github.com/killbill/killbill/releases'); return false;">Release&nbsp;Notes</a></li></ul></li><li><div class="icon-title"><a class="bd-toc-link main-link" role="button">AWS</a><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/how-to-set-up-a-single-tier-system.html">Single-Tier Setup</a></li><li><a class="nav-link" href="/latest/how-to-set-up-a-multi-tier-system.html">Multi-Tier Setup</a></li><li><a class="nav-link" href="/latest/how-to-set-up-a-cloud-formation-system.html">CloudFormation Setup</a></li><li class="bd-sidenav-active"><a class="nav-link" href="/latest/how-to-maintain-a-single-tier-system.html">Single-Tier Maintenance</a></li><li><a class="nav-link" href="/latest/how-to-maintain-a-multi-tier-system.html">Multi-Tier Maintenance</a></li><li><a class="nav-link" href="/latest/how-to-maintain-a-cloud-formation-system.html">CloudFormation Maintenance</a></li></ul></li><li><div class="icon-title"><a class="bd-toc-link main-link" role="button">Manuals</a><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/userguide_subscription.html">Subscription&nbsp;Billing</a></li><li><a class="nav-link" href="/latest/userguide_payment.html">Payment Processing</a></li><li><a class="nav-link" href="/latest/userguide_kaui.html">Kaui, the Administrative&nbsp;UI</a></li><li><a class="nav-link" href="/latest/email-notification-plugin.html">Email Notification Plugin</a></li><li><a class="nav-link" href="/latest/custom-email-invoice-formatter.html">Custom Email Formatter</a></li><li><a class="nav-link" href="/latest/userguide_analytics.html">Analytics Plugin</a></li><li><a class="nav-link" href="/latest/userguide_configuration.html">Kill Bill&nbsp;Configuration</a></li><li><a class="nav-link" href="/latest/internationalization.html">Kill Bill&nbsp;Internationalization</a></li><li><a class="nav-link" href="/latest/migration_guide.html">Migrating to Kill Bill</a></li></ul></li><li><div class="icon-title"><a class="bd-toc-link main-link" role="button">Tutorials</a><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/plan_alignment.html">Plans Alignments</a></li><li><a class="nav-link" href="/latest/overdue.html">Overdue System</a></li><li><a class="nav-link" href="/latest/consumable_in_arrear.html">In Arrear UsageBilling</a></li><li><a class="nav-link" href="/latest/ha.html">Hierarchical Accounts</a></li><li><a class="nav-link" href="/latest/catalog-examples.html">Catalog Examples</a></li><li><a class="nav-link" href="/latest/invoice_examples.html">Invoice Examples</a></li><li><a class="nav-link" href="/latest/invoice_templates.html">Invoice Templates</a></li></ul></li><li><div class="icon-title"><a class="bd-toc-link main-link" role="button">Integration</a><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="http://killbill.github.io/slate" onclick="getOutboundLink('http://killbill.github.io/slate'); return false;">REST API Reference</a></li><li><a class="nav-link" href="/latest/swagger_documentation.html">Swagger UI Documentation</a></li><li><a class="nav-link" href="/latest/postman.html">Postman Integration</a></li><li><a class="nav-link" href="/latest/debugging.html">Debugging</a></li><li><a class="nav-link" href="/latest/push_notifications.html">Push Notifications</a></li><li><a class="nav-link" href="/latest/kill_bill_events.html">Kill Bill Events</a></li></ul></li><li><div class="icon-title"><a class="bd-toc-link main-link" role="button">Plugin Development</a><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/plugin_introduction.html">Plugin Introduction</a></li><li class="bd-sidenav-active"><a class="nav-link" href="/latest/plugin_development.html">Plugin Development</a></li><li class="bd-sidenav-active"><a class="nav-link" href="/latest/plugin_installation.html">Plugin Installation</a></li><li><a class="nav-link" href="/latest/plugin_use_cases.html">Special Plugin Use Cases</a></li><li><a class="nav-link" href="/latest/notification_plugin.html">Notification Plugins</a></li><li><a class="nav-link" href="/latest/payment_plugin.html">Payment Plugins</a></li><li><a class="nav-link" href="/latest/payment_control_plugin.html">Payment Control Plugins</a></li><li><a class="nav-link" href="/latest/usage_plugin.html">Usage Plugins</a></li><li><a class="nav-link" href="/latest/invoice_plugin.html">Invoice Plugins</a></li><li><a class="nav-link" href="/latest/catalog_plugin.html">Catalog Plugins</a></li><li><a class="nav-link" href="/latest/entitlement_plugin.html">Entitlement Plugins</a></li></ul></li><li><div class="icon-title"><a class="bd-toc-link main-link" role="button">Operational Guides</a><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/deploy_to_kubernetes.html">Kubernetes (K8s) Deployment</a></li><li class="bd-sidenav-active"><a class="nav-link" href="/latest/user_management.html">Users, Roles, and Permissions</a></li><li><a class="nav-link" href="/latest/plugin_management.html">Plugin Management</a></li><li><a class="nav-link" href="/latest/aws-tools.html">AWS Analytics Tools</a></li></ul></li><li><div class="icon-title"><a class="bd-toc-link main-link" role="button">Client Libraries</a><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/java_client.html">Java</a></li><li><a class="nav-link" href="http://github.com/killbill/killbill-client-ruby" onclick="getOutboundLink('http://github.com/killbill/killbill-client-ruby'); return false;">Ruby</a></li><li><a class="nav-link" href="http://github.com/killbill/killbill-client-php" onclick="getOutboundLink('http://github.com/killbill/killbill-client-php'); return false;">PHP</a></li><li><a class="nav-link" href="http://github.com/killbill/killbill-client-js" onclick="getOutboundLink('http://github.com/killbill/killbill-client-js'); return false;">Node.js</a></li><li><a class="nav-link" href="http://github.com/killbill/killbill-client-python" onclick="getOutboundLink('http://github.com/killbill/killbill-client-python'); return false;">Python</a></li><li><a class="nav-link" href="http://github.com/killbill/kbcli" onclick="getOutboundLink('http://github.com/killbill/kbcli'); return false;">KillBill Go </a></li></ul></li><li><div class="icon-title"><a class="bd-toc-link main-link" role="button">About Kill Bill</a><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/demo.html">Demo</a></li><li><a class="nav-link" href="/latest/features.html">Features List</a></li><li><a class="nav-link" href="/latest/faq.html">Technical FAQs</a></li><li><a class="nav-link" href="/latest/Kill-Bill-Glossary.html">Glossary</a></li></ul></li><li><div class="icon-title"><a class="bd-toc-link main-link" role="button">Internal</a><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/internal_design.html">Internal Design</a></li><li><a class="nav-link" href="/latest/entitlement_subsystem.html">Entitlement Subsystem</a></li><li><a class="nav-link" href="/latest/invoice_subsystem.html">Invoice Subsystem</a></li><li><a class="nav-link" href="/latest/development.html">Development Environment</a></li></ul></li><li><div class="icon-title"><a class="bd-toc-link main-link" role="button">References</a><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="https://github.com/killbill/killbill-docs/tree/v3/swagger" onclick="getOutboundLink('https://github.com/killbill/killbill-docs/tree/v3/swagger'); return false;">Swagger&nbsp;API Schema</a></li><li><a class="nav-link" href="/latest/catalog.xsd">Catalog XSD Reference</a></li><li><a class="nav-link" href="/latest/overdue.xsd">Overdue XSD Reference</a></li></ul></li></ul></nav><script src="https://code.jquery.com/jquery-3.6.1.min.js"></script><script>
  let $ = jQuery;
  $('.sidebar-nav .icon-title').on('click', function (e) {
    e.preventDefault();
    $('.sidebar-nav .nav.navbar-nav .nav.navbar-nav').slideUp(200);
    $('.sidebar-nav > .navbar-nav > li').removeClass('open');

    if($(this).next().is(':visible')){
      $('.sidebar-nav .nav.navbar-nav .nav.navbar-nav').slideUp(200);
      $('.sidebar-nav > .navbar-nav > li').removeClass('open');
    } else {
      $(this).parent().addClass('open');
      $(this).next().slideDown(200);
    }
  });

  let pageURL = $(location).attr("href");
  pageURL = pageURL.includes('.html') ? pageURL : pageURL + '.html';
  $('.nav-link').each(function() {
    if (pageURL.toLowerCase().includes($(this).attr('href').toLowerCase())) {
      $(this).parent().addClass('list-item-active');
      $(this).parent().parent().addClass('active-list');
      $(this).parent().parent().prev().addClass('bd-link-active-wrap');
    }
  });
</script><a class="doclink" href="mailto:support@killbill.io">Report a doc problem</a></aside></div><div class="article-container"><div class="center-content"><div class="main-wrapper"><article class="content-wrapper"><div class="banner"><h1>Hierarchical Accounts Tutorial</h1></div><div id="content"><div class="sect1">
<h2 id="_overview">Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Starting with Kill Bill 0.18.x, we have introduced support for Hierarchical Accounts (HA). In this tutorial, we will review what the feature is about, and then explore how it works and which APIs to use.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s first review what we have prior to introducing the HA feature: In the Kill Bill terminology, a customer will be represented as a Kill Bill <code>Account</code>, and such <code>Account</code> will then be invoiced based on its current subscriptions and one-off charges. Payments will also be made by using the default payment method associated with the <code>Account</code>.</p>
</div>
<div class="paragraph">
<p>The idea of the HA feature is to delegate some of the payment operations associated with an <code>Account</code> to a <code>parent Account</code>. Some typical use cases are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Affiliate model: In this scenario, payments associated with some customers are made through the <code>parent Account</code> but each individual <code>Account</code> will manage its own subscriptions and will have access to its associated invoices.</p>
</li>
<li>
<p>Sub-Organization: In large organizations, it is common to see sub-organizations working independently, and yet the parent organization is responsible for the payments.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The new HA feature allows for the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ability to set an <code>Account</code> as the child of another <code>Account</code></p>
</li>
<li>
<p>Ability to specify on an <code>Account</code> that it will be responsible for paying its own invoices (default behaviour)</p>
</li>
<li>
<p>Ability to specify on an <code>Account</code> that the parent will be responsible for the payments</p>
</li>
<li>
<p>Ability to transfer credit from child <code>Account</code> to parent <code>Account</code></p>
</li>
<li>
<p>Ability to list all children <code>Account</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_does_it_work">How does it work?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Kill Bill <code>Account</code> abstraction has been enhanced to allow specifying a parent <code>Account</code> and whether or not that parent <code>Account</code> is responsible to pay its children&#8217;s invoices. A parent <code>Account</code> is an <code>Account</code> that contains one or more children <code>Account</code>. When such a parent <code>Account</code> exists and when its children have been configured to delegate their payments, the following happens:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Every time the system computes a new invoice (or adjusts an existing one) for a given child <code>Account</code>, the parent gets notified and also computes a special summary invoice that will include all of the items for all the children on a given day.</p>
</li>
<li>
<p>The payment system will ignore the child invoice as it knows this should be paid by the parent.</p>
</li>
<li>
<p>At the end of each day (UTC time, or as configued by the per-tenant <code>org.killbill.invoice.parent.commit.local.utc.time</code> property), the summary invoice will transition from <code>DRAFT</code> to <code>COMMITTED</code>.</p>
</li>
<li>
<p>As a result, the payment system will attempt to make a payment for the parent summary invoice using the default payment method associated with the parent <code>Account</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>As we can see, each child <code>Account</code> can still have its own subscriptions and matching invoices, but associated payments are delegated to the parent through the daily computation of a summary invoice.</p>
</div>
<div class="paragraph">
<p>The balance associated with both the child invoice and parent summary invoice will be zero until the end of the day when the transition from <code>DRAFT</code> to <code>COMMITTED</code> occurs. At this point, if the payment succeeds, then such invoice balances remain at zero. If not, then each invoice balance (child and parent) becomes equal to its invoice amount.</p>
</div>
<div class="paragraph">
<p>In terms of dunning (overdue), since the parent <code>Account</code> is the one making the payments, then overdue system will compute dunning state based on the per-tenant overdue configuration and parent <code>Account&#8217;s payment state. The children `Account</code> will inherit the same dunning state as their parent. As a result, one unpaid parent invoice that did not contain any invoice item for a given child would still put this child in an overdue state.</p>
</div>
<div class="sect2">
<h3 id="_un_and_re_parenting">Un- and Re-parenting</h3>
<div class="paragraph">
<p>Children can be un-parented or re-parented to a different parent <code>Account</code>.</p>
</div>
<div class="paragraph">
<p>Common use-cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Affiliate parent goes out of business but the child would like to continue using the service without interruption</p>
</li>
<li>
<p>Ownership transfer: a service provider company (parent <code>Account</code>) created a child account for a specific customer or project. During the Proof Of Concept (POC) phase, the service provider pays the bills. Past the POC stage, the company transfers ownership to the customer so it starts paying its own bills</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When this occurs, the previous parent still owes any unpaid invoice. For instance, if the child had an unpaid invoice of $10, both parent and child still have an account balance of $10 after un-parenting. Payment retries will continue; for example, if the parent retries the payment after un-parenting occurs, and if the payment retry is successful, the parent will pay the child invoice (and bring back both account balances to $0), even though the relationship doesn&#8217;t exist anymore. Any new invoice generated after un-parenting would only be owed by the child, though.</p>
</div>
<div class="paragraph">
<p>To put it differently, un- and re-parenting don&#8217;t affect past invoices: children can return to do their own billing, in which case the parent is responsible for things billed up to un-parenting and children are responsible for things billed after that. Similarly, children will continue to be responsible for payments against anything that has already been billed before (re-)parenting but the parent will be responsible for bills moving forward.</p>
</div>
<div class="paragraph">
<p>To avoid this behavior, child invoices should be adjusted (or written off) prior to un- or re-parenting, to start from a clean state.</p>
</div>
</div>
<div class="sect2">
<h3 id="_invoices_in_draft_mode">Invoices in DRAFT mode</h3>
<div class="paragraph">
<p>If a child <code>Account</code> is tagged with <code>AUTO_INVOICING_DRAFT</code>, the parent does not receive any notification until that child invoice gets committed.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tutorial">Tutorial</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will generate a child <code>Account</code> associated with one parent <code>Account</code> to see what happens (we assume the defauly demo bob/lazar tenant already exists).</p>
</div>
<div class="paragraph">
<p>Let&#8217;s first create the parent <code>Account</code> (we can see its ID in the <code>Location</code> header that is being returned) and also add a default payment method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>curl<span class="tok-w"> </span>-v<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-u<span class="tok-w"> </span>admin:password<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;X-Killbill-ApiKey: bob&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;X-Killbill-ApiSecret: lazar&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;Content-Type: application/json&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;X-Killbill-CreatedBy: demo&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-X<span class="tok-w"> </span>POST<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>--data-binary<span class="tok-w"> </span><span class="tok-s1">&#39;{&quot;name&quot;:&quot;Parent&quot;,&quot;email&quot;:&quot;parent@example.com&quot;,&quot;currency&quot;:&quot;USD&quot;}&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span><span class="tok-s2">&quot;http://127.0.0.1:8080/1.0/kb/accounts&quot;</span>

&lt;<span class="tok-w"> </span>Location:<span class="tok-w"> </span>http://127.0.0.1:8080/1.0/kb/accounts/09d5dfdf-eff2-4b45-96d8-535ea269178e

curl<span class="tok-w"> </span>-v<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-u<span class="tok-w"> </span>admin:password<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;X-Killbill-ApiKey: bob&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;X-Killbill-ApiSecret: lazar&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;Content-Type: application/json&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;X-Killbill-CreatedBy: demo&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-X<span class="tok-w"> </span>POST<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>--data-binary<span class="tok-w"> </span><span class="tok-s1">&#39;{&quot;pluginName&quot;:&quot;__EXTERNAL_PAYMENT__&quot;,&quot;pluginInfo&quot;:{}}&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span><span class="tok-s2">&quot;http://127.0.0.1:8080/1.0/kb/accounts/09d5dfdf-eff2-4b45-96d8-535ea269178e/paymentMethods?isDefault=true&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s now create the child <code>Account</code> (notice the new fields <code>parentAccountId</code> and <code>isPaymentDelegatedToParent</code> in the json):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>curl<span class="tok-w"> </span>-v<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-u<span class="tok-w"> </span>admin:password<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;X-Killbill-ApiKey: bob&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;X-Killbill-ApiSecret: lazar&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;Content-Type: application/json&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;X-Killbill-CreatedBy: demo&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-X<span class="tok-w"> </span>POST<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>--data-binary<span class="tok-w"> </span><span class="tok-s1">&#39;{&quot;name&quot;:&quot;C1&quot;,&quot;email&quot;:&quot;c1@example.com&quot;,&quot;currency&quot;:&quot;USD&quot;,&quot;parentAccountId&quot;:&quot;09d5dfdf-eff2-4b45-96d8-535ea269178e&quot;, &quot;isPaymentDelegatedToParent&quot;:true}&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span><span class="tok-s2">&quot;http://127.0.0.1:8080/1.0/kb/accounts&quot;</span>

&lt;<span class="tok-w"> </span>Location:<span class="tok-w"> </span>http://127.0.0.1:8080/1.0/kb/accounts/ea58b7dd-eb23-4065-a3e5-980291d45ab8</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s now create a subscription for the child <code>Account</code> (we&#8217;ll use a simple monthly plan with no trial called <code>zoo-monthly</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>curl<span class="tok-w"> </span>-v<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-u<span class="tok-w"> </span>admin:password<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;X-Killbill-ApiKey: bob&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;X-Killbill-ApiSecret: lazar&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;Content-Type: application/json&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;X-Killbill-CreatedBy: demo&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-X<span class="tok-w"> </span>POST<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>--data-binary<span class="tok-w"> </span><span class="tok-s1">&#39;{&quot;accountId&quot;:&quot;ea58b7dd-eb23-4065-a3e5-980291d45ab8&quot;,&quot;externalKey&quot;:&quot;s1&quot;,&quot;planName&quot;:&quot;zoo-monthly&quot;}&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span><span class="tok-s2">&quot;http://127.0.0.1:8080/1.0/kb/subscriptions&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we inspect our database entries, we see that there is a COMMITTED invoice for the child and a DRAFT invoice for the parent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mysql&gt;<span class="tok-w"> </span><span class="tok-k">select</span><span class="tok-w"> </span>*<span class="tok-w"> </span>from<span class="tok-w"> </span>invoices<span class="tok-w"> </span>where<span class="tok-w"> </span><span class="tok-nv">account_id</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s1">&#39;ea58b7dd-eb23-4065-a3e5-980291d45ab8&#39;</span><span class="tok-se">\G</span>
***************************<span class="tok-w"> </span><span class="tok-m">1</span>.<span class="tok-w"> </span>row<span class="tok-w"> </span>***************************
<span class="tok-w">        </span>record_id:<span class="tok-w"> </span><span class="tok-m">45545</span>
<span class="tok-w">               </span>id:<span class="tok-w"> </span>742c700d-e957-4948-a0bb-b16c0e4a4ecb
<span class="tok-w">       </span>account_id:<span class="tok-w"> </span>ea58b7dd-eb23-4065-a3e5-980291d45ab8
<span class="tok-w">     </span>invoice_date:<span class="tok-w"> </span><span class="tok-m">2016</span>-12-09
<span class="tok-w">      </span>target_date:<span class="tok-w"> </span><span class="tok-m">2016</span>-12-09
<span class="tok-w">         </span>currency:<span class="tok-w"> </span>USD
<span class="tok-w">           </span>status:<span class="tok-w"> </span>COMMITTED
<span class="tok-w">         </span>migrated:<span class="tok-w"> </span><span class="tok-m">0</span>
<span class="tok-w">   </span>parent_invoice:<span class="tok-w"> </span><span class="tok-m">0</span>
<span class="tok-w">       </span>created_by:<span class="tok-w"> </span>SubscriptionBaseTransition
<span class="tok-w">     </span>created_date:<span class="tok-w"> </span><span class="tok-m">2016</span>-12-09<span class="tok-w"> </span><span class="tok-m">21</span>:11:12
account_record_id:<span class="tok-w"> </span><span class="tok-m">6750</span>
<span class="tok-w"> </span>tenant_record_id:<span class="tok-w"> </span><span class="tok-m">338</span>
<span class="tok-m">1</span><span class="tok-w"> </span>row<span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-nb">set</span><span class="tok-w"> </span><span class="tok-o">(</span><span class="tok-m">0</span>.00<span class="tok-w"> </span>sec<span class="tok-o">)</span>

mysql&gt;<span class="tok-w"> </span><span class="tok-k">select</span><span class="tok-w"> </span>*<span class="tok-w"> </span>from<span class="tok-w"> </span>invoices<span class="tok-w"> </span>where<span class="tok-w"> </span><span class="tok-nv">account_id</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s1">&#39;09d5dfdf-eff2-4b45-96d8-535ea269178e&#39;</span><span class="tok-se">\G</span>
***************************<span class="tok-w"> </span><span class="tok-m">1</span>.<span class="tok-w"> </span>row<span class="tok-w"> </span>***************************
<span class="tok-w">        </span>record_id:<span class="tok-w"> </span><span class="tok-m">45546</span>
<span class="tok-w">               </span>id:<span class="tok-w"> </span>5a056e57-1089-4d15-a2b2-27df996dfbb1
<span class="tok-w">       </span>account_id:<span class="tok-w"> </span>09d5dfdf-eff2-4b45-96d8-535ea269178e
<span class="tok-w">     </span>invoice_date:<span class="tok-w"> </span><span class="tok-m">2016</span>-12-09
<span class="tok-w">      </span>target_date:<span class="tok-w"> </span>NULL
<span class="tok-w">         </span>currency:<span class="tok-w"> </span>USD
<span class="tok-w">           </span>status:<span class="tok-w"> </span>DRAFT
<span class="tok-w">         </span>migrated:<span class="tok-w"> </span><span class="tok-m">0</span>
<span class="tok-w">   </span>parent_invoice:<span class="tok-w"> </span><span class="tok-m">1</span>
<span class="tok-w">       </span>created_by:<span class="tok-w"> </span>CreateParentInvoice
<span class="tok-w">     </span>created_date:<span class="tok-w"> </span><span class="tok-m">2016</span>-12-09<span class="tok-w"> </span><span class="tok-m">21</span>:11:13
account_record_id:<span class="tok-w"> </span><span class="tok-m">6749</span>
<span class="tok-w"> </span>tenant_record_id:<span class="tok-w"> </span><span class="tok-m">338</span>
<span class="tok-m">1</span><span class="tok-w"> </span>row<span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-nb">set</span><span class="tok-w"> </span><span class="tok-o">(</span><span class="tok-m">0</span>.00<span class="tok-w"> </span>sec<span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s now move the clock to the end of the day to trigger the transition from <code>DRAFT</code> to <code>COMMITTED</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>curl<span class="tok-w"> </span>-v<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>-X<span class="tok-w"> </span>POST<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-u<span class="tok-w"> </span>admin:password<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;X-Killbill-ApiKey: bob&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;X-Killbill-ApiSecret: lazar&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;Content-Type: application/json&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;X-Killbill-CreatedBy: demo&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span><span class="tok-s1">&#39;http://127.0.0.1:8080/1.0/kb/test/clock?requestedDate=2016-12-10&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s look again at the parent invoice (and also the item it contains):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mysql&gt;<span class="tok-w">  </span><span class="tok-k">select</span><span class="tok-w"> </span>*<span class="tok-w"> </span>from<span class="tok-w"> </span>invoices<span class="tok-w"> </span>where<span class="tok-w"> </span><span class="tok-nv">account_id</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s1">&#39;09d5dfdf-eff2-4b45-96d8-535ea269178e&#39;</span><span class="tok-se">\G</span>
***************************<span class="tok-w"> </span><span class="tok-m">1</span>.<span class="tok-w"> </span>row<span class="tok-w"> </span>***************************
<span class="tok-w">        </span>record_id:<span class="tok-w"> </span><span class="tok-m">45546</span>
<span class="tok-w">               </span>id:<span class="tok-w"> </span>5a056e57-1089-4d15-a2b2-27df996dfbb1
<span class="tok-w">       </span>account_id:<span class="tok-w"> </span>09d5dfdf-eff2-4b45-96d8-535ea269178e
<span class="tok-w">     </span>invoice_date:<span class="tok-w"> </span><span class="tok-m">2016</span>-12-09
<span class="tok-w">      </span>target_date:<span class="tok-w"> </span>NULL
<span class="tok-w">         </span>currency:<span class="tok-w"> </span>USD
<span class="tok-w">           </span>status:<span class="tok-w"> </span>COMMITTED
<span class="tok-w">         </span>migrated:<span class="tok-w"> </span><span class="tok-m">0</span>
<span class="tok-w">   </span>parent_invoice:<span class="tok-w"> </span><span class="tok-m">1</span>
<span class="tok-w">       </span>created_by:<span class="tok-w"> </span>CreateParentInvoice
<span class="tok-w">     </span>created_date:<span class="tok-w"> </span><span class="tok-m">2016</span>-12-09<span class="tok-w"> </span><span class="tok-m">21</span>:11:13
account_record_id:<span class="tok-w"> </span><span class="tok-m">6749</span>
<span class="tok-w"> </span>tenant_record_id:<span class="tok-w"> </span><span class="tok-m">338</span>
<span class="tok-m">1</span><span class="tok-w"> </span>row<span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-nb">set</span><span class="tok-w"> </span><span class="tok-o">(</span><span class="tok-m">0</span>.00<span class="tok-w"> </span>sec<span class="tok-o">)</span>

&gt;<span class="tok-w"> </span><span class="tok-k">select</span><span class="tok-w"> </span>*<span class="tok-w"> </span>from<span class="tok-w"> </span>invoice_items<span class="tok-w">  </span>where<span class="tok-w"> </span><span class="tok-nv">invoice_id</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s1">&#39;5a056e57-1089-4d15-a2b2-27df996dfbb1&#39;</span><span class="tok-se">\G</span>
***************************<span class="tok-w"> </span><span class="tok-m">1</span>.<span class="tok-w"> </span>row<span class="tok-w"> </span>***************************
<span class="tok-w">        </span>record_id:<span class="tok-w"> </span><span class="tok-m">59901</span>
<span class="tok-w">               </span>id:<span class="tok-w"> </span>bed7bd0d-4557-435c-9208-f09ef08d36c3
<span class="tok-w">             </span>type:<span class="tok-w"> </span>PARENT_SUMMARY
<span class="tok-w">       </span>invoice_id:<span class="tok-w"> </span>5a056e57-1089-4d15-a2b2-27df996dfbb1
<span class="tok-w">       </span>account_id:<span class="tok-w"> </span>09d5dfdf-eff2-4b45-96d8-535ea269178e
<span class="tok-w"> </span>child_account_id:<span class="tok-w"> </span>ea58b7dd-eb23-4065-a3e5-980291d45ab8
<span class="tok-w">        </span>bundle_id:<span class="tok-w"> </span>NULL
<span class="tok-w">  </span>subscription_id:<span class="tok-w"> </span>NULL
<span class="tok-w">      </span>description:<span class="tok-w"> </span>ea58b7dd-eb23-4065-a3e5-980291d45ab8<span class="tok-w"> </span>summary
<span class="tok-w">        </span>plan_name:<span class="tok-w"> </span>NULL
<span class="tok-w">       </span>phase_name:<span class="tok-w"> </span>NULL
<span class="tok-w">       </span>usage_name:<span class="tok-w"> </span>NULL
<span class="tok-w">       </span>start_date:<span class="tok-w"> </span>NULL
<span class="tok-w">         </span>end_date:<span class="tok-w"> </span>NULL
<span class="tok-w">           </span>amount:<span class="tok-w"> </span><span class="tok-m">34</span>.000000000
<span class="tok-w">             </span>rate:<span class="tok-w"> </span>NULL
<span class="tok-w">         </span>currency:<span class="tok-w"> </span>USD
<span class="tok-w">   </span>linked_item_id:<span class="tok-w"> </span>NULL
<span class="tok-w">       </span>created_by:<span class="tok-w"> </span>CreateParentInvoice
<span class="tok-w">     </span>created_date:<span class="tok-w"> </span><span class="tok-m">2016</span>-12-09<span class="tok-w"> </span><span class="tok-m">21</span>:11:13
account_record_id:<span class="tok-w"> </span><span class="tok-m">6749</span>
<span class="tok-w"> </span>tenant_record_id:<span class="tok-w"> </span><span class="tok-m">338</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can see that the parent invoice contains only one <code>PARENT_SUMMARY</code> item and that its state is now <code>COMMITTED</code> as expected.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s now verify what happens on the payment side:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-w"> </span>mysql&gt;<span class="tok-w"> </span><span class="tok-k">select</span><span class="tok-w"> </span>*<span class="tok-w"> </span>from<span class="tok-w"> </span>payments<span class="tok-w"> </span>where<span class="tok-w"> </span><span class="tok-nv">account_id</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s1">&#39;09d5dfdf-eff2-4b45-96d8-535ea269178e&#39;</span><span class="tok-se">\G</span>
<span class="tok-w"> </span>***************************<span class="tok-w"> </span><span class="tok-m">1</span>.<span class="tok-w"> </span>row<span class="tok-w"> </span>***************************
<span class="tok-w">               </span>record_id:<span class="tok-w"> </span><span class="tok-m">17634</span>
<span class="tok-w">                      </span>id:<span class="tok-w"> </span>b75a7646-091d-471c-824c-4cef375de714
<span class="tok-w">              </span>account_id:<span class="tok-w"> </span>09d5dfdf-eff2-4b45-96d8-535ea269178e
<span class="tok-w">       </span>payment_method_id:<span class="tok-w"> </span>857aea5d-9c55-475b-8094-7746e96448de
<span class="tok-w">            </span>external_key:<span class="tok-w"> </span>e9f07f58-4332-44ee-8c4a-05c89395a308
<span class="tok-w">              </span>state_name:<span class="tok-w"> </span>PURCHASE_SUCCESS
<span class="tok-w"> </span>last_success_state_name:<span class="tok-w"> </span>PURCHASE_SUCCESS
<span class="tok-w">              </span>created_by:<span class="tok-w"> </span>PaymentRequestProcessor
<span class="tok-w">            </span>created_date:<span class="tok-w"> </span><span class="tok-m">2016</span>-12-10<span class="tok-w"> </span><span class="tok-m">00</span>:00:00
<span class="tok-w">              </span>updated_by:<span class="tok-w"> </span>PaymentRequestProcessor
<span class="tok-w">            </span>updated_date:<span class="tok-w"> </span><span class="tok-m">2016</span>-12-10<span class="tok-w"> </span><span class="tok-m">00</span>:00:00
<span class="tok-w">       </span>account_record_id:<span class="tok-w"> </span><span class="tok-m">6749</span>
<span class="tok-w">        </span>tenant_record_id:<span class="tok-w"> </span><span class="tok-m">338</span>
<span class="tok-w"> </span><span class="tok-m">1</span><span class="tok-w"> </span>row<span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-nb">set</span><span class="tok-w"> </span><span class="tok-o">(</span><span class="tok-m">0</span>.00<span class="tok-w"> </span>sec<span class="tok-o">)</span>

<span class="tok-w"> </span>mysql&gt;
<span class="tok-w"> </span>mysql&gt;<span class="tok-w"> </span><span class="tok-k">select</span><span class="tok-w"> </span>*<span class="tok-w"> </span>from<span class="tok-w"> </span>payments<span class="tok-w"> </span>where<span class="tok-w"> </span><span class="tok-nv">account_id</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s1">&#39;ea58b7dd-eb23-4065-a3e5-980291d45ab8&#39;</span><span class="tok-se">\G</span>
<span class="tok-w"> </span>Empty<span class="tok-w"> </span><span class="tok-nb">set</span><span class="tok-w"> </span><span class="tok-o">(</span><span class="tok-m">0</span>.01<span class="tok-w"> </span>sec<span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As expected we see one payment for the parent invoice and no payment for the child.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_advanced_use_cases">Advanced use-cases</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_committing_parent_invoices_early">Committing parent invoices early</h3>
<div class="paragraph">
<p>Parent <code>DRAFT</code> invoices can be committed early if needed, through the <code>PUT /1.0/kb/invoices/&lt;parentInvoiceId&gt;/commitInvoice</code> API. If a new child invoice is generated prior the end of that day, the system will recreate a new <code>SUMMARY</code> invoice for that day.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There is a lot more to demo (regarding dunning, invoice adjustment, &#8230;&#8203;), but this should provide a highlight of what the feature is about. Note that this is a new feature in 0.18 and as such it should be seen as Beta (you are responsible to verify it works accordingly to your use case, load, &#8230;&#8203;).</p>
</div>
</div>
</div></div><div class="bottom-nav-links"><a href="#" id="prev-nav-link" class="bottom-nav-link card prev"><span class="arrow-icon left"><svg class="i-arrow" width="12" height="11" viewBox="0 0 12 11" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4.19526 1.02876C4.45561 0.768409 4.87772 0.768409 5.13807 1.02876C5.39842 1.28911 5.39842 1.71122 5.13807 1.97157L2.27614 4.8335H11.3333C11.7015 4.8335 12 5.13197 12 5.50016C12 5.86835 11.7015 6.16683 11.3333 6.16683H2.27614L5.13807 9.02876C5.39842 9.28911 5.39842 9.71122 5.13807 9.97157C4.87772 10.2319 4.45561 10.2319 4.19526 9.97157L0.195261 5.97157C-0.0650883 5.71122 -0.0650883 5.28911 0.195261 5.02876L4.19526 1.02876Z" fill=""/></svg><span class="prev-text">Previous</span></span><span id="prev-navigator" class="bottom-nav-text">Prev</span>                               </a><a href="#" id="next-nav-link" class="bottom-nav-link card next"><span class="arrow-icon"><span class="next-text">Next</span><svg class="i-arrow icon-left" width="12" height="11" viewBox="0 0 12 11" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4.19526 1.02876C4.45561 0.768409 4.87772 0.768409 5.13807 1.02876C5.39842 1.28911 5.39842 1.71122 5.13807 1.97157L2.27614 4.8335H11.3333C11.7015 4.8335 12 5.13197 12 5.50016C12 5.86835 11.7015 6.16683 11.3333 6.16683H2.27614L5.13807 9.02876C5.39842 9.28911 5.39842 9.71122 5.13807 9.97157C4.87772 10.2319 4.45561 10.2319 4.19526 9.97157L0.195261 5.97157C-0.0650883 5.71122 -0.0650883 5.28911 0.195261 5.02876L4.19526 1.02876Z" fill=""/></svg></span><span id="next-navigator" class="bottom-nav-text">Next</span></a></div></article></div><div class="bd-links-wrapper"><nav class="bd-links toc right-side-menu" id="myScrollspy" data-toggle="toc"></nav></div></div></div></div></div></main><script src="https://cdn.staticaly.com/gh/afeld/bootstrap-toc/v1.0.0/dist/bootstrap-toc.min.js"></script><script type="module" src="javascripts/kb.js"></script><script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script><script src="javascripts/bootstrap.min.js"></script><script>docsearch({apiKey: '3ef227e7fd5e2e1a3fffd880484934bf', container: '#docsearch', appId: 'S2ISXITURI', indexName: 'killbill'});</script></body></html>