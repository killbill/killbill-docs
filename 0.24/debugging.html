<!DOCTYPE html><html lang="en"><head><title>Debugging tips</title><style>pre.pygments .hll { background-color: #ffffcc }
pre.pygments { background: #f8f8f8; }
pre.pygments .tok-c { color: #3D7B7B; font-style: italic } /* Comment */
pre.pygments .tok-err { border: 1px solid #FF0000 } /* Error */
pre.pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
pre.pygments .tok-o { color: #666666 } /* Operator */
pre.pygments .tok-ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
pre.pygments .tok-cp { color: #9C6500 } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
pre.pygments .tok-cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
pre.pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-gr { color: #E40000 } /* Generic.Error */
pre.pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
pre.pygments .tok-gi { color: #008400 } /* Generic.Inserted */
pre.pygments .tok-go { color: #717171 } /* Generic.Output */
pre.pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
pre.pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
pre.pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
pre.pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #B00040 } /* Keyword.Type */
pre.pygments .tok-m { color: #666666 } /* Literal.Number */
pre.pygments .tok-s { color: #BA2121 } /* Literal.String */
pre.pygments .tok-na { color: #687822 } /* Name.Attribute */
pre.pygments .tok-nb { color: #008000 } /* Name.Builtin */
pre.pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
pre.pygments .tok-no { color: #880000 } /* Name.Constant */
pre.pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
pre.pygments .tok-ni { color: #717171; font-weight: bold } /* Name.Entity */
pre.pygments .tok-ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
pre.pygments .tok-nf { color: #0000FF } /* Name.Function */
pre.pygments .tok-nl { color: #767600 } /* Name.Label */
pre.pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
pre.pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
pre.pygments .tok-nv { color: #19177C } /* Name.Variable */
pre.pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
pre.pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
pre.pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #BA2121 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #BA2121 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
pre.pygments .tok-se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #008000 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #A45A77 } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #0000FF } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #19177C } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */</style><link rel="icon" type="image/x-icon" href="/stylesheets/images/favicon.ico"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3"><link rel="preconnect" href="https://S2ISXITURI-dsn.algolia.net"><link rel="stylesheet" href='stylesheets/bootstrap.min.css'><link rel="stylesheet" href='stylesheets/bootstrap-toc.min.css'><link rel="stylesheet" href="stylesheets/kb.css"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="description" content="Debugging tips"></head><body data-spy="scroll" data-target="#myScrollspy" data-offset="100"><div class="loader-wrapper"><div id="loading"></div></div><header class="header sticky" id="header"><div class="header-wrapper"><div class="container-fluid"><div class="row flex-xl-nowrap justify-content-evenly"><div class="header-logo"><div class="logo"><a href="/"><img src="/stylesheets/images/logo/light-logo.svg" style="height:38px" alt="Kill Bill Docs" id="logo" height="38" width="146"></a></div><div class="switch"><input type="checkbox" aria-label="Search" name="theme-toggle" id="theme-toggle"><span class="slider round"></span></div></div><div class="nav-toggler sidebar-toggler"><svg class="hamburger" xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M20.75 7C20.75 7.41421 20.4142 7.75 20 7.75L4 7.75C3.58579 7.75 3.25 7.41421 3.25 7C3.25 6.58579 3.58579 6.25 4 6.25L20 6.25C20.4142 6.25 20.75 6.58579 20.75 7Z" fill=""/><path fill-rule="evenodd" clip-rule="evenodd" d="M20.75 12C20.75 12.4142 20.4142 12.75 20 12.75L4 12.75C3.58579 12.75 3.25 12.4142 3.25 12C3.25 11.5858 3.58579 11.25 4 11.25L20 11.25C20.4142 11.25 20.75 11.5858 20.75 12Z" fill=""/><path fill-rule="evenodd" clip-rule="evenodd" d="M20.75 17C20.75 17.4142 20.4142 17.75 20 17.75L4 17.75C3.58579 17.75 3.25 17.4142 3.25 17C3.25 16.5858 3.58579 16.25 4 16.25L20 16.25C20.4142 16.25 20.75 16.5858 20.75 17Z" fill=""/></svg></div><div class="header-search"><div class="search-form-wrapper"><div id="docsearch" style="height: 43px; display: flex; align-items: center; width: 100%;"></div></div></div></div></div></div></header><main class="main sidebar-show"><div class="container-fluid"><div class="row flex-xl-nowrap"><div class="sidebar-wrapper"><aside class="sidebar"><div class="sidebar__control"><svg width="8" height="12" viewBox="0 0 8 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6.33316 10.6665L1.6665 5.99992L6.33316 1.33325" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div><nav class="sidebar-nav"><ul class="nav navbar-nav"><li><div class="icon-title"><a class="bd-toc-link main-link" role="button">Getting Started</a><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li><a class="nav-link" href="/latest/what_is_kill_bill.html">What is Kill Bill?</a></li><li><a class="nav-link" href="/latest/getting_started.html">Getting Started (Installation)</a></li><li><a class="nav-link" href="/latest/quick_start_with_kaui.html">Quick Start with Kaui</a></li><li><a class="nav-link" href="/latest/quick_start_with_kb_api.html">Quick Start with the Kill Bill API</a></li></ul></li><li><div class="icon-title"><a class="bd-toc-link main-link" role="button">Installation</a><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/stripe_plugin.html">Kill Bill + Stripe DIY</a></li><li><a class="nav-link" href="/latest/userguide_deployment.html">Going to Production</a></li><li><a class="nav-link" href="/latest/how-to-upgrade-the-database.html">Database Migrations</a></li><li><a class="nav-link" href="/latest/PostgreSQL.html">PostgreSQL Setup</a></li><li><a class="nav-link" href="https://github.com/killbill/killbill/releases" onclick="getOutboundLink('https://github.com/killbill/killbill/releases'); return false;">Release&nbsp;Notes</a></li></ul></li><li><div class="icon-title"><a class="bd-toc-link main-link" role="button">AWS</a><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/aws.html">AWS Introduction</a></li><li><a class="nav-link" href="/latest/how-to-set-up-a-single-tier-system.html">Single-Tier Setup</a></li><li><a class="nav-link" href="/latest/how-to-set-up-a-multi-tier-system.html">Multi-Tier Setup</a></li><li><a class="nav-link" href="/latest/how-to-set-up-a-cloud-formation-system.html">CloudFormation Setup</a></li><li><a class="nav-link" href="/latest/aws-container.html">AWS Container Setup</a></li><li><a class="nav-link" href="/latest/how-to-maintain-a-single-tier-system.html">Single-Tier Maintenance</a></li><li><a class="nav-link" href="/latest/how-to-maintain-a-multi-tier-system.html">Multi-Tier Maintenance</a></li><li><a class="nav-link" href="/latest/how-to-maintain-a-cloud-formation-system.html">CloudFormation Maintenance</a></li><li><a class="nav-link" href="/latest/explanation-https-and-certificates.html">HTTPS and Certificates</a></li><li><a class="nav-link" href="/latest/how-to-add-a-certificate-using-ACM.html">How to add a certificate using ACM</a></li><li><a class="nav-link" href="/latest/using-ses-with-aws.html">Using SES with AWS</a></li><li><a class="nav-link" href="/latest/aws-tools.html">AWS Observability Tools</a></li><li><a class="nav-link" href="/latest/metrics-datadog.html">Managing Metrics with Datadog</a></li><li><a class="nav-link" href="/latest/metrics-newrelic.html">Managing Metrics with New Relic</a></li><li><a class="nav-link" href="/latest/metrics-cloudwatch.html">Managing Metrics with Cloudwatch</a></li><li><a class="nav-link" href="/latest/errors-rollbar.html">Error Tracking with Rollbar</a></li><li><a class="nav-link" href="/latest/errors-sentry.html">Error Tracking with Sentry</a></li></ul></li><li><div class="icon-title"><a class="bd-toc-link main-link" role="button">Manuals</a><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/userguide_subscription.html">Subscription&nbsp;Billing</a></li><li><a class="nav-link" href="/latest/userguide_payment.html">Payment Processing</a></li><li><a class="nav-link" href="/latest/userguide_kaui.html">Kaui, the Administrative&nbsp;UI</a></li><li><a class="nav-link" href="/latest/email-notification-plugin.html">Email Notification Plugin</a></li><li><a class="nav-link" href="/latest/custom-email-invoice-formatter.html">Custom Email Formatter</a></li><li><a class="nav-link" href="/latest/userguide_analytics.html">Analytics Plugin</a></li><li><a class="nav-link" href="/latest/userguide_configuration.html">Kill Bill&nbsp;Configuration</a></li><li><a class="nav-link" href="/latest/internationalization.html">Kill Bill&nbsp;Internationalization</a></li><li><a class="nav-link" href="/latest/migration_guide.html">Migrating to Kill Bill</a></li></ul></li><li><div class="icon-title"><a class="bd-toc-link main-link" role="button">Tutorials</a><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/plan_alignment.html">Plans Alignments</a></li><li><a class="nav-link" href="/latest/overdue.html">Overdue System</a></li><li><a class="nav-link" href="/latest/consumable_in_arrear.html">In Arrear UsageBilling</a></li><li><a class="nav-link" href="/latest/ha.html">Hierarchical Accounts</a></li><li><a class="nav-link" href="/latest/catalog-examples.html">Catalog Examples</a></li><li><a class="nav-link" href="/latest/invoice_examples.html">Invoice Examples</a></li><li><a class="nav-link" href="/latest/invoice_templates.html">Invoice Templates</a></li></ul></li><li><div class="icon-title"><a class="bd-toc-link main-link" role="button">Integration</a><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="http://killbill.github.io/slate" onclick="getOutboundLink('http://killbill.github.io/slate'); return false;">REST API Reference</a></li><li><a class="nav-link" href="/latest/swagger_documentation.html">Swagger UI Documentation</a></li><li><a class="nav-link" href="/latest/postman.html">Postman Integration</a></li><li><a class="nav-link" href="/latest/debugging.html">Debugging</a></li><li><a class="nav-link" href="/latest/push_notifications.html">Push Notifications</a></li><li><a class="nav-link" href="/latest/kill_bill_events.html">Kill Bill Events</a></li><li><a class="nav-link" href="/latest/events-to-aws-sqs.html">Kill Bill Events to AWS SQS</a></li><li><a class="nav-link" href="/latest/how-to-use-kpm-diagnostic.html">KPM Diagnostic Usage</a></li></ul></li><li><div class="icon-title"><a class="bd-toc-link main-link" role="button">Plugin Development</a><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/plugin_introduction.html">Plugin Introduction</a></li><li class="bd-sidenav-active"><a class="nav-link" href="/latest/plugin_development.html">Plugin Development</a></li><li class="bd-sidenav-active"><a class="nav-link" href="/latest/plugin_installation.html">Plugin Installation</a></li><li><a class="nav-link" href="/latest/plugin_use_cases.html">Special Plugin Use Cases</a></li><li><a class="nav-link" href="/latest/notification_plugin.html">Notification Plugins</a></li><li><a class="nav-link" href="/latest/payment_plugin.html">Payment Plugins</a></li><li><a class="nav-link" href="/latest/payment_control_plugin.html">Payment Control Plugins</a></li><li><a class="nav-link" href="/latest/usage_plugin.html">Usage Plugins</a></li><li><a class="nav-link" href="/latest/invoice_plugin.html">Invoice Plugins</a></li><li><a class="nav-link" href="/latest/catalog_plugin.html">Catalog Plugins</a></li><li><a class="nav-link" href="/latest/entitlement_plugin.html">Entitlement Plugins</a></li></ul></li><li><div class="icon-title"><a class="bd-toc-link main-link" role="button">Operational Guides</a><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/deploy_to_kubernetes.html">Kubernetes (K8s) Deployment</a></li><li class="bd-sidenav-active"><a class="nav-link" href="/latest/user_management.html">Users, Roles, and Permissions</a></li><li><a class="nav-link" href="/latest/plugin_management.html">Plugin Management</a></li></ul></li><li><div class="icon-title"><a class="bd-toc-link main-link" role="button">Client Libraries</a><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/java_client.html">Java</a></li><li><a class="nav-link" href="http://github.com/killbill/killbill-client-ruby" onclick="getOutboundLink('http://github.com/killbill/killbill-client-ruby'); return false;">Ruby</a></li><li><a class="nav-link" href="http://github.com/killbill/killbill-client-php" onclick="getOutboundLink('http://github.com/killbill/killbill-client-php'); return false;">PHP</a></li><li><a class="nav-link" href="http://github.com/killbill/killbill-client-js" onclick="getOutboundLink('http://github.com/killbill/killbill-client-js'); return false;">Node.js</a></li><li><a class="nav-link" href="http://github.com/killbill/killbill-client-python" onclick="getOutboundLink('http://github.com/killbill/killbill-client-python'); return false;">Python</a></li><li><a class="nav-link" href="http://github.com/killbill/kbcli" onclick="getOutboundLink('http://github.com/killbill/kbcli'); return false;">KillBill Go </a></li></ul></li><li><div class="icon-title"><a class="bd-toc-link main-link" role="button">About Kill Bill</a><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/demo.html">Demo</a></li><li><a class="nav-link" href="/latest/features.html">Features List</a></li><li><a class="nav-link" href="/latest/faq.html">Technical FAQs</a></li><li><a class="nav-link" href="/latest/Kill-Bill-Glossary.html">Glossary</a></li></ul></li><li><div class="icon-title"><a class="bd-toc-link main-link" role="button">Internal</a><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/internal_design.html">Internal Design</a></li><li><a class="nav-link" href="/latest/entitlement_subsystem.html">Entitlement Subsystem</a></li><li><a class="nav-link" href="/latest/invoice_subsystem.html">Invoice Subsystem</a></li><li><a class="nav-link" href="/latest/development.html">Development Environment</a></li></ul></li><li><div class="icon-title"><a class="bd-toc-link main-link" role="button">References</a><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="https://github.com/killbill/killbill-docs/tree/v3/swagger" onclick="getOutboundLink('https://github.com/killbill/killbill-docs/tree/v3/swagger'); return false;">Swagger&nbsp;API Schema</a></li><li><a class="nav-link" href="/latest/catalog.xsd">Catalog XSD Reference</a></li><li><a class="nav-link" href="/latest/overdue.xsd">Overdue XSD Reference</a></li></ul></li></ul></nav><a class="doclink" href="mailto:support@killbill.io">Report a doc problem</a></aside></div><div class="article-container"><div class="center-content"><div class="main-wrapper"><article class="content-wrapper"><div class="banner"><h1>Debugging tips</h1></div><div id="content"><div class="sect1">
<h2 id="_finding_the_current_kill_bill_versionplugin_information">Finding the Current Kill Bill Version/Plugin Information</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can find the current Kill Bill version/information about plugins by invoking the following endpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>curl<span class="tok-w"> </span>-v<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-u<span class="tok-w"> </span>admin:password<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>http://127.0.0.1:8080/1.0/kb/nodesInfo</code></pre>
</div>
</div>
<div class="paragraph">
<p>This displays a response similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-o">[</span>
<span class="tok-w">  </span><span class="tok-o">{</span>
<span class="tok-w">    </span><span class="tok-s2">&quot;nodeName&quot;</span>:<span class="tok-w"> </span><span class="tok-s2">&quot;DESKTOP-NCUS49R&quot;</span>,
<span class="tok-w">    </span><span class="tok-s2">&quot;bootTime&quot;</span>:<span class="tok-w"> </span><span class="tok-s2">&quot;2022-08-10T06:30:52.000Z&quot;</span>,
<span class="tok-w">    </span><span class="tok-s2">&quot;lastUpdatedDate&quot;</span>:<span class="tok-w"> </span><span class="tok-s2">&quot;2022-08-10T06:30:52.000Z&quot;</span>,
<span class="tok-w">    </span><span class="tok-s2">&quot;kbVersion&quot;</span>:<span class="tok-w"> </span><span class="tok-s2">&quot;0.22.18&quot;</span>,
<span class="tok-w">    </span><span class="tok-s2">&quot;apiVersion&quot;</span>:<span class="tok-w"> </span><span class="tok-s2">&quot;0.53.17&quot;</span>,
<span class="tok-w">    </span><span class="tok-s2">&quot;pluginApiVersion&quot;</span>:<span class="tok-w"> </span><span class="tok-s2">&quot;0.26.4&quot;</span>,
<span class="tok-w">    </span><span class="tok-s2">&quot;commonVersion&quot;</span>:<span class="tok-w"> </span><span class="tok-s2">&quot;0.24.9&quot;</span>,
<span class="tok-w">    </span><span class="tok-s2">&quot;platformVersion&quot;</span>:<span class="tok-w"> </span><span class="tok-s2">&quot;0.40.4&quot;</span>,
<span class="tok-w">    </span><span class="tok-s2">&quot;pluginsInfo&quot;</span>:<span class="tok-w"> </span><span class="tok-o">[</span>
<span class="tok-w">      </span><span class="tok-o">{</span>
<span class="tok-w">        </span><span class="tok-s2">&quot;bundleSymbolicName&quot;</span>:<span class="tok-w"> </span><span class="tok-s2">&quot;org.kill-bill.billing.plugin.java.analytics-plugin&quot;</span>,
<span class="tok-w">        </span><span class="tok-s2">&quot;pluginKey&quot;</span>:<span class="tok-w"> </span><span class="tok-s2">&quot;analytics&quot;</span>,
<span class="tok-w">        </span><span class="tok-s2">&quot;pluginName&quot;</span>:<span class="tok-w"> </span><span class="tok-s2">&quot;analytics-plugin&quot;</span>,
<span class="tok-w">        </span><span class="tok-s2">&quot;version&quot;</span>:<span class="tok-w"> </span><span class="tok-s2">&quot;7.3.0-SNAPSHOT&quot;</span>,
<span class="tok-w">        </span><span class="tok-s2">&quot;state&quot;</span>:<span class="tok-w"> </span><span class="tok-s2">&quot;STOPPED&quot;</span>,
<span class="tok-w">        </span><span class="tok-s2">&quot;isSelectedForStart&quot;</span>:<span class="tok-w"> </span>true,
<span class="tok-w">        </span><span class="tok-s2">&quot;services&quot;</span>:<span class="tok-w"> </span><span class="tok-o">[]</span>
<span class="tok-w">      </span><span class="tok-o">}</span>
<span class="tok-w">    </span><span class="tok-o">]</span>
<span class="tok-w">  </span><span class="tok-o">}</span>
<span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can also find the Kill Bill version via Kaui by accessing http://&lt;KAUI_HOME&gt;/kpm.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_healthchecks_and_metrics">Healthchecks and metrics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Kill Bill exposes both healthchecks and metrics. These can be accessed via:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>curl<span class="tok-w"> </span>-v<span class="tok-w"> </span>http://&lt;IP_ADDRESS&gt;:8080/1.0/healthcheck?pretty<span class="tok-o">=</span><span class="tok-nb">true</span>
curl<span class="tok-w"> </span>-v<span class="tok-w"> </span>http://&lt;IP_ADDRESS&gt;:8080/1.0/metrics?pretty<span class="tok-o">=</span><span class="tok-nb">true</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_remote_debugging">Remote Debugging</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_remote_debuggging_kill_bill_running_in_tomcat">Remote debuggging Kill Bill running in Tomcat</h3>
<div class="paragraph">
<p>In order to remote debug Kill Bill running in Tomcat, the following needs to be done:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ensure that you have Kill Bill and Kaui installed in Tomcat as explained in the <a href="https://docs.killbill.io/latest/getting_started.html#_tomcat">Getting Started</a> guide.</p>
</li>
<li>
<p>Set the following environment variable:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nv">JPDA_OPTS</span><span class="tok-o">=</span>-agentlib:jdwp<span class="tok-o">=</span><span class="tok-nv">transport</span><span class="tok-o">=</span>dt_socket,address<span class="tok-o">=</span><span class="tok-m">12345</span>,server<span class="tok-o">=</span>y,suspend<span class="tok-o">=</span>n</code></pre>
</div>
</div>
</li>
<li>
<p>Start Tomcat as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>catalina.sh<span class="tok-w"> </span>jpda<span class="tok-w"> </span>start</code></pre>
</div>
</div>
</li>
<li>
<p>Create a new remote debug configuration in Eclipse/Intellij with <code>Host=localhost</code> and <code>Port=12345</code>.</p>
</li>
<li>
<p>Add a breakpoint to the code.</p>
</li>
<li>
<p>Execute any action that invokes the code with the breakpoint. This will run the code in debug mode.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_remote_debuggging_kill_bill_running_in_docker">Remote debuggging Kill Bill running in Docker</h3>
<div class="paragraph">
<p>In order to remote debug Kill Bill running in Docker, the following needs to be done:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Expose port <code>12345</code> and specify the <code>JVM_JDWP_PORT</code> environment variable in your <a href="https://docs.killbill.io/latest/getting_started.html#_kill_bill_installation">docker-compose</a> file as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>version:<span class="tok-w"> </span><span class="tok-s1">&#39;3.2&#39;</span>
volumes:
<span class="tok-w">  </span>db:
services:
<span class="tok-w">  </span>killbill:
<span class="tok-w">    </span>image:<span class="tok-w"> </span>killbill/killbill:0.24.10
<span class="tok-w">    </span>ports:
<span class="tok-w">      </span>-<span class="tok-w"> </span><span class="tok-s2">&quot;8080:8080&quot;</span>
<span class="tok-w">      </span>-<span class="tok-w"> </span><span class="tok-m">12345</span>:12345
<span class="tok-w">    </span>environment:
<span class="tok-w">      </span>-<span class="tok-w"> </span><span class="tok-nv">JVM_JDWP_PORT</span><span class="tok-o">=</span>*:12345
<span class="tok-w">      </span>-<span class="tok-w"> </span><span class="tok-nv">KILLBILL_DAO_URL</span><span class="tok-o">=</span>jdbc:mysql://db:3306/killbill
<span class="tok-w">      </span>-<span class="tok-w"> </span><span class="tok-nv">KILLBILL_DAO_USER</span><span class="tok-o">=</span>root
<span class="tok-w">      </span>-<span class="tok-w"> </span><span class="tok-nv">KILLBILL_DAO_PASSWORD</span><span class="tok-o">=</span>killbill
<span class="tok-w">      </span>-<span class="tok-w"> </span><span class="tok-nv">KILLBILL_CATALOG_URI</span><span class="tok-o">=</span>SpyCarAdvanced.xml
<span class="tok-w">      </span>-<span class="tok-w"> </span><span class="tok-nv">KB_org_killbill_server_test_mode</span><span class="tok-o">=</span><span class="tok-nb">true</span>
<span class="tok-w">  </span>kaui:
<span class="tok-w">    </span>image:<span class="tok-w"> </span>killbill/kaui:3.0.9
<span class="tok-w">    </span>ports:
<span class="tok-w">      </span>-<span class="tok-w"> </span><span class="tok-s2">&quot;9090:8080&quot;</span>
<span class="tok-w">    </span>environment:
<span class="tok-w">      </span>-<span class="tok-w"> </span><span class="tok-nv">KAUI_CONFIG_DAO_URL</span><span class="tok-o">=</span>jdbc:mysql://db:3306/kaui
<span class="tok-w">      </span>-<span class="tok-w"> </span><span class="tok-nv">KAUI_CONFIG_DAO_USER</span><span class="tok-o">=</span>root
<span class="tok-w">      </span>-<span class="tok-w"> </span><span class="tok-nv">KAUI_CONFIG_DAO_PASSWORD</span><span class="tok-o">=</span>killbill
<span class="tok-w">      </span>-<span class="tok-w"> </span><span class="tok-nv">KAUI_KILLBILL_URL</span><span class="tok-o">=</span>http://killbill:8080
<span class="tok-w">  </span>db:
<span class="tok-w">    </span>image:<span class="tok-w"> </span>killbill/mariadb:0.24
<span class="tok-w">    </span>volumes:
<span class="tok-w">      </span>-<span class="tok-w"> </span>type:<span class="tok-w"> </span>volume
<span class="tok-w">        </span>source:<span class="tok-w"> </span>db
<span class="tok-w">        </span>target:<span class="tok-w"> </span>/var/lib/mysql
<span class="tok-w">    </span>expose:
<span class="tok-w">      </span>-<span class="tok-w"> </span><span class="tok-s2">&quot;3306&quot;</span>
<span class="tok-w">    </span>environment:
<span class="tok-w">      </span>-<span class="tok-w"> </span><span class="tok-nv">MYSQL_ROOT_PASSWORD</span><span class="tok-o">=</span>killbill</code></pre>
</div>
</div>
</li>
<li>
<p>Create a new remote debug configuration in Eclipse/Intellij with <code>Host=localhost</code> and <code>Port=12345</code>.</p>
</li>
<li>
<p>Add a breakpoint to the code.</p>
</li>
<li>
<p>Execute any action that invokes the code with the breakpoint. This will run the code in debug mode.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Alternatively, you may also start Kill Bill in Docker using the following command at step 1:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>docker<span class="tok-w"> </span>run<span class="tok-w"> </span>-p<span class="tok-w"> </span><span class="tok-m">12345</span>:12345<span class="tok-w"> </span>-p<span class="tok-w"> </span><span class="tok-m">8080</span>:8080<span class="tok-w"> </span>-e<span class="tok-w"> </span><span class="tok-s1">&#39;JVM_JDWP_PORT=*:12345&#39;</span><span class="tok-w"> </span>killbill/killbill:0.24.1</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_other_notes">Other Notes</h3>
<div class="ulist">
<ul>
<li>
<p>To debug instances remotely (e.g. in the cloud), you need to specify the publicly accessible IP address of your instance.</p>
</li>
<li>
<p>Make sure also that the port <code>12345</code> is open (e.g. check your security groups in AWS)</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_turning_on_debug_logging">Turning on DEBUG logging</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Specify:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="properties"><span></span><span class="tok-na">-Dcom.sun.management.jmxremote</span><span class="tok-o">=</span><span class="tok-s">true</span>
<span class="tok-na">-Dcom.sun.management.jmxremote.authenticate</span><span class="tok-o">=</span><span class="tok-s">false</span>
<span class="tok-na">-Dcom.sun.management.jmxremote.port</span><span class="tok-o">=</span><span class="tok-s">8000</span>
<span class="tok-na">-Dcom.sun.management.jmxremote.rmi.port</span><span class="tok-o">=</span><span class="tok-s">8000</span>
<span class="tok-na">-Dcom.sun.management.jmxremote.ssl</span><span class="tok-o">=</span><span class="tok-s">false</span>
<span class="tok-na">-Djava.rmi.server.hostname</span><span class="tok-o">=</span><span class="tok-s">localhost</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>on startup in your JVM settings to enable access via <code>jconsole</code>.</p>
</div>
<div class="paragraph">
<p>You can set at runtime the log level of specific classes and packages (look for  the <code>ch.qos.logback.classic:Name=default,Type=ch.qos.logback.classic.jmx.JMXConfigurator</code> MBean).</p>
</div>
<div class="paragraph">
<p>Similar considerations as the remote debugging section apply regarding the IP address and expose ports (see above). For Docker, <code>java.rmi.server.hostname</code> should point to the host IP address (e.g. <code>192.168.99.100</code>). Passing this IP address to our Docker images as <code>ENV_HOST_IP</code> enables jConsole automatically.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_following_tokens">Following tokens</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To understand why a specific action was taken, it is often useful to follow tokens.</p>
</div>
<div class="paragraph">
<p>When invoking a JAX-RS (HTTP) API, a <code>userToken</code> is automatically generated. You can also specify your own token via the <code>X-Request-Id</code> HTTP header (it <strong>must</strong> be a UUID).</p>
</div>
<div class="paragraph">
<p>Once set, this token is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>attached to the processing thread</p>
</li>
<li>
<p>attached to SLF4J MDC context as <code>kb.userToken</code> and displayed by default in logs (<code>tok=</code>)</p>
</li>
<li>
<p>passed to all APIs as <code>CallContext#getUserToken()</code></p>
</li>
<li>
<p>passed to internal bus events as <code>BusEvent#getUserToken()</code></p>
</li>
<li>
<p>passed to external bus events as <code>ExtBusEvent#getUserToken()</code></p>
</li>
<li>
<p>passed to future notifications as <code>userToken</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that when a notification is created, a <code>futureUserToken</code> is auto-generated. That <code>futureUserToken</code> becomes the <code>userToken</code> when the notification is dispatched.</p>
</div>
<div class="paragraph">
<p>You can search for these tokens in Kaui, on the <em>Queues</em> screen, accessible from the tenant page or via the per-account sub-menu (you need to be logged-in as the Kaui root user).</p>
</div>
<div class="sect2">
<h3 id="_testing_changes_over_time">Testing changes over time</h3>
<div class="paragraph">
<p>We have a clock abstraction in Kill Bill that can be manipulated through an API, as long as you start Kill Bill with <code>org.killbill.server.test.mode=true</code> (<code>-e KILLBILL_SERVER_TEST_MODE=true</code> in Docker):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>curl<span class="tok-w"> </span>-v<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-u<span class="tok-w"> </span>admin:password<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;X-Killbill-ApiKey: bob&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s1">&#39;X-Killbill-ApiSecret: lazar&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s1">&#39;X-Killbill-CreatedBy: admin&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span><span class="tok-s2">&quot;http://127.0.0.1:8080/1.0/kb/test/clock&quot;</span>

curl<span class="tok-w"> </span>-v<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-u<span class="tok-w"> </span>admin:password<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;X-Killbill-ApiKey: bob&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s1">&#39;X-Killbill-ApiSecret: lazar&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s1">&#39;X-Killbill-CreatedBy: admin&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;Accept: application/json&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-X<span class="tok-w"> </span>POST<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span><span class="tok-s2">&quot;http://127.0.0.1:8080/1.0/kb/test/clock?requestedDate=2015-12-14T23:02:15.000Z&quot;</span>

curl<span class="tok-w"> </span>-v<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-u<span class="tok-w"> </span>admin:password<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;X-Killbill-ApiKey: bob&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s1">&#39;X-Killbill-ApiSecret: lazar&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s1">&#39;X-Killbill-CreatedBy: admin&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;Accept: application/json&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-X<span class="tok-w"> </span>PUT<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span><span class="tok-s2">&quot;http://127.0.0.1:8080/1.0/kb/test/clock?days=10&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is an <a href="https://github.com/killbill/killbill-integration-tests/blob/165b76b5864fb40f1a5774f64c145d56123a5e62/killbill-integration-tests/mixin-utils/helper.rb#L131-L145">example</a> how it could be used in tests.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_docker_and_ansible">Docker and Ansible</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Our Docker images use Ansible behind the scenes to install and configure Kill Bill in the container. The actual Ansible commands run are available in the images via the environment variables <code>$KPM_INSTALL_CMD</code> and <code>$START_TOMCAT_CMD</code>.</p>
</div>
<div class="paragraph">
<p>If you need to debug this setup process, you can start a container via <code>docker run -ti killbill/killbill:0.22.0 bash</code> and execute these commands manually.</p>
</div>
<div class="paragraph">
<p>The Ansible command to start Tomcat can also be modified via the <code>$START_TOMCAT_OPTS</code> variable. One useful setting is to create the container using <code>START_TOMCAT_OPTS='--skip-tags tomcat_cleanup'</code> (e.g. <code>docker run -e START_TOMCAT_OPTS='--skip-tags tomcat_cleanup' -ti killbill/killbill:0.22.0</code>). While by default Ansible will cleanup the Tomcat directories (such as <code>webapps/ROOT</code>), this option will skip this task. This is especially useful when developping on Kill Bill: you can replace specific jars in the <code>webapps/ROOT</code> directory and simply restart the container to test your changes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_performance_and_profiling">Performance and profiling</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Kill Bill has some built-in support to profile incoming calls. The mechanism is based on HTTP headers that need to be set to specify what needs to be profiled, and as a result, a new HTTP header is returned.</p>
</div>
<div class="sect2">
<h3 id="_types_of_profiling">Types of profiling</h3>
<div class="paragraph">
<p>In order to return profiling information, one needs to add the HTTP header <code>X-Killbill-Profiling-Req</code> and specify which calls should be instrumented. Today, we support:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JAXRS: The HTTP call will be returned with the time spent in the call.</p>
</li>
<li>
<p>API: Any Kill Bill API call will be returned with the time spent in the call</p>
</li>
<li>
<p>DAO: Any Kill Bill DAO (request to database) call will be returned with the time spent in the call</p>
</li>
<li>
<p>DAO_DETAILS: Any Kill Bill DAO (request to database) call along with specifics about time time spent for audit/history and caching will be returned with the time spent in the call</p>
</li>
<li>
<p>DAO_CONNECTION: The time spent trying to acquire a database connection</p>
</li>
<li>
<p>GLOCK: The time spent trying to acquire the global (<code>Account</code>) lock</p>
</li>
<li>
<p>PLUGIN: Any Kill Bill call spent when calling a plugin will be returned with the time spent in the call</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_jaxrs_profiling">JAXRS Profiling</h4>
<div class="paragraph">
<p>The time is extracted from a <a href="https://github.com/killbill/killbill/blob/killbill-0.20.0/profiles/killbill/src/main/java/org/killbill/billing/server/filters/ProfilingContainerResponseFilter.java#L53">Jersey filter</a>, so it should be very close to the time spent into the JAX-RS application handler, not taking into account the time spent in the container itself (i.e. Jetty, Tomcat, &#8230;&#8203;).</p>
</div>
</div>
<div class="sect3">
<h4 id="_api_profiling">API Profiling</h4>
<div class="paragraph">
<p>We are relying on AOP to profile each of our API calls. We are injecting a <a href="https://github.com/killbill/killbill/blob/killbill-0.20.0/util/src/main/java/org/killbill/billing/util/glue/KillbillApiAopModule.java#L72">Guice AOP module</a> to profile each of our API calls. The time returned does not include the extra time spent to dispatch the request using the AOP handler.</p>
</div>
<div class="paragraph">
<p>In addition, there is another <a href="https://github.com/killbill/killbill/blob/killbill-0.20.0/util/src/main/java/org/killbill/billing/util/glue/KillBillShiroAopModule.java#L45">AOP module</a> that is used to validate the user has the right set of permissions to execute this call. Since this occurs prior we do the profiling this time is currently not included in the profiling of the API call.</p>
</div>
<div class="paragraph">
<p>Finally when making API calls from plugins, there may be also a small overhead to go through OSGI layer and this time is also not included.</p>
</div>
</div>
<div class="sect3">
<h4 id="_doa_profiling">DOA Profiling</h4>
<div class="paragraph">
<p>Most of the requests issued from Kill Bill Dao (e.g <code>DefaultPaymentDao</code>) classes follow the same mechanism:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A transaction is started by calling the <code>execute</code> method of the <a href="https://github.com/killbill/killbill/blob/killbill-0.20.0/util/src/main/java/org/killbill/billing/util/entity/dao/EntitySqlDaoTransactionalJdbiWrapper.java#L87">EntitySqlDaoTransactionalJdbiWrapper</a>. Here, we create a <code>Handle</code>, essentially retrieving a database connection. The time taken to get the connection can be profiled by using the <code>DAO_CONNECTION</code> mask.</p>
</li>
<li>
<p>Then, a jdbi transaction is started using cglib, and this transaction is actually run through a series of handlers, such as our <a href="https://github.com/killbill/killbill-commons/blob/killbill-commons-0.22.0/jdbi/src/main/java/org/killbill/commons/jdbi/transaction/RestartTransactionRunner.java">RestartTransactionRunner</a>. This extra time, is not being measured by our profiling layer.</p>
</li>
<li>
<p>Finally, for each SQL operation within the transaction, we also proxy the calls using the java <code>Proxy</code> mechanism, and so all those calls are funneled trough the associated <code>EntitySqlDaoWrapperInvocationHandler</code>, and this is where the timing associated to the <code>DAO</code> (and <code>DAO_DETAILS</code>) mask is taken.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note that the profiling time reported by the <code>API</code> mask&#8201;&#8212;&#8201;since it supersedes all dao calls&#8201;&#8212;&#8201;will include everything described above. Therefore it is possible to see an API that would only make a dao call take slightly longer than the dao call itself.</p>
</div>
<div class="paragraph">
<p>The <code>DAO</code> mask will take the total time it takes to run the invocation handler invoke method. Because there are several paths, we also include the option to return <code>DAO_DETAILS</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In most cases, we will have a profiling entry <code>DAO_DETAILS:&lt;method&gt; (raw)</code> that only profiles the call requested.</p>
</li>
<li>
<p>In the case of an insert, update, deletion, the code will also update audit logs, and history table. In this case, we will also see a profiling entry <code>DAO_DETAILS:&lt;method&gt; (history/audit)</code> that will return the time it took to create the additional records in these tables.</p>
</li>
<li>
<p>In the case of a cacheable query (e.g return a <code>record_id</code> associated to an object <code>uuid</code>), we may return the result from the cache and so this is the only case where <code>DAO_DETAILS:&lt;method&gt;:raw</code> will not be printed.</p>
</li>
<li>
<p>In all other cases, the <code>DAO_DETAILS:&lt;method&gt; (raw)</code> should match the <code>DAO:&lt;method&gt;</code> time.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_glock_profiling">GLOCK Profiling</h4>
<div class="paragraph">
<p>The <code>GLOCK</code> mask will simply output the time it took to grab the database lock associated with a given <code>Account</code>&#8201;&#8212;&#8201;the only kind of global lock currently supported in Kill Bill.</p>
</div>
</div>
<div class="sect3">
<h4 id="_plugin_profiling">PLUGIN Profiling</h4>
<div class="paragraph">
<p>This mask can be used to profile the time it takes for Kill Bill to make calls to a given plugin using a given plugin api. Here again, such plugin calls are being proxied using the <code>Proxy</code> mechanism, and the timing is taken from the <a href="https://github.com/killbill/killbill-platform/blob/killbill-platform-0.38.0/osgi/src/main/java/org/killbill/billing/osgi/ContextClassLoaderHelper.java#L106">invocation handler</a>.</p>
</div>
<div class="paragraph">
<p>The information will contain the name of the plugin api class and the method being invoked.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_example">Example</h3>
<div class="paragraph">
<p>Kill Bill will return a json object containing the hierarchy for the calls along with the time spent in uSec (1000 nanoseconds or 0.000001 seconds).</p>
</div>
<div class="paragraph">
<p>Example (Note the piping to extract the response header, and format the json nicely):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>curl<span class="tok-w"> </span>-v<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-u<span class="tok-w"> </span>admin:password<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;Accept: application/json&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;X-Killbill-ApiKey: bob&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;X-Killbill-ApiSecret: lazar&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s1">&#39;X-Killbill-Profiling-Req: JAXRS,API,DAO,DAO_DETAILS,DAO_CONNECTION,GLOCK&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span><span class="tok-s2">&quot;http://127.0.0.1:8080/1.0/kb/paymentMethods/3dd4e9d3-2be3-4bf2-b1e4-64a1785afd53&quot;</span><span class="tok-w"> </span><span class="tok-m">2</span>&gt;<span class="tok-p">&amp;</span><span class="tok-m">1</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span><span class="tok-s1">&#39;X-Killbill-Profiling-Resp&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span><span class="tok-p">|</span><span class="tok-w"> </span>awk<span class="tok-w"> </span><span class="tok-s1">&#39;{$1=$2=&quot;&quot;; print $0}&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span><span class="tok-p">|</span><span class="tok-w"> </span>jq<span class="tok-w"> </span><span class="tok-s1">&#39;.&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="json"><span></span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-nt">&quot;rawData&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p">[</span>
<span class="tok-w">    </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-nt">&quot;name&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s2">&quot;JAXRS:1.0/kb/paymentMethods/3dd4e9d3-2be3-4bf2-b1e4-64a1785afd53&quot;</span><span class="tok-p">,</span>
<span class="tok-w">      </span><span class="tok-nt">&quot;durationUsec&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-mi">7654</span><span class="tok-p">,</span>
<span class="tok-w">      </span><span class="tok-nt">&quot;calls&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p">[</span>
<span class="tok-w">        </span><span class="tok-p">{</span>
<span class="tok-w">          </span><span class="tok-nt">&quot;name&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s2">&quot;API:getPaymentMethodById&quot;</span><span class="tok-p">,</span>
<span class="tok-w">          </span><span class="tok-nt">&quot;durationUsec&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-mi">4158</span><span class="tok-p">,</span>
<span class="tok-w">          </span><span class="tok-nt">&quot;calls&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p">[</span>
<span class="tok-w">            </span><span class="tok-p">{</span>
<span class="tok-w">              </span><span class="tok-nt">&quot;name&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s2">&quot;DAO_CONNECTION:get&quot;</span><span class="tok-p">,</span>
<span class="tok-w">              </span><span class="tok-nt">&quot;durationUsec&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-mi">60</span>
<span class="tok-w">            </span><span class="tok-p">},</span>
<span class="tok-w">            </span><span class="tok-p">{</span>
<span class="tok-w">              </span><span class="tok-nt">&quot;name&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s2">&quot;DAO:PaymentMethodSqlDao: getById&quot;</span><span class="tok-p">,</span>
<span class="tok-w">              </span><span class="tok-nt">&quot;durationUsec&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-mi">1371</span><span class="tok-p">,</span>
<span class="tok-w">              </span><span class="tok-nt">&quot;calls&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p">[</span>
<span class="tok-w">                </span><span class="tok-p">{</span>
<span class="tok-w">                  </span><span class="tok-nt">&quot;name&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s2">&quot;DAO_DETAILS:PaymentMethodSqlDao (raw): getById&quot;</span><span class="tok-p">,</span>
<span class="tok-w">                  </span><span class="tok-nt">&quot;durationUsec&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-mi">1364</span>
<span class="tok-w">                </span><span class="tok-p">}</span>
<span class="tok-w">              </span><span class="tok-p">]</span>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">          </span><span class="tok-p">]</span>
<span class="tok-w">        </span><span class="tok-p">},</span>
<span class="tok-w">        </span><span class="tok-p">{</span>
<span class="tok-w">          </span><span class="tok-nt">&quot;name&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s2">&quot;API:getAccountById&quot;</span><span class="tok-p">,</span>
<span class="tok-w">          </span><span class="tok-nt">&quot;durationUsec&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-mi">2593</span><span class="tok-p">,</span>
<span class="tok-w">          </span><span class="tok-nt">&quot;calls&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p">[</span>
<span class="tok-w">            </span><span class="tok-p">{</span>
<span class="tok-w">              </span><span class="tok-nt">&quot;name&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s2">&quot;API:getAccountById&quot;</span><span class="tok-p">,</span>
<span class="tok-w">              </span><span class="tok-nt">&quot;durationUsec&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-mi">2462</span><span class="tok-p">,</span>
<span class="tok-w">              </span><span class="tok-nt">&quot;calls&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p">[</span>
<span class="tok-w">                </span><span class="tok-p">{</span>
<span class="tok-w">                  </span><span class="tok-nt">&quot;name&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s2">&quot;API:getAccountByRecordIdInternal&quot;</span><span class="tok-p">,</span>
<span class="tok-w">                  </span><span class="tok-nt">&quot;durationUsec&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-mi">2408</span><span class="tok-p">,</span>
<span class="tok-w">                  </span><span class="tok-nt">&quot;calls&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p">[</span>
<span class="tok-w">                    </span><span class="tok-p">{</span>
<span class="tok-w">                      </span><span class="tok-nt">&quot;name&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s2">&quot;DAO_CONNECTION:get&quot;</span><span class="tok-p">,</span>
<span class="tok-w">                      </span><span class="tok-nt">&quot;durationUsec&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-mi">40</span>
<span class="tok-w">                    </span><span class="tok-p">},</span>
<span class="tok-w">                    </span><span class="tok-p">{</span>
<span class="tok-w">                      </span><span class="tok-nt">&quot;name&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s2">&quot;DAO:AccountSqlDao: getByRecordId&quot;</span><span class="tok-p">,</span>
<span class="tok-w">                      </span><span class="tok-nt">&quot;durationUsec&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-mi">877</span><span class="tok-p">,</span>
<span class="tok-w">                      </span><span class="tok-nt">&quot;calls&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p">[</span>
<span class="tok-w">                        </span><span class="tok-p">{</span>
<span class="tok-w">                          </span><span class="tok-nt">&quot;name&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s2">&quot;DAO_DETAILS:AccountSqlDao (raw): getByRecordId&quot;</span><span class="tok-p">,</span>
<span class="tok-w">                          </span><span class="tok-nt">&quot;durationUsec&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-mi">872</span>
<span class="tok-w">                        </span><span class="tok-p">}</span>
<span class="tok-w">                      </span><span class="tok-p">]</span>
<span class="tok-w">                    </span><span class="tok-p">}</span>
<span class="tok-w">                  </span><span class="tok-p">]</span>
<span class="tok-w">                </span><span class="tok-p">}</span>
<span class="tok-w">              </span><span class="tok-p">]</span>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">          </span><span class="tok-p">]</span>
<span class="tok-w">        </span><span class="tok-p">},</span>
<span class="tok-w">        </span><span class="tok-p">{</span>
<span class="tok-w">          </span><span class="tok-nt">&quot;name&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s2">&quot;API:getAccountAuditLogs&quot;</span><span class="tok-p">,</span>
<span class="tok-w">          </span><span class="tok-nt">&quot;durationUsec&quot;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-mi">6</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">      </span><span class="tok-p">]</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">  </span><span class="tok-p">]</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can see that for each mask there is some profiling data and such data retains the struture of the calls being made.</p>
</div>
</div>
<div class="sect2">
<h3 id="_client_side">Client Side</h3>
<div class="paragraph">
<p>The Ruby client library (<a href="https://github.com/killbill/killbill-client-ruby" class="bare">https://github.com/killbill/killbill-client-ruby</a>) has been extended to support profiling data. By passing a additional options the library will send the correct header to Kill Bill and capture the resulting information.</p>
</div>
<div class="paragraph">
<p>Currently, only JAXRS profilingData will be requested and returned for simplification.</p>
</div>
<div class="paragraph">
<p>In the example below <code>per_thread_profiling_data</code> will contain the timing for the various calls, which in that scenario would be <code>post:/1.0/kb/payments/uuid</code> and <code>get:/1.0/kb/payments/uuid:</code>. The provided hash will contain one key per call and the values will be an array of timing data expressed in uSec:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-c1"># Add the :profilingData option</span>
<span class="tok-n">per_thread_profiling_data</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">{}</span>
<span class="tok-n">options</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-ss">:username</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-s1">&#39;admin&#39;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-ss">:password</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-s1">&#39;password&#39;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-ss">:profilingData</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-n">per_thread_profiling_data</span><span class="tok-p">}</span>
<span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">auth_capture_task</span><span class="tok-o">.</span><span class="tok-n">op_create_capture</span><span class="tok-p">(</span><span class="tok-n">payment_id</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">ext_key</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">amount</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">currency</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">username</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">options</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that Ruby client gem will not make any attempt to synchronize access the the profiling_data map, when multiple threads are making calls. It is recommended to use per-thread data and potentially merge the results from the different threads at the end.</p>
</div>
</div>
<div class="sect2">
<h3 id="_tips_and_tricks">Tips and tricks</h3>
<div class="ulist">
<ul>
<li>
<p>In most cases, the client will be a bottleneck. Make sure to watch the number of sockets in <code>TIME_WAIT</code> (<code>watch 'netstat -an | grep 8080 | grep WAIT | wc -l'</code>) and speed up the recycling process:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-m">2</span><span class="tok-w"> </span>&gt;<span class="tok-w"> </span>/proc/sys/net/ipv4/tcp_fin_timeout
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-m">15000</span><span class="tok-w"> </span><span class="tok-m">65000</span><span class="tok-w"> </span>&gt;<span class="tok-w"> </span>/proc/sys/net/ipv4/ip_local_port_range
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-m">1</span><span class="tok-w"> </span>&gt;<span class="tok-w"> </span>/proc/sys/net/ipv4/tcp_tw_recycle
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-m">1</span><span class="tok-w"> </span>&gt;<span class="tok-w"> </span>/proc/sys/net/ipv4/tcp_tw_reuse</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>On the server side, check the expected concurrency level by watching the number of sockets in <code>ESTABLISHED</code> (<code>watch 'netstat -an | grep 8080 | grep EST | wc -l'</code>)</p>
</li>
<li>
<p>Make sure to allocate enough database (<code>org.killbill.dao.maxActive</code> / <code>org.killbill.billing.osgi.dao.maxActive</code>) and plugin (<code>org.killbill.payment.plugin.threads.nb</code>) threads. Check your container thread pool too (e.g. <code>conf/server.xml</code> for Tomcat)</p>
</li>
<li>
<p>Use tools like Siege (<a href="http://www.joedog.org/siege-home/" class="bare">http://www.joedog.org/siege-home/</a>) to verify your basic setup: <code>siege -b -t30S -c100 <a href="http://127.0.0.1:8080/1.0/kb/test/clock" class="bare">http://127.0.0.1:8080/1.0/kb/test/clock</a></code> should yield at least 5k req./s.</p>
</li>
<li>
<p>If Shiro is spending too many CPU cycles for authentication, lower the default number of iterations (e.g. <code>org.killbill.security.shiroNbHashIterations=2000</code>).</p>
</li>
<li>
<p>When using YourKit, turn off probes (especially the database ones). They cause a significant slowdown.</p>
</li>
<li>
<p>Allow a warm-up period, before starting a full test, to avoid contention in the JRuby JIT.</p>
</li>
<li>
<p>Use <a href="https://github.com/AdoptOpenJDK/mjprof">mjprof</a> to extract stacktraces:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>java<span class="tok-w"> </span>-jar<span class="tok-w"> </span>target/mjprof-1.0.jar<span class="tok-w"> </span>jmx/127.0.0.1:8989/.ncontains/name,RMI<span class="tok-w"> </span>TCP/.ncontains/name,RMI<span class="tok-w"> </span>Reaper/.ncontains/name,RMI<span class="tok-w"> </span>RenewClean/.ncontains/name,RMI<span class="tok-w"> </span>Scheduler/.ncontains/name,jruby-restarter/.ncontains/name,com.google.inject.internal.util.<span class="tok-nv">$Finalizer</span>/.ncontains/name,Finalizer/.ncontains/name,Reference/.ncontains/name,FelixStartLevel/.ncontains/name,FelixDispatchQueue/.ncontains/name,http-nio-8080/.ncontains/name,Abandoned<span class="tok-w"> </span>connection<span class="tok-w"> </span>cleanup<span class="tok-w"> </span>thread/.ncontains/name,CM<span class="tok-w"> </span>Event<span class="tok-w"> </span>Dispatcher/.ncontains/name,CM<span class="tok-w"> </span>Configuration<span class="tok-w"> </span>Updater/.ncontains/name,SCR<span class="tok-w"> </span>Component<span class="tok-w"> </span>Actor/.ncontains/name,Timer-/.ncontains/name,telnetconsole.Listener/.ncontains/name,O<span class="tok-w"> </span>worker<span class="tok-w"> </span>/.ncontains/name,O<span class="tok-w"> </span>boss<span class="tok-w"> </span>/.ncontains/name,NioBlockingSelector/.ncontains/name,Signal<span class="tok-w"> </span>Dispatcher/.ncontains/name,main/.ncontains/name,JMX<span class="tok-w"> </span>server<span class="tok-w"> </span>connection<span class="tok-w"> </span>timeout/.ncontains/state,WAITING/.sort/state/</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_load_tests">Load Tests</h3>
<div class="sect3">
<h4 id="_integration_tests">Integration Tests</h4>
<div class="paragraph">
<p>The <a href="https://github.com/killbill/killbill-integration-tests">integration tests repo</a> allows to run load tests against a running instance of Kill Bill. The <a href="https://github.com/killbill/killbill-integration-tests/blob/master/README.md">README</a> has a section explaining how they work.</p>
</div>
<div class="paragraph">
<p>Note: It is difficult to rely on single process MT threaded Ruby script to generate enough load.</p>
</div>
</div>
<div class="sect3">
<h4 id="_gnu_parallel_simple_load_testing_script">GNU parallel: simple load testing script</h4>
<div class="paragraph">
<p>Another way to generate load is to rely on <code>GNU parallel</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>seq<span class="tok-w"> </span><span class="tok-m">0</span><span class="tok-w"> </span><span class="tok-m">500</span><span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>parallel<span class="tok-w"> </span>-j10<span class="tok-w"> </span>--no-notice<span class="tok-w"> </span>-u<span class="tok-w"> </span>./perf_test.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where <code>perf_test.sh</code> is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nv">iteration_id</span><span class="tok-o">=</span><span class="tok-nv">$1</span>

<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;===&gt; Starting </span><span class="tok-nv">$iteration_id</span><span class="tok-s2">&quot;</span>

<span class="tok-nv">account_id</span><span class="tok-o">=</span><span class="tok-k">$(</span>curl<span class="tok-w"> </span>-v<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">                  </span>-X<span class="tok-w"> </span>POST<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">                  </span>-u<span class="tok-w"> </span>admin:password<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">                  </span>-H<span class="tok-w"> </span><span class="tok-s1">&#39;Content-Type: application/json&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">                  </span>-H<span class="tok-w"> </span><span class="tok-s1">&#39;X-Killbill-ApiKey: bob&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">                  </span>-H<span class="tok-w"> </span><span class="tok-s1">&#39;X-Killbill-ApiSecret: lazar&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">                  </span>-H<span class="tok-w"> </span><span class="tok-s1">&#39;X-Killbill-CreatedBy: creator&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">                  </span>--data-binary<span class="tok-w"> </span><span class="tok-s2">&quot;{\&quot;name\&quot;:\&quot;john\&quot;,\&quot;email\&quot;:\&quot;profiling@example.com\&quot;,\&quot;externalKey\&quot;:\&quot;perf-</span><span class="tok-nv">$RANDOM</span><span class="tok-s2">-</span><span class="tok-nv">$RANDOM</span><span class="tok-s2">-</span><span class="tok-nv">$RANDOM</span><span class="tok-s2">\&quot;,\&quot;currency\&quot;:\&quot;USD\&quot;}&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">                  </span>http://127.0.0.1:8080/1.0/kb/accounts<span class="tok-w"> </span><span class="tok-m">2</span>&gt;<span class="tok-p">&amp;</span><span class="tok-m">1</span><span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>Location<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>awk<span class="tok-w"> </span><span class="tok-s1">&#39;{print $3}&#39;</span><span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>awk<span class="tok-w"> </span>-F<span class="tok-s1">&#39;/&#39;</span><span class="tok-w"> </span><span class="tok-s1">&#39;{print $7}&#39;</span><span class="tok-k">)</span>

<span class="tok-nv">account_id</span><span class="tok-o">=</span><span class="tok-k">$(</span>tr<span class="tok-w"> </span>-dc<span class="tok-w"> </span><span class="tok-s1">&#39;[[:print:]]&#39;</span><span class="tok-w"> </span><span class="tok-o">&lt;&lt;&lt;</span><span class="tok-w"> </span><span class="tok-s2">&quot;</span><span class="tok-nv">$account_id</span><span class="tok-s2">&quot;</span><span class="tok-k">)</span>

curl<span class="tok-w">  </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-X<span class="tok-w"> </span>POST<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-u<span class="tok-w"> </span>admin:password<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s1">&#39;Content-Type: application/json&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s1">&#39;X-Killbill-ApiKey: bob&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s1">&#39;X-Killbill-ApiSecret: lazar&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s1">&#39;X-Killbill-CreatedBy: creator&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>--data-binary<span class="tok-w"> </span><span class="tok-s1">&#39;{&quot;pluginName&quot;:&quot;YOUR-PLUGIN&quot;,&quot;pluginInfo&quot;:{&quot;properties&quot;:[{&quot;key&quot;:&quot;type&quot;,&quot;value&quot;:&quot;CreditCard&quot;,&quot;isUpdatable&quot;:false},{&quot;key&quot;:&quot;ccType&quot;,&quot;value&quot;:&quot;visa&quot;,&quot;isUpdatable&quot;:false},{&quot;key&quot;:&quot;ccName&quot;,&quot;value&quot;:&quot;A Smith&quot;,&quot;isUpdatable&quot;:false},{&quot;key&quot;:&quot;email&quot;,&quot;value&quot;:&quot;foo@bar.com&quot;,&quot;isUpdatable&quot;:false},{&quot;key&quot;:&quot;ccExpirationMonth&quot;,&quot;value&quot;:&quot;03&quot;,&quot;isUpdatable&quot;:false},{&quot;key&quot;:&quot;ccExpirationYear&quot;,&quot;value&quot;:&quot;2016&quot;,&quot;isUpdatable&quot;:false},{&quot;key&quot;:&quot;ccVerificationValue&quot;,&quot;value&quot;:&quot;222&quot;,&quot;isUpdatable&quot;:false},{&quot;key&quot;:&quot;address1&quot;,&quot;value&quot;:&quot;lskdjf&quot;,&quot;isUpdatable&quot;:false},{&quot;key&quot;:&quot;address2&quot;,&quot;value&quot;:&quot;&quot;,&quot;isUpdatable&quot;:false},{&quot;key&quot;:&quot;city&quot;,&quot;value&quot;:&quot;sdfsdfsff&quot;,&quot;isUpdatable&quot;:false},{&quot;key&quot;:&quot;ccFirstName&quot;,&quot;value&quot;:&quot;sdfsdf&quot;,&quot;isUpdatable&quot;:false},{&quot;key&quot;:&quot;ccLastName&quot;,&quot;value&quot;:&quot;fdsfdsf&quot;,&quot;isUpdatable&quot;:false},{&quot;key&quot;:&quot;zip&quot;,&quot;value&quot;:&quot;23812&quot;,&quot;isUpdatable&quot;:false},{&quot;key&quot;:&quot;country&quot;,&quot;value&quot;:&quot;USA&quot;,&quot;isUpdatable&quot;:false},{&quot;key&quot;:&quot;state&quot;,&quot;value&quot;:&quot;CA&quot;,&quot;isUpdatable&quot;:false},{&quot;key&quot;:&quot;ccNumber&quot;,&quot;value&quot;:&quot;4111111111111111&quot;,&quot;isUpdatable&quot;:false}]}}&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span><span class="tok-s2">&quot;http://127.0.0.1:8080/1.0/kb/accounts/</span><span class="tok-si">${</span><span class="tok-nv">account_id</span><span class="tok-si">}</span><span class="tok-s2">/paymentMethods?isDefault=true&quot;</span><span class="tok-w"> </span>&gt;<span class="tok-w"> </span>/dev/null<span class="tok-w"> </span><span class="tok-m">2</span>&gt;<span class="tok-p">&amp;</span><span class="tok-m">1</span>


curl<span class="tok-w">  </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-X<span class="tok-w"> </span>POST<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-u<span class="tok-w"> </span>admin:password<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s1">&#39;Content-Type: application/json&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s1">&#39;X-Killbill-ApiKey: bob&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s1">&#39;X-Killbill-ApiSecret: lazar&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>-H<span class="tok-w"> </span><span class="tok-s1">&#39;X-Killbill-CreatedBy: creator&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span>--data-binary<span class="tok-w"> </span><span class="tok-s1">&#39;{&quot;transactionType&quot;:&quot;AUTHORIZE&quot;,&quot;amount&quot;:&quot;10&quot;,&quot;currency&quot;:&quot;USD&quot;}&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">     </span><span class="tok-s2">&quot;http://127.0.0.1:8080/1.0/kb/accounts/</span><span class="tok-si">${</span><span class="tok-nv">account_id</span><span class="tok-si">}</span><span class="tok-s2">/payments&quot;</span><span class="tok-w"> </span>&gt;<span class="tok-w"> </span>/dev/null<span class="tok-w"> </span><span class="tok-m">2</span>&gt;<span class="tok-p">&amp;</span><span class="tok-m">1</span>

<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;===&gt; Finished </span><span class="tok-nv">$iteration_id</span><span class="tok-s2">&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that on a single machine, this client-side script will most likely be the bottleneck (spawning the processes takes too much time). Use <a href="http://jmeter.apache.org/">JMeter</a> instead.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_seeking_help">Seeking help</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If all else fail, reach out to our <a href="https://groups.google.com/forum/#!forum/killbilling-users">mailing-list</a> for help (<strong>do not open a GitHub issue</strong>).</p>
</div>
<div class="paragraph">
<p>In your message, specify:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What you are seeing and what you are expecting</p>
</li>
<li>
<p>How to reproduce your scenario (cURL commands, code snippet, &#8230;&#8203;)</p>
</li>
<li>
<p><code>kpm diagnostic</code> output (see <a href="https://docs.killbill.io/latest/how-to-use-kpm-diagnostic">KPM Diagnostic Usage</a>)</p>
</li>
</ul>
</div>
</div>
</div></div><div class="bottom-nav-links"><a href="#" id="prev-nav-link" class="bottom-nav-link card prev"><span class="arrow-icon left"><svg class="i-arrow" width="12" height="11" viewBox="0 0 12 11" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4.19526 1.02876C4.45561 0.768409 4.87772 0.768409 5.13807 1.02876C5.39842 1.28911 5.39842 1.71122 5.13807 1.97157L2.27614 4.8335H11.3333C11.7015 4.8335 12 5.13197 12 5.50016C12 5.86835 11.7015 6.16683 11.3333 6.16683H2.27614L5.13807 9.02876C5.39842 9.28911 5.39842 9.71122 5.13807 9.97157C4.87772 10.2319 4.45561 10.2319 4.19526 9.97157L0.195261 5.97157C-0.0650883 5.71122 -0.0650883 5.28911 0.195261 5.02876L4.19526 1.02876Z" fill=""/></svg><span class="prev-text">Previous</span></span><span id="prev-navigator" class="bottom-nav-text">Prev</span>                               </a><a href="#" id="next-nav-link" class="bottom-nav-link card next"><span class="arrow-icon"><span class="next-text">Next</span><svg class="i-arrow icon-left" width="12" height="11" viewBox="0 0 12 11" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4.19526 1.02876C4.45561 0.768409 4.87772 0.768409 5.13807 1.02876C5.39842 1.28911 5.39842 1.71122 5.13807 1.97157L2.27614 4.8335H11.3333C11.7015 4.8335 12 5.13197 12 5.50016C12 5.86835 11.7015 6.16683 11.3333 6.16683H2.27614L5.13807 9.02876C5.39842 9.28911 5.39842 9.71122 5.13807 9.97157C4.87772 10.2319 4.45561 10.2319 4.19526 9.97157L0.195261 5.97157C-0.0650883 5.71122 -0.0650883 5.28911 0.195261 5.02876L4.19526 1.02876Z" fill=""/></svg></span><span id="next-navigator" class="bottom-nav-text">Next</span></a></div></article></div><div class="bd-links-wrapper"><nav class="bd-links toc right-side-menu" id="myScrollspy" data-toggle="toc"></nav></div></div></div></div></div></main><script src="javascripts/jquery-3.6.1.min.js"></script><script src="javascripts/bootstrap.min.js"></script><script src="javascripts/bootstrap-toc.min.js"></script><script type="module" src="javascripts/kb.js"></script><script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script><script>docsearch({apiKey: '3ef227e7fd5e2e1a3fffd880484934bf', container: '#docsearch', appId: 'S2ISXITURI', indexName: 'killbill'});</script><script>
  jQuery(document).ready(function($){
    $('.sidebar-nav .icon-title').on('click', function (e) {
      e.preventDefault();
      $('.sidebar-nav .nav.navbar-nav .nav.navbar-nav').slideUp(200);
      $('.sidebar-nav > .navbar-nav > li').removeClass('open');

      if($(this).next().is(':visible')){
        $('.sidebar-nav .nav.navbar-nav .nav.navbar-nav').slideUp(200);
        $('.sidebar-nav > .navbar-nav > li').removeClass('open');
      } else {
        $(this).parent().addClass('open');
        $(this).next().slideDown(200);
      }
    });

    let pageURL = $(location).attr("href");
    pageURL = pageURL.includes('.html') ? pageURL : pageURL + '.html';
    $('.nav-link').each(function() {
      if (pageURL.toLowerCase().includes($(this).attr('href').toLowerCase())) {
        $(this).parent().addClass('list-item-active');
        $(this).parent().parent().addClass('active-list');
        $(this).parent().parent().prev().addClass('bd-link-active-wrap');
      }
    });
  });
</script>
</body></html>