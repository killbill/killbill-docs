<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]--><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="Asciidoctor 2.0.20"><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.staticaly.com/gh/afeld/bootstrap-toc/v1.0.0/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3"><link rel="preconnect" href="https://S2ISXITURI-dsn.algolia.net"><style type="text/css"></style><title>Invoice subsystem</title><style>/*Default CSS*/

/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */

@import "https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap";

*,
*::before,
*::after {
  -webkit-box-sizing: border-box;
  box-sizing: border-box;
}

ul,
ol {
  padding: 0;
  list-style-type: none;
}

body,
h1,
h2,
h3,
h4,
p,
ul[class],
ol[class],
li,
figure,
figcaption,
blockquote,
dl,
dd {
  margin: 0;
}

body {
  min-height: 100vh;
  scroll-behavior: smooth;
  text-rendering: optimizeSpeed;
  font-family: 'Inter', sans-serif;
  font-size: 16px;
  line-height: 150%;
  color: #374151;
  max-width: 100%;
  overflow-x: hidden;
}

ul[class],
ol[class] {
  list-style: none;
}

img {
  max-width: 100%;
  display: block;
}

img[align=center] {
  margin: 0 auto;
}

button {
  cursor: pointer;
}

input,
button,
textarea,
select {
  font: inherit;
}
a {
  color: #167BB7;
}
h1,
h3,
h4 {
  font-weight: 400;
}
h2,
h3,
h4 {
  color: #1F2937;
}
h1 {
  font-size: 40px;
  line-height: 120%;
  letter-spacing: -0.025em;
  color: #FFFFFF;
}
h2 {
  font-weight: 600;
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
  font-weight: 500;
}

.header {
  padding: 16px 0;
  background: #FFFFFF;
  box-shadow: 0 1px 3px rgba(0, 0, 0, .1), 0 1px 2px rgba(0, 0, 0, .06);
}
@media (min-width: 768px) {
  .header-logo {
    width: 320px;
  }
}
.header-wrapper .logo {
  max-width: 215px;
  margin: auto;
  width: 80%;
}
.header-wrapper .logo img {
  object-fit: contain;
}
@media (max-width: 767px) {
  .header-wrapper .logo a {
    display: flex;
    justify-content: center;
  }
}
.header-search {
  flex-grow: 1;
  padding-right: 16px;
}
@media (min-width: 768px) {
  .header-search {
    /*flex-grow: 1;*/
    /*max-width: calc(100% - 590px);*/
    /*padding-right: 53px;*/
    /*padding-left: 45px;*/
  }
}
@media (min-width: 1200px) {
  .header-search {
    max-width: calc(100% - 590px);
    padding-right: 53px;
    padding-left: 45px;
  }
}

.header-wrapper .search-form-wrapper {
  flex-grow: 1;
}
.header-wrapper .search-form {
  position: relative;
}
.header-wrapper .search-form .algolia-autocomplete {
  width: 100%;
}
.header-wrapper .search-form input[type="search"] {
  width: 100%;
  padding: 9px 9px 9px 40px;
  border: 1px solid #D1D5DB;
  border-radius: 6px;
  box-shadow: 0 1px 2px rgba(0, 0, 0, .05);
}
.header-wrapper .search-form .ds-dropdown-menu {
  max-width: none;
  width: 100%;
}
.header-wrapper .search-form .search-form-icon {
  position: absolute;
  left: 13px;
  top: 9px;
  z-index: 1;
  width: 20px;
  height: 20px;
  pointer-events: none;
}
.content-wrapper {
  padding: 24px 20px;
}
@media (min-width: 1024px) {
  .content-wrapper {
    padding-right: 54px;
    padding-left: 54px;
  }
}

.content-wrapper .banner {
  position: relative;
  display: flex;
  align-items: center;
  min-height: 174px;
  margin-bottom: 24px;
  padding: 0 40px;
  background-color: #167BB7;
  border-radius: 8px;
}
.content-wrapper .banner .bg-image {
  position: absolute;
  width: 100%;
  height: 100%;
  top: 0;
  left: 0;
  pointer-events: none;
}

.main {
  position: relative;
  line-height: 1.5;
}

.main p {
  margin-bottom: 12px;
}

.main .sidebar {
  width: calc(100% + 15px);
  flex-shrink: 0;
  margin-right: 40px;
  position: sticky;
  top: 0;
  margin-left: -15px;
  padding: 24px 16px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, .1), 0 1px 2px rgba(0, 0, 0, .06);
}

.main .sidebar .icon-title {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding-top: 8px;
  padding-bottom: 8px;
  cursor: pointer;
}

.main .sidebar .icon-title .left-part{
  display: flex;
  align-items: center;
  order: 2;
  flex-grow: 1;
}

.main .sidebar .icon-title .chevron,
.main .sidebar .icon-title.bd-link-active-wrap .chevron.rotated {
  transform: rotate(180deg);
}

.main .sidebar .icon-title.bd-link-active-wrap .bd-toc-link {
  color: #167BB7;
}

.main .sidebar .open .icon-title .chevron,
.main .sidebar .icon-title.bd-link-active-wrap .chevron{
  transform: rotate(0);
  transition-duration: .25s;
  transform-origin: center;
}

.main .sidebar .bd-link-active-wrap  .chevron path {
  fill: #D1D5DB;
}

.main .sidebar .bd-link-active-wrap svg path {
  fill: #167BB7;
}

.main .sidebar .icon-title svg {
  width: 16px;
  order: 1;
}
.main .sidebar-nav {
  height: 100vh;
}
.main .sidebar-nav,
.main .right-side-menu {
  overflow-y: scroll;
  padding: 0 24px;
}

.main .right-side-menu {
  direction: rtl;
  padding: 24px 0 0 24px;
}

.main .right-side-menu .navbar-nav {
  direction: ltr;
}

.main .sidebar-nav::-webkit-scrollbar,
.main .right-side-menu::-webkit-scrollbar
{
  width: 8px;
}

.main .sidebar-nav::-webkit-scrollbar-track,
.main .right-side-menu::-webkit-scrollbar-track
{
  background-color: transparent;
}

.main .sidebar-nav::-webkit-scrollbar-thumb,
.main .right-side-menu::-webkit-scrollbar-thumb
{
  background-color: #F3F4F6;
  width: 6px;
  border-radius: 32px;
}

.main .sidebar-nav a.nav-link {
  transition-duration: .25s;
  transition-property: color;
}
.main .sidebar-nav a.nav-link:hover {
  color: #167BB7;
}
.main .sidebar-nav a {
  color: #6B7280;
}

.main .sidebar-nav a.bd-toc-link {
  padding-left: 12px;
  font-weight: 500;
  font-size: 14px;
  display: block;
  color: #6B7280;
  transition-duration: .25s;
  transition-property: color;
}
.main .sidebar-nav li:hover a.bd-toc-link,
.main .sidebar-nav li.active a.bd-toc-link,
.main .sidebar-nav .open a.bd-toc-link {
  color: #374151;
}
@media (min-width: 768px) {
  .main .sidebar:after {
    content: '';
    position: absolute;
    top: 30px;
    right: -12px;
    width: 13px;
    height: 24px;
    border-radius: 4px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
  }
}
.sidebar-toggler {
  display: none;
}
@media (min-width: 768px) {
  .sidebar-toggler {
    display: block;
    position: absolute;
    top: 30px;
    right: -12px;
    width: 24px;
    height: 24px;
    border-radius: 4px;
    cursor: pointer;
    background-color: #F3F4F6;
    transition-duration: .25s;
    z-index: 2;
  }
  .sidebar-toggler:hover {
    background-color: #efefef;
  }
  .sidebar-toggler:after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 8px;
    height: 12px;
    transform: translate(-50%, -50%) rotate(0deg);
    background-image: url("data:image/svg+xml,%3Csvg width='8' height='12' viewBox='0 0 8 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M6.33337 10.6666L1.66671 5.99998L6.33337 1.33331' stroke='%23167BB7' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E%0A");
    background-size: contain;
    background-repeat: no-repeat;
    transition-duration: .25s;
  }
  .sidebar-toggler.active:after {
    transform: translate(-50%, -50%) rotate(180deg);
  }
}


pre.pygments .tok-o {
  color: #167BB7;
}

.main p code {
  color: inherit;
  font-size: inherit;
}

.main table,.main table td,.main table th {
  border: 1px solid #dedede;
  padding: 10px;
}

.main .note table,.main .note table td,.main .note table th {
  border: none;
}

.main .note .icon {
  width: 60px;
}

.main .note .icon .fa.icon-note {
  display: none;
}

.main .note .content {
  font-weight: normal;
  color: #374151;
}

.main table td.icon svg{
  width: 30px;
  height: auto;
}

.main table td.icon .title {
  display: none;
}

.main table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 15px;
}

.main table .title {
  text-transform: uppercase;
  font-weight: 600;
  padding: 0 5px;
}

pre.pygments .tok-o {
  color: #167BB7!important;
}

.main .sidebar-nav > ul li ul {
  display: none;
  padding-left: 16px;
  padding-bottom: 8px;
  font-size: 14px;
  border-bottom: 1px solid #F3F4F6;
}

.main .sidebar-nav > ul li ul.active-list {
  display: block;
}

.main .sidebar-nav > ul li ul li a{
  display: block;
  position: relative;
  padding-left: 16px;
  font-size: 14px;
}

.main .sidebar-nav .list-item-active a {
  color: #167BB7;
}

.main .sidebar-nav > .navbar-nav  > li {
  margin-bottom: 8px;
}

.main .right-side-menu {
  position: sticky;
  top: 16px;
  height: calc(100vh - 40px);
  margin-top: 24px;
}

.main .right-side-menu > .navbar-nav {
  position: relative;
}

.sidebar-wrapper {
  margin-left: 0;
  transition-duration: .25s;
  flex-shrink: 0;
  width: calc(100% - 16px);
}
.main-wrapper {
  flex-grow: 1;
}
.bd-links-wrapper {
  flex-shrink: 0;
}
.right-side-menu ul ul {
  padding-left: 16px;
}
@media (min-width: 768px) {
  .sidebar-wrapper {
    width: 310px;
  }
  .sidebar-hide .sidebar-wrapper {
    margin-left: -280px;
  }
  .main-wrapper {
    width: calc(100% - 520px);
  }
}
@media (min-width: 1200px) {
  .main-wrapper {
    width: calc(100% - 590px);
  }
  .bd-links-wrapper {
    width: 268px;
  }
}


.main .right-side-menu > .navbar-nav:before {
  content: "In this document";
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  font-size: 14px;
  line-height: 16px;
  text-transform: uppercase;
  color: #1F2937;
}

.main .right-side-menu > ul > li > a {
  font-size: 14px;
  font-weight: 300;
  margin-bottom: 7px;
  padding: 4px 0;
}

.main .right-side-menu .nav-link {
  border: none!important;
  color: #6B7280!important;
}

.main .right-side-menu .nav-link.active{
  padding-left: 0;
  color: #167BB7!important;
  font-weight: 500;
}

.main .right-side-menu .navbar-nav {
  display: block;
}
.main nav[data-toggle=toc] .nav > li > a {
  padding-left: 0;
  transition-property: color;
  transition-duration: .25s;
}
.main nav[data-toggle=toc] .nav > li > a:focus,
.main nav[data-toggle=toc] .nav > li > a:hover {
  color: #167BB7!important;
}
.main nav[data-toggle=toc] .nav .nav > li > a:focus,
.main nav[data-toggle=toc] .nav .nav > li > a:hover,
.main nav[data-toggle=toc] .nav .nav > li > .active,
.main nav[data-toggle=toc] .nav .nav > li > .active:focus,
.main nav[data-toggle=toc] .nav .nav > li > .active:hover {
  padding-left: 0;
}
.main nav[data-toggle=toc] .nav-link.active:hover {
  padding-left: 0;
}

.main img {
  box-shadow: none;
  border-radius: 0;
  margin-bottom: 24px;
  margin-top: 10px;
  display: inline;
}

.main .note img {
  box-shadow: none;
  border-radius: 0;
  min-width: 40px;
  width: 40px;
  margin-bottom: 10px;
}

.main .imageblock img {
  height: auto;
}
.main p span.image {
  display: inline-flex;
  flex-direction: column;
  align-items: center;
  height: 16px;
  width: 20px;
  margin-left: 4px;
  margin-right: 4px;
}
.main p span.image img {
  height: 100%;
  width: 100%;
  margin-bottom: 0;
  margin-top: 0;
  box-shadow: none;
  object-fit: cover;
}

.main .listingblock, .literalblock > .content pre {
  padding: 8px 14px;
  background: #50576A;
  border-radius: 4px;
  margin-bottom: 24px;
  font-size: 14px;
  font-weight: 400;
  color: #CECECE;
}

pre.pygments {
  background: #50576A!important;
  margin-bottom: 0;
}

.main .listingblock  .tok-nt {
  color: #29A9C9;
}

.main .listingblock .tok-s {
  color: #E44C3A;
}

.main .listingblock  .tok-p {
  color: #F5FBFF;
}

.main ol {
  counter-reset: my-awesome-counter;
  list-style: none;
  color: #167BB7;
  margin-left: 20px;
  margin-bottom: 16px;
}

.main ol > li {
  position: relative;
  counter-increment: my-awesome-counter;
  font-weight: 600;
}

.main ol.arabic > li::before {
  content: counter(my-awesome-counter);
  position: absolute;
  top: -1px;
  left: -20px;
  display: flex;
  justify-content: center;
  align-items: center;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background-color: #E5E7EB;
  color: #6B7280;
  font-weight: 400;
  font-size: inherit;
}
.main ol > li::before {
}

.main ol.arabic:first-child p {
  color: #374151;
  margin-left: 10px;
  font-weight: 400;
}

.main .content-wrapper ul{
  color: #374151;
  list-style: disc;
  margin-left: 20px;
}

.main .content-wrapper ul > li ul {
  margin-left: 0;
  list-style-type: none;
}

.main .content-wrapper ul.nav-tabs{
  list-style: none;
}
.main ol ol {
  margin-left: 30px;
}
.main ol.loweralpha[type=a] > li {
  list-style-type: lower-alpha;
}
.main ol.lowerroman[type=i] > li {
  list-style-type: lower-roman;
}
.main ol li::marker {
  color: #6B7280;
}

.main h2, .main h3 {
  margin-bottom: 16px;
  padding-top: 24px;
}

.main h4 {
  margin-bottom: 16px;
  padding-top: 16px;
}

.content-wrapper h2 a, .content-wrapper h3 a, .content-wrapper h4 a {
  display: none;
  margin-left: 5px;
}

.content-wrapper h4 a svg {
  height: 14px;
  width: auto;
}

.content-wrapper h2:hover a, .content-wrapper h3:hover a, .content-wrapper h4:hover a {
  display: inline;
}

.breadcrumbs-wrapper {
  margin-bottom: 24px;
}
.breadcrumbs-list {
  display: flex;
  align-items: center;
}
.breadcrumbs-list li {
  display: flex;
  align-items: center;
}
.breadcrumbs-list li:not(:last-of-type):after {
  content: '/';
  margin-left: 6px;
  margin-right: 6px;
}
.breadcrumbs-list a {
  display: flex;
  align-items: center;
  letter-spacing: -0.025em;
  color: #374151;
}
.breadcrumbs-list a svg {
  width: 24px;
  height: 24px;
  margin-right: 4px;
}

.note table code {
  color: #374151;
}

.banner .absolute-figure {
  position: absolute;
}

.banner .absolute-figure.abstract-figure {
  right: 0;
}

.banner .absolute-figure.circle2 {
  right: 30%;
  top: 10%;
}

.banner .absolute-figure.circle3 {
  right: 15%;
  top: 10%;
}

.banner .absolute-figure.circle4 {
  left: 5%;
  top: 10%;
}

.banner .absolute-figure.circle5 {
  left: 30%;
}

.banner .absolute-figure.circle6 {
  left: 6%;
  bottom: 0;
}

.banner .absolute-figure.circle7 {
  left: 35%;
  bottom: 15%;
}

.banner .absolute-figure.circle8 {
  left: 55%;
  bottom: 0;
}

.banner .absolute-figure.circle9 {
  bottom: 0;
  right: 0;
}

.doclink {
  position: fixed;
  bottom: 0;
  padding: 0 15px 10px;
  background-color: #FBFDFF;
  z-index: 1000;
  font-size: 12px;
}

.btn-primary, .btn-primary:hover {
  background-color: #167BB7;
  border-color: #167BB7;
}

.card {
  height: 100%;
}
.card-wrapper .card-text {
  min-height: 80px;
  margin-bottom: 16px;
}

.card-wrapper .card-body {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  padding: 1rem 0.25rem;
}

pre.pygments .tok-c1 {
  color: #29A9C9!important;
}

@media screen and (max-width: 1520px) {
  .card-wrapper .card-text {
    min-height: 110px;
  }
}

.DocSearch.DocSearch-Button {
    margin-left: 0;
    width: 100%;
    height: 38px;
    padding: 0 15px;
    background-color: transparent;
    border: 1px solid #D1D5DB;
    box-shadow: 0 1px 2px rgba(0, 0, 0, .05);
    border-radius: 6px;
    font-weight: 400;
    font-size: 14px;
    line-height: 20px;
    color: #6B7280;
}
.search-form-wrapper .DocSearch-Button-Keys {
  display: none;
}
.DocSearch-Hit-content-wrapper {
  overflow-x: inherit !important;
}
.search-form-wrapper .DocSearch-Button .DocSearch-Search-Icon {
  color: #9CA3AF;
  width: 16px;
  height: 16px;
}
.search-form-wrapper .DocSearch-Button-Placeholder {
  padding-left: 10px;
}
.oneline_with_image img {
    display: inline-block;
    height: 30px;
    margin: 0 10px;
}

.warning table td, .warning table,
.important table td, .important table {
  border: none;
}
.copy-icon {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  height: 40px;
  margin: -8px -14px 8px;
  padding: 0 16px;
  background-color: #3C4356;
  border-top-left-radius: 4px;
  border-top-right-radius: 4px;
}
.copy-icon svg {
  cursor: pointer;
}
.icon-tip {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 502 502' xml:space='preserve'%3E%3Cpath d='M230.523 78.722c-35.583-.342-69.221 13.48-94.756 38.802-25.528 25.316-39.587 58.839-39.587 94.396 0 34.708 13.278 67.567 37.387 92.524 24 24.844 37.216 57.409 37.216 91.697v70.281c0 5.523 4.477 10 10 10h12.756C197.871 491.185 211.53 502 227.676 502s29.805-10.815 34.138-25.578h16.166c5.523 0 10-4.477 10-10v-70.275c0-34.627 12.99-66.961 36.576-91.044 24.522-25.04 38.027-58.133 38.027-93.185 0-35.38-13.723-68.697-38.64-93.812-24.902-25.1-58.079-39.086-93.42-39.384zM227.676 482c-4.787 0-9.076-2.17-11.936-5.578h23.872c-2.86 3.408-7.149 5.578-11.936 5.578zm40.304-25.578h-77.197v-37.125h77.197v37.125zm42.287-165.313c-27.269 27.844-42.287 65.148-42.287 105.039v3.15h-77.197v-3.156c0-39.5-15.211-77-42.832-105.593-20.488-21.208-31.771-49.133-31.771-78.629 0-30.183 11.958-58.663 33.67-80.194 21.72-21.538 50.338-33.226 80.505-33.005 61.882.521 112.228 51.301 112.228 113.197 0 29.789-11.477 57.912-32.316 79.191zM229.381 55.584c5.523 0 10-4.477 10-10V10c0-5.523-4.477-10-10-10s-10 4.477-10 10v35.584c0 5.523 4.477 10 10 10zM85.246 29.896a9.988 9.988 0 0 0 8.099 4.123 9.96 9.96 0 0 0 5.87-1.91c4.468-3.247 5.458-9.5 2.212-13.968l-7.108-9.783C91.073 3.89 84.82 2.9 80.351 6.146c-4.468 3.247-5.458 9.5-2.212 13.968l7.107 9.782zM124.729 84.239a9.988 9.988 0 0 0 8.099 4.123 9.96 9.96 0 0 0 5.87-1.91c4.468-3.246 5.458-9.5 2.212-13.968l-19.113-26.308c-3.246-4.468-9.499-5.459-13.968-2.212-4.468 3.246-5.458 9.5-2.212 13.968l19.112 26.307zM37.031 160.15l33.843 10.996a10.01 10.01 0 0 0 3.092.492c4.215 0 8.136-2.687 9.509-6.913 1.707-5.253-1.168-10.894-6.42-12.601l-33.843-10.996c-5.251-1.705-10.894 1.168-12.601 6.42-1.707 5.254 1.167 10.895 6.42 12.602zM84.808 260.51c-1.707-5.253-7.346-8.126-12.601-6.42l-33.843 10.996c-5.252 1.707-8.127 7.348-6.42 12.601 1.373 4.226 5.293 6.913 9.509 6.913a10.01 10.01 0 0 0 3.092-.492l33.843-10.996c5.252-1.708 8.126-7.349 6.42-12.602zM102.626 391.668c-4.467-3.246-10.721-2.255-13.968 2.212l-8.903 12.253c-3.246 4.468-2.256 10.722 2.212 13.968a9.952 9.952 0 0 0 5.87 1.91 9.99 9.99 0 0 0 8.099-4.123l8.903-12.253c3.246-4.467 2.256-10.72-2.213-13.967z'/%3E%3Cpath d='M134.544 347.736c-4.468-3.246-10.722-2.255-13.968 2.212l-8.845 12.175c-3.246 4.468-2.255 10.722 2.212 13.968a9.952 9.952 0 0 0 5.87 1.91 9.99 9.99 0 0 0 8.099-4.123l8.845-12.175c3.246-4.467 2.255-10.721-2.213-13.967zM338.347 336.895c-3.246-4.468-9.499-5.459-13.968-2.212-4.468 3.247-5.458 9.5-2.212 13.968l20.916 28.789a9.988 9.988 0 0 0 8.099 4.123 9.96 9.96 0 0 0 5.87-1.91c4.468-3.247 5.458-9.5 2.212-13.968l-20.917-28.79zM426.045 260.984l-33.843-10.997c-5.252-1.705-10.894 1.168-12.601 6.42-1.707 5.252 1.168 10.894 6.42 12.601l33.843 10.997a10.01 10.01 0 0 0 3.092.492c4.215 0 8.136-2.687 9.509-6.913 1.707-5.251-1.167-10.893-6.42-12.6zM471.39 130.367c-1.706-5.252-7.347-8.127-12.601-6.42l-14.678 4.769c-5.252 1.707-8.127 7.348-6.42 12.601 1.373 4.226 5.293 6.913 9.509 6.913a10.01 10.01 0 0 0 3.092-.492l14.678-4.769c5.252-1.708 8.126-7.349 6.42-12.602zM387.777 167.536a10.01 10.01 0 0 0 3.092-.492l25.994-8.446c5.252-1.707 8.127-7.348 6.42-12.601-1.707-5.252-7.347-8.127-12.601-6.42l-25.994 8.446c-5.252 1.707-8.127 7.348-6.42 12.601 1.374 4.225 5.294 6.912 9.509 6.912zM320.89 83.916a9.952 9.952 0 0 0 5.87 1.91 9.99 9.99 0 0 0 8.099-4.123l20.916-28.789c3.246-4.468 2.255-10.722-2.212-13.968-4.469-3.246-10.722-2.255-13.968 2.212l-20.916 28.789c-3.248 4.469-2.257 10.722 2.211 13.969zM288.349 135.549c-11.289-8.76-24.609-14.981-38.521-17.992-5.395-1.169-10.721 2.26-11.889 7.659-1.168 5.398 2.261 10.721 7.659 11.889 11.007 2.382 21.55 7.308 30.491 14.245a9.954 9.954 0 0 0 6.124 2.1 9.981 9.981 0 0 0 7.907-3.87c3.385-4.363 2.592-10.645-1.771-14.031zM202.914 119.066c-41.096 11.729-69.797 49.799-69.797 92.579 0 5.523 4.477 10 10 10s10-4.477 10-10c0-33.895 22.735-64.056 55.287-73.346 5.311-1.516 8.387-7.05 6.872-12.361-1.518-5.31-7.052-8.388-12.362-6.872z'/%3E%3C/svg%3E");
  width: 42px;
  height: 42px;
  background-repeat: no-repeat;
  background-position: center;
}
.main table td.icon {
  text-align: center;
}
.icon-warning {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='554.2' height='554.199' xml:space='preserve' fill='%23E44C3A'%3E%3Cpath d='M538.5 386.199 356.5 70.8a91.803 91.803 0 0 0-79.501-45.9c-32.8 0-63.1 17.5-79.5 45.9L12.3 391.6a91.793 91.793 0 0 0 0 91.8c16.4 28.4 46.7 45.9 79.5 45.9H462.4c50.7 0 91.8-41.101 91.8-91.8 0-19-5.8-36.7-15.7-51.301zm-222.2 30.7c0 21.7-16.7 38.3-39.2 38.3s-39.2-16.6-39.2-38.3V416c0-21.601 16.7-38.301 39.2-38.301S316.3 394.3 316.3 416v.899zm.9-258.199-19.4 169.4c-1.3 12.2-9.4 19.8-20.7 19.8s-19.4-7.7-20.7-19.8L237 158.6c-1.3-13.1 5.801-23 18-23h44.1c12.2.1 19.4 10 18.1 23.1z'/%3E%3C/svg%3E%0A");
  width: 40px;
  height: 39px;
  background-size: 100%;
}
.icon-important {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Cg transform='scale(.521)'%3E%3Ccircle cx='96' cy='96' r='74' fill='%23E44C3A'/%3E%3Cpath d='M86 48h20l-4 72H90z' fill='%23fff'/%3E%3Ccircle cx='96' cy='140' r='10' fill='%23fff'/%3E%3C/g%3E%3C/svg%3E");
  width: 40px;
  height: 40px;
  background-size: 100%;
}
.main .admonitionblock.tip table,
.main .admonitionblock.tip table td {
  border: none;
}
/*Light box start*/

.lightbox-modal {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  background-color: #ebebeb;
  padding: 20px;
  transform: translate(-50%, -50%);
  z-index: 100;
  border-radius: 8px;
  max-width: 95vw;
  width: 100%;
  height: 90vh;
}
.lightbox-modal .img {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
}
.lightbox-modal .img img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  margin: 0;
}
@media (max-width: 1023px) {
  .lightbox-modal {
    height: auto;
    max-width: 95vw;
  }
}
#close-ligtbox {
  position: absolute;
  right: -35px;
  top: -35px;
  display: block;
  width: 30px;
  font-size: 36px;
  border-radius: 8px;
  cursor: pointer;
  color: #fff;
}
@media (max-width: 1023px) {
  #close-ligtbox {
    right: 0;
    top: -40px;
    width: 24px;
    font-size: 28px;
  }
}
.overlay {
  display: none;
  position: fixed;
  background-color: rgba(0,0,0,.5);
  left: 0;
  top: 0;
  right: 0;
  bottom: 0;
  z-index: 99;
}
.imageblock img, .paragraph .image img {
  cursor: pointer;
}
/*Light box end*/

.ulist {
  margin-left: 10px;
}
.main ol.arabic:first-child .ulist p,
.ulist ul li p {
  margin-left: 0!important;
}

.ulist li::marker {
  font-size: 20px;
  color: #6d7176;
}
.ulist li ul {
  list-style-type: none;
}
.ulist li ul li {
  position: relative;
  padding-left: 24px;
}
.ulist li ul li:before {
  content: '';
  position: absolute;
  left: 0;
  top: 9px;
  width: 8px;
  height: 8px;
  background-color: #E5E7EB;
  border: 1px solid #9CA3AF;
  border-radius: 100%;
}
.right-side-menu ul ul li:not(:last-child) {
  margin-bottom: 5px;
}
.imageblock .title {
  margin-bottom: 24px;
}
</style>
<style>pre.pygments .hll { background-color: #49483e }
pre.pygments { background: #272822; color: #f8f8f2 }
pre.pygments .tok-c { color: #75715e } /* Comment */
pre.pygments .tok-err { color: #960050; background-color: #1e0010 } /* Error */
pre.pygments .tok-k { color: #66d9ef } /* Keyword */
pre.pygments .tok-l { color: #ae81ff } /* Literal */
pre.pygments .tok-n { color: #f8f8f2 } /* Name */
pre.pygments .tok-o { color: #f92672 } /* Operator */
pre.pygments .tok-p { color: #f8f8f2 } /* Punctuation */
pre.pygments .tok-ch { color: #75715e } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #75715e } /* Comment.Multiline */
pre.pygments .tok-cp { color: #75715e } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #75715e } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #75715e } /* Comment.Single */
pre.pygments .tok-cs { color: #75715e } /* Comment.Special */
pre.pygments .tok-gd { color: #f92672 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-gi { color: #a6e22e } /* Generic.Inserted */
pre.pygments .tok-go { color: #66d9ef } /* Generic.Output */
pre.pygments .tok-gp { color: #f92672; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #75715e } /* Generic.Subheading */
pre.pygments .tok-kc { color: #66d9ef } /* Keyword.Constant */
pre.pygments .tok-kd { color: #66d9ef } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #f92672 } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #66d9ef } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #66d9ef } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #66d9ef } /* Keyword.Type */
pre.pygments .tok-ld { color: #e6db74 } /* Literal.Date */
pre.pygments .tok-m { color: #ae81ff } /* Literal.Number */
pre.pygments .tok-s { color: #e6db74 } /* Literal.String */
pre.pygments .tok-na { color: #a6e22e } /* Name.Attribute */
pre.pygments .tok-nb { color: #f8f8f2 } /* Name.Builtin */
pre.pygments .tok-nc { color: #a6e22e } /* Name.Class */
pre.pygments .tok-no { color: #66d9ef } /* Name.Constant */
pre.pygments .tok-nd { color: #a6e22e } /* Name.Decorator */
pre.pygments .tok-ni { color: #f8f8f2 } /* Name.Entity */
pre.pygments .tok-ne { color: #a6e22e } /* Name.Exception */
pre.pygments .tok-nf { color: #a6e22e } /* Name.Function */
pre.pygments .tok-nl { color: #f8f8f2 } /* Name.Label */
pre.pygments .tok-nn { color: #f8f8f2 } /* Name.Namespace */
pre.pygments .tok-nx { color: #a6e22e } /* Name.Other */
pre.pygments .tok-py { color: #f8f8f2 } /* Name.Property */
pre.pygments .tok-nt { color: #f92672 } /* Name.Tag */
pre.pygments .tok-nv { color: #f8f8f2 } /* Name.Variable */
pre.pygments .tok-ow { color: #f92672 } /* Operator.Word */
pre.pygments .tok-w { color: #f8f8f2 } /* Text.Whitespace */
pre.pygments .tok-mb { color: #ae81ff } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #ae81ff } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #ae81ff } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #ae81ff } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #ae81ff } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #e6db74 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #e6db74 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #e6db74 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #e6db74 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #e6db74 } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #e6db74 } /* Literal.String.Double */
pre.pygments .tok-se { color: #ae81ff } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #e6db74 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #e6db74 } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #e6db74 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #e6db74 } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #e6db74 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #e6db74 } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #f8f8f2 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #a6e22e } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #f8f8f2 } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #f8f8f2 } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #f8f8f2 } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #f8f8f2 } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #ae81ff } /* Literal.Number.Integer.Long */</style></head><body data-spy="scroll" data-target="#toc" class="book"><header class="header"><div class="header-wrapper"><div class="container-fluid"><div class="row flex-xl-nowrap"><div class="header-logo"><div class="logo"><a href="https://docs.killbill.io"><img src="https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/img/logo.png" style="height:41px" alt="KillBill Docs"></a></div></div><div class="header-search"><div class="search-form-wrapper"><div id="docsearch" style="height: 43px; display: flex; align-items: center; width: 100%;"></div></div></div></div></div></div></header><main class="main"><div class="container-fluid"><div class="row flex-xl-nowrap"><div class="sidebar-wrapper"><aside class="sidebar"><nav class="sidebar-nav"><ul class="nav navbar-nav"><li><div class="icon-title"><div class="left-part"><a class="bd-toc-link main-link">Getting Started</a></div><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li><a class="nav-link" href="/latest/what_is_kill_bill.html">What is Kill Bill?</a></li><li><a class="nav-link" href="/latest/getting_started.html">Getting Started (Installation)</a></li><li><a class="nav-link" href="/latest/quick_start_with_kaui.html">Quick Start with Kaui</a></li><li><a class="nav-link" href="/latest/quick_start_with_kb_api.html">Quick Start with the Kill Bill API</a></li></ul></li><li><div class="icon-title"><div class="left-part"><a class="bd-toc-link main-link">Installation</a></div><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/stripe_plugin.html">Kill Bill + Stripe DIY</a></li><li><a class="nav-link" href="/latest/userguide_deployment.html">Going to Production</a></li><li><a class="nav-link" href="/latest/how-to-upgrade-the-database.html">Database Migrations</a></li><li><a class="nav-link" href="/latest/PostgreSQL.html">PostgreSQL Setup</a></li><li><a class="nav-link" href="https://github.com/killbill/killbill/releases" onclick="getOutboundLink('https://github.com/killbill/killbill/releases'); return false;">Release&nbsp;Notes</a></li></ul></li><li><div class="icon-title"><div class="left-part"><a class="bd-toc-link main-link">AWS</a></div><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/how-to-set-up-a-single-tier-system.html">Single-Tier Setup</a></li><li><a class="nav-link" href="/latest/how-to-set-up-a-multi-tier-system.html">Multi-Tier Setup</a></li><li><a class="nav-link" href="/latest/how-to-set-up-a-cloud-formation-system.html">CloudFormation Setup</a></li><li class="bd-sidenav-active"><a class="nav-link" href="/latest/how-to-maintain-a-single-tier-system.html">Single-Tier Maintenance</a></li><li><a class="nav-link" href="/latest/how-to-maintain-a-multi-tier-system.html">Multi-Tier Maintenance</a></li><li><a class="nav-link" href="/latest/how-to-maintain-a-cloud-formation-system.html">CloudFormation Maintenance</a></li></ul></li><li><div class="icon-title"><div class="left-part"><a class="bd-toc-link main-link">Manuals</a></div><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/userguide_subscription.html">Subscription&nbsp;Billing</a></li><li><a class="nav-link" href="/latest/userguide_payment.html">Payment Processing</a></li><li><a class="nav-link" href="/latest/userguide_kaui.html">Kaui, the Administrative&nbsp;UI</a></li><li><a class="nav-link" href="/latest/email-notification-plugin.html">Email Notification Plugin</a></li><li><a class="nav-link" href="/latest/custom-email-invoice-formatter.html">Custom Email Formatter</a></li><li><a class="nav-link" href="/latest/userguide_analytics.html">Analytics Plugin</a></li><li><a class="nav-link" href="/latest/userguide_configuration.html">Kill Bill&nbsp;Configuration</a></li><li><a class="nav-link" href="/latest/internationalization.html">Kill Bill&nbsp;Internationalization</a></li><li><a class="nav-link" href="/latest/migration_guide.html">Migrating to Kill Bill</a></li></ul></li><li><div class="icon-title"><div class="left-part"><a class="bd-toc-link main-link">Tutorials</a></div><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/plan_alignment.html">Plans Alignments</a></li><li><a class="nav-link" href="/latest/overdue.html">Overdue System</a></li><li><a class="nav-link" href="/latest/consumable_in_arrear.html">In Arrear UsageBilling</a></li><li><a class="nav-link" href="/latest/ha.html">Hierarchical Accounts</a></li><li><a class="nav-link" href="/latest/catalog-examples.html">Catalog Examples</a></li><li><a class="nav-link" href="/latest/invoice_examples.html">Invoice Examples</a></li><li><a class="nav-link" href="/latest/invoice_templates.html">Invoice Templates</a></li></ul></li><li><div class="icon-title"><div class="left-part"><a class="bd-toc-link main-link">Integration</a></div><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="http://killbill.github.io/slate" onclick="getOutboundLink('http://killbill.github.io/slate'); return false;">REST API Reference</a></li><li><a class="nav-link" href="/latest/swagger_documentation.html">Swagger UI Documentation</a></li><li><a class="nav-link" href="/latest/postman.html">Postman Integration</a></li><li><a class="nav-link" href="/latest/debugging.html">Debugging</a></li><li><a class="nav-link" href="/latest/push_notifications.html">Push Notifications</a></li><li><a class="nav-link" href="/latest/kill_bill_events.html">Kill Bill Events</a></li></ul></li><li><div class="icon-title"><div class="left-part"><a class="bd-toc-link main-link">Plugin Development</a></div><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/plugin_introduction.html">Plugin Introduction</a></li><li class="bd-sidenav-active"><a class="nav-link" href="/latest/plugin_development.html">Plugin Development</a></li><li class="bd-sidenav-active"><a class="nav-link" href="/latest/plugin_installation.html">Plugin Installation</a></li><li><a class="nav-link" href="/latest/plugin_use_cases.html">Special Plugin Use Cases</a></li><li><a class="nav-link" href="/latest/notification_plugin.html">Notification Plugins</a></li><li><a class="nav-link" href="/latest/payment_plugin.html">Payment Plugins</a></li><li><a class="nav-link" href="/latest/payment_control_plugin.html">Payment Control Plugins</a></li><li><a class="nav-link" href="/latest/invoice_plugin.html">Invoice Plugins</a></li><li><a class="nav-link" href="/latest/catalog_plugin.html">Catalog Plugins</a></li><li><a class="nav-link" href="/latest/entitlement_plugin.html">Entitlement Plugins</a></li></ul></li><li><div class="icon-title"><div class="left-part"><a class="bd-toc-link main-link">Operational Guides</a></div><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/deploy_to_kubernetes.html">Kubernetes (K8s) Deployment</a></li><li class="bd-sidenav-active"><a class="nav-link" href="/latest/user_management.html">Users, Roles, and Permissions</a></li><li><a class="nav-link" href="/latest/plugin_management.html">Plugin Management</a></li><li><a class="nav-link" href="/latest/aws-tools.html">AWS Analytics Tools</a></li></ul></li><li><div class="icon-title"><div class="left-part"><a class="bd-toc-link main-link">Client Libraries</a></div><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/java_client.html">Java</a></li><li><a class="nav-link" href="http://github.com/killbill/killbill-client-ruby" onclick="getOutboundLink('http://github.com/killbill/killbill-client-ruby'); return false;">Ruby</a></li><li><a class="nav-link" href="http://github.com/killbill/killbill-client-php" onclick="getOutboundLink('http://github.com/killbill/killbill-client-php'); return false;">PHP</a></li><li><a class="nav-link" href="http://github.com/killbill/killbill-client-js" onclick="getOutboundLink('http://github.com/killbill/killbill-client-js'); return false;">Node.js</a></li><li><a class="nav-link" href="http://github.com/killbill/killbill-client-python" onclick="getOutboundLink('http://github.com/killbill/killbill-client-python'); return false;">Python</a></li><li><a class="nav-link" href="http://github.com/killbill/kbcli" onclick="getOutboundLink('http://github.com/killbill/kbcli'); return false;">Go</a></li></ul></li><li><div class="icon-title"><div class="left-part"><a class="bd-toc-link main-link">About Kill Bill</a></div><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/demo.html">Demo</a></li><li><a class="nav-link" href="/latest/features.html">Features List</a></li><li><a class="nav-link" href="/latest/faq.html">Technical FAQs</a></li><li><a class="nav-link" href="/latest/Kill-Bill-Glossary.html">Glossary</a></li></ul></li><li><div class="icon-title"><div class="left-part"><a class="bd-toc-link main-link">Internal</a></div><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="/latest/internal_design.html">Internal Design</a></li><li><a class="nav-link" href="/latest/entitlement_subsystem.html">Entitlement Subsystem</a></li><li><a class="nav-link" href="/latest/invoice_subsystem.html">Invoice Subsystem</a></li><li><a class="nav-link" href="/latest/development.html">Development Environment</a></li></ul></li><li><div class="icon-title"><div class="left-part"><a class="bd-toc-link main-link">References</a></div><svg class="chevron" width="11" height="6" viewBox="0 0 11 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5024 5.70711C10.1119 6.09763 9.47871 6.09763 9.08818 5.70711L5.7953 2.41421L2.50241 5.70711C2.11188 6.09763 1.47872 6.09763 1.0882 5.70711C0.697672 5.31658 0.697672 4.68342 1.0882 4.29289L5.08819 0.292893C5.47871 -0.0976311 6.11188 -0.0976311 6.5024 0.292893L10.5024 4.29289C10.8929 4.68342 10.8929 5.31658 10.5024 5.70711Z" fill="#D1D5DB"/></svg></div><ul class="nav navbar-nav"><li class="bd-sidenav-active"><a class="nav-link" href="https://github.com/killbill/killbill-docs/tree/v3/swagger" onclick="getOutboundLink('https://github.com/killbill/killbill-docs/tree/v3/swagger'); return false;">Swagger&nbsp;API Schema</a></li><li><a class="nav-link" href="/latest/catalog.xsd">Catalog XSD Reference</a></li><li><a class="nav-link" href="/latest/overdue.xsd">Overdue XSD Reference</a></li></ul></li></ul><div class="sidebar-toggler"></div></nav><script src="https://code.jquery.com/jquery-3.6.1.min.js"></script><script>
  let $ = jQuery;
  $('.sidebar-nav .icon-title').on('click', function (e) {
    e.preventDefault();
    $('.sidebar-nav .nav.navbar-nav .nav.navbar-nav').slideUp(200);
    $('.sidebar-nav > .navbar-nav > li').removeClass('open');

    if($(this).next().is(':visible')){
      $('.sidebar-nav .nav.navbar-nav .nav.navbar-nav').slideUp(200);
      $('.sidebar-nav > .navbar-nav > li').removeClass('open');
    } else {
      $(this).parent().addClass('open');
      $(this).next().slideDown(200);
    }
  });

  let pageURL = $(location).attr("href");
  $('.nav-link').each(function() {
    if (pageURL.includes($(this).attr('href'))) {
      $(this).parent().addClass('list-item-active');
      $(this).parent().parent().addClass('active-list');
      $(this).parent().parent().prev().addClass('bd-link-active-wrap');
    }
  });
</script><a class="doclink" href="mailto:support@killbill.io">Report a doc problem</a></aside></div><div class="main-wrapper"><article class="content-wrapper"><div class="banner"><div class="bg-image"><svg class="absolute-figure circle1" width="41" height="38" viewBox="0 0 41 38" fill="none" xmlns="http://www.w3.org/2000/svg">
  <ellipse cx="12.5" cy="10.5" rx="28.5" ry="27.5" fill="white" fill-opacity="0.2"/>
</svg>
<svg class="absolute-figure circle2" width="20" height="19" viewBox="0 0 20 19" fill="none" xmlns="http://www.w3.org/2000/svg">
  <ellipse cx="10" cy="9.5" rx="10" ry="9.5" fill="white" fill-opacity="0.2"/>
</svg>
<svg class="absolute-figure circle3" width="97" height="97" viewBox="0 0 97 97" fill="none" xmlns="http://www.w3.org/2000/svg">
  <circle cx="48.5" cy="48.5" r="48.5" fill="white" fill-opacity="0.4"/>
</svg>
<svg class="absolute-figure circle4" width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
  <circle cx="7" cy="7" r="7" fill="white" fill-opacity="0.2"/>
</svg>
<svg class="absolute-figure circle5" width="65" height="23" viewBox="0 0 65 23" fill="none" xmlns="http://www.w3.org/2000/svg">
  <circle cx="32.5" cy="-9.5" r="32.5" fill="white" fill-opacity="0.2"/>
</svg>
<svg class="absolute-figure circle6" width="48" height="31" viewBox="0 0 48 31" fill="none" xmlns="http://www.w3.org/2000/svg">
  <circle cx="24" cy="24" r="24" fill="white" fill-opacity="0.2"/>
</svg>
<svg class="absolute-figure circle7" width="20" height="19" viewBox="0 0 20 19" fill="none" xmlns="http://www.w3.org/2000/svg">
  <ellipse cx="10" cy="9.5" rx="10" ry="9.5" fill="white" fill-opacity="0.2"/>
</svg>
<svg class="absolute-figure circle8" width="20" height="10" viewBox="0 0 20 10" fill="none" xmlns="http://www.w3.org/2000/svg">
  <ellipse cx="10" cy="9.5" rx="10" ry="9.5" fill="white" fill-opacity="0.2"/>
</svg>
<svg class="absolute-figure circle9" width="49" height="48" viewBox="0 0 49 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <circle cx="48.5" cy="48.5" r="48.5" fill="white" fill-opacity="0.2"/>
</svg>
<svg class="absolute-figure abstract-figure" width="703" height="174" viewBox="0 0 703 174" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M25.5 246C-96 87.7673 245.949 67.3215 475.548 64.1799C705.146 61.0384 565.01 -188.501 629.653 -188.741C694.297 -188.982 766.062 221.014 766.062 221.014L297.072 460.733C297.072 460.733 147 404.233 25.5 246Z" fill="white" fill-opacity="0.2"/>
</svg></div><h1>Invoice subsystem</h1></div><div id="content"><div id="preamble"><div class="sectionbody"><div class="paragraph"><p>Driven by the entitlement and subscription modules, along with the catalog configuration, the invoice subsystem is core to Kill Bill. This manual will walk you through a couple of use-cases, to help you understand how it works under the covers and how to make sense of the data on disk.</p></div></div></div>
<div class="sect1"><h2 id="_overview">Overview</h2><div class="sectionbody"><div class="paragraph"><p>Before we dig into examples, let&#8217;s review some of the characteristics of the invoicing algorithm. The first thing to recall is that there are different ways to invoice customers and this is specified inside the catalog configuration. For the sake of simplicity we will discard usage-billing altogether here and focus on recurring subscriptions (along with fixed-term charges).</p></div>
<div class="paragraph"><p>Invoicing for recurring subscriptions also comes in two different fashions, or so called <code>billing modes</code>. Such a mode is defined at the <code>Plan</code> level-- with a possible default at the catalog level&#8201;&#8212;&#8201;and there are 2 options:</p></div>
<div class="ulist"><ul><li><p><code>IN_ADVANCE</code>: In such a configuration, each recurring subscription is charged at the begining of the period (in advance), and as a consequence, this can lead to pro-ration credits upon certain cancellation or change of <code>Plan</code> (special policies can be configured to make the system generate or not such pro-ration credits).</p></li><li><p><code>IN_ARREAR</code>: In such a configuration, each recurring subscription is charged at the end of the period (in arrear), and as a consequence there is never any pro-ration credit generated because the system always know what to bill for (things can&#8217;t change back in time).</p></li></ul></div>
<div class="paragraph"><p>In the rest of this documentation, <strong>we will assume an <code>IN_ADVANCE</code> billing mode</strong> because this is the most common and most complex to deal with.</p></div>
<div class="paragraph"><p>Let&#8217;s revisit some of the terminology:</p></div>
<div class="ulist"><ul><li><p><code>chargedThroughDate</code> or <code>CTD</code>: We call <code>chargedThroughDate</code> the last day of the recurring period associated with a given subscription that has been charged for; there is one such date for each subscription in the system.</p></li><li><p><code>targetDate</code>: We call <code>targetDate</code> the date up to which we want the invoiving system to bill for. Let&#8217;s assume a monthly subscription and a current date of <code>2012-05-01</code> (which corresponds to our <code>PHASE</code> event in our example below), and let&#8217;s look at the impact of the <code>targetDate</code>:</p><div class="ulist"><ul><li><p><code>targetDate</code> &lt; <code>2012-05-01</code> : Nothing happens</p></li><li><p><code>2012-05-01</code> &#8656; <code>targetDate</code> &lt;  <code>2012-06-01</code> : System would bill for period [2012-05-01, 2012-06-01), and  CTD = <code>2012-06-01</code></p></li><li><p><code>2012-06-01</code> &#8656; <code>targetDate</code> &lt;  <code>2012-07-01</code> : System would bill for period [2012-05-01, 2012-06-01) and [2012-06-01, 2012-07-01)  and  CTD = <code>2012-07-01</code></p></li></ul></div></li></ul></div>
<div class="paragraph"><p>Kill Bill always invoice at the account level, meaning each time an invoice is being generated, this is for a given Kill Bill <code>Account</code> (matching a given customer) and so the resulting invoice will include potentially different items matching different subscriptions associated with this particular account. In the most normal case, invoices are generated by reacting to specific events and we 'll see examples below of the system reacting to specific bus events or (future) notifications.</p></div></div></div>
<div class="sect1"><h2 id="_initial_subscription_creation">Initial subscription creation</h2><div class="sectionbody"><div class="paragraph"><p>Let&#8217;s assume a new user subscribes to the shotgun-monthly plan on 2012-04-01.</p></div>
<div class="paragraph"><p>The plan is defined as follows:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="xml"><span></span><span class="tok-nt">&lt;plan</span> <span class="tok-na">name=</span><span class="tok-s">&quot;shotgun-monthly&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;product&gt;</span>Shotgun<span class="tok-nt">&lt;/product&gt;</span>
    <span class="tok-nt">&lt;initialPhases&gt;</span>
        <span class="tok-nt">&lt;phase</span> <span class="tok-na">type=</span><span class="tok-s">&quot;TRIAL&quot;</span><span class="tok-nt">&gt;</span>
            <span class="tok-nt">&lt;duration&gt;</span>
                <span class="tok-nt">&lt;unit&gt;</span>DAYS<span class="tok-nt">&lt;/unit&gt;</span>
                <span class="tok-nt">&lt;number&gt;</span>30<span class="tok-nt">&lt;/number&gt;</span>
            <span class="tok-nt">&lt;/duration&gt;</span>
        <span class="tok-nt">&lt;/phase&gt;</span>
    <span class="tok-nt">&lt;/initialPhases&gt;</span>
    <span class="tok-nt">&lt;finalPhase</span> <span class="tok-na">type=</span><span class="tok-s">&quot;EVERGREEN&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;duration&gt;</span>
            <span class="tok-nt">&lt;unit&gt;</span>UNLIMITED<span class="tok-nt">&lt;/unit&gt;</span>
            <span class="tok-nt">&lt;number&gt;</span>-1<span class="tok-nt">&lt;/number&gt;</span>
        <span class="tok-nt">&lt;/duration&gt;</span>
        <span class="tok-nt">&lt;recurring&gt;</span>
            <span class="tok-nt">&lt;billingPeriod&gt;</span>MONTHLY<span class="tok-nt">&lt;/billingPeriod&gt;</span>
            <span class="tok-nt">&lt;recurringPrice&gt;</span>
                <span class="tok-nt">&lt;price&gt;</span>
                    <span class="tok-nt">&lt;currency&gt;</span>USD<span class="tok-nt">&lt;/currency&gt;</span>
                    <span class="tok-nt">&lt;value&gt;</span>249.95<span class="tok-nt">&lt;/value&gt;</span>
                <span class="tok-nt">&lt;/price&gt;</span>
            <span class="tok-nt">&lt;/recurringPrice&gt;</span>
        <span class="tok-nt">&lt;/recurring&gt;</span>
    <span class="tok-nt">&lt;/finalPhase&gt;</span>
<span class="tok-nt">&lt;/plan&gt;</span></code></pre></div></div>
<div class="paragraph"><p>Upon subscription creation, a new entry is added to the <code>bundles</code> and <code>subscriptions</code> tables, which look like this:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="mysql"><span></span><span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">bundles</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
            <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
                   <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">a7a1370e</span><span class="tok-o">-</span><span class="tok-n">1fa4</span><span class="tok-o">-</span><span class="tok-n">4c32</span><span class="tok-o">-</span><span class="tok-n">abd5</span><span class="tok-o">-</span><span class="tok-mf">223e1</span><span class="tok-n">da97339</span>
         <span class="tok-n">external_key</span><span class="tok-o">:</span> <span class="tok-n">externalKey</span>
           <span class="tok-n">account_id</span><span class="tok-o">:</span> <span class="tok-mf">8e4</span><span class="tok-n">f353f</span><span class="tok-o">-</span><span class="tok-n">ddbb</span><span class="tok-o">-</span><span class="tok-mi">4155</span><span class="tok-o">-</span><span class="tok-n">b52d</span><span class="tok-o">-</span><span class="tok-n">9fe77b8e96e3</span>
 <span class="tok-n">last_sys_update_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">15</span>
<span class="tok-n">original_created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">14</span>
           <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">website</span><span class="tok-o">-</span><span class="tok-n">through</span><span class="tok-o">-</span><span class="tok-n">http</span><span class="tok-o">-</span><span class="tok-k">client</span>
         <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">14</span>
           <span class="tok-n">updated_by</span><span class="tok-o">:</span> <span class="tok-n">SubscriptionBaseTransition</span>
         <span class="tok-n">updated_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">15</span>
    <span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
     <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">1</span> <span class="tok-k">row</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span>

<span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">subscriptions</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
           <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
                  <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">d9c7bb57</span><span class="tok-o">-</span><span class="tok-mf">675e-4419</span><span class="tok-o">-</span><span class="tok-n">a340</span><span class="tok-o">-</span><span class="tok-n">5f6b4fd612f4</span>
           <span class="tok-n">bundle_id</span><span class="tok-o">:</span> <span class="tok-n">a7a1370e</span><span class="tok-o">-</span><span class="tok-n">1fa4</span><span class="tok-o">-</span><span class="tok-n">4c32</span><span class="tok-o">-</span><span class="tok-n">abd5</span><span class="tok-o">-</span><span class="tok-mf">223e1</span><span class="tok-n">da97339</span>
            <span class="tok-n">category</span><span class="tok-o">:</span> <span class="tok-n">BASE</span>
          <span class="tok-n">start_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">14</span>
   <span class="tok-n">bundle_start_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">14</span>
<span class="tok-n">charged_through_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">00</span>
            <span class="tok-n">migrated</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
          <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">website</span><span class="tok-o">-</span><span class="tok-n">through</span><span class="tok-o">-</span><span class="tok-n">http</span><span class="tok-o">-</span><span class="tok-k">client</span>
        <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">15</span>
          <span class="tok-n">updated_by</span><span class="tok-o">:</span> <span class="tok-n">SubscriptionBaseTransition</span>
        <span class="tok-n">updated_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">15</span>
   <span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
    <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">1</span> <span class="tok-k">row</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Associated with the subscription are a couple of subscription events, one <code>CREATE</code> marking the beginning of the subscription at the effective date <code>2012-04-01 00:01:14</code> and one <code>PHASE</code> event marking the date at which the <code>EVERGREEN</code> phase starts:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="mysql"><span></span><span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">subscription_events</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
              <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
                     <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">55d5cc5e</span><span class="tok-o">-</span><span class="tok-n">2c58</span><span class="tok-o">-</span><span class="tok-mi">4560</span><span class="tok-o">-</span><span class="tok-mi">9042</span><span class="tok-o">-</span><span class="tok-n">f3c7115d6ccd</span>
             <span class="tok-n">event_type</span><span class="tok-o">:</span> <span class="tok-n">API_USER</span>
              <span class="tok-n">user_type</span><span class="tok-o">:</span> <span class="tok-k">CREATE</span>
         <span class="tok-n">effective_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">14</span>
        <span class="tok-n">subscription_id</span><span class="tok-o">:</span> <span class="tok-n">d9c7bb57</span><span class="tok-o">-</span><span class="tok-mf">675e-4419</span><span class="tok-o">-</span><span class="tok-n">a340</span><span class="tok-o">-</span><span class="tok-n">5f6b4fd612f4</span>
              <span class="tok-n">plan_name</span><span class="tok-o">:</span> <span class="tok-n">shotgun</span><span class="tok-o">-</span><span class="tok-n">monthly</span>
             <span class="tok-n">phase_name</span><span class="tok-o">:</span> <span class="tok-n">shotgun</span><span class="tok-o">-</span><span class="tok-n">monthly</span><span class="tok-o">-</span><span class="tok-n">trial</span>
        <span class="tok-n">price_list_name</span><span class="tok-o">:</span> <span class="tok-k">DEFAULT</span>
<span class="tok-n">billing_cycle_day_local</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
              <span class="tok-n">is_active</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
             <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">website</span><span class="tok-o">-</span><span class="tok-n">through</span><span class="tok-o">-</span><span class="tok-n">http</span><span class="tok-o">-</span><span class="tok-k">client</span>
           <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">15</span>
             <span class="tok-n">updated_by</span><span class="tok-o">:</span> <span class="tok-n">website</span><span class="tok-o">-</span><span class="tok-n">through</span><span class="tok-o">-</span><span class="tok-n">http</span><span class="tok-o">-</span><span class="tok-k">client</span>
           <span class="tok-n">updated_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">15</span>
      <span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
       <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-o">***************************</span> <span class="tok-mf">2.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
              <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">2</span>
                     <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">8751c48e</span><span class="tok-o">-</span><span class="tok-n">686b</span><span class="tok-o">-</span><span class="tok-n">4eea</span><span class="tok-o">-</span><span class="tok-n">b959</span><span class="tok-o">-</span><span class="tok-mf">52676e1</span><span class="tok-n">bb9da</span>
             <span class="tok-n">event_type</span><span class="tok-o">:</span> <span class="tok-k">PHASE</span>
              <span class="tok-n">user_type</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
         <span class="tok-n">effective_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">14</span>
        <span class="tok-n">subscription_id</span><span class="tok-o">:</span> <span class="tok-n">d9c7bb57</span><span class="tok-o">-</span><span class="tok-mf">675e-4419</span><span class="tok-o">-</span><span class="tok-n">a340</span><span class="tok-o">-</span><span class="tok-n">5f6b4fd612f4</span>
              <span class="tok-n">plan_name</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
             <span class="tok-n">phase_name</span><span class="tok-o">:</span> <span class="tok-n">shotgun</span><span class="tok-o">-</span><span class="tok-n">monthly</span><span class="tok-o">-</span><span class="tok-n">evergreen</span>
        <span class="tok-n">price_list_name</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
<span class="tok-n">billing_cycle_day_local</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
              <span class="tok-n">is_active</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
             <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">website</span><span class="tok-o">-</span><span class="tok-n">through</span><span class="tok-o">-</span><span class="tok-n">http</span><span class="tok-o">-</span><span class="tok-k">client</span>
           <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">15</span>
             <span class="tok-n">updated_by</span><span class="tok-o">:</span> <span class="tok-n">website</span><span class="tok-o">-</span><span class="tok-n">through</span><span class="tok-o">-</span><span class="tok-n">http</span><span class="tok-o">-</span><span class="tok-k">client</span>
           <span class="tok-n">updated_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">15</span>
      <span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
       <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">2</span> <span class="tok-k">rows</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>The subscription service has also recorded a future notification effective when the <code>EVERGREEN</code> phase starts:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="mysql"><span></span><span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">notifications</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
                <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
               <span class="tok-n">class_name</span><span class="tok-o">:</span> <span class="tok-n">org</span><span class="tok-p">.</span><span class="tok-n">killbill</span><span class="tok-p">.</span><span class="tok-n">billing</span><span class="tok-p">.</span><span class="tok-n">subscription</span><span class="tok-p">.</span><span class="tok-k">engine</span><span class="tok-p">.</span><span class="tok-n">core</span><span class="tok-p">.</span><span class="tok-n">SubscriptionNotificationKey</span>
               <span class="tok-n">event_json</span><span class="tok-o">:</span> <span class="tok-err">{</span><span class="tok-s2">&quot;eventId&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;8751c48e-686b-4eea-b959-52676e1bb9da&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;seqId&quot;</span><span class="tok-o">:</span><span class="tok-mi">0</span><span class="tok-err">}</span>
               <span class="tok-n">user_token</span><span class="tok-o">:</span> <span class="tok-n">f291917d</span><span class="tok-o">-</span><span class="tok-n">ce03</span><span class="tok-o">-</span><span class="tok-n">428f</span><span class="tok-o">-</span><span class="tok-mf">9e58</span><span class="tok-o">-</span><span class="tok-n">e538db057d37</span>
             <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">15</span>
           <span class="tok-n">creating_owner</span><span class="tok-o">:</span> <span class="tok-mf">127.0.0.1</span>
         <span class="tok-n">processing_owner</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
<span class="tok-n">processing_available_date</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
         <span class="tok-n">processing_state</span><span class="tok-o">:</span> <span class="tok-n">AVAILABLE</span>
              <span class="tok-n">error_count</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
              <span class="tok-n">search_key1</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
              <span class="tok-n">search_key2</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
               <span class="tok-n">queue_name</span><span class="tok-o">:</span> <span class="tok-n">subscription</span><span class="tok-o">-</span><span class="tok-n">service</span><span class="tok-o">:</span><span class="tok-n">subscription</span><span class="tok-o">-</span><span class="tok-k">events</span>
           <span class="tok-n">effective_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">14</span>
        <span class="tok-n">future_user_token</span><span class="tok-o">:</span> <span class="tok-n">892a1fdf</span><span class="tok-o">-</span><span class="tok-n">45b5</span><span class="tok-o">-</span><span class="tok-n">404d</span><span class="tok-o">-</span><span class="tok-n">a492</span><span class="tok-o">-</span><span class="tok-n">99f612ba8b55</span>
<span class="tok-mi">1</span> <span class="tok-k">row</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>The entitlement subsystem has also a record of the start of the entitlement, in the <code>blocking_states</code> table (on older Kill Bill versions, this was not present so you could still see some data were this is missing and this is fine, the system knows how to handle this case):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="mysql"><span></span><span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">blocking_states</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
        <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
               <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">18696a69</span><span class="tok-o">-</span><span class="tok-n">bcb0</span><span class="tok-o">-</span><span class="tok-n">40c4</span><span class="tok-o">-</span><span class="tok-n">98b5</span><span class="tok-o">-</span><span class="tok-n">9c13bc00307e</span>
     <span class="tok-n">blockable_id</span><span class="tok-o">:</span> <span class="tok-n">d9c7bb57</span><span class="tok-o">-</span><span class="tok-mf">675e-4419</span><span class="tok-o">-</span><span class="tok-n">a340</span><span class="tok-o">-</span><span class="tok-n">5f6b4fd612f4</span>
             <span class="tok-k">type</span><span class="tok-o">:</span> <span class="tok-n">SUBSCRIPTION</span>
            <span class="tok-n">state</span><span class="tok-o">:</span> <span class="tok-n">ENT_STARTED</span>
          <span class="tok-n">service</span><span class="tok-o">:</span> <span class="tok-n">entitlement</span><span class="tok-o">-</span><span class="tok-n">service</span>
     <span class="tok-n">block_change</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-n">block_entitlement</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
    <span class="tok-n">block_billing</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
   <span class="tok-n">effective_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">15</span>
        <span class="tok-n">is_active</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
     <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">14</span>
       <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">website</span><span class="tok-o">-</span><span class="tok-n">through</span><span class="tok-o">-</span><span class="tok-n">http</span><span class="tok-o">-</span><span class="tok-k">client</span>
     <span class="tok-n">updated_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">14</span>
       <span class="tok-n">updated_by</span><span class="tok-o">:</span> <span class="tok-n">website</span><span class="tok-o">-</span><span class="tok-n">through</span><span class="tok-o">-</span><span class="tok-n">http</span><span class="tok-o">-</span><span class="tok-k">client</span>
<span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
 <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">1</span> <span class="tok-k">row</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Upon subscription creation, a bus event is triggered and caught by the invoicing subsystem, which invoices the account with a target date of 2012-04-01. To do so, it computes the billing events from these subscription events and blocking states (they are effectively markers between billable periods). In our case, these billing events are:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-n">DefaultBillingEvent</span><span class="tok-p">{</span><span class="tok-n">type</span><span class="tok-o">=</span><span class="tok-n">CREATE</span><span class="tok-p">,</span> <span class="tok-n">effectiveDate</span><span class="tok-o">=</span><span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mo">04</span><span class="tok-o">-</span><span class="tok-mo">01</span><span class="tok-n">T00</span><span class="tok-p">:</span><span class="tok-mo">01</span><span class="tok-p">:</span><span class="tok-mf">14.000</span><span class="tok-n">Z</span><span class="tok-p">,</span> <span class="tok-n">planPhaseName</span><span class="tok-o">=</span><span class="tok-n">shotgun</span><span class="tok-o">-</span><span class="tok-n">monthly</span><span class="tok-o">-</span><span class="tok-n">trial</span><span class="tok-p">,</span> <span class="tok-n">subscriptionId</span><span class="tok-o">=</span><span class="tok-n">d9c7bb57</span><span class="tok-o">-</span><span class="tok-mi">675</span><span class="tok-n">e</span><span class="tok-o">-</span><span class="tok-mi">4419</span><span class="tok-o">-</span><span class="tok-n">a340</span><span class="tok-o">-</span><span class="tok-mf">5f</span><span class="tok-mi">6</span><span class="tok-n">b4fd612f4</span><span class="tok-p">,</span> <span class="tok-n">totalOrdering</span><span class="tok-o">=</span><span class="tok-mi">1</span><span class="tok-p">}</span>
<span class="tok-n">DefaultBillingEvent</span><span class="tok-p">{</span><span class="tok-n">type</span><span class="tok-o">=</span><span class="tok-n">PHASE</span><span class="tok-p">,</span> <span class="tok-n">effectiveDate</span><span class="tok-o">=</span><span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mo">05</span><span class="tok-o">-</span><span class="tok-mo">01</span><span class="tok-n">T00</span><span class="tok-p">:</span><span class="tok-mo">01</span><span class="tok-p">:</span><span class="tok-mf">14.000</span><span class="tok-n">Z</span><span class="tok-p">,</span> <span class="tok-n">planPhaseName</span><span class="tok-o">=</span><span class="tok-n">shotgun</span><span class="tok-o">-</span><span class="tok-n">monthly</span><span class="tok-o">-</span><span class="tok-n">evergreen</span><span class="tok-p">,</span> <span class="tok-n">subscriptionId</span><span class="tok-o">=</span><span class="tok-n">d9c7bb57</span><span class="tok-o">-</span><span class="tok-mi">675</span><span class="tok-n">e</span><span class="tok-o">-</span><span class="tok-mi">4419</span><span class="tok-o">-</span><span class="tok-n">a340</span><span class="tok-o">-</span><span class="tok-mf">5f</span><span class="tok-mi">6</span><span class="tok-n">b4fd612f4</span><span class="tok-p">,</span> <span class="tok-n">totalOrdering</span><span class="tok-o">=</span><span class="tok-mi">2</span><span class="tok-p">}</span></code></pre></div></div>
<div class="paragraph"><p>The target date being 2012-04-01, only the first one matters. Based on the catalog configuration, the following invoice and invoice item are generated (an invoice has always 1 or more invoice items associated with it):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="mysql"><span></span><span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">invoices</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
        <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
               <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">5c6369d2</span><span class="tok-o">-</span><span class="tok-n">cd18</span><span class="tok-o">-</span><span class="tok-n">489f</span><span class="tok-o">-</span><span class="tok-n">9fe5</span><span class="tok-o">-</span><span class="tok-mf">748e72</span><span class="tok-n">f9938e</span>
       <span class="tok-n">account_id</span><span class="tok-o">:</span> <span class="tok-mf">8e4</span><span class="tok-n">f353f</span><span class="tok-o">-</span><span class="tok-n">ddbb</span><span class="tok-o">-</span><span class="tok-mi">4155</span><span class="tok-o">-</span><span class="tok-n">b52d</span><span class="tok-o">-</span><span class="tok-n">9fe77b8e96e3</span>
     <span class="tok-n">invoice_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span>
      <span class="tok-n">target_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span>
         <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
           <span class="tok-k">status</span><span class="tok-o">:</span> <span class="tok-k">COMMITTED</span>
         <span class="tok-n">migrated</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
   <span class="tok-n">parent_invoice</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
       <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">SubscriptionBaseTransition</span>
     <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">15</span>
<span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
 <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">1</span> <span class="tok-k">row</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span>

<span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">invoice_items</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
        <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
               <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-mi">19667140</span><span class="tok-o">-</span><span class="tok-n">fa16</span><span class="tok-o">-</span><span class="tok-mf">48e0</span><span class="tok-o">-</span><span class="tok-n">b04e</span><span class="tok-o">-</span><span class="tok-n">579b9972f612</span>
             <span class="tok-k">type</span><span class="tok-o">:</span> <span class="tok-kt">FIXED</span>
       <span class="tok-n">invoice_id</span><span class="tok-o">:</span> <span class="tok-n">5c6369d2</span><span class="tok-o">-</span><span class="tok-n">cd18</span><span class="tok-o">-</span><span class="tok-n">489f</span><span class="tok-o">-</span><span class="tok-n">9fe5</span><span class="tok-o">-</span><span class="tok-mf">748e72</span><span class="tok-n">f9938e</span>
       <span class="tok-n">account_id</span><span class="tok-o">:</span> <span class="tok-mf">8e4</span><span class="tok-n">f353f</span><span class="tok-o">-</span><span class="tok-n">ddbb</span><span class="tok-o">-</span><span class="tok-mi">4155</span><span class="tok-o">-</span><span class="tok-n">b52d</span><span class="tok-o">-</span><span class="tok-n">9fe77b8e96e3</span>
 <span class="tok-n">child_account_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
        <span class="tok-n">bundle_id</span><span class="tok-o">:</span> <span class="tok-n">a7a1370e</span><span class="tok-o">-</span><span class="tok-n">1fa4</span><span class="tok-o">-</span><span class="tok-n">4c32</span><span class="tok-o">-</span><span class="tok-n">abd5</span><span class="tok-o">-</span><span class="tok-mf">223e1</span><span class="tok-n">da97339</span>
  <span class="tok-n">subscription_id</span><span class="tok-o">:</span> <span class="tok-n">d9c7bb57</span><span class="tok-o">-</span><span class="tok-mf">675e-4419</span><span class="tok-o">-</span><span class="tok-n">a340</span><span class="tok-o">-</span><span class="tok-n">5f6b4fd612f4</span>
      <span class="tok-k">description</span><span class="tok-o">:</span> <span class="tok-n">shotgun</span><span class="tok-o">-</span><span class="tok-n">monthly</span><span class="tok-o">-</span><span class="tok-n">trial</span>
        <span class="tok-n">plan_name</span><span class="tok-o">:</span> <span class="tok-n">shotgun</span><span class="tok-o">-</span><span class="tok-n">monthly</span>
       <span class="tok-n">phase_name</span><span class="tok-o">:</span> <span class="tok-n">shotgun</span><span class="tok-o">-</span><span class="tok-n">monthly</span><span class="tok-o">-</span><span class="tok-n">trial</span>
       <span class="tok-n">usage_name</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">start_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span>
         <span class="tok-n">end_date</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
           <span class="tok-n">amount</span><span class="tok-o">:</span> <span class="tok-mf">0.000000000</span>
             <span class="tok-n">rate</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
         <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
   <span class="tok-n">linked_item_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">SubscriptionBaseTransition</span>
     <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">15</span>
<span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
 <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span></code></pre></div></div>
<div class="paragraph"><p>There is only a single <code>FIXED</code> item with a start date of 2012-04-01.</p></div>
<div class="paragraph"><p>Upon invoice generation, an event is triggered and caught by the payment subsystem, which triggers a payment for that invoice (using the default payment method on the account).</p></div>
<div class="paragraph"><p>What happens is that the payment subsystem calls the <code>createPurchaseWithPaymentControl</code> API and specifies <code><em>INVOICE_PAYMENT_CONTROL_PLUGIN</em></code> as the control plugin to use (you can add your own via the system property <code>org.killbill.payment.invoice.plugin</code>). This plugin is responsible to compute the payment amount (typically the invoice balance) and to insert a row in the <code>invoice_payments</code> table (<code>success</code> is first set to false, to implement a two-phase commit strategy). The payment is then delegated to the payment system (a payment and/or a transaction are recorded if necessary). Upon success, the entry is updated with the metadata from the payment (the plugin could have decided to pay less than the requested amount for example) and the success flag is set to <code>true</code>. In case of failure, <code>success</code> would remain set to false and the next payment retry date would be computed, based on the system configuration.</p></div>
<div class="paragraph"><p>While the link between invoice and payments is encapsulated in the <code>invoice_payments</code> table, there is one level of indirection with the <code>payments</code> table through the <code>payment_attempts</code> table, to manage aborted payments and retries:</p></div>
<div class="ulist"><ul><li><p>Aborted payments: In a situation where the invoice was already paid (or there is a $0 balance), the invoice control plugin would abort the payment. In such situations, we would end up with a row in the <code>payment_attempts</code> table with an <code>ABORTED</code> state and no row in the <code>invoice_payments</code>, <code>payments</code> and <code>payment_transactions</code> tables.</p></li><li><p>Payment Retries: In a situation where we see a payment failure (e.g. insufficient funds), a payment will be associated with multiple transactions (all sharing the same transaction external key and typically in a <code>PAYMENT_FAILURE</code> status). Each of these transactions will be associated with an attempt in a <code>RETRIED</code> state.</p></li></ul></div>
<div class="paragraph"><p>Note also that the <code>payment_attempts</code> entry is linked to the invoice via the plugin property <code>IPCD_INVOICE_ID</code> (which points to the invoice id).</p></div>
<div class="paragraph"><p>In our scenario, no payment was actually processed, since the invoice amount is zero (trial). Hence the <code>ABORTED</code> state:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="mysql"><span></span><span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">payment_attempts</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
               <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
                      <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">16f869b1</span><span class="tok-o">-</span><span class="tok-n">c5c9</span><span class="tok-o">-</span><span class="tok-n">41ed</span><span class="tok-o">-</span><span class="tok-n">a776</span><span class="tok-o">-</span><span class="tok-n">87f3ce4e5bb5</span>
              <span class="tok-n">account_id</span><span class="tok-o">:</span> <span class="tok-mf">8e4</span><span class="tok-n">f353f</span><span class="tok-o">-</span><span class="tok-n">ddbb</span><span class="tok-o">-</span><span class="tok-mi">4155</span><span class="tok-o">-</span><span class="tok-n">b52d</span><span class="tok-o">-</span><span class="tok-n">9fe77b8e96e3</span>
       <span class="tok-n">payment_method_id</span><span class="tok-o">:</span> <span class="tok-n">c046e5be</span><span class="tok-o">-</span><span class="tok-n">e632</span><span class="tok-o">-</span><span class="tok-n">444a</span><span class="tok-o">-</span><span class="tok-n">905f</span><span class="tok-o">-</span><span class="tok-n">c4bc0c5c0086</span>
    <span class="tok-n">payment_external_key</span><span class="tok-o">:</span> <span class="tok-n">6bd135f7</span><span class="tok-o">-</span><span class="tok-n">8a7d</span><span class="tok-o">-</span><span class="tok-mi">4448</span><span class="tok-o">-</span><span class="tok-n">9ce9</span><span class="tok-o">-</span><span class="tok-n">3889055af9e3</span>
          <span class="tok-n">transaction_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
<span class="tok-n">transaction_external_key</span><span class="tok-o">:</span> <span class="tok-n">ae53501e</span><span class="tok-o">-</span><span class="tok-n">c9dd</span><span class="tok-o">-</span><span class="tok-mf">45e3</span><span class="tok-o">-</span><span class="tok-n">8ec6</span><span class="tok-o">-</span><span class="tok-n">78da4e9f8d99</span>
        <span class="tok-n">transaction_type</span><span class="tok-o">:</span> <span class="tok-n">PURCHASE</span>
              <span class="tok-n">state_name</span><span class="tok-o">:</span> <span class="tok-n">ABORTED</span>
                  <span class="tok-n">amount</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
                <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
             <span class="tok-n">plugin_name</span><span class="tok-o">:</span> <span class="tok-n">__INVOICE_PAYMENT_CONTROL_PLUGIN__</span>
       <span class="tok-n">plugin_properties</span><span class="tok-o">:</span> <span class="tok-n">ZV</span>  <span class="tok-o">&lt;</span><span class="tok-err">[{</span><span class="tok-s2">&quot;IPCD_INVOICE_ID&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;5c6369d2-cd18-489f-9fe5-748e72f9938e&quot;</span><span class="tok-err">}]</span>
              <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">PaymentRequestProcessor</span>
            <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">15</span>
              <span class="tok-n">updated_by</span><span class="tok-o">:</span> <span class="tok-n">PaymentRequestProcessor</span>
            <span class="tok-n">updated_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">15</span>
       <span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
        <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">1</span> <span class="tok-k">row</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span>

<span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">invoice_payments</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-k">Empty</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span>

<span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">payments</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-k">Empty</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Note: if the payment didn&#8217;t go through because a custom payment control plugin aborted the payment (after the built-in <code><em>INVOICE_PAYMENT_CONTROL_PLUGIN</em></code>), there would be a row in <code>invoice_payments</code> (with the <code>success</code> flag set to false and a <code>NULL</code> <code>payment_id</code>) and a corresponding <code>ABORTED</code> row in <code>payment_attempts</code>.</p></div>
<div class="paragraph"><p>See below for an example of an actual payment and what would happen in case of payment failures.</p></div>
<div class="sect2"><h3 id="_reference_time_and_fixed_offset_timezone">Reference time and fixed offset timezone</h3><div class="paragraph"><p>Each account in Kill Bill has a reference time associated with it. It is the <code>reference_time</code> value associated with the <code>accounts</code> row (specified at account creation time, default value is the <code>created_date</code>). Additionally, it is associated with a fixed offset timezone, a special timezone used by the system for dates manipulation which ignores changes like DST (you cannot change it either). This timezone depends on the account timezone (UTC if none specified) and if DST was in effect at the reference time (this lets us handle gracefully DST gaps throughout the year with respect to invoicing, handling subscription changes, etc.).</p></div>
<div class="paragraph"><p>For example, if the account timezone is America/Los_Angeles and the reference time is 2015-03-07T10:00:01.000Z, DST was not in effect and the fixed offset timezone is -08:00. If the reference time however is 2015-03-08T10:00:01.000Z, DST was in effect and the fixed offset timezone is -07:00.</p></div>
<div class="paragraph"><p>While most subsystems (entitlement, subscription, etc.) work at the time level (i.e. you could have several upgrades during the day), invoicing works at the day boundary level (Kill Bill doesn&#8217;t invoice for granularities smaller than a day). Both of these parameters help us convert <code>LocalDate</code> (i.e. a specify day in a year, like 2012-04-01) to a <code>DateTime</code> (i.e. a specific point in time, in a specific timezone), and vice versa. The former conversion is required for instance when computing the next notification time (based on the invoice item end date for instance). The latter can happen during invoice generation, when transforming a <code>BillingEvent</code> effective <code>DateTime</code> to a <code>LocalDate</code> for the invoice item (service period).</p></div>
<div class="paragraph"><p>A nice side effect of using this fixed reference time is that most system-driven operations will always happen at the same time during the day for a given account. It also helps spreading the load on the system since the distribution of these reference times should be uniform.</p></div></div></div></div>
<div class="sect1"><h2 id="_phase_transition">Phase transition</h2><div class="sectionbody"><div class="paragraph"><p>Let&#8217;s fast forward the time to 2012-05-02.</p></div>
<div class="paragraph"><p>The notification for the phase event is processed by the subscription subsystem. There is nothing to be done in that case (in other scenarios, add-ons may need to be cancelled or a future phase event may need to be computed): it simply sends a message on the bus letting the system know about the phase transition.</p></div>
<div class="paragraph"><p>The invoicing subsystem picks it up and re-compute the billing events:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code><span></span>DefaultBillingEvent{type=CREATE, effectiveDate=2012-04-01T00:01:14.000Z, planPhaseName=shotgun-monthly-trial, subscriptionId=d9c7bb57-675e-4419-a340-5f6b4fd612f4, totalOrdering=1}
DefaultBillingEvent{type=PHASE, effectiveDate=2012-05-01T00:01:14.000Z, planPhaseName=shotgun-monthly-evergreen, subscriptionId=d9c7bb57-675e-4419-a340-5f6b4fd612f4, totalOrdering=2}</code></pre></div></div>
<div class="paragraph"><p>Nothing has changed but since the target date is now 2012-05-01, both events need to be taken into account. The invoice subsystem recomputes all invoice items since the beginning of time, and come up with a <code>FIXED</code> item (trial period) and a <code>RECURRING</code> item (for the service period 2012-05-01 to 2012-06-01). Because the <code>FIXED</code> item is already present in the database, only the second one is persisted on disk, on a new invoice:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="mysql"><span></span><span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">invoices</span> <span class="tok-k">order</span> <span class="tok-k">by</span> <span class="tok-n">record_id</span> <span class="tok-k">desc</span> <span class="tok-k">limit</span> <span class="tok-mi">1</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
        <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">2</span>
               <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">fa759cb6</span><span class="tok-o">-</span><span class="tok-mi">6702</span><span class="tok-o">-</span><span class="tok-n">4a1c</span><span class="tok-o">-</span><span class="tok-n">85a3</span><span class="tok-o">-</span><span class="tok-n">9df7b101d3bc</span>
       <span class="tok-n">account_id</span><span class="tok-o">:</span> <span class="tok-mf">8e4</span><span class="tok-n">f353f</span><span class="tok-o">-</span><span class="tok-n">ddbb</span><span class="tok-o">-</span><span class="tok-mi">4155</span><span class="tok-o">-</span><span class="tok-n">b52d</span><span class="tok-o">-</span><span class="tok-n">9fe77b8e96e3</span>
     <span class="tok-n">invoice_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span>
      <span class="tok-n">target_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">01</span>
         <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
           <span class="tok-k">status</span><span class="tok-o">:</span> <span class="tok-k">COMMITTED</span>
         <span class="tok-n">migrated</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
   <span class="tok-n">parent_invoice</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
       <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">SubscriptionBaseTransition</span>
     <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">14</span><span class="tok-o">:</span><span class="tok-mi">43</span>
<span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
 <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">1</span> <span class="tok-k">row</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span>

<span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">invoice_items</span> <span class="tok-k">order</span> <span class="tok-k">by</span> <span class="tok-n">record_id</span> <span class="tok-k">desc</span> <span class="tok-k">limit</span> <span class="tok-mi">1</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
        <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">2</span>
               <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">2326d3ff</span><span class="tok-o">-</span><span class="tok-n">e90d</span><span class="tok-o">-</span><span class="tok-n">43f0</span><span class="tok-o">-</span><span class="tok-n">b611</span><span class="tok-o">-</span><span class="tok-n">6c028bb88c71</span>
             <span class="tok-k">type</span><span class="tok-o">:</span> <span class="tok-n">RECURRING</span>
       <span class="tok-n">invoice_id</span><span class="tok-o">:</span> <span class="tok-n">fa759cb6</span><span class="tok-o">-</span><span class="tok-mi">6702</span><span class="tok-o">-</span><span class="tok-n">4a1c</span><span class="tok-o">-</span><span class="tok-n">85a3</span><span class="tok-o">-</span><span class="tok-n">9df7b101d3bc</span>
       <span class="tok-n">account_id</span><span class="tok-o">:</span> <span class="tok-mf">8e4</span><span class="tok-n">f353f</span><span class="tok-o">-</span><span class="tok-n">ddbb</span><span class="tok-o">-</span><span class="tok-mi">4155</span><span class="tok-o">-</span><span class="tok-n">b52d</span><span class="tok-o">-</span><span class="tok-n">9fe77b8e96e3</span>
 <span class="tok-n">child_account_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
        <span class="tok-n">bundle_id</span><span class="tok-o">:</span> <span class="tok-n">a7a1370e</span><span class="tok-o">-</span><span class="tok-n">1fa4</span><span class="tok-o">-</span><span class="tok-n">4c32</span><span class="tok-o">-</span><span class="tok-n">abd5</span><span class="tok-o">-</span><span class="tok-mf">223e1</span><span class="tok-n">da97339</span>
  <span class="tok-n">subscription_id</span><span class="tok-o">:</span> <span class="tok-n">d9c7bb57</span><span class="tok-o">-</span><span class="tok-mf">675e-4419</span><span class="tok-o">-</span><span class="tok-n">a340</span><span class="tok-o">-</span><span class="tok-n">5f6b4fd612f4</span>
      <span class="tok-k">description</span><span class="tok-o">:</span> <span class="tok-n">shotgun</span><span class="tok-o">-</span><span class="tok-n">monthly</span><span class="tok-o">-</span><span class="tok-n">evergreen</span>
        <span class="tok-n">plan_name</span><span class="tok-o">:</span> <span class="tok-n">shotgun</span><span class="tok-o">-</span><span class="tok-n">monthly</span>
       <span class="tok-n">phase_name</span><span class="tok-o">:</span> <span class="tok-n">shotgun</span><span class="tok-o">-</span><span class="tok-n">monthly</span><span class="tok-o">-</span><span class="tok-n">evergreen</span>
       <span class="tok-n">usage_name</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">start_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">01</span>
         <span class="tok-n">end_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">06</span><span class="tok-o">-</span><span class="tok-mi">01</span>
           <span class="tok-n">amount</span><span class="tok-o">:</span> <span class="tok-mf">249.950000000</span>
             <span class="tok-n">rate</span><span class="tok-o">:</span> <span class="tok-mf">249.950000000</span>
         <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
   <span class="tok-n">linked_item_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">SubscriptionBaseTransition</span>
     <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">14</span><span class="tok-o">:</span><span class="tok-mi">43</span>
<span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
 <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">1</span> <span class="tok-k">row</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>The subscription <code>charged_through_date</code> is updated to 2012-06-01:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="mysql"><span></span><span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">subscriptions</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
           <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
                  <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">d9c7bb57</span><span class="tok-o">-</span><span class="tok-mf">675e-4419</span><span class="tok-o">-</span><span class="tok-n">a340</span><span class="tok-o">-</span><span class="tok-n">5f6b4fd612f4</span>
           <span class="tok-n">bundle_id</span><span class="tok-o">:</span> <span class="tok-n">a7a1370e</span><span class="tok-o">-</span><span class="tok-n">1fa4</span><span class="tok-o">-</span><span class="tok-n">4c32</span><span class="tok-o">-</span><span class="tok-n">abd5</span><span class="tok-o">-</span><span class="tok-mf">223e1</span><span class="tok-n">da97339</span>
            <span class="tok-n">category</span><span class="tok-o">:</span> <span class="tok-n">BASE</span>
          <span class="tok-n">start_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">14</span>
   <span class="tok-n">bundle_start_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">14</span>
<span class="tok-n">charged_through_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">06</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">00</span>
            <span class="tok-n">migrated</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
          <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">website</span><span class="tok-o">-</span><span class="tok-n">through</span><span class="tok-o">-</span><span class="tok-n">http</span><span class="tok-o">-</span><span class="tok-k">client</span>
        <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">04</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">15</span>
          <span class="tok-n">updated_by</span><span class="tok-o">:</span> <span class="tok-n">SubscriptionBaseTransition</span>
        <span class="tok-n">updated_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">14</span><span class="tok-o">:</span><span class="tok-mi">44</span>
   <span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
    <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span></code></pre></div></div>
<div class="paragraph"><p>The system will also generate a new (future) notification on 2012-06-01. This invoice notification will be the trigger for the next invoice generation:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="mysql"><span></span><span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span>  <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">notifications</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
                <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">2</span>
               <span class="tok-n">class_name</span><span class="tok-o">:</span> <span class="tok-n">org</span><span class="tok-p">.</span><span class="tok-n">killbill</span><span class="tok-p">.</span><span class="tok-n">billing</span><span class="tok-p">.</span><span class="tok-n">invoice</span><span class="tok-p">.</span><span class="tok-n">notification</span><span class="tok-p">.</span><span class="tok-n">NextBillingDateNotificationKey</span>
               <span class="tok-n">event_json</span><span class="tok-o">:</span> <span class="tok-err">{</span><span class="tok-s2">&quot;uuidKey&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;d9c7bb57-675e-4419-a340-5f6b4fd612f4&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;targetDate&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;2012-06-01T00:00:00.000Z&quot;</span><span class="tok-p">,</span><span class="tok-s2">&quot;isDryRunForInvoiceNotification&quot;</span><span class="tok-o">:</span><span class="tok-no">false</span><span class="tok-err">}</span>
               <span class="tok-n">user_token</span><span class="tok-o">:</span> <span class="tok-n">892a1fdf</span><span class="tok-o">-</span><span class="tok-n">45b5</span><span class="tok-o">-</span><span class="tok-n">404d</span><span class="tok-o">-</span><span class="tok-n">a492</span><span class="tok-o">-</span><span class="tok-n">99f612ba8b55</span>
             <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">14</span><span class="tok-o">:</span><span class="tok-mi">44</span>
           <span class="tok-n">creating_owner</span><span class="tok-o">:</span> <span class="tok-mf">127.0.0.1</span>
         <span class="tok-n">processing_owner</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
<span class="tok-n">processing_available_date</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
         <span class="tok-n">processing_state</span><span class="tok-o">:</span> <span class="tok-n">AVAILABLE</span>
              <span class="tok-n">error_count</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
              <span class="tok-n">search_key1</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
              <span class="tok-n">search_key2</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
               <span class="tok-n">queue_name</span><span class="tok-o">:</span> <span class="tok-n">invoice</span><span class="tok-o">-</span><span class="tok-n">service</span><span class="tok-o">:</span><span class="tok-k">next</span><span class="tok-o">-</span><span class="tok-n">billing</span><span class="tok-o">-</span><span class="tok-kt">date</span><span class="tok-o">-</span><span class="tok-n">queue</span>
           <span class="tok-n">effective_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">06</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">00</span>
        <span class="tok-n">future_user_token</span><span class="tok-o">:</span> <span class="tok-n">aa2c96e2</span><span class="tok-o">-</span><span class="tok-n">71b4</span><span class="tok-o">-</span><span class="tok-mi">4149</span><span class="tok-o">-</span><span class="tok-n">abdc</span><span class="tok-o">-</span><span class="tok-n">2889256c2b34</span>
<span class="tok-mi">1</span> <span class="tok-k">row</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>After the invoice is generated, an event is sent to the bus, which makes the payment subsystem react to it:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="mysql"><span></span><span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">invoice_payments</span> <span class="tok-k">order</span> <span class="tok-k">by</span> <span class="tok-n">record_id</span> <span class="tok-k">desc</span> <span class="tok-k">limit</span> <span class="tok-mi">1</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
                <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">2</span>
                       <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">e6e534e1</span><span class="tok-o">-</span><span class="tok-n">2ffa</span><span class="tok-o">-</span><span class="tok-n">4d5e</span><span class="tok-o">-</span><span class="tok-n">bcac</span><span class="tok-o">-</span><span class="tok-n">6905d4d26f61</span>
                     <span class="tok-k">type</span><span class="tok-o">:</span> <span class="tok-n">ATTEMPT</span>
               <span class="tok-n">invoice_id</span><span class="tok-o">:</span> <span class="tok-n">fa759cb6</span><span class="tok-o">-</span><span class="tok-mi">6702</span><span class="tok-o">-</span><span class="tok-n">4a1c</span><span class="tok-o">-</span><span class="tok-n">85a3</span><span class="tok-o">-</span><span class="tok-n">9df7b101d3bc</span>
               <span class="tok-n">payment_id</span><span class="tok-o">:</span> <span class="tok-n">b0e61973</span><span class="tok-o">-</span><span class="tok-n">a921</span><span class="tok-o">-</span><span class="tok-n">413d</span><span class="tok-o">-</span><span class="tok-n">a04b</span><span class="tok-o">-</span><span class="tok-mf">84e36</span><span class="tok-n">e3ad6bf</span>
             <span class="tok-n">payment_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">14</span><span class="tok-o">:</span><span class="tok-mi">44</span>
                   <span class="tok-n">amount</span><span class="tok-o">:</span> <span class="tok-mf">249.950000000</span>
                 <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
       <span class="tok-n">processed_currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
        <span class="tok-n">payment_cookie_id</span><span class="tok-o">:</span> <span class="tok-n">943d005c</span><span class="tok-o">-</span><span class="tok-n">5f89</span><span class="tok-o">-</span><span class="tok-mi">4664</span><span class="tok-o">-</span><span class="tok-n">88f5</span><span class="tok-o">-</span><span class="tok-n">c65f39a3a9c8</span>
<span class="tok-n">linked_invoice_payment_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
                  <span class="tok-n">success</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
               <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">PaymentRequestProcessor</span>
             <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">14</span><span class="tok-o">:</span><span class="tok-mi">44</span>
        <span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
         <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">1</span> <span class="tok-k">row</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span>

<span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">payment_attempts</span> <span class="tok-k">order</span> <span class="tok-k">by</span> <span class="tok-n">record_id</span> <span class="tok-k">desc</span> <span class="tok-k">limit</span> <span class="tok-mi">1</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
               <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">2</span>
                      <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">090fa541</span><span class="tok-o">-</span><span class="tok-n">7b69</span><span class="tok-o">-</span><span class="tok-n">42b2</span><span class="tok-o">-</span><span class="tok-n">bec7</span><span class="tok-o">-</span><span class="tok-n">a16f3c616071</span>
              <span class="tok-n">account_id</span><span class="tok-o">:</span> <span class="tok-mf">8e4</span><span class="tok-n">f353f</span><span class="tok-o">-</span><span class="tok-n">ddbb</span><span class="tok-o">-</span><span class="tok-mi">4155</span><span class="tok-o">-</span><span class="tok-n">b52d</span><span class="tok-o">-</span><span class="tok-n">9fe77b8e96e3</span>
       <span class="tok-n">payment_method_id</span><span class="tok-o">:</span> <span class="tok-n">c046e5be</span><span class="tok-o">-</span><span class="tok-n">e632</span><span class="tok-o">-</span><span class="tok-n">444a</span><span class="tok-o">-</span><span class="tok-n">905f</span><span class="tok-o">-</span><span class="tok-n">c4bc0c5c0086</span>
    <span class="tok-n">payment_external_key</span><span class="tok-o">:</span> <span class="tok-n">d04ce5ad</span><span class="tok-o">-</span><span class="tok-n">e667</span><span class="tok-o">-</span><span class="tok-mi">4113</span><span class="tok-o">-</span><span class="tok-n">8eb3</span><span class="tok-o">-</span><span class="tok-n">6d7f87f92bca</span>
          <span class="tok-n">transaction_id</span><span class="tok-o">:</span> <span class="tok-n">8b671a2e</span><span class="tok-o">-</span><span class="tok-mi">6556</span><span class="tok-o">-</span><span class="tok-n">4aa8</span><span class="tok-o">-</span><span class="tok-mi">8464</span><span class="tok-o">-</span><span class="tok-n">ef1cb99e5189</span>
<span class="tok-n">transaction_external_key</span><span class="tok-o">:</span> <span class="tok-n">943d005c</span><span class="tok-o">-</span><span class="tok-n">5f89</span><span class="tok-o">-</span><span class="tok-mi">4664</span><span class="tok-o">-</span><span class="tok-n">88f5</span><span class="tok-o">-</span><span class="tok-n">c65f39a3a9c8</span>
        <span class="tok-n">transaction_type</span><span class="tok-o">:</span> <span class="tok-n">PURCHASE</span>
              <span class="tok-n">state_name</span><span class="tok-o">:</span> <span class="tok-n">SUCCESS</span>
                  <span class="tok-n">amount</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
                <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
             <span class="tok-n">plugin_name</span><span class="tok-o">:</span> <span class="tok-n">__INVOICE_PAYMENT_CONTROL_PLUGIN__</span>
       <span class="tok-n">plugin_properties</span><span class="tok-o">:</span> <span class="tok-n">ZV</span>  <span class="tok-o">&lt;</span><span class="tok-err">[{</span><span class="tok-s2">&quot;IPCD_INVOICE_ID&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;fa759cb6-6702-4a1c-85a3-9df7b101d3bc&quot;</span><span class="tok-err">}]</span>
              <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">PaymentRequestProcessor</span>
            <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">14</span><span class="tok-o">:</span><span class="tok-mi">44</span>
              <span class="tok-n">updated_by</span><span class="tok-o">:</span> <span class="tok-n">PaymentRequestProcessor</span>
            <span class="tok-n">updated_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">14</span><span class="tok-o">:</span><span class="tok-mi">44</span>
       <span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
        <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">1</span> <span class="tok-k">row</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span>

<span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">payments</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
              <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
                     <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">b0e61973</span><span class="tok-o">-</span><span class="tok-n">a921</span><span class="tok-o">-</span><span class="tok-n">413d</span><span class="tok-o">-</span><span class="tok-n">a04b</span><span class="tok-o">-</span><span class="tok-mf">84e36</span><span class="tok-n">e3ad6bf</span>
             <span class="tok-n">account_id</span><span class="tok-o">:</span> <span class="tok-mf">8e4</span><span class="tok-n">f353f</span><span class="tok-o">-</span><span class="tok-n">ddbb</span><span class="tok-o">-</span><span class="tok-mi">4155</span><span class="tok-o">-</span><span class="tok-n">b52d</span><span class="tok-o">-</span><span class="tok-n">9fe77b8e96e3</span>
      <span class="tok-n">payment_method_id</span><span class="tok-o">:</span> <span class="tok-n">c046e5be</span><span class="tok-o">-</span><span class="tok-n">e632</span><span class="tok-o">-</span><span class="tok-n">444a</span><span class="tok-o">-</span><span class="tok-n">905f</span><span class="tok-o">-</span><span class="tok-n">c4bc0c5c0086</span>
           <span class="tok-n">external_key</span><span class="tok-o">:</span> <span class="tok-n">d04ce5ad</span><span class="tok-o">-</span><span class="tok-n">e667</span><span class="tok-o">-</span><span class="tok-mi">4113</span><span class="tok-o">-</span><span class="tok-n">8eb3</span><span class="tok-o">-</span><span class="tok-n">6d7f87f92bca</span>
             <span class="tok-n">state_name</span><span class="tok-o">:</span> <span class="tok-n">PURCHASE_SUCCESS</span>
<span class="tok-n">last_success_state_name</span><span class="tok-o">:</span> <span class="tok-n">PURCHASE_SUCCESS</span>
             <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">PaymentRequestProcessor</span>
           <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">14</span><span class="tok-o">:</span><span class="tok-mi">44</span>
             <span class="tok-n">updated_by</span><span class="tok-o">:</span> <span class="tok-n">PaymentRequestProcessor</span>
           <span class="tok-n">updated_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">14</span><span class="tok-o">:</span><span class="tok-mi">44</span>
      <span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
       <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">1</span> <span class="tok-k">row</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span>

<span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">payment_transactions</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
               <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
                      <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">8b671a2e</span><span class="tok-o">-</span><span class="tok-mi">6556</span><span class="tok-o">-</span><span class="tok-n">4aa8</span><span class="tok-o">-</span><span class="tok-mi">8464</span><span class="tok-o">-</span><span class="tok-n">ef1cb99e5189</span>
              <span class="tok-n">attempt_id</span><span class="tok-o">:</span> <span class="tok-n">090fa541</span><span class="tok-o">-</span><span class="tok-n">7b69</span><span class="tok-o">-</span><span class="tok-n">42b2</span><span class="tok-o">-</span><span class="tok-n">bec7</span><span class="tok-o">-</span><span class="tok-n">a16f3c616071</span>
<span class="tok-n">transaction_external_key</span><span class="tok-o">:</span> <span class="tok-n">943d005c</span><span class="tok-o">-</span><span class="tok-n">5f89</span><span class="tok-o">-</span><span class="tok-mi">4664</span><span class="tok-o">-</span><span class="tok-n">88f5</span><span class="tok-o">-</span><span class="tok-n">c65f39a3a9c8</span>
        <span class="tok-n">transaction_type</span><span class="tok-o">:</span> <span class="tok-n">PURCHASE</span>
          <span class="tok-n">effective_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">14</span><span class="tok-o">:</span><span class="tok-mi">44</span>
      <span class="tok-n">transaction_status</span><span class="tok-o">:</span> <span class="tok-n">SUCCESS</span>
                  <span class="tok-n">amount</span><span class="tok-o">:</span> <span class="tok-mf">249.950000000</span>
                <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
        <span class="tok-n">processed_amount</span><span class="tok-o">:</span> <span class="tok-mf">249.950000000</span>
      <span class="tok-n">processed_currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
              <span class="tok-n">payment_id</span><span class="tok-o">:</span> <span class="tok-n">b0e61973</span><span class="tok-o">-</span><span class="tok-n">a921</span><span class="tok-o">-</span><span class="tok-n">413d</span><span class="tok-o">-</span><span class="tok-n">a04b</span><span class="tok-o">-</span><span class="tok-mf">84e36</span><span class="tok-n">e3ad6bf</span>
      <span class="tok-n">gateway_error_code</span><span class="tok-o">:</span>
       <span class="tok-n">gateway_error_msg</span><span class="tok-o">:</span>
              <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">PaymentRequestProcessor</span>
            <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">14</span><span class="tok-o">:</span><span class="tok-mi">44</span>
              <span class="tok-n">updated_by</span><span class="tok-o">:</span> <span class="tok-n">PaymentRequestProcessor</span>
            <span class="tok-n">updated_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">14</span><span class="tok-o">:</span><span class="tok-mi">44</span>
       <span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
        <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">1</span> <span class="tok-k">row</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>In this case, a <code>PURCHASE</code> (i.e. auto-capture) payment was performed. The <code>invoice_payments</code> entry is linked to the <code>payments</code> entry via <code>payment_id</code> and to the <code>transactions</code> table via <code>payment_cookie_id</code> (which is the transaction external key).</p></div>
<div class="paragraph"><p>If the payment didn&#8217;t go through the first time (e.g. insufficient funds on the credit card), and the system was configured to retry the payments 8 days after, the data would look like this on a successful retry:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="mysql"><span></span><span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">invoice_payments</span> <span class="tok-k">order</span> <span class="tok-k">by</span> <span class="tok-n">record_id</span> <span class="tok-k">desc</span> <span class="tok-k">limit</span> <span class="tok-mi">1</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
                <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">2</span>
                       <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">6a45a92e</span><span class="tok-o">-</span><span class="tok-n">72ee</span><span class="tok-o">-</span><span class="tok-mi">4415</span><span class="tok-o">-</span><span class="tok-n">9c5a</span><span class="tok-o">-</span><span class="tok-n">8066d4448cc5</span>
                     <span class="tok-k">type</span><span class="tok-o">:</span> <span class="tok-n">ATTEMPT</span>
               <span class="tok-n">invoice_id</span><span class="tok-o">:</span> <span class="tok-n">fa759cb6</span><span class="tok-o">-</span><span class="tok-mi">6702</span><span class="tok-o">-</span><span class="tok-n">4a1c</span><span class="tok-o">-</span><span class="tok-n">85a3</span><span class="tok-o">-</span><span class="tok-n">9df7b101d3bc</span>
               <span class="tok-n">payment_id</span><span class="tok-o">:</span> <span class="tok-n">d0a6b1c4</span><span class="tok-o">-</span><span class="tok-n">44b0</span><span class="tok-o">-</span><span class="tok-mf">4e84</span><span class="tok-o">-</span><span class="tok-mi">8883</span><span class="tok-o">-</span><span class="tok-n">4ec4cf8a3b2a</span>
             <span class="tok-n">payment_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">09</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">49</span>
                   <span class="tok-n">amount</span><span class="tok-o">:</span> <span class="tok-mf">249.950000000</span>
                 <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
       <span class="tok-n">processed_currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
        <span class="tok-n">payment_cookie_id</span><span class="tok-o">:</span> <span class="tok-n">6a5b6c15</span><span class="tok-o">-</span><span class="tok-n">0a8b</span><span class="tok-o">-</span><span class="tok-n">43ae</span><span class="tok-o">-</span><span class="tok-n">8b82</span><span class="tok-o">-</span><span class="tok-n">f6d66568eb8f</span>
<span class="tok-n">linked_invoice_payment_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
                  <span class="tok-n">success</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
               <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">PaymentRequestProcessor</span>
             <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">14</span><span class="tok-o">:</span><span class="tok-mi">44</span>
        <span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
         <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">1</span> <span class="tok-k">row</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span>

<span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">payment_attempts</span> <span class="tok-k">where</span> <span class="tok-n">record_id</span> <span class="tok-o">&gt;</span> <span class="tok-mi">1</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
               <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">2</span>
                      <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">be5f3706</span><span class="tok-o">-</span><span class="tok-n">105d</span><span class="tok-o">-</span><span class="tok-mi">4874</span><span class="tok-o">-</span><span class="tok-mi">9857</span><span class="tok-o">-</span><span class="tok-n">2b0d197b7ff3</span>
              <span class="tok-n">account_id</span><span class="tok-o">:</span> <span class="tok-mf">8e4</span><span class="tok-n">f353f</span><span class="tok-o">-</span><span class="tok-n">ddbb</span><span class="tok-o">-</span><span class="tok-mi">4155</span><span class="tok-o">-</span><span class="tok-n">b52d</span><span class="tok-o">-</span><span class="tok-n">9fe77b8e96e3</span>
       <span class="tok-n">payment_method_id</span><span class="tok-o">:</span> <span class="tok-n">c046e5be</span><span class="tok-o">-</span><span class="tok-n">e632</span><span class="tok-o">-</span><span class="tok-n">444a</span><span class="tok-o">-</span><span class="tok-n">905f</span><span class="tok-o">-</span><span class="tok-n">c4bc0c5c0086</span>
    <span class="tok-n">payment_external_key</span><span class="tok-o">:</span> <span class="tok-n">73035f59</span><span class="tok-o">-</span><span class="tok-mi">9364</span><span class="tok-o">-</span><span class="tok-n">408f</span><span class="tok-o">-</span><span class="tok-n">a41f</span><span class="tok-o">-</span><span class="tok-n">d89b3483cd26</span>
          <span class="tok-n">transaction_id</span><span class="tok-o">:</span> <span class="tok-n">4935d163</span><span class="tok-o">-</span><span class="tok-n">7f3a</span><span class="tok-o">-</span><span class="tok-n">4b5d</span><span class="tok-o">-</span><span class="tok-n">8ad2</span><span class="tok-o">-</span><span class="tok-n">13dcb6d4b540</span>
<span class="tok-n">transaction_external_key</span><span class="tok-o">:</span> <span class="tok-n">6a5b6c15</span><span class="tok-o">-</span><span class="tok-n">0a8b</span><span class="tok-o">-</span><span class="tok-n">43ae</span><span class="tok-o">-</span><span class="tok-n">8b82</span><span class="tok-o">-</span><span class="tok-n">f6d66568eb8f</span>
        <span class="tok-n">transaction_type</span><span class="tok-o">:</span> <span class="tok-n">PURCHASE</span>
              <span class="tok-n">state_name</span><span class="tok-o">:</span> <span class="tok-n">RETRIED</span>
                  <span class="tok-n">amount</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
                <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
             <span class="tok-n">plugin_name</span><span class="tok-o">:</span> <span class="tok-n">__INVOICE_PAYMENT_CONTROL_PLUGIN__</span>
       <span class="tok-n">plugin_properties</span><span class="tok-o">:</span> <span class="tok-n">ZV</span>  <span class="tok-o">&lt;</span><span class="tok-err">[{</span><span class="tok-s2">&quot;IPCD_INVOICE_ID&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;fa759cb6-6702-4a1c-85a3-9df7b101d3bc&quot;</span><span class="tok-err">}]</span>
              <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">PaymentRequestProcessor</span>
            <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">46</span>
              <span class="tok-n">updated_by</span><span class="tok-o">:</span> <span class="tok-n">PaymentRequestProcessor</span>
            <span class="tok-n">updated_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">46</span>
       <span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
        <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-o">***************************</span> <span class="tok-mf">2.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
               <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">3</span>
                      <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">672bc1a2</span><span class="tok-o">-</span><span class="tok-n">189a</span><span class="tok-o">-</span><span class="tok-mi">4615</span><span class="tok-o">-</span><span class="tok-mi">9619</span><span class="tok-o">-</span><span class="tok-n">544977cca8ea</span>
              <span class="tok-n">account_id</span><span class="tok-o">:</span> <span class="tok-mf">8e4</span><span class="tok-n">f353f</span><span class="tok-o">-</span><span class="tok-n">ddbb</span><span class="tok-o">-</span><span class="tok-mi">4155</span><span class="tok-o">-</span><span class="tok-n">b52d</span><span class="tok-o">-</span><span class="tok-n">9fe77b8e96e3</span>
       <span class="tok-n">payment_method_id</span><span class="tok-o">:</span> <span class="tok-n">c046e5be</span><span class="tok-o">-</span><span class="tok-n">e632</span><span class="tok-o">-</span><span class="tok-n">444a</span><span class="tok-o">-</span><span class="tok-n">905f</span><span class="tok-o">-</span><span class="tok-n">c4bc0c5c0086</span>
    <span class="tok-n">payment_external_key</span><span class="tok-o">:</span> <span class="tok-n">73035f59</span><span class="tok-o">-</span><span class="tok-mi">9364</span><span class="tok-o">-</span><span class="tok-n">408f</span><span class="tok-o">-</span><span class="tok-n">a41f</span><span class="tok-o">-</span><span class="tok-n">d89b3483cd26</span>
          <span class="tok-n">transaction_id</span><span class="tok-o">:</span> <span class="tok-n">49ff12b5</span><span class="tok-o">-</span><span class="tok-n">7dfc</span><span class="tok-o">-</span><span class="tok-n">408d</span><span class="tok-o">-</span><span class="tok-mf">956e-3</span><span class="tok-n">d5335818738</span>
<span class="tok-n">transaction_external_key</span><span class="tok-o">:</span> <span class="tok-n">6a5b6c15</span><span class="tok-o">-</span><span class="tok-n">0a8b</span><span class="tok-o">-</span><span class="tok-n">43ae</span><span class="tok-o">-</span><span class="tok-n">8b82</span><span class="tok-o">-</span><span class="tok-n">f6d66568eb8f</span>
        <span class="tok-n">transaction_type</span><span class="tok-o">:</span> <span class="tok-n">PURCHASE</span>
              <span class="tok-n">state_name</span><span class="tok-o">:</span> <span class="tok-n">SUCCESS</span>
                  <span class="tok-n">amount</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
                <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
             <span class="tok-n">plugin_name</span><span class="tok-o">:</span> <span class="tok-n">__INVOICE_PAYMENT_CONTROL_PLUGIN__</span>
       <span class="tok-n">plugin_properties</span><span class="tok-o">:</span> <span class="tok-n">ZV</span>  <span class="tok-o">&lt;</span><span class="tok-err">[{</span><span class="tok-s2">&quot;IPCD_INVOICE_ID&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;fa759cb6-6702-4a1c-85a3-9df7b101d3bc&quot;</span><span class="tok-err">}]</span>
              <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">payment</span><span class="tok-o">-</span><span class="tok-n">service</span><span class="tok-o">-</span><span class="tok-n">retry</span>
            <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">09</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">49</span>
              <span class="tok-n">updated_by</span><span class="tok-o">:</span> <span class="tok-n">payment</span><span class="tok-o">-</span><span class="tok-n">service</span><span class="tok-o">-</span><span class="tok-n">retry</span>
            <span class="tok-n">updated_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">09</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">49</span>
       <span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
        <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">2</span> <span class="tok-k">rows</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span>

<span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">payments</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
              <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
                     <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">d0a6b1c4</span><span class="tok-o">-</span><span class="tok-n">44b0</span><span class="tok-o">-</span><span class="tok-mf">4e84</span><span class="tok-o">-</span><span class="tok-mi">8883</span><span class="tok-o">-</span><span class="tok-n">4ec4cf8a3b2a</span>
             <span class="tok-n">account_id</span><span class="tok-o">:</span> <span class="tok-mf">8e4</span><span class="tok-n">f353f</span><span class="tok-o">-</span><span class="tok-n">ddbb</span><span class="tok-o">-</span><span class="tok-mi">4155</span><span class="tok-o">-</span><span class="tok-n">b52d</span><span class="tok-o">-</span><span class="tok-n">9fe77b8e96e3</span>
      <span class="tok-n">payment_method_id</span><span class="tok-o">:</span> <span class="tok-n">c046e5be</span><span class="tok-o">-</span><span class="tok-n">e632</span><span class="tok-o">-</span><span class="tok-n">444a</span><span class="tok-o">-</span><span class="tok-n">905f</span><span class="tok-o">-</span><span class="tok-n">c4bc0c5c0086</span>
           <span class="tok-n">external_key</span><span class="tok-o">:</span> <span class="tok-n">73035f59</span><span class="tok-o">-</span><span class="tok-mi">9364</span><span class="tok-o">-</span><span class="tok-n">408f</span><span class="tok-o">-</span><span class="tok-n">a41f</span><span class="tok-o">-</span><span class="tok-n">d89b3483cd26</span>
             <span class="tok-n">state_name</span><span class="tok-o">:</span> <span class="tok-n">PURCHASE_SUCCESS</span>
<span class="tok-n">last_success_state_name</span><span class="tok-o">:</span> <span class="tok-n">PURCHASE_SUCCESS</span>
             <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">PaymentRequestProcessor</span>
           <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">46</span>
             <span class="tok-n">updated_by</span><span class="tok-o">:</span> <span class="tok-n">payment</span><span class="tok-o">-</span><span class="tok-n">service</span><span class="tok-o">-</span><span class="tok-n">retry</span>
           <span class="tok-n">updated_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">09</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">49</span>
      <span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
       <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">1</span> <span class="tok-k">row</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span>

<span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">payment_transactions</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
               <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
                      <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">4935d163</span><span class="tok-o">-</span><span class="tok-n">7f3a</span><span class="tok-o">-</span><span class="tok-n">4b5d</span><span class="tok-o">-</span><span class="tok-n">8ad2</span><span class="tok-o">-</span><span class="tok-n">13dcb6d4b540</span>
              <span class="tok-n">attempt_id</span><span class="tok-o">:</span> <span class="tok-n">be5f3706</span><span class="tok-o">-</span><span class="tok-n">105d</span><span class="tok-o">-</span><span class="tok-mi">4874</span><span class="tok-o">-</span><span class="tok-mi">9857</span><span class="tok-o">-</span><span class="tok-n">2b0d197b7ff3</span>
<span class="tok-n">transaction_external_key</span><span class="tok-o">:</span> <span class="tok-n">6a5b6c15</span><span class="tok-o">-</span><span class="tok-n">0a8b</span><span class="tok-o">-</span><span class="tok-n">43ae</span><span class="tok-o">-</span><span class="tok-n">8b82</span><span class="tok-o">-</span><span class="tok-n">f6d66568eb8f</span>
        <span class="tok-n">transaction_type</span><span class="tok-o">:</span> <span class="tok-n">PURCHASE</span>
          <span class="tok-n">effective_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">46</span>
      <span class="tok-n">transaction_status</span><span class="tok-o">:</span> <span class="tok-n">PAYMENT_FAILURE</span>
                  <span class="tok-n">amount</span><span class="tok-o">:</span> <span class="tok-mf">249.950000000</span>
                <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
        <span class="tok-n">processed_amount</span><span class="tok-o">:</span> <span class="tok-mf">0.000000000</span>
      <span class="tok-n">processed_currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
              <span class="tok-n">payment_id</span><span class="tok-o">:</span> <span class="tok-n">d0a6b1c4</span><span class="tok-o">-</span><span class="tok-n">44b0</span><span class="tok-o">-</span><span class="tok-mf">4e84</span><span class="tok-o">-</span><span class="tok-mi">8883</span><span class="tok-o">-</span><span class="tok-n">4ec4cf8a3b2a</span>
      <span class="tok-n">gateway_error_code</span><span class="tok-o">:</span> <span class="tok-mi">500</span>
       <span class="tok-n">gateway_error_msg</span><span class="tok-o">:</span> <span class="tok-n">Insufficient</span> <span class="tok-n">funds</span>
              <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">PaymentRequestProcessor</span>
            <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">46</span>
              <span class="tok-n">updated_by</span><span class="tok-o">:</span> <span class="tok-n">PaymentRequestProcessor</span>
            <span class="tok-n">updated_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">46</span>
       <span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
        <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-o">***************************</span> <span class="tok-mf">2.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
               <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">2</span>
                      <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">49ff12b5</span><span class="tok-o">-</span><span class="tok-n">7dfc</span><span class="tok-o">-</span><span class="tok-n">408d</span><span class="tok-o">-</span><span class="tok-mf">956e-3</span><span class="tok-n">d5335818738</span>
              <span class="tok-n">attempt_id</span><span class="tok-o">:</span> <span class="tok-n">672bc1a2</span><span class="tok-o">-</span><span class="tok-n">189a</span><span class="tok-o">-</span><span class="tok-mi">4615</span><span class="tok-o">-</span><span class="tok-mi">9619</span><span class="tok-o">-</span><span class="tok-n">544977cca8ea</span>
<span class="tok-n">transaction_external_key</span><span class="tok-o">:</span> <span class="tok-n">6a5b6c15</span><span class="tok-o">-</span><span class="tok-n">0a8b</span><span class="tok-o">-</span><span class="tok-n">43ae</span><span class="tok-o">-</span><span class="tok-n">8b82</span><span class="tok-o">-</span><span class="tok-n">f6d66568eb8f</span>
        <span class="tok-n">transaction_type</span><span class="tok-o">:</span> <span class="tok-n">PURCHASE</span>
          <span class="tok-n">effective_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">09</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">49</span>
      <span class="tok-n">transaction_status</span><span class="tok-o">:</span> <span class="tok-n">SUCCESS</span>
                  <span class="tok-n">amount</span><span class="tok-o">:</span> <span class="tok-mf">249.950000000</span>
                <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
        <span class="tok-n">processed_amount</span><span class="tok-o">:</span> <span class="tok-mf">249.950000000</span>
      <span class="tok-n">processed_currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
              <span class="tok-n">payment_id</span><span class="tok-o">:</span> <span class="tok-n">d0a6b1c4</span><span class="tok-o">-</span><span class="tok-n">44b0</span><span class="tok-o">-</span><span class="tok-mf">4e84</span><span class="tok-o">-</span><span class="tok-mi">8883</span><span class="tok-o">-</span><span class="tok-n">4ec4cf8a3b2a</span>
      <span class="tok-n">gateway_error_code</span><span class="tok-o">:</span>
       <span class="tok-n">gateway_error_msg</span><span class="tok-o">:</span>
              <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">payment</span><span class="tok-o">-</span><span class="tok-n">service</span><span class="tok-o">-</span><span class="tok-n">retry</span>
            <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">09</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">49</span>
              <span class="tok-n">updated_by</span><span class="tok-o">:</span> <span class="tok-n">payment</span><span class="tok-o">-</span><span class="tok-n">service</span><span class="tok-o">-</span><span class="tok-n">retry</span>
            <span class="tok-n">updated_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">09</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">49</span>
       <span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
        <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">2</span> <span class="tok-k">rows</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>A few things to notice:</p></div>
<div class="ulist"><ul><li><p>There is a single <code>invoice_payments</code> entry pointing to a single <code>payments</code> entry</p></li><li><p>There are two <code>payment_attempts</code>, one <code>RETRIED</code> and one <code>SUCCESS</code>, pointing to two transactions in <code>PAYMENT_FAILURE</code> and <code>SUCCESS</code> respectfully</p></li><li><p>The transaction external key is shared for both transactions</p></li></ul></div></div></div>
<div class="sect1"><h2 id="_invoice_item_adjustment">Invoice item adjustment</h2><div class="sectionbody"><div class="paragraph"><p>Let&#8217;s consider the case where the administrator item adjusts for $10 the recurring item (for the service period 2012-05-01 to 2012-06-01). The second invoice now has 2 new items:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="mysql"><span></span><span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">invoice_items</span> <span class="tok-k">where</span> <span class="tok-n">invoice_id</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;fa759cb6-6702-4a1c-85a3-9df7b101d3bc&#39;</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
        <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">2</span>
               <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">2326d3ff</span><span class="tok-o">-</span><span class="tok-n">e90d</span><span class="tok-o">-</span><span class="tok-n">43f0</span><span class="tok-o">-</span><span class="tok-n">b611</span><span class="tok-o">-</span><span class="tok-n">6c028bb88c71</span>
             <span class="tok-k">type</span><span class="tok-o">:</span> <span class="tok-n">RECURRING</span>
       <span class="tok-n">invoice_id</span><span class="tok-o">:</span> <span class="tok-n">fa759cb6</span><span class="tok-o">-</span><span class="tok-mi">6702</span><span class="tok-o">-</span><span class="tok-n">4a1c</span><span class="tok-o">-</span><span class="tok-n">85a3</span><span class="tok-o">-</span><span class="tok-n">9df7b101d3bc</span>
       <span class="tok-n">account_id</span><span class="tok-o">:</span> <span class="tok-mf">8e4</span><span class="tok-n">f353f</span><span class="tok-o">-</span><span class="tok-n">ddbb</span><span class="tok-o">-</span><span class="tok-mi">4155</span><span class="tok-o">-</span><span class="tok-n">b52d</span><span class="tok-o">-</span><span class="tok-n">9fe77b8e96e3</span>
 <span class="tok-n">child_account_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
        <span class="tok-n">bundle_id</span><span class="tok-o">:</span> <span class="tok-n">a7a1370e</span><span class="tok-o">-</span><span class="tok-n">1fa4</span><span class="tok-o">-</span><span class="tok-n">4c32</span><span class="tok-o">-</span><span class="tok-n">abd5</span><span class="tok-o">-</span><span class="tok-mf">223e1</span><span class="tok-n">da97339</span>
  <span class="tok-n">subscription_id</span><span class="tok-o">:</span> <span class="tok-n">d9c7bb57</span><span class="tok-o">-</span><span class="tok-mf">675e-4419</span><span class="tok-o">-</span><span class="tok-n">a340</span><span class="tok-o">-</span><span class="tok-n">5f6b4fd612f4</span>
      <span class="tok-k">description</span><span class="tok-o">:</span> <span class="tok-n">shotgun</span><span class="tok-o">-</span><span class="tok-n">monthly</span><span class="tok-o">-</span><span class="tok-n">evergreen</span>
        <span class="tok-n">plan_name</span><span class="tok-o">:</span> <span class="tok-n">shotgun</span><span class="tok-o">-</span><span class="tok-n">monthly</span>
       <span class="tok-n">phase_name</span><span class="tok-o">:</span> <span class="tok-n">shotgun</span><span class="tok-o">-</span><span class="tok-n">monthly</span><span class="tok-o">-</span><span class="tok-n">evergreen</span>
       <span class="tok-n">usage_name</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">start_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">01</span>
         <span class="tok-n">end_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">06</span><span class="tok-o">-</span><span class="tok-mi">01</span>
           <span class="tok-n">amount</span><span class="tok-o">:</span> <span class="tok-mf">249.950000000</span>
             <span class="tok-n">rate</span><span class="tok-o">:</span> <span class="tok-mf">249.950000000</span>
         <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
   <span class="tok-n">linked_item_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">SubscriptionBaseTransition</span>
     <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">14</span><span class="tok-o">:</span><span class="tok-mi">43</span>
<span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
 <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-o">***************************</span> <span class="tok-mf">2.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
        <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">3</span>
               <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">e702518e</span><span class="tok-o">-</span><span class="tok-n">2da1</span><span class="tok-o">-</span><span class="tok-n">4d1a</span><span class="tok-o">-</span><span class="tok-mi">8939</span><span class="tok-o">-</span><span class="tok-n">316a2fef4df3</span>
             <span class="tok-k">type</span><span class="tok-o">:</span> <span class="tok-n">ITEM_ADJ</span>
       <span class="tok-n">invoice_id</span><span class="tok-o">:</span> <span class="tok-n">fa759cb6</span><span class="tok-o">-</span><span class="tok-mi">6702</span><span class="tok-o">-</span><span class="tok-n">4a1c</span><span class="tok-o">-</span><span class="tok-n">85a3</span><span class="tok-o">-</span><span class="tok-n">9df7b101d3bc</span>
       <span class="tok-n">account_id</span><span class="tok-o">:</span> <span class="tok-mf">8e4</span><span class="tok-n">f353f</span><span class="tok-o">-</span><span class="tok-n">ddbb</span><span class="tok-o">-</span><span class="tok-mi">4155</span><span class="tok-o">-</span><span class="tok-n">b52d</span><span class="tok-o">-</span><span class="tok-n">9fe77b8e96e3</span>
 <span class="tok-n">child_account_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
        <span class="tok-n">bundle_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
  <span class="tok-n">subscription_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
      <span class="tok-k">description</span><span class="tok-o">:</span> <span class="tok-n">Invoice</span> <span class="tok-n">item</span> <span class="tok-n">adjustment</span>
        <span class="tok-n">plan_name</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">phase_name</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">usage_name</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">start_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span>
         <span class="tok-n">end_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span>
           <span class="tok-n">amount</span><span class="tok-o">:</span> <span class="tok-o">-</span><span class="tok-mf">10.000000000</span>
             <span class="tok-n">rate</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
         <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
   <span class="tok-n">linked_item_id</span><span class="tok-o">:</span> <span class="tok-n">2326d3ff</span><span class="tok-o">-</span><span class="tok-n">e90d</span><span class="tok-o">-</span><span class="tok-n">43f0</span><span class="tok-o">-</span><span class="tok-n">b611</span><span class="tok-o">-</span><span class="tok-n">6c028bb88c71</span>
       <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">kaui</span><span class="tok-o">-</span><span class="tok-n">through</span><span class="tok-o">-</span><span class="tok-n">http</span><span class="tok-o">-</span><span class="tok-k">client</span>
     <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">30</span><span class="tok-o">:</span><span class="tok-mi">41</span>
<span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
 <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-o">***************************</span> <span class="tok-mf">3.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
        <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">4</span>
               <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">74d1d3eb</span><span class="tok-o">-</span><span class="tok-n">d4b7</span><span class="tok-o">-</span><span class="tok-n">4b45</span><span class="tok-o">-</span><span class="tok-n">93ac</span><span class="tok-o">-</span><span class="tok-n">01805156d3db</span>
             <span class="tok-k">type</span><span class="tok-o">:</span> <span class="tok-n">CBA_ADJ</span>
       <span class="tok-n">invoice_id</span><span class="tok-o">:</span> <span class="tok-n">fa759cb6</span><span class="tok-o">-</span><span class="tok-mi">6702</span><span class="tok-o">-</span><span class="tok-n">4a1c</span><span class="tok-o">-</span><span class="tok-n">85a3</span><span class="tok-o">-</span><span class="tok-n">9df7b101d3bc</span>
       <span class="tok-n">account_id</span><span class="tok-o">:</span> <span class="tok-mf">8e4</span><span class="tok-n">f353f</span><span class="tok-o">-</span><span class="tok-n">ddbb</span><span class="tok-o">-</span><span class="tok-mi">4155</span><span class="tok-o">-</span><span class="tok-n">b52d</span><span class="tok-o">-</span><span class="tok-n">9fe77b8e96e3</span>
 <span class="tok-n">child_account_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
        <span class="tok-n">bundle_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
  <span class="tok-n">subscription_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
      <span class="tok-k">description</span><span class="tok-o">:</span> <span class="tok-n">Adjustment</span> <span class="tok-p">(</span><span class="tok-k">account</span> <span class="tok-n">credit</span><span class="tok-p">)</span>
        <span class="tok-n">plan_name</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">phase_name</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">usage_name</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">start_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span>
         <span class="tok-n">end_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span>
           <span class="tok-n">amount</span><span class="tok-o">:</span> <span class="tok-mf">10.000000000</span>
             <span class="tok-n">rate</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
         <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
   <span class="tok-n">linked_item_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">kaui</span><span class="tok-o">-</span><span class="tok-n">through</span><span class="tok-o">-</span><span class="tok-n">http</span><span class="tok-o">-</span><span class="tok-k">client</span>
     <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">30</span><span class="tok-o">:</span><span class="tok-mi">41</span>
<span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
 <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">3</span> <span class="tok-k">rows</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>The <code>ITEM_ADJ</code> of $-10 points to the recurring item (see <code>linked_item_id</code>). Because the balance of the invoice was $0, a credit item (<code>CBA_ADJ</code>) of $10 is also added and will be available when the next invoice is being generated.</p></div>
<div class="sect2"><h3 id="_refund_with_invoice_item_adjustment">Refund with invoice item adjustment</h3><div class="paragraph"><p>A variation of the invoice item adjustment is refund with invoice item adjustment, i.e. refund the customer instead of generating a credit.</p></div>
<div class="paragraph"><p>This time, there would only be a single <code>ITEM_ADJ</code> (no <code>CBA_ADJ</code> item):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="mysql"><span></span><span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">invoice_items</span> <span class="tok-k">where</span> <span class="tok-n">invoice_id</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;fa759cb6-6702-4a1c-85a3-9df7b101d3bc&#39;</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
        <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">2</span>
               <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">2326d3ff</span><span class="tok-o">-</span><span class="tok-n">e90d</span><span class="tok-o">-</span><span class="tok-n">43f0</span><span class="tok-o">-</span><span class="tok-n">b611</span><span class="tok-o">-</span><span class="tok-n">6c028bb88c71</span>
             <span class="tok-k">type</span><span class="tok-o">:</span> <span class="tok-n">RECURRING</span>
       <span class="tok-n">invoice_id</span><span class="tok-o">:</span> <span class="tok-n">fa759cb6</span><span class="tok-o">-</span><span class="tok-mi">6702</span><span class="tok-o">-</span><span class="tok-n">4a1c</span><span class="tok-o">-</span><span class="tok-n">85a3</span><span class="tok-o">-</span><span class="tok-n">9df7b101d3bc</span>
       <span class="tok-n">account_id</span><span class="tok-o">:</span> <span class="tok-mf">8e4</span><span class="tok-n">f353f</span><span class="tok-o">-</span><span class="tok-n">ddbb</span><span class="tok-o">-</span><span class="tok-mi">4155</span><span class="tok-o">-</span><span class="tok-n">b52d</span><span class="tok-o">-</span><span class="tok-n">9fe77b8e96e3</span>
 <span class="tok-n">child_account_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
        <span class="tok-n">bundle_id</span><span class="tok-o">:</span> <span class="tok-n">a7a1370e</span><span class="tok-o">-</span><span class="tok-n">1fa4</span><span class="tok-o">-</span><span class="tok-n">4c32</span><span class="tok-o">-</span><span class="tok-n">abd5</span><span class="tok-o">-</span><span class="tok-mf">223e1</span><span class="tok-n">da97339</span>
  <span class="tok-n">subscription_id</span><span class="tok-o">:</span> <span class="tok-n">d9c7bb57</span><span class="tok-o">-</span><span class="tok-mf">675e-4419</span><span class="tok-o">-</span><span class="tok-n">a340</span><span class="tok-o">-</span><span class="tok-n">5f6b4fd612f4</span>
      <span class="tok-k">description</span><span class="tok-o">:</span> <span class="tok-n">shotgun</span><span class="tok-o">-</span><span class="tok-n">monthly</span><span class="tok-o">-</span><span class="tok-n">evergreen</span>
        <span class="tok-n">plan_name</span><span class="tok-o">:</span> <span class="tok-n">shotgun</span><span class="tok-o">-</span><span class="tok-n">monthly</span>
       <span class="tok-n">phase_name</span><span class="tok-o">:</span> <span class="tok-n">shotgun</span><span class="tok-o">-</span><span class="tok-n">monthly</span><span class="tok-o">-</span><span class="tok-n">evergreen</span>
       <span class="tok-n">usage_name</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">start_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">01</span>
         <span class="tok-n">end_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">06</span><span class="tok-o">-</span><span class="tok-mi">01</span>
           <span class="tok-n">amount</span><span class="tok-o">:</span> <span class="tok-mf">249.950000000</span>
             <span class="tok-n">rate</span><span class="tok-o">:</span> <span class="tok-mf">249.950000000</span>
         <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
   <span class="tok-n">linked_item_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">SubscriptionBaseTransition</span>
     <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">14</span><span class="tok-o">:</span><span class="tok-mi">43</span>
<span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
 <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-o">***************************</span> <span class="tok-mf">2.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
        <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">3</span>
               <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">aadfc291</span><span class="tok-o">-</span><span class="tok-mi">0981</span><span class="tok-o">-</span><span class="tok-mf">4e20</span><span class="tok-o">-</span><span class="tok-n">b231</span><span class="tok-o">-</span><span class="tok-n">8ae047e5514b</span>
             <span class="tok-k">type</span><span class="tok-o">:</span> <span class="tok-n">ITEM_ADJ</span>
       <span class="tok-n">invoice_id</span><span class="tok-o">:</span> <span class="tok-n">fa759cb6</span><span class="tok-o">-</span><span class="tok-mi">6702</span><span class="tok-o">-</span><span class="tok-n">4a1c</span><span class="tok-o">-</span><span class="tok-n">85a3</span><span class="tok-o">-</span><span class="tok-n">9df7b101d3bc</span>
       <span class="tok-n">account_id</span><span class="tok-o">:</span> <span class="tok-mf">8e4</span><span class="tok-n">f353f</span><span class="tok-o">-</span><span class="tok-n">ddbb</span><span class="tok-o">-</span><span class="tok-mi">4155</span><span class="tok-o">-</span><span class="tok-n">b52d</span><span class="tok-o">-</span><span class="tok-n">9fe77b8e96e3</span>
 <span class="tok-n">child_account_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
        <span class="tok-n">bundle_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
  <span class="tok-n">subscription_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
      <span class="tok-k">description</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
        <span class="tok-n">plan_name</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">phase_name</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">usage_name</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">start_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span>
         <span class="tok-n">end_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span>
           <span class="tok-n">amount</span><span class="tok-o">:</span> <span class="tok-o">-</span><span class="tok-mf">10.000000000</span>
             <span class="tok-n">rate</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
         <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
   <span class="tok-n">linked_item_id</span><span class="tok-o">:</span> <span class="tok-n">2326d3ff</span><span class="tok-o">-</span><span class="tok-n">e90d</span><span class="tok-o">-</span><span class="tok-n">43f0</span><span class="tok-o">-</span><span class="tok-n">b611</span><span class="tok-o">-</span><span class="tok-n">6c028bb88c71</span>
       <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">kaui</span><span class="tok-o">-</span><span class="tok-n">through</span><span class="tok-o">-</span><span class="tok-n">http</span><span class="tok-o">-</span><span class="tok-k">client</span>
     <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">15</span><span class="tok-o">:</span><span class="tok-mi">25</span>
<span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
 <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">2</span> <span class="tok-k">rows</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.01</span> <span class="tok-n">sec</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Note that the refund would have actually happened first and the <code>invoice_items</code> and <code>invoice_payments</code> tables would have been updated upon success.</p></div>
<div class="paragraph"><p>Here is the state of the payment related tables:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="mysql"><span></span><span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">invoice_payments</span> <span class="tok-k">where</span> <span class="tok-n">record_id</span> <span class="tok-o">&gt;</span> <span class="tok-mi">2</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
                <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">3</span>
                       <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">35159bde</span><span class="tok-o">-</span><span class="tok-n">7bf0</span><span class="tok-o">-</span><span class="tok-n">4b77</span><span class="tok-o">-</span><span class="tok-n">a506</span><span class="tok-o">-</span><span class="tok-n">43aa1f37a29d</span>
                     <span class="tok-k">type</span><span class="tok-o">:</span> <span class="tok-n">REFUND</span>
               <span class="tok-n">invoice_id</span><span class="tok-o">:</span> <span class="tok-n">fa759cb6</span><span class="tok-o">-</span><span class="tok-mi">6702</span><span class="tok-o">-</span><span class="tok-n">4a1c</span><span class="tok-o">-</span><span class="tok-n">85a3</span><span class="tok-o">-</span><span class="tok-n">9df7b101d3bc</span>
               <span class="tok-n">payment_id</span><span class="tok-o">:</span> <span class="tok-n">b0e61973</span><span class="tok-o">-</span><span class="tok-n">a921</span><span class="tok-o">-</span><span class="tok-n">413d</span><span class="tok-o">-</span><span class="tok-n">a04b</span><span class="tok-o">-</span><span class="tok-mf">84e36</span><span class="tok-n">e3ad6bf</span>
             <span class="tok-n">payment_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">15</span><span class="tok-o">:</span><span class="tok-mi">25</span>
                   <span class="tok-n">amount</span><span class="tok-o">:</span> <span class="tok-o">-</span><span class="tok-mf">10.000000000</span>
                 <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
       <span class="tok-n">processed_currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
        <span class="tok-n">payment_cookie_id</span><span class="tok-o">:</span> <span class="tok-n">212ce168</span><span class="tok-o">-</span><span class="tok-mf">526e-4</span><span class="tok-n">f23</span><span class="tok-o">-</span><span class="tok-n">85a5</span><span class="tok-o">-</span><span class="tok-n">ffaa67b189a8</span>
<span class="tok-n">linked_invoice_payment_id</span><span class="tok-o">:</span> <span class="tok-n">e6e534e1</span><span class="tok-o">-</span><span class="tok-n">2ffa</span><span class="tok-o">-</span><span class="tok-n">4d5e</span><span class="tok-o">-</span><span class="tok-n">bcac</span><span class="tok-o">-</span><span class="tok-n">6905d4d26f61</span>
                  <span class="tok-n">success</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
               <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">kaui</span><span class="tok-o">-</span><span class="tok-n">through</span><span class="tok-o">-</span><span class="tok-n">http</span><span class="tok-o">-</span><span class="tok-k">client</span>
             <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">15</span><span class="tok-o">:</span><span class="tok-mi">25</span>
        <span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
         <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">1</span> <span class="tok-k">row</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span>

<span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">payment_attempts</span> <span class="tok-k">where</span> <span class="tok-n">record_id</span> <span class="tok-o">&gt;</span> <span class="tok-mi">2</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
               <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">3</span>
                      <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-mf">45e7</span><span class="tok-n">adfc</span><span class="tok-o">-</span><span class="tok-mi">7549</span><span class="tok-o">-</span><span class="tok-n">4f81</span><span class="tok-o">-</span><span class="tok-mi">8562</span><span class="tok-o">-</span><span class="tok-n">8c6907485275</span>
              <span class="tok-n">account_id</span><span class="tok-o">:</span> <span class="tok-mf">8e4</span><span class="tok-n">f353f</span><span class="tok-o">-</span><span class="tok-n">ddbb</span><span class="tok-o">-</span><span class="tok-mi">4155</span><span class="tok-o">-</span><span class="tok-n">b52d</span><span class="tok-o">-</span><span class="tok-n">9fe77b8e96e3</span>
       <span class="tok-n">payment_method_id</span><span class="tok-o">:</span> <span class="tok-n">c046e5be</span><span class="tok-o">-</span><span class="tok-n">e632</span><span class="tok-o">-</span><span class="tok-n">444a</span><span class="tok-o">-</span><span class="tok-n">905f</span><span class="tok-o">-</span><span class="tok-n">c4bc0c5c0086</span>
    <span class="tok-n">payment_external_key</span><span class="tok-o">:</span> <span class="tok-n">d04ce5ad</span><span class="tok-o">-</span><span class="tok-n">e667</span><span class="tok-o">-</span><span class="tok-mi">4113</span><span class="tok-o">-</span><span class="tok-n">8eb3</span><span class="tok-o">-</span><span class="tok-n">6d7f87f92bca</span>
          <span class="tok-n">transaction_id</span><span class="tok-o">:</span> <span class="tok-n">0d6b12b6</span><span class="tok-o">-</span><span class="tok-n">b54a</span><span class="tok-o">-</span><span class="tok-mi">4092</span><span class="tok-o">-</span><span class="tok-n">a977</span><span class="tok-o">-</span><span class="tok-n">9d950214d4e4</span>
<span class="tok-n">transaction_external_key</span><span class="tok-o">:</span> <span class="tok-n">212ce168</span><span class="tok-o">-</span><span class="tok-mf">526e-4</span><span class="tok-n">f23</span><span class="tok-o">-</span><span class="tok-n">85a5</span><span class="tok-o">-</span><span class="tok-n">ffaa67b189a8</span>
        <span class="tok-n">transaction_type</span><span class="tok-o">:</span> <span class="tok-n">REFUND</span>
              <span class="tok-n">state_name</span><span class="tok-o">:</span> <span class="tok-n">SUCCESS</span>
                  <span class="tok-n">amount</span><span class="tok-o">:</span> <span class="tok-mf">10.000000000</span>
                <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
             <span class="tok-n">plugin_name</span><span class="tok-o">:</span> <span class="tok-n">__INVOICE_PAYMENT_CONTROL_PLUGIN__</span>
       <span class="tok-n">plugin_properties</span><span class="tok-o">:</span> <span class="tok-n">ZV</span> <span class="tok-n">j</span> <span class="tok-n">s</span><span class="tok-err">[{</span><span class="tok-s2">&quot;IPCD_REFUND_WITH_ADJUSTMENTS:&quot;</span><span class="tok-no">true</span><span class="tok-s2">&quot;},�&#39;IDS_AMOU`&quot;</span><span class="tok-err">{</span><span class="tok-s2">&quot;2326d3ff-e90d-43f0-b611-6c028bb88c71&quot;</span><span class="tok-o">:</span><span class="tok-no">null</span><span class="tok-err">}}]</span>
              <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">kaui</span><span class="tok-o">-</span><span class="tok-n">through</span><span class="tok-o">-</span><span class="tok-n">http</span><span class="tok-o">-</span><span class="tok-k">client</span>
            <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">15</span><span class="tok-o">:</span><span class="tok-mi">25</span>
              <span class="tok-n">updated_by</span><span class="tok-o">:</span> <span class="tok-n">kaui</span><span class="tok-o">-</span><span class="tok-n">through</span><span class="tok-o">-</span><span class="tok-n">http</span><span class="tok-o">-</span><span class="tok-k">client</span>
            <span class="tok-n">updated_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">15</span><span class="tok-o">:</span><span class="tok-mi">25</span>
       <span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
        <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">1</span> <span class="tok-k">row</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span>

<span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">payments</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
              <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
                     <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">b0e61973</span><span class="tok-o">-</span><span class="tok-n">a921</span><span class="tok-o">-</span><span class="tok-n">413d</span><span class="tok-o">-</span><span class="tok-n">a04b</span><span class="tok-o">-</span><span class="tok-mf">84e36</span><span class="tok-n">e3ad6bf</span>
             <span class="tok-n">account_id</span><span class="tok-o">:</span> <span class="tok-mf">8e4</span><span class="tok-n">f353f</span><span class="tok-o">-</span><span class="tok-n">ddbb</span><span class="tok-o">-</span><span class="tok-mi">4155</span><span class="tok-o">-</span><span class="tok-n">b52d</span><span class="tok-o">-</span><span class="tok-n">9fe77b8e96e3</span>
      <span class="tok-n">payment_method_id</span><span class="tok-o">:</span> <span class="tok-n">c046e5be</span><span class="tok-o">-</span><span class="tok-n">e632</span><span class="tok-o">-</span><span class="tok-n">444a</span><span class="tok-o">-</span><span class="tok-n">905f</span><span class="tok-o">-</span><span class="tok-n">c4bc0c5c0086</span>
           <span class="tok-n">external_key</span><span class="tok-o">:</span> <span class="tok-n">d04ce5ad</span><span class="tok-o">-</span><span class="tok-n">e667</span><span class="tok-o">-</span><span class="tok-mi">4113</span><span class="tok-o">-</span><span class="tok-n">8eb3</span><span class="tok-o">-</span><span class="tok-n">6d7f87f92bca</span>
             <span class="tok-n">state_name</span><span class="tok-o">:</span> <span class="tok-n">REFUND_SUCCESS</span>
<span class="tok-n">last_success_state_name</span><span class="tok-o">:</span> <span class="tok-n">REFUND_SUCCESS</span>
             <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">PaymentRequestProcessor</span>
           <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">14</span><span class="tok-o">:</span><span class="tok-mi">44</span>
             <span class="tok-n">updated_by</span><span class="tok-o">:</span> <span class="tok-n">kaui</span><span class="tok-o">-</span><span class="tok-n">through</span><span class="tok-o">-</span><span class="tok-n">http</span><span class="tok-o">-</span><span class="tok-k">client</span>
           <span class="tok-n">updated_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">15</span><span class="tok-o">:</span><span class="tok-mi">25</span>
      <span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
       <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">1</span> <span class="tok-k">row</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span>

<span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">payment_transactions</span> <span class="tok-k">where</span> <span class="tok-n">record_id</span> <span class="tok-o">&gt;</span> <span class="tok-mi">1</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
               <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">2</span>
                      <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">0d6b12b6</span><span class="tok-o">-</span><span class="tok-n">b54a</span><span class="tok-o">-</span><span class="tok-mi">4092</span><span class="tok-o">-</span><span class="tok-n">a977</span><span class="tok-o">-</span><span class="tok-n">9d950214d4e4</span>
              <span class="tok-n">attempt_id</span><span class="tok-o">:</span> <span class="tok-mf">45e7</span><span class="tok-n">adfc</span><span class="tok-o">-</span><span class="tok-mi">7549</span><span class="tok-o">-</span><span class="tok-n">4f81</span><span class="tok-o">-</span><span class="tok-mi">8562</span><span class="tok-o">-</span><span class="tok-n">8c6907485275</span>
<span class="tok-n">transaction_external_key</span><span class="tok-o">:</span> <span class="tok-n">212ce168</span><span class="tok-o">-</span><span class="tok-mf">526e-4</span><span class="tok-n">f23</span><span class="tok-o">-</span><span class="tok-n">85a5</span><span class="tok-o">-</span><span class="tok-n">ffaa67b189a8</span>
        <span class="tok-n">transaction_type</span><span class="tok-o">:</span> <span class="tok-n">REFUND</span>
          <span class="tok-n">effective_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">15</span><span class="tok-o">:</span><span class="tok-mi">25</span>
      <span class="tok-n">transaction_status</span><span class="tok-o">:</span> <span class="tok-n">SUCCESS</span>
                  <span class="tok-n">amount</span><span class="tok-o">:</span> <span class="tok-mf">10.000000000</span>
                <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
        <span class="tok-n">processed_amount</span><span class="tok-o">:</span> <span class="tok-mf">10.000000000</span>
      <span class="tok-n">processed_currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
              <span class="tok-n">payment_id</span><span class="tok-o">:</span> <span class="tok-n">b0e61973</span><span class="tok-o">-</span><span class="tok-n">a921</span><span class="tok-o">-</span><span class="tok-n">413d</span><span class="tok-o">-</span><span class="tok-n">a04b</span><span class="tok-o">-</span><span class="tok-mf">84e36</span><span class="tok-n">e3ad6bf</span>
      <span class="tok-n">gateway_error_code</span><span class="tok-o">:</span>
       <span class="tok-n">gateway_error_msg</span><span class="tok-o">:</span>
              <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">kaui</span><span class="tok-o">-</span><span class="tok-n">through</span><span class="tok-o">-</span><span class="tok-n">http</span><span class="tok-o">-</span><span class="tok-k">client</span>
            <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">15</span><span class="tok-o">:</span><span class="tok-mi">25</span>
              <span class="tok-n">updated_by</span><span class="tok-o">:</span> <span class="tok-n">kaui</span><span class="tok-o">-</span><span class="tok-n">through</span><span class="tok-o">-</span><span class="tok-n">http</span><span class="tok-o">-</span><span class="tok-k">client</span>
            <span class="tok-n">updated_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">15</span><span class="tok-o">:</span><span class="tok-mi">25</span>
       <span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
        <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">1</span> <span class="tok-k">row</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>A few things to notice:</p></div>
<div class="ulist"><ul><li><p>There is a new <code>invoice_payments</code> entry of type <code>REFUND</code>, linking to the attempt through <code>linked_invoice_payment_id</code></p></li><li><p>There is still a single <code>payments</code> entry, but the state is now <code>REFUND_SUCCESS</code></p></li><li><p>The payment has an additional <code>payment_transactions</code> entry of type <code>REFUND</code>, linking to a new <code>payment_attempts</code> entry</p></li></ul></div></div></div></div>
<div class="sect1"><h2 id="_change_plan">Change plan</h2><div class="sectionbody"><div class="paragraph"><p>Let&#8217;s assume the user changes on 2012-05-02 to the blowdart-monthly plan.</p></div>
<div class="paragraph"><p>The plan is defined as follows:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="xml"><span></span><span class="tok-nt">&lt;plan</span> <span class="tok-na">name=</span><span class="tok-s">&quot;blowdart-monthly&quot;</span><span class="tok-nt">&gt;</span>
    <span class="tok-nt">&lt;product&gt;</span>Blowdart<span class="tok-nt">&lt;/product&gt;</span>
    <span class="tok-nt">&lt;initialPhases&gt;</span>
        <span class="tok-nt">&lt;phase</span> <span class="tok-na">type=</span><span class="tok-s">&quot;TRIAL&quot;</span><span class="tok-nt">&gt;</span>
            <span class="tok-nt">&lt;duration&gt;</span>
                <span class="tok-nt">&lt;unit&gt;</span>DAYS<span class="tok-nt">&lt;/unit&gt;</span>
                <span class="tok-nt">&lt;number&gt;</span>30<span class="tok-nt">&lt;/number&gt;</span>
            <span class="tok-nt">&lt;/duration&gt;</span>
        <span class="tok-nt">&lt;/phase&gt;</span>
        <span class="tok-nt">&lt;phase</span> <span class="tok-na">type=</span><span class="tok-s">&quot;DISCOUNT&quot;</span><span class="tok-nt">&gt;</span>
            <span class="tok-nt">&lt;duration&gt;</span>
                <span class="tok-nt">&lt;unit&gt;</span>MONTHS<span class="tok-nt">&lt;/unit&gt;</span>
                <span class="tok-nt">&lt;number&gt;</span>6<span class="tok-nt">&lt;/number&gt;</span>
            <span class="tok-nt">&lt;/duration&gt;</span>
            <span class="tok-nt">&lt;recurring&gt;</span>
                <span class="tok-nt">&lt;billingPeriod&gt;</span>MONTHLY<span class="tok-nt">&lt;/billingPeriod&gt;</span>
                <span class="tok-nt">&lt;recurringPrice&gt;</span>
                    <span class="tok-nt">&lt;price&gt;</span>
                        <span class="tok-nt">&lt;currency&gt;</span>USD<span class="tok-nt">&lt;/currency&gt;</span>
                        <span class="tok-nt">&lt;value&gt;</span>9.95<span class="tok-nt">&lt;/value&gt;</span>
                    <span class="tok-nt">&lt;/price&gt;</span>
                <span class="tok-nt">&lt;/recurringPrice&gt;</span>
            <span class="tok-nt">&lt;/recurring&gt;</span>
        <span class="tok-nt">&lt;/phase&gt;</span>
    <span class="tok-nt">&lt;/initialPhases&gt;</span>
    <span class="tok-nt">&lt;finalPhase</span> <span class="tok-na">type=</span><span class="tok-s">&quot;EVERGREEN&quot;</span><span class="tok-nt">&gt;</span>
        <span class="tok-nt">&lt;duration&gt;</span>
            <span class="tok-nt">&lt;unit&gt;</span>UNLIMITED<span class="tok-nt">&lt;/unit&gt;</span>
        <span class="tok-nt">&lt;/duration&gt;</span>
        <span class="tok-nt">&lt;recurring&gt;</span>
            <span class="tok-nt">&lt;billingPeriod&gt;</span>MONTHLY<span class="tok-nt">&lt;/billingPeriod&gt;</span>
            <span class="tok-nt">&lt;recurringPrice&gt;</span>
                <span class="tok-nt">&lt;price&gt;</span>
                    <span class="tok-nt">&lt;currency&gt;</span>USD<span class="tok-nt">&lt;/currency&gt;</span>
                    <span class="tok-nt">&lt;value&gt;</span>29.95<span class="tok-nt">&lt;/value&gt;</span>
                <span class="tok-nt">&lt;/price&gt;</span>
            <span class="tok-nt">&lt;/recurringPrice&gt;</span>
        <span class="tok-nt">&lt;/recurring&gt;</span>
    <span class="tok-nt">&lt;/finalPhase&gt;</span>
<span class="tok-nt">&lt;/plan&gt;</span></code></pre></div></div>
<div class="paragraph"><p>For this scenario, we assume a <code>START_OF_SUBSCRIPTION</code> change alignment. Conceptually, the timeline for the subscriptions are as follows:</p></div>
<div class="ulist"><ul><li><p>shotgun-monthly:  <code>[TRIAL 2012-04-01 &#8594; 2012-05-01][EVERGREEN 2012-05-01 &#8594; &#8230;&#8203;]</code></p></li><li><p>blowdart-monthly: <code>[TRIAL 2012-04-01 &#8594; 2012-05-01][DISCOUNT 2012-05-01 &#8594; 2012-11-01][EVERGREEN 2012-11-01 &#8594; &#8230;&#8203;]</code></p></li></ul></div>
<div class="paragraph"><p>With a <code>START_OF_SUBSCRIPTION</code> change alignment, both timelines align on the start of the subscription (2012-04-01). On 2012-05-02, the target phase is hence the <code>DISCOUNT</code> one. If we had chosen a <code>CHANGE_OF_PLAN</code> alignment instead, the <code>blowdart-monthly</code> timeline would have been aligned on the date of the change (2012-05-02) and the target phase would have been the <code>TRIAL</code> one.</p></div>
<div class="paragraph"><p>Two new subscription events are recorded, one for the change and one for the future phase change:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="mysql"><span></span><span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">subscription_events</span> <span class="tok-k">where</span> <span class="tok-n">record_id</span> <span class="tok-o">&gt;</span> <span class="tok-mi">2</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
              <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">3</span>
                     <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">c3a87783</span><span class="tok-o">-</span><span class="tok-n">b6fc</span><span class="tok-o">-</span><span class="tok-n">41bd</span><span class="tok-o">-</span><span class="tok-n">acc9</span><span class="tok-o">-</span><span class="tok-n">130aba08dc5c</span>
             <span class="tok-n">event_type</span><span class="tok-o">:</span> <span class="tok-n">API_USER</span>
              <span class="tok-n">user_type</span><span class="tok-o">:</span> <span class="tok-k">CHANGE</span>
         <span class="tok-n">effective_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">37</span><span class="tok-o">:</span><span class="tok-mi">59</span>
        <span class="tok-n">subscription_id</span><span class="tok-o">:</span> <span class="tok-n">d9c7bb57</span><span class="tok-o">-</span><span class="tok-mf">675e-4419</span><span class="tok-o">-</span><span class="tok-n">a340</span><span class="tok-o">-</span><span class="tok-n">5f6b4fd612f4</span>
              <span class="tok-n">plan_name</span><span class="tok-o">:</span> <span class="tok-n">blowdart</span><span class="tok-o">-</span><span class="tok-n">monthly</span>
             <span class="tok-n">phase_name</span><span class="tok-o">:</span> <span class="tok-n">blowdart</span><span class="tok-o">-</span><span class="tok-n">monthly</span><span class="tok-o">-</span><span class="tok-n">discount</span>
        <span class="tok-n">price_list_name</span><span class="tok-o">:</span> <span class="tok-k">DEFAULT</span>
<span class="tok-n">billing_cycle_day_local</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
              <span class="tok-n">is_active</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
             <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">website</span><span class="tok-o">-</span><span class="tok-n">through</span><span class="tok-o">-</span><span class="tok-n">http</span><span class="tok-o">-</span><span class="tok-k">client</span>
           <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">37</span><span class="tok-o">:</span><span class="tok-mi">59</span>
             <span class="tok-n">updated_by</span><span class="tok-o">:</span> <span class="tok-n">website</span><span class="tok-o">-</span><span class="tok-n">through</span><span class="tok-o">-</span><span class="tok-n">http</span><span class="tok-o">-</span><span class="tok-k">client</span>
           <span class="tok-n">updated_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">37</span><span class="tok-o">:</span><span class="tok-mi">59</span>
      <span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
       <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-o">***************************</span> <span class="tok-mf">2.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
              <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">4</span>
                     <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">0f448b11</span><span class="tok-o">-</span><span class="tok-n">b705</span><span class="tok-o">-</span><span class="tok-mi">4074</span><span class="tok-o">-</span><span class="tok-n">b6a6</span><span class="tok-o">-</span><span class="tok-n">ecc62cc2b305</span>
             <span class="tok-n">event_type</span><span class="tok-o">:</span> <span class="tok-k">PHASE</span>
              <span class="tok-n">user_type</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
         <span class="tok-n">effective_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">11</span><span class="tok-o">-</span><span class="tok-mi">01</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">01</span><span class="tok-o">:</span><span class="tok-mi">14</span>
        <span class="tok-n">subscription_id</span><span class="tok-o">:</span> <span class="tok-n">d9c7bb57</span><span class="tok-o">-</span><span class="tok-mf">675e-4419</span><span class="tok-o">-</span><span class="tok-n">a340</span><span class="tok-o">-</span><span class="tok-n">5f6b4fd612f4</span>
              <span class="tok-n">plan_name</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
             <span class="tok-n">phase_name</span><span class="tok-o">:</span> <span class="tok-n">blowdart</span><span class="tok-o">-</span><span class="tok-n">monthly</span><span class="tok-o">-</span><span class="tok-n">evergreen</span>
        <span class="tok-n">price_list_name</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
<span class="tok-n">billing_cycle_day_local</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
              <span class="tok-n">is_active</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
             <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">website</span><span class="tok-o">-</span><span class="tok-n">through</span><span class="tok-o">-</span><span class="tok-n">http</span><span class="tok-o">-</span><span class="tok-k">client</span>
           <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">37</span><span class="tok-o">:</span><span class="tok-mi">59</span>
             <span class="tok-n">updated_by</span><span class="tok-o">:</span> <span class="tok-n">website</span><span class="tok-o">-</span><span class="tok-n">through</span><span class="tok-o">-</span><span class="tok-n">http</span><span class="tok-o">-</span><span class="tok-k">client</span>
           <span class="tok-n">updated_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">37</span><span class="tok-o">:</span><span class="tok-mi">59</span>
      <span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
       <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">2</span> <span class="tok-k">rows</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>And a new invoice is generated with 3 items:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="mysql"><span></span><span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">invoices</span> <span class="tok-k">order</span> <span class="tok-k">by</span> <span class="tok-n">record_id</span> <span class="tok-k">desc</span> <span class="tok-k">limit</span> <span class="tok-mi">1</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
        <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">3</span>
               <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">742a1a60</span><span class="tok-o">-</span><span class="tok-n">58f8</span><span class="tok-o">-</span><span class="tok-n">4ed2</span><span class="tok-o">-</span><span class="tok-n">b9db</span><span class="tok-o">-</span><span class="tok-n">b1816a741f44</span>
       <span class="tok-n">account_id</span><span class="tok-o">:</span> <span class="tok-mf">8e4</span><span class="tok-n">f353f</span><span class="tok-o">-</span><span class="tok-n">ddbb</span><span class="tok-o">-</span><span class="tok-mi">4155</span><span class="tok-o">-</span><span class="tok-n">b52d</span><span class="tok-o">-</span><span class="tok-n">9fe77b8e96e3</span>
     <span class="tok-n">invoice_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span>
      <span class="tok-n">target_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span>
         <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
           <span class="tok-k">status</span><span class="tok-o">:</span> <span class="tok-k">COMMITTED</span>
         <span class="tok-n">migrated</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
   <span class="tok-n">parent_invoice</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
       <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">SubscriptionBaseTransition</span>
     <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">37</span><span class="tok-o">:</span><span class="tok-mi">59</span>
<span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
 <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">1</span> <span class="tok-k">row</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span>

<span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">invoice_items</span> <span class="tok-k">where</span> <span class="tok-n">record_id</span> <span class="tok-o">&gt;</span> <span class="tok-mi">4</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
        <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">5</span>
               <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">d6b71f66</span><span class="tok-o">-</span><span class="tok-n">d54a</span><span class="tok-o">-</span><span class="tok-n">4cfc</span><span class="tok-o">-</span><span class="tok-n">bb73</span><span class="tok-o">-</span><span class="tok-n">ba55c91d8429</span>
             <span class="tok-k">type</span><span class="tok-o">:</span> <span class="tok-n">RECURRING</span>
       <span class="tok-n">invoice_id</span><span class="tok-o">:</span> <span class="tok-n">742a1a60</span><span class="tok-o">-</span><span class="tok-n">58f8</span><span class="tok-o">-</span><span class="tok-n">4ed2</span><span class="tok-o">-</span><span class="tok-n">b9db</span><span class="tok-o">-</span><span class="tok-n">b1816a741f44</span>
       <span class="tok-n">account_id</span><span class="tok-o">:</span> <span class="tok-mf">8e4</span><span class="tok-n">f353f</span><span class="tok-o">-</span><span class="tok-n">ddbb</span><span class="tok-o">-</span><span class="tok-mi">4155</span><span class="tok-o">-</span><span class="tok-n">b52d</span><span class="tok-o">-</span><span class="tok-n">9fe77b8e96e3</span>
 <span class="tok-n">child_account_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
        <span class="tok-n">bundle_id</span><span class="tok-o">:</span> <span class="tok-n">a7a1370e</span><span class="tok-o">-</span><span class="tok-n">1fa4</span><span class="tok-o">-</span><span class="tok-n">4c32</span><span class="tok-o">-</span><span class="tok-n">abd5</span><span class="tok-o">-</span><span class="tok-mf">223e1</span><span class="tok-n">da97339</span>
  <span class="tok-n">subscription_id</span><span class="tok-o">:</span> <span class="tok-n">d9c7bb57</span><span class="tok-o">-</span><span class="tok-mf">675e-4419</span><span class="tok-o">-</span><span class="tok-n">a340</span><span class="tok-o">-</span><span class="tok-n">5f6b4fd612f4</span>
      <span class="tok-k">description</span><span class="tok-o">:</span> <span class="tok-n">blowdart</span><span class="tok-o">-</span><span class="tok-n">monthly</span><span class="tok-o">-</span><span class="tok-n">discount</span>
        <span class="tok-n">plan_name</span><span class="tok-o">:</span> <span class="tok-n">blowdart</span><span class="tok-o">-</span><span class="tok-n">monthly</span>
       <span class="tok-n">phase_name</span><span class="tok-o">:</span> <span class="tok-n">blowdart</span><span class="tok-o">-</span><span class="tok-n">monthly</span><span class="tok-o">-</span><span class="tok-n">discount</span>
       <span class="tok-n">usage_name</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">start_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span>
         <span class="tok-n">end_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">06</span><span class="tok-o">-</span><span class="tok-mi">01</span>
           <span class="tok-n">amount</span><span class="tok-o">:</span> <span class="tok-mf">9.630000000</span>
             <span class="tok-n">rate</span><span class="tok-o">:</span> <span class="tok-mf">9.950000000</span>
         <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
   <span class="tok-n">linked_item_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">SubscriptionBaseTransition</span>
     <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">37</span><span class="tok-o">:</span><span class="tok-mi">59</span>
<span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
 <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-o">***************************</span> <span class="tok-mf">2.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
        <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">6</span>
               <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">592d7318</span><span class="tok-o">-</span><span class="tok-n">8fea</span><span class="tok-o">-</span><span class="tok-mf">4e3</span><span class="tok-n">b</span><span class="tok-o">-</span><span class="tok-n">b843</span><span class="tok-o">-</span><span class="tok-n">f6d444857132</span>
             <span class="tok-k">type</span><span class="tok-o">:</span> <span class="tok-n">REPAIR_ADJ</span>
       <span class="tok-n">invoice_id</span><span class="tok-o">:</span> <span class="tok-n">742a1a60</span><span class="tok-o">-</span><span class="tok-n">58f8</span><span class="tok-o">-</span><span class="tok-n">4ed2</span><span class="tok-o">-</span><span class="tok-n">b9db</span><span class="tok-o">-</span><span class="tok-n">b1816a741f44</span>
       <span class="tok-n">account_id</span><span class="tok-o">:</span> <span class="tok-mf">8e4</span><span class="tok-n">f353f</span><span class="tok-o">-</span><span class="tok-n">ddbb</span><span class="tok-o">-</span><span class="tok-mi">4155</span><span class="tok-o">-</span><span class="tok-n">b52d</span><span class="tok-o">-</span><span class="tok-n">9fe77b8e96e3</span>
 <span class="tok-n">child_account_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
        <span class="tok-n">bundle_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
  <span class="tok-n">subscription_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
      <span class="tok-k">description</span><span class="tok-o">:</span> <span class="tok-n">Adjustment</span> <span class="tok-p">(</span><span class="tok-n">subscription</span> <span class="tok-k">change</span><span class="tok-p">)</span>
        <span class="tok-n">plan_name</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">phase_name</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">usage_name</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">start_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span>
         <span class="tok-n">end_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">06</span><span class="tok-o">-</span><span class="tok-mi">01</span>
           <span class="tok-n">amount</span><span class="tok-o">:</span> <span class="tok-o">-</span><span class="tok-mf">239.950000000</span>
             <span class="tok-n">rate</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
         <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
   <span class="tok-n">linked_item_id</span><span class="tok-o">:</span> <span class="tok-n">2326d3ff</span><span class="tok-o">-</span><span class="tok-n">e90d</span><span class="tok-o">-</span><span class="tok-n">43f0</span><span class="tok-o">-</span><span class="tok-n">b611</span><span class="tok-o">-</span><span class="tok-n">6c028bb88c71</span>
       <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">SubscriptionBaseTransition</span>
     <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">37</span><span class="tok-o">:</span><span class="tok-mi">59</span>
<span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
 <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-o">***************************</span> <span class="tok-mf">3.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
        <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">7</span>
               <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">3413d964</span><span class="tok-o">-</span><span class="tok-n">90d3</span><span class="tok-o">-</span><span class="tok-n">4aa0</span><span class="tok-o">-</span><span class="tok-n">8b0e</span><span class="tok-o">-</span><span class="tok-n">406d02eb231e</span>
             <span class="tok-k">type</span><span class="tok-o">:</span> <span class="tok-n">CBA_ADJ</span>
       <span class="tok-n">invoice_id</span><span class="tok-o">:</span> <span class="tok-n">742a1a60</span><span class="tok-o">-</span><span class="tok-n">58f8</span><span class="tok-o">-</span><span class="tok-n">4ed2</span><span class="tok-o">-</span><span class="tok-n">b9db</span><span class="tok-o">-</span><span class="tok-n">b1816a741f44</span>
       <span class="tok-n">account_id</span><span class="tok-o">:</span> <span class="tok-mf">8e4</span><span class="tok-n">f353f</span><span class="tok-o">-</span><span class="tok-n">ddbb</span><span class="tok-o">-</span><span class="tok-mi">4155</span><span class="tok-o">-</span><span class="tok-n">b52d</span><span class="tok-o">-</span><span class="tok-n">9fe77b8e96e3</span>
 <span class="tok-n">child_account_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
        <span class="tok-n">bundle_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
  <span class="tok-n">subscription_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
      <span class="tok-k">description</span><span class="tok-o">:</span> <span class="tok-n">Adjustment</span> <span class="tok-p">(</span><span class="tok-k">account</span> <span class="tok-n">credit</span><span class="tok-p">)</span>
        <span class="tok-n">plan_name</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">phase_name</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">usage_name</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">start_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span>
         <span class="tok-n">end_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span>
           <span class="tok-n">amount</span><span class="tok-o">:</span> <span class="tok-mf">230.320000000</span>
             <span class="tok-n">rate</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
         <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
   <span class="tok-n">linked_item_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
       <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">SubscriptionBaseTransition</span>
     <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">37</span><span class="tok-o">:</span><span class="tok-mi">59</span>
<span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
 <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">3</span> <span class="tok-k">rows</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>The <code>REPAIR_ADJ</code> item on the new invoice points to the <code>RECURRING</code> item on the second invoice that is being adjusted (repaired). The amount repaired is only $239.95 because of the previous item adjustment.</p></div>
<div class="paragraph"><p>Because the new rate is only $9.95, the account has extra credit of $239.95 - $9.63 (pro-rated) = $230.32 (new <code>CBA_ADJ</code> item).</p></div>
<div class="paragraph"><p>Note that the previous invoices have not been updated in that case.</p></div>
<div class="paragraph"><p>A new payment attempt is triggered, but aborted since the invoice balance is $0:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="mysql"><span></span><span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">invoice_payments</span> <span class="tok-k">order</span> <span class="tok-k">by</span> <span class="tok-n">record_id</span> <span class="tok-k">desc</span> <span class="tok-k">limit</span> <span class="tok-mi">1</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
                <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">3</span>
                       <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">e7f6b1d0</span><span class="tok-o">-</span><span class="tok-mi">3823</span><span class="tok-o">-</span><span class="tok-n">4c5b</span><span class="tok-o">-</span><span class="tok-mi">9226</span><span class="tok-o">-</span><span class="tok-n">12327af64492</span>
                     <span class="tok-k">type</span><span class="tok-o">:</span> <span class="tok-n">ATTEMPT</span>
               <span class="tok-n">invoice_id</span><span class="tok-o">:</span> <span class="tok-n">742a1a60</span><span class="tok-o">-</span><span class="tok-n">58f8</span><span class="tok-o">-</span><span class="tok-n">4ed2</span><span class="tok-o">-</span><span class="tok-n">b9db</span><span class="tok-o">-</span><span class="tok-n">b1816a741f44</span>
               <span class="tok-n">payment_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
             <span class="tok-n">payment_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">37</span><span class="tok-o">:</span><span class="tok-mi">59</span>
                   <span class="tok-n">amount</span><span class="tok-o">:</span> <span class="tok-mf">0.000000000</span>
                 <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
       <span class="tok-n">processed_currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
        <span class="tok-n">payment_cookie_id</span><span class="tok-o">:</span> <span class="tok-n">bac67833</span><span class="tok-o">-</span><span class="tok-n">ac7c</span><span class="tok-o">-</span><span class="tok-n">458d</span><span class="tok-o">-</span><span class="tok-mf">8e2</span><span class="tok-n">a</span><span class="tok-o">-</span><span class="tok-n">659c0cdfb0b6</span>
<span class="tok-n">linked_invoice_payment_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
                  <span class="tok-n">success</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
               <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">PaymentRequestProcessor</span>
             <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">37</span><span class="tok-o">:</span><span class="tok-mi">59</span>
        <span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
         <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">1</span> <span class="tok-k">row</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span>

<span class="tok-n">MySQL</span> <span class="tok-err">[</span><span class="tok-n">killbill</span><span class="tok-err">]</span><span class="tok-o">&gt;</span> <span class="tok-k">select</span> <span class="tok-o">*</span> <span class="tok-k">from</span> <span class="tok-n">payment_attempts</span> <span class="tok-k">order</span> <span class="tok-k">by</span> <span class="tok-n">record_id</span> <span class="tok-k">desc</span> <span class="tok-k">limit</span> <span class="tok-mi">1</span><span class="tok-err">\</span><span class="tok-n">G</span>
<span class="tok-o">***************************</span> <span class="tok-mf">1.</span> <span class="tok-k">row</span> <span class="tok-o">***************************</span>
               <span class="tok-n">record_id</span><span class="tok-o">:</span> <span class="tok-mi">3</span>
                      <span class="tok-n">id</span><span class="tok-o">:</span> <span class="tok-n">0703a3de</span><span class="tok-o">-</span><span class="tok-mi">9216</span><span class="tok-o">-</span><span class="tok-mi">4601</span><span class="tok-o">-</span><span class="tok-n">95cd</span><span class="tok-o">-</span><span class="tok-mf">8540e0687</span><span class="tok-n">bf5</span>
              <span class="tok-n">account_id</span><span class="tok-o">:</span> <span class="tok-mf">8e4</span><span class="tok-n">f353f</span><span class="tok-o">-</span><span class="tok-n">ddbb</span><span class="tok-o">-</span><span class="tok-mi">4155</span><span class="tok-o">-</span><span class="tok-n">b52d</span><span class="tok-o">-</span><span class="tok-n">9fe77b8e96e3</span>
       <span class="tok-n">payment_method_id</span><span class="tok-o">:</span> <span class="tok-n">c046e5be</span><span class="tok-o">-</span><span class="tok-n">e632</span><span class="tok-o">-</span><span class="tok-n">444a</span><span class="tok-o">-</span><span class="tok-n">905f</span><span class="tok-o">-</span><span class="tok-n">c4bc0c5c0086</span>
    <span class="tok-n">payment_external_key</span><span class="tok-o">:</span> <span class="tok-n">dff4c517</span><span class="tok-o">-</span><span class="tok-n">b229</span><span class="tok-o">-</span><span class="tok-mi">4796</span><span class="tok-o">-</span><span class="tok-n">afe2</span><span class="tok-o">-</span><span class="tok-n">112aa4ba35e5</span>
          <span class="tok-n">transaction_id</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
<span class="tok-n">transaction_external_key</span><span class="tok-o">:</span> <span class="tok-n">bac67833</span><span class="tok-o">-</span><span class="tok-n">ac7c</span><span class="tok-o">-</span><span class="tok-n">458d</span><span class="tok-o">-</span><span class="tok-mf">8e2</span><span class="tok-n">a</span><span class="tok-o">-</span><span class="tok-n">659c0cdfb0b6</span>
        <span class="tok-n">transaction_type</span><span class="tok-o">:</span> <span class="tok-n">PURCHASE</span>
              <span class="tok-n">state_name</span><span class="tok-o">:</span> <span class="tok-n">ABORTED</span>
                  <span class="tok-n">amount</span><span class="tok-o">:</span> <span class="tok-no">NULL</span>
                <span class="tok-n">currency</span><span class="tok-o">:</span> <span class="tok-n">USD</span>
             <span class="tok-n">plugin_name</span><span class="tok-o">:</span> <span class="tok-n">__INVOICE_PAYMENT_CONTROL_PLUGIN__</span>
       <span class="tok-n">plugin_properties</span><span class="tok-o">:</span> <span class="tok-n">ZV</span>  <span class="tok-o">&lt;</span><span class="tok-err">[{</span><span class="tok-s2">&quot;IPCD_INVOICE_ID&quot;</span><span class="tok-o">:</span><span class="tok-s2">&quot;742a1a60-58f8-4ed2-b9db-b1816a741f44&quot;</span><span class="tok-err">}]</span>
              <span class="tok-n">created_by</span><span class="tok-o">:</span> <span class="tok-n">PaymentRequestProcessor</span>
            <span class="tok-n">created_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">37</span><span class="tok-o">:</span><span class="tok-mi">59</span>
              <span class="tok-n">updated_by</span><span class="tok-o">:</span> <span class="tok-n">PaymentRequestProcessor</span>
            <span class="tok-n">updated_date</span><span class="tok-o">:</span> <span class="tok-mi">2012</span><span class="tok-o">-</span><span class="tok-mi">05</span><span class="tok-o">-</span><span class="tok-mi">02</span> <span class="tok-mi">00</span><span class="tok-o">:</span><span class="tok-mi">37</span><span class="tok-o">:</span><span class="tok-mi">59</span>
       <span class="tok-n">account_record_id</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
        <span class="tok-n">tenant_record_id</span><span class="tok-o">:</span> <span class="tok-mi">0</span>
<span class="tok-mi">1</span> <span class="tok-k">row</span> <span class="tok-k">in</span> <span class="tok-kt">set</span> <span class="tok-p">(</span><span class="tok-mf">0.00</span> <span class="tok-n">sec</span><span class="tok-p">)</span></code></pre></div></div></div></div>
<div class="sect1"><h2 id="_invoicing_internals">Invoicing internals</h2><div class="sectionbody"><div class="paragraph"><p>The invoice subsystem computes new invoices in several stages.</p></div>
<div class="paragraph"><p>First, it loads all existing invoices on disk for the account being processed, and creates a tree per subscription (<code>SubscriptionItemTree</code>) containing all of these invoice items. Each node in the tree represents all invoice items for a given service period. The service period of a parent node overlaps all service periods of its children.</p></div>
<div class="paragraph"><p>For example, let&#8217;s assume a subscription was billed in advance from 2012-05-01 to 2012-06-01, and a change plan occured on 2012-05-07. There would be 3 items on disk, one recurring for the first plan (2012-05-01 to 2012-06-01), a second recurring for the second plan (2012-05-07 to 2012-06-01) and a repair adjustment (from 2012-05-07 to 2012-06-01) associated with the initial item.</p></div>
<div class="paragraph"><p>The tree would look like this:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code><span></span>  A
 /
 B
/
C

A: [2012-05-01,2012-06-01]
B: [2012-05-01,2012-06-01](A)
C: [2012-05-07,2012-06-01](A,C)</code></pre></div></div>
<div class="paragraph"><p><code>A</code> is the root node, it doesn&#8217;t contain any item and the service period is the largest period containing all items in the tree. Node <code>B</code> represents the initial recurring period (the node has one <code>ADD</code>&#8201;&#8212;&#8201;or <code>A</code>&#8201;&#8212;&#8201;invoice item). <code>B</code> has one child node&#8201;&#8212;&#8201;<code>C</code>&#8201;&#8212;&#8201;which has two items, the <code>ADD</code> item representing the new recurring item, and the <code>CANCEL</code> item, pointing to the <code>ADD</code> item in the node <code>B</code>, representing the repair.</p></div>
<div class="paragraph"><p>The next step is to build the tree: resulting invoice items for each service period are computed and item adjustments processed (if any). In this case, 2 items would be generated (one from 2012-05-01 to 2012-05-07 and one from 2012-05-07 to 2012-06-01). The original tree is then replaced (flatten phase) by a shallow one containing these items (it&#8217;s really a list at this point):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code><span></span> A
/
Bc

A: [2012-05-01,2012-06-01]
B: [2012-05-01,2012-05-07](C)
c: [2012-05-07,2012-06-01](C)</code></pre></div></div>
<div class="paragraph"><p>The items already invoiced are also reversed and labeled as <code>C</code> (<code>CANCEL</code>) before the next step.</p></div>
<div class="paragraph"><p>Billing events are then processed and a list of proposed invoice items is generated. Each item will either be matched to an (existing) item in the flattened list, trigger a repair (in case of new change plan for instance) or kept as-is.</p></div>
<div class="paragraph"><p>For example, if a proposed <code>RECURRING</code> item from 2012-05-01 to 2012-05-07 is merged, the flattened list becomes:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code><span></span> A
/
Bc

A: [2012-05-01,2012-06-01]
B: [2012-05-01,2012-05-07]
c: [2012-05-07,2012-06-01](C)</code></pre></div></div>
<div class="paragraph"><p>Note that node <code>B</code> is empty now, the existing item has been removed (matched).</p></div>
<div class="paragraph"><p>If a change plan would occur on 2012-05-08 and a proposed <code>RECURRING</code> item from 2012-05-07 to 2012-05-08 is merged, the list would become:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code><span></span> A
/
B-c
 /
 D

A: [2012-05-01,2012-06-01]
B: [2012-05-01,2012-05-07]
c: [2012-05-07,2012-06-01](C)
D: [2012-05-07,2012-05-08](A)</code></pre></div></div>
<div class="paragraph"><p>A new node <code>D</code>, child of <code>c</code>, is inserted representing that period. After the <code>RECURRING</code> from 2012-05-08 to 2012-06-01 is merged, the list would be unchanged (no match found and no repair to create) and the <code>RECURRING</code> item kept on the side.</p></div>
<div class="paragraph"><p>Finally, one last time, the tree is built and the computed invoice items become the resulting items, i.e. the items for the resulting invoice. In our case, two items are generated: the <code>RECURRING</code> kept as-is (outside the tree), and a repair from 2012-05-08 to 2012-06-01.</p></div></div></div>
<div class="sect1"><h2 id="_keeping_invoices_in_draft_mode">Keeping invoices in DRAFT mode</h2><div class="sectionbody"><div class="paragraph"><p>In some situations, we would like Kill Bill to generate the invoices, but leave them in a <code>DRAFT</code> mode.</p></div>
<div class="paragraph"><p>Examples:</p></div>
<div class="ulist"><ul><li><p>Case where we need to append invoice items after generation</p></li><li><p>Case where we want payment system to ignore the invoice until it has been <code>COMMITTED</code></p></li></ul></div>
<div class="paragraph"><p>This behavior can be configured at the account level through the <code>AUTO_INVOICING_DRAFT</code> tag: when an <code>Account</code> is tagged with <code>AUTO_INVOICING_DRAFT</code>, any automatic invoice generated by the system (such as when generating invoices for recurring and usage subscriptions) will end up in <code>DRAFT</code> mode. Generating invoices through API calls (e.g. adding external charges) will not be affected by this tag.</p></div>
<div class="sect2"><h3 id="_implementation_expectation">Implementation expectation</h3><div class="paragraph"><p>Any <code>DRAFT</code> invoice containing <code>RECURRING</code> or <code>USAGE</code> items will be taken into consideration by the system when computing subsequent invoices, regardless of the <code>AUTO_INVOICING_DRAFT</code> tag.</p></div>
<div class="paragraph"><p>As an example, let&#8217;s assume a monthly recurring subscription billed on the 1st of the month:</p></div>
<div class="ulist"><ul><li><p><code>AUTO_INVOICING_DRAFT</code> is added</p></li><li><p>January 1st : <code>DRAFT</code> invoice generated with a <code>RECURRING</code> item from January 1st to February 1st</p></li><li><p><code>AUTO_INVOICING_DRAFT</code> is removed</p></li><li><p>February 1st : <code>COMMITTED</code> invoice generated with a <code>RECURRING</code> item from February 1st to March 1st&#8201;&#8212;&#8201;although the previous invoice has not been committed yet</p></li></ul></div>
<div class="paragraph"><p>In other words, the feature assumes that at some point such <code>DRAFT</code> invoices will be committed by the user. Not doing so will lead to users not being billed for those specific periods.</p></div></div>
<div class="sect2"><h3 id="_invoice_date">Invoice Date</h3><div class="paragraph"><p>The invoice date is the one from when the <code>DRAFT</code> invoice was generated&#8201;&#8212;&#8201;the date at which this invoice gets committed is not reflected. In particular, this may have some impact if the payment associated with such invoice fails, and dunning kicks-in: the <code>timeSinceEarliestUnpaidInvoiceEqualsOrExceeds</code>  overdue configuration option will be based on the original invoice creation date (<code>DRAFT</code>).</p></div></div></div></div>
<div class="sect1"><h2 id="_re_using_invoices_in_draft_mode">Re-using invoices in DRAFT mode</h2><div class="sectionbody"><div class="paragraph"><p>The account level <code>AUTO_INVOICING_REUSE_DRAFT</code> control tag will make the invoicing system reuse an existing <code>DRAFT</code> invoice instead of creating a new invoice when generating invoices for recurring and usage subscriptions, or when generating parent summary invoices:</p></div>
<div class="ulist"><ul><li><p>If there is no existing <code>DRAFT</code> invoice, the system would default to normal behavior and create a new invoice</p></li><li><p>If there is one existing <code>DRAFT</code> invoice, the system would use this <code>DRAFT</code> invoice instead of creating a new one</p></li><li><p>If there is more than one, the system will use the earliest <code>DRAFT</code> invoice</p></li></ul></div>
<div class="paragraph"><p>Similar to the <code>AUTO_INVOICING_DRAFT</code> feature, it is the responsibility of the user to to commit such <code>DRAFT</code> invoices.</p></div></div></div>
<div class="sect1"><h2 id="_parked_accounts">Parked Accounts</h2><div class="sectionbody"><div class="paragraph"><p>Because invoicing drives payments, any issue in the system or misconfiguration leading to wrong invoices could have a direct impact on your customers. In order to avoid bad invoicing (and potentially invalid customer payment) we have introduced a mechanism to PARK the accounts. Once an account has been parked, no more invoicing will happen until its state has been fixed (or until safety bounds have been removed). A account can become parked in the following scenarios:</p></div>
<div class="paragraph"><p>First, the system now has a safety bound mechanism on the upper limit of invoice items generated for a given subscription on a given day. This safety bound is controlled by a system property <code>org.killbill.invoice.maxDailyNumberOfItemsSafetyBound</code> whose default value is set to <code>15</code> but that can also be disabled by setting it to <code>-1</code>. The safety bound will kick-in if a customer tries to buy too many things during a single day or in situations where the customer has not been invoiced for a while and the system is catching up (could happen if the account was tagged with <code>AUTO_INVOICING_OFF</code> and the tag gets removed).</p></div>
<div class="paragraph"><p>Second, the invoicing system will automatically park an account when an illegal state is reached during invoicing. This could be because the data associated with the account looks corrupted (which could happen because of previous bugs that did corrupt the data, manual data manipulation, or existing bug in the system).</p></div>
<div class="paragraph"><p>The way to get out of that state is to fix the issue that led to that state in the first place and trigger a new invoice generation. If this issue arose because of a bug, fixing the issue may require voiding invoices creating the issues.</p></div>
<div class="paragraph"><p>For cases where there are many parked accounts, we have added an administrative <a href="https://killbill.github.io/slate/#admin-trigger-an-invoice-generation-for-all-parked-accounts">api</a> to go through all parked accounts and issue an invoice generation for each of those, only leaving in the parked state, accounts whose state has not been fixed yet. If you think the issue that led into that state is not a problem with the account state (data) but a bug in the system, please report to the <a href="https://groups.google.com/forum/#!forum/killbilling-users">mailing list</a>.</p></div></div></div>
<div class="sect1"><h2 id="_summary">Summary</h2><div class="sectionbody"><div class="paragraph"><p>The Kill Bill invoicing system generates invoices on a per account level based on some system trigger:</p></div>
<div class="ulist"><ul><li><p>Bus event: Those are usually subscription events like when a subscription starts, when there is a phase transition (trial &#8594; evergreen), upon plan change or cancellation (there are also other bus events in the system that could trigger an invoice generation, but not discussed for sake of simplicity).</p></li><li><p>Future notfications: The recurring piece of the invoiving is based on the invoice system inserting future notfications on the right date (so as to be called back at the right time and generate the next invoice).</p></li></ul></div>
<div class="paragraph"><p>Note also that invoice generation can be triggered through API but this is not the default use case.</p></div>
<div class="paragraph"><p>The computation of the next invoice (and matching invoice items) is based upon the following:</p></div>
<div class="ulist"><ul><li><p>A billing mode (e.g <code>IN_ADVANCE</code>)</p></li><li><p>A set of billing events (mostly aggregated across <code>subscritpion_events</code> and <code>blocking_states</code> tables)</p></li><li><p>A <code>targetDate</code> specifying upon which point to bill (and which billing events to consider)</p></li></ul></div>
<div class="paragraph"><p>The invoicing algorithm recomputes the full view at each invocation and compares the <strong>existing</strong> view on disk (what was already billed) with the new set of <strong>proposed</strong> items, and based on the difference generates the next invoice (or nothing if there is no change since the previous invocation). If a new invoice was generated, it also inserts a new future notification and updates the <code>chargedThroughDate</code> for all subscriptions.</p></div>
<div class="paragraph"><p>In terms of payments, the source of truth resides in the <code>payments</code> (and associated <code>payments_transactions</code>) tables. However, the payment view of the invoicing subsystem relies on the <code>invoice_payments</code> table and is used to compute things like invoice and account balance: The <code>invoice_payments</code> table is updated using a 2-phase commit algorithm where a row is first inserted with a <code>status</code> set to false and then upon payment completion is updated to <code>true</code>.</p></div></div></div></div></article></div><div class="bd-links-wrapper"><nav class="bd-links toc right-side-menu" id="toc" data-toggle="toc"></nav></div></div></div></main><script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script><script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script><script src="https://cdn.staticaly.com/gh/afeld/bootstrap-toc/v1.0.0/dist/bootstrap-toc.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script><script src="https://www.googletagmanager.com/gtag/js?id=G-C0HVJ1E78Z"></script><script>
    setTimeout(function(){
      $('.content-wrapper h2, .content-wrapper h3, .content-wrapper h4').append('<a href=""><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>');
      $('.content-wrapper h2, .content-wrapper h3, .content-wrapper h4').each(function(){
        let itemHref = '#' + $(this).attr('id');
        $(this).find('a').attr("href", itemHref);
      })
      $('.content-wrapper table').each(function() {
        $(this).wrap('<div class="table-wrap"></div>')
        $('.table-wrap').each(function() {
          if ($(this).find('table').width() > $(this).width()){
            $(this).css('max-width', '100%');
            $(this).css('overflow-x', 'scroll');
          }
        })
      })
      function copyToClipboard(text) {
        let sampleTextarea = document.createElement("textarea");
        document.body.appendChild(sampleTextarea);
        sampleTextarea.value = text;
        sampleTextarea.select();
        document.execCommand("copy");
        document.body.removeChild(sampleTextarea);
      }
      $('.content-wrapper h2 a, .content-wrapper h3 a, .content-wrapper h4 a').on('click', function(){
        setTimeout(function(){
          copyToClipboard($(location).attr("href"));
        }, 500);
      });
      $('.content-wrapper .note td.icon').append('<img src="https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/img/note-icon.png">');

      $('.content pre').parent('.content').prepend('<div class="copy-icon"><svg width="20" height="20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 3a1 1 0 0 1 1-1h2a1 1 0 1 1 0 2H9a1 1 0 0 1-1-1Z" fill="#78AECD"/><path d="M6 3a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2 3 3 0 0 1-3 3H9a3 3 0 0 1-3-3Z" fill="#78AECD"/></svg></div>');
      $('.copy-icon svg').on('click', function () {
        copyToClipboard($(this).parent().next().find('code').text());
      });
    }, 1000);

    $('.main').append('<div class="lightbox-modal"> <div id="close-ligtbox">✕</div> <div class="img"><img src="" alt=""></div></div><div class="overlay"></div>');
    $('.main img').on('click', function () {
      let path = $(this).attr('src');
      $('.lightbox-modal img').attr('src', path);
      $('.lightbox-modal, .overlay').show();
    });
    $('#close-ligtbox, .overlay').on('click',function () {
      $('.lightbox-modal, .overlay').hide();
    });

$('.sidebar-toggler').on('click', function () {
  $(this).toggleClass('active');
  $('main.main').toggleClass('sidebar-hide');
});

$('.content-wrapper a').filter(function() {
  return this.hostname && this.hostname !== location.hostname;
}).each(function() {
  $(this).attr({
    target: '_blank',
    title: 'Visit ' + this.href + ' (click to open in a new window)'
  });
});

  </script><script>docsearch({apiKey: '3ef227e7fd5e2e1a3fffd880484934bf', container: '#docsearch', appId: 'S2ISXITURI', indexName: 'killbill'});</script><script>window.dataLayer = window.dataLayer || [];
function gtag(){window.dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-C0HVJ1E78Z');</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create','UA-32705710-3','auto');
  ga('send','pageview');
  var getOutboundLink = function(url) {
    ga('send', {
      hitType: 'event',
      eventCategory: 'outbound',
      eventAction: 'click',
      eventLabel: url,
      hitCallback: function(){document.location = url;}
    });
  }</script></body></html>