<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]--><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="Asciidoctor 1.5.7.1"><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.0/dist/bootstrap-toc.min.css"><title>Plugin development</title><style>/*Default CSS*/

/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove the comments around the @import statement below when using this as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
#map_canvas img,#map_canvas embed,#map_canvas object,.map_canvas img,.map_canvas embed,.map_canvas object{max-width:none!important}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
.antialiased,body{-webkit-font-smoothing:antialiased}
img{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
    h1{font-size:2.75em}
    h2{font-size:2.3125em}
    h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
    h4{font-size:1.4375em}}table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{display:inline-block;color:rgba(0,0,0,.8);font-size:.75em;line-height:1.4;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:-.15em .15em 0 .15em;padding:.2em .6em .2em .5em;vertical-align:middle;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
    body.toc2{padding-left:15em;padding-right:0}
    #toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
    #toc.toc2 #toctitle{margin-top:0;font-size:1.2em}
    #toc.toc2>ul{font-size:.9em;margin-bottom:0}
    #toc.toc2 ul ul{margin-left:0;padding-left:1em}
    #toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
    body.toc2.toc-right{padding-left:0;padding-right:15em}
    body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
    #toc.toc2{width:20em}
    #toc.toc2 #toctitle{font-size:1.375em}
    #toc.toc2>ul{font-size:.95em}
    #toc.toc2 ul ul{padding-left:1.25em}
    body.toc2.toc-right{padding-left:0;padding-right:20em}}#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:#2E3336;padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.05em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.spread{width:100%}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1{padding-right:.75em;font-weight:bold}
td.hdlist1,td.hdlist2{vertical-align:top}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none}
span.footnote,span.footnoteref{vertical-align:super;font-size:.875em}
span.footnote a,span.footnoteref a{text-decoration:none}
span.footnote a:active,span.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em;line-height:1.3;font-size:.875em;margin-left:1.2em;text-indent:-1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
h1,h2{letter-spacing:-.01em}
dt,th.tableblock,td.content{text-rendering:optimizeLegibility}
p,td.content{letter-spacing:-.01em}
p strong,td.content strong{letter-spacing:-.005em}
p,blockquote,dt,td.content{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
    *{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
    a{color:inherit!important;text-decoration:underline!important}
    a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
    a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
    abbr[title]:after{content:" (" attr(title) ")"}
    pre,blockquote,tr,img{page-break-inside:avoid}
    thead{display:table-header-group}
    img{max-width:100%!important}
    p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
    h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
    #toc,.sidebarblock,.exampleblock>.content{background:none!important}
    #toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
    .sect1{padding-bottom:0!important}
    .sect1+.sect1{border:0!important}
    #header>h1:first-child{margin-top:1.25rem}
    body.book #header{text-align:center}
    body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
    body.book #header .details{border:0!important;display:block;padding:0!important}
    body.book #header .details span:first-child{margin-left:0!important}
    body.book #header .details br{display:block}
    body.book #header .details br+span:before{content:none!important}
    body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
    body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
    .listingblock code[data-lang]:before{display:block}
    #footer{background:none!important;padding:0 .9375em}
    #footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
    .hide-on-print{display:none!important}
    .print-only{display:block!important}
    .hide-for-print{display:none!important}
    .show-for-print{display:inherit!important}}

  .listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments  { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */

/*Custom CSS*/
.container{
    max-width: 100%;
}
.logo{
    margin-top: 5px;
}
.toc{
    margin-top: 45px;
}
#toctitle{
    font-size: 1.2em;
}
.sectlevel1{
    padding-left: 7px;
}
.border-columns{
    background-color: #2E3336;
}
.footer {
    display: block;
    bottom: 0;
    width: 75%;
    height: 40px;
    line-height: 40px;
    background-color: #2E3336;
    margin: 0 auto;
}
.footer > .container {
    padding-right: 15px;
    padding-left: 15px;
}
nav[data-toggle=toc] .nav>li>a {
    display: block;
    padding: 4px 20px;
    font-size: 13px;
    font-weight: 500;
    color: #fff;
}
nav[data-toggle=toc] .nav>li>a:hover {
    background-color: #1F7CB5;
    color: #fff;
}
.text-muted {
    color: #fff!important;
}
nav[data-toggle='toc'] {
    top: 80px;
}

nav[data-toggle=toc] .nav-link.active, nav[data-toggle=toc] .nav-link.active:focus, nav[data-toggle=toc] .nav-link.active:hover {
    padding-left: 18px;
    font-weight: 700;
    color: #1F7CB5;
    background-color: transparent;
    border-left: 2px solid #1F7CB5;
}

/* small screens */
@media (max-width: 768px) {
    /* override stickyness so that the navigation does not follow scrolling */
    nav[data-toggle='toc'] {
        margin-bottom: 42px;
        position: static;
    }
    nav[data-toggle='toc'] .nav .active .nav {
        display: none;
    }
}</style>
<style>.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments, .listingblock .pygments code { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */</style></head><body data-spy="scroll" data-target="#toc" class="book"><div class="container"><div class="row"><div id="header" class="col-sm-2 border-columns"><a href="/0.20/"><img class="logo rounded mx-auto d-block sticky-top" src="https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/img/logo.png"></a><nav id="toc" data-toggle="toc" class="toc sticky-top"></nav></div><div class="col-sm-8"><div id="header"><h1>Plugin development</h1></div><div id="content"><div class="sect1"><h2 id="_scope">Scope</h2><div class="sectionbody"><div class="paragraph"><p>This document is indented to provide some information about plugin development:</p></div>
<div class="ulist"><ul><li><p>What are plugins and what can be achieved through plugins?</p></li><li><p>Where to start the development?</p></li><li><p>Tooling and APIs to build and deploy plugins</p></li></ul></div></div></div>
<div class="sect1"><h2 id="_kill_bill_plugins">Kill Bill Plugins</h2><div class="sectionbody"><div class="paragraph"><p>Kill Bill Plugins are based on the <a href="https://www.osgi.org/">OSGI standard</a> to provide a way to write isolated code on top of the Kill Bill platform and interact with the system through different ways:</p></div>
<div class="ulist"><ul><li><p>They can be called from the Kill Bill platform through <a href="https://github.com/killbill/killbill-plugin-api">plugin APIs</a>. This happens when a plugin that implements one of those APIs (or 'SPI' to be more precise) was correctly registered in the system.</p></li><li><p>They can receive notifications (bus events) from the Kill Bill platform</p></li><li><p>They can make <a href="https://github.com/killbill/killbill-api">API calls</a> to Kill Bill</p></li></ul></div>
<div class="paragraph"><p>Here are a few examples:</p></div>
<div class="ulist"><ul><li><p>Notification Plugin: A plugin registered to receive bus events. When a bus event is being delivered to the plugin, the plugin calls back Kill Bill through API calls to retrieve additional state for this event or to change the state in the system</p></li><li><p>Plugin that registered as an implementor of a specific <a href="https://github.com/killbill/killbill-plugin-api">plugin API</a>: A payment plugin for instance would have registered itself as an implementor of the <a href="https://github.com/killbill/killbill-plugin-api/blob/master/payment/src/main/java/org/killbill/billing/payment/plugin/api/PaymentPluginApi.java">PaymentPluginApi</a> and the payment system would then invoke that plugin for issuing payment operations. The plugin would have the ability to call back Kill Bill using APIs to retrieve more state or create/change state in the system.</p></li></ul></div>
<div class="paragraph"><p>A Kill Bill plugin will either implement one (or several) plugin API(s) and/or also listen to Kill Bill bus events to be notified of changes and take appropriate actions. It often makes sense to specialize plugins and have them implement only one of the <a href="https://github.com/killbill/killbill-plugin-api">plugin APIs</a>, but this is a design choice, and there is nothing preventing a plugin from implementing multiple of those APIs. Although we don&#8217;t recommend it, a plugin could implement the <a href="https://github.com/killbill/killbill-plugin-api/blob/master/payment/src/main/java/org/killbill/billing/payment/plugin/api/PaymentPluginApi.java">PaymentPluginApi</a> and the <a href="https://github.com/killbill/killbill-plugin-api/blob/master/control/src/main/java/org/killbill/billing/control/plugin/api/PaymentControlPluginApi.java">PaymentControlPluginApi</a>, and that would qualify it as a 'payment and payment control plugin'.</p></div>
<div class="paragraph"><p>Kill Bill Plugins can be used in a variety of ways:</p></div>
<div class="ulist"><ul><li><p>Extend Kill Bill subsytem: Payment plugins are a good example of such plugins; they extend the core payment functionality by connecting to third party systems</p></li><li><p>Provide additional business logic: Payment control plugins and invoice plugins allow to intercept the requests so as to modify it, abort it, or change state on the fly.</p></li><li><p>Listen to system events: The analytics plugin is a good example of such plugin</p></li></ul></div>
<div class="paragraph"><p>Kill Bill Plugins have full power (and therefore need to be designed and tested carefully):</p></div>
<div class="ulist"><ul><li><p>They have access to the database so as to maintain their own state. However they <strong>should not interact with the Kill Bill core tables directly</strong> but rely on APIs to retrieve and change state,</p></li><li><p>They have access to system properties</p></li><li><p>They have the ability to export their own HTTP endpoints under a <code>/plugins/&lt;pluginName&gt;</code> namespace</p></li><li><p>They receive all events in the system</p></li><li><p>They are isolated from the rest of the code and can use their own libraries (versions) without risk of conflict</p></li></ul></div></div></div>
<div class="sect1"><h2 id="_where_to_start">Where to Start?</h2><div class="sectionbody"><div class="paragraph"><p>A good starting point is to assess what the plugin should do and then based on that, read the various <a href="http://docs.killbill.io/">plugin docs in the developer guide section</a> that describe the different types of plugins offered in Kill Bill:</p></div>
<div class="ulist"><ul><li><p><a href="http://docs.killbill.io/latest/catalog_plugin.html">Catalog Plugin</a></p></li><li><p><a href="http://docs.killbill.io/latest/payment_plugin.html">Payment Plugin</a></p></li><li><p><a href="http://docs.killbill.io/latest/payment_control_plugin.html">(Payment) Control Plugin</a></p></li><li><p>Entitlement plugin</p></li><li><p><a href="http://docs.killbill.io/latest/invoice_plugin.html">Invoice Plugin</a></p></li><li><p><a href="http://docs.killbill.io/latest/notification_plugin.html">Notification Plugin</a></p></li></ul></div>
<div class="paragraph"><p>The next stage is to identify existing (similar) plugins which could be used as a starting point to write the code. At this point, this becomes a normal software development cycle, including writing unit tests for that plugin (independent of Kill Bill).</p></div></div></div>
<div class="sect1"><h2 id="_development">Development</h2><div class="sectionbody"><div class="paragraph"><p>It is recommened to clone some of our existing plugins to get started. For <code>java</code>, the <a href="https://github.com/killbill/killbill-hello-world-java-plugin">hello world plugin</a> is a good starting point. For <code>ruby</code>, we also provide a <a href="https://github.com/killbill/killbill-hello-world-ruby-plugin">hello world plugin</a>. Depending on the type of plugin to be built, there may be a better example to look at (e.g. look at an existing payment plugin if you are building a new gateway integration).</p></div>
<div class="paragraph"><p>We provide two plugin frameworks that can be used to implement some of the work that plugins need to do - although your plugin does not have to rely on these frameworks, it is often a good idea to leverage those to avoid boilerplate code.</p></div>
<div class="ulist"><ul><li><p><a href="https://github.com/killbill/killbill-plugin-framework-java"><code>java plugin framework</code></a></p></li><li><p><a href="https://github.com/killbill/killbill-plugin-framework-ruby"><code>ruby plugin framework</code></a></p></li></ul></div>
<div class="paragraph"><p>Also, for internal reference, you might want to take a look at <a href="https://github.com/killbill/killbill-platform/blob/killbill-platform-0.36.2/osgi-bundles/libs/killbill/src/main/java/org/killbill/billing/osgi/libs/killbill/KillbillActivatorBase.java#L59">KillbillActivatorBase</a>, which provides all the abstractions that plugins require (access to java APIs, database connections, system properties, logging, &#8230;&#8203;).</p></div>
<div class="sect2"><h3 id="_java_plugins">Java Plugins</h3><div class="sect3"><h4 id="_prerequisites">Prerequisites</h4><div class="paragraph"><p>Java versions 6+ are supported.</p></div></div>
<div class="sect3"><h4 id="_build">Build</h4><div class="paragraph"><p><code>java</code> plugins rely on the <a href="http://felix.apache.org/documentation/subprojects/apache-felix-maven-bundle-plugin-bnd.html"><code>maven-bundle-plugin</code></a> to produce the correct OSGI plugin (with the correct <code>MANIFEST.MF</code>). It is recommended to start from a plugin that already works, as the build configuration can be quite tricky. A good example is to look at the <code>pom.xml</code> from the <a href="https://github.com/killbill/killbill-hello-world-java-plugin/blob/master/pom.xml">hello world plugin</a></p></div>
<div class="paragraph"><p>The build will produce a <code>jar</code> under the <code>target</code> directory which should contain all the classes and configuration files directly accessible for that plugin. OSGI also provides a way to import classes that are exported by other plugins and this is configured in the <code>Import-Package</code> section of the <code>maven-bundle-plugin</code>. The hello world plugin provides some default based on the <a href="https://github.com/killbill/killbill-platform/blob/killbill-platform-0.36.2/osgi/src/main/java/org/killbill/billing/osgi/config/OSGIConfig.java#L49">classes exported by the system bundle in Kill Bill</a>. Kill Bill offers a system property, <code>org.killbill.osgi.system.bundle.export.packages.extra</code>, to specify additional packages to be exported by the system bundle and that could in turn be imported by the plugin. Desiging which packages are served by the plugin jar and which one are imported from another bundle (and mostly the system bundle inside Kill Bill) is one of the challenges of the OSGI mechanism.</p></div>
<div class="paragraph"><p>Once the pom is correctly written, building the plugin is straightforward:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash">mvn clean install
<span class="tok-c"># Look for entry under target &lt;artifact_id&gt;-&lt;version&gt;.jar</span></code></pre></div></div></div>
<div class="sect3"><h4 id="_deployment">Deployment</h4><div class="paragraph"><p>After the plugin was built, one can deploy the plugin using the <code>kpm</code> command. The steps provided below assume Kill Bill is running inside a docker container and specify the steps that occur outside and inside the container:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span class="tok-c"># Copy the Jar inside the container</span>
&gt; docker cp target/hello-world-plugin-1.0.1-SNAPSHOT.jar kb_killbill_1:/tmp

<span class="tok-c"># SSH inside the conatainer</span>
&gt; docker <span class="tok-nb">exec</span> -ti kb_killbill_1 bash

<span class="tok-c"># Install the plugin : &#39;/var/lib/killbill/bundles&#39; is the default in our Kill Bill docker images</span>
tomcat@6e7d5ae5bfc4&gt; kpm install_java_plugin <span class="tok-s1">&#39;dev:hello&#39;</span> --from-source-file<span class="tok-o">=</span>/tmp/hello-world-plugin-1.0.1-SNAPSHOT.jar  --destination<span class="tok-o">=</span>/var/lib/killbill/bundles

<span class="tok-c"># exit</span>
tomcat@6e7d5ae5bfc4&gt; ^D

<span class="tok-c"># Restart Kill Bill core</span>
&gt; docker restart kb_killbill_1</code></pre></div></div>
<div class="paragraph"><p>Note that the last step that restarts the container&#8201;&#8212;&#8201;and therefore Kill Bill core&#8201;&#8212;&#8201;is required to make the newly installed plugin visible. KPM only allows to install the plugin on the filesystem and until Kill Bill core gets restarted this plugin is unknown to the system. However, once the plugin has been installed once, iterating through development becomes easier because all is needed is to copy the jar at the right location and restart the plugin&#8201;&#8212;&#8201;restarting Kill Bill core is not even necessary anymore&#8201;&#8212;&#8201;as illustrated below:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span class="tok-c"># Override the existing jar</span>
&gt; docker cp target/hello-world-plugin-1.0.1-SNAPSHOT.jar kb_killbill_1:/var/lib/killbill/bundles/plugins/java/1.0.1-SNAPSHOT/hello-world-plugin-1.0.1-SNAPSHOT.jar

<span class="tok-c"># Restart the plugin</span>
&gt; curl -v <span class="tok-se">\</span>
-u admin:password <span class="tok-se">\</span>
-H <span class="tok-s2">&quot;Content-Type: application/json&quot;</span> <span class="tok-se">\</span>
-H <span class="tok-s1">&#39;X-Killbill-CreatedBy: admin&#39;</span> <span class="tok-se">\</span>
-X POST <span class="tok-se">\</span>
--data-binary <span class="tok-s1">&#39;{</span>
<span class="tok-s1">    &quot;nodeCommandProperties&quot;: [</span>
<span class="tok-s1">        {</span>
<span class="tok-s1">            &quot;key&quot;: &quot;pluginKey&quot;,</span>
<span class="tok-s1">            &quot;value&quot;: &quot;hdev:hello&quot;</span>
<span class="tok-s1">        }</span>
<span class="tok-s1">    ],</span>
<span class="tok-s1">    &quot;nodeCommandType&quot;: &quot;RESTART_PLUGIN&quot;,</span>
<span class="tok-s1">    &quot;isSystemCommandType&quot;: true</span>
<span class="tok-s1">}&#39;</span> <span class="tok-se">\</span>
<span class="tok-s2">&quot;http://127.0.0.1:8080/1.0/kb/nodesInfo&quot;</span>

<span class="tok-c"># Follow console traces and verify things are in good order</span>
&gt; curl -v <span class="tok-se">\</span>
-u admin:password <span class="tok-se">\</span>
http://127.0.0.1:8080/1.0/kb/nodesInfo <span class="tok-p">|</span> python -m json.tool</code></pre></div></div>
<div class="paragraph"><p>Note that when using OSS released plugins, the steps are simpler because the plugin can be installed directly using our <a href="http://docs.killbill.io/0.20/plugin_management.html#_installation">plugin management apis</a> and don&#8217;t require mucking around with copying jars and restarting Kill Bill core.</p></div></div>
<div class="sect3"><h4 id="_examples_of_java_plugins">Examples of Java Plugins</h4><div class="ulist"><ul><li><p><a href="https://github.com/killbill/killbill-analytics-plugin">Analytics plugin</a> (<a href="https://github.com/killbill/killbill-plugin-api/blob/master/notification/src/main/java/org/killbill/billing/notification/plugin/api/NotificationPluginApi.java">notification plugin</a>)</p></li><li><p><a href="https://github.com/killbill/killbill-adyen-plugin">Adyen plugin</a> (<a href="https://github.com/killbill/killbill-plugin-api/blob/master/payment/src/main/java/org/killbill/billing/payment/plugin/api/PaymentPluginApi.java">payment plugin</a>)</p></li><li><p><a href="https://github.com/killbill/killbill-accertify-plugin">Accertify plugin</a> (<a href="https://github.com/killbill/killbill-plugin-api/blob/master/control/src/main/java/org/killbill/billing/control/plugin/api/PaymentControlPluginApi.java">payment control plugin</a>)</p></li><li><p><a href="https://github.com/killbill/killbill-coupon-plugin-demo">Coupon plugin</a> (<a href="https://github.com/killbill/killbill-plugin-api/blob/master/entitlement/src/main/java/org/killbill/billing/entitlement/plugin/api/EntitlementPluginApi.java">entitlement plugin</a>)</p></li><li><p><a href="https://github.com/killbill/killbill-avatax-plugin">Avalara plugin</a> (<a href="https://github.com/killbill/killbill-plugin-api/blob/master/invoice/src/main/java/org/killbill/billing/invoice/plugin/api/InvoicePluginApi.java">invoice plugin</a>)</p></li><li><p><a href="https://github.com/killbill/killbill-catalog-plugin-test">Catalog test plugin</a> (<a href="https://github.com/killbill/killbill-plugin-api/blob/master/catalog/src/main/java/org/killbill/billing/catalog/plugin/api/CatalogPluginApi.java">catalog plugin</a>)</p></li></ul></div></div></div>
<div class="sect2"><h3 id="_ruby_plugins">Ruby Plugins</h3><div class="sect3"><h4 id="_prerequisites_2">Prerequisites</h4><div class="paragraph"><p>Ruby 2.1+ or JRuby 1.7.20+ is recommended. If you don&#8217;t have a Ruby installation yet, use <a href="https://rvm.io/rvm/install">RVM</a>:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash">gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3
<span class="tok-se">\c</span>url -sSL https://get.rvm.io <span class="tok-p">|</span> bash -s stable --ruby</code></pre></div></div>
<div class="paragraph"><p>After following the post-installation instructions, you should have access to the <code>ruby</code> and <code>gem</code> executables.</p></div>
<div class="paragraph"><p>Install the following gems:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash">gem install bundler
gem install jbundler</code></pre></div></div></div>
<div class="sect3"><h4 id="_build_2">Build</h4><div class="paragraph"><p>Follow these steps, making sure each one is successful before moving on to the next one:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="ruby"><span class="tok-n">rm</span> <span class="tok-o">-</span><span class="tok-n">f</span> <span class="tok-no">Gemfile</span><span class="tok-o">.</span><span class="tok-n">lock</span> <span class="tok-no">Jarfile</span><span class="tok-o">.</span><span class="tok-n">lock</span> <span class="tok-o">.</span><span class="tok-n">jbundler</span><span class="tok-o">/</span><span class="tok-n">classpath</span><span class="tok-o">.</span><span class="tok-n">rb</span>
<span class="tok-n">bundle</span> <span class="tok-n">install</span>
<span class="tok-n">jbundle</span> <span class="tok-n">install</span>
<span class="tok-c1"># Cleanup output directories</span>
<span class="tok-n">bundle</span> <span class="tok-nb">exec</span> <span class="tok-n">rake</span> <span class="tok-ss">killbill</span><span class="tok-p">:</span><span class="tok-n">clean</span>
<span class="tok-c1"># Build your plugin gem in the pkg/ directory</span>
<span class="tok-n">bundle</span> <span class="tok-nb">exec</span> <span class="tok-n">rake</span> <span class="tok-n">build</span>
<span class="tok-c1"># Build the Killbill plugin in the pkg/ directory</span>
<span class="tok-n">bundle</span> <span class="tok-nb">exec</span> <span class="tok-n">rake</span> <span class="tok-ss">killbill</span><span class="tok-p">:</span><span class="tok-n">package</span></code></pre></div></div></div>
<div class="sect3"><h4 id="_deployment_2">Deployment</h4><div class="paragraph"><p>The steps are very similar to the one provided in the java section above, except for the fact that in ruby we are not deploying a jar but the package (<code>tar.gz</code>). Assuming a modified version of our stripe plugin was built:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span class="tok-c"># Copy the tar.gz</span>
&gt; docker cp pkg/killbill-stripe-5.0.0-dev.tar.gz  kb_killbill_1:/tmp

<span class="tok-c"># SSH inside the conatainer</span>
&gt; docker <span class="tok-nb">exec</span> -ti kb_killbill_1 bash

<span class="tok-c"># Install the plugin : &#39;/var/lib/killbill/bundles&#39; is the default in our Kill Bill docker images</span>
tomcat@6e7d5ae5bfc4&gt; kpm install_ruby_plugin <span class="tok-s1">&#39;dev:stripe&#39;</span> --from-source-file<span class="tok-o">=</span><span class="tok-s2">&quot;/tmp/killbill-stripe-5.0.0-dev.tar.gz&quot;</span>  --destination<span class="tok-o">=</span>/var/lib/killbill/bundles

<span class="tok-c"># exit</span>
tomcat@6e7d5ae5bfc4&gt; ^D

<span class="tok-c"># Restart Kill Bill core</span>
&gt; docker restart kb_killbill_1</code></pre></div></div></div>
<div class="sect3"><h4 id="_examples_of_ruby_plugins">Examples of Ruby Plugins</h4><div class="paragraph"><p>We provide a <a href="https://github.com/killbill/killbill-hello-world-ruby-plugin">hello world</a> ruby plugin that can be used as starting point. Make sure to correctly update the <code>*.gemspec</code> and the <code>pom.xml</code> to correctly reflect the gem name, and maven coordinates of your plugin (if you decide to publish your plugin to Nexus).</p></div>
<div class="ulist"><ul><li><p><a href="https://github.com/killbill/killbill-zendesk-plugin">Zendesk plugin</a> (<a href="https://github.com/killbill/killbill-plugin-api/blob/master/notification/src/main/java/org/killbill/billing/notification/plugin/api/NotificationPluginApi.java">notification plugin</a>)</p></li><li><p><a href="https://github.com/killbill/killbill-cybersource-plugin">CyberSource plugin</a> (<a href="https://github.com/killbill/killbill-plugin-api/blob/master/payment/src/main/java/org/killbill/billing/payment/plugin/api/PaymentPluginApi.java">payment plugin</a> which relies on the <a href="https://github.com/activemerchant/active_merchant">Active Merchant gem</a>)</p></li><li><p><a href="https://github.com/killbill/killbill-entitlement-test-plugin">Entitlement test plugin</a> (<a href="https://github.com/killbill/killbill-plugin-api/blob/master/entitlement/src/main/java/org/killbill/billing/entitlement/plugin/api/EntitlementPluginApi.java">entitlement plugin</a>)</p></li><li><p><a href="https://github.com/killbill/killbill-invoice-test-plugin">Invoice test plugin</a> (<a href="https://github.com/killbill/killbill-plugin-api/blob/master/invoice/src/main/java/org/killbill/billing/invoice/plugin/api/InvoicePluginApi.java">invoice plugin</a>)</p></li><li><p><a href="https://github.com/killbill/killbill-catalog-ruby-plugin">Catalog test plugin</a> (<a href="https://github.com/killbill/killbill-plugin-api/blob/master/catalog/src/main/java/org/killbill/billing/catalog/plugin/api/CatalogPluginApi.java">catalog plugin</a>)</p></li></ul></div>
<div class="paragraph"><p>We also provide a collection of <a href="https://github.com/killbill/killbill-plugin-framework-ruby/wiki/Snippets">Ruby Snippets</a>, which shows how to call Kill Bill APIs from Ruby plugins.</p></div></div></div></div></div>
<div class="sect1"><h2 id="_recipes">Recipes</h2><div class="sectionbody"><div class="sect2"><h3 id="_using_notificationqueue_from_plugins">Using NotificationQueue from plugins</h3><div class="paragraph"><p>There are times when a plugin needs to queue some events for later/future processing. Such situations could be to handle certain bus events at a later time, or enqueue specific operations that have failed so they can be retried, &#8230;&#8203;</p></div>
<div class="paragraph"><p>In those situations, the plugin implementor has the choice to use its own mechanism, use open source solutions,&#8230;&#8203; and this all depends on the objectives (e.g persistent queue?) and the familiarity with certain frameworks.</p></div>
<div class="paragraph"><p>One possibility is to use the <a href="https://github.com/killbill/killbill-commons/blob/master/queue/src/main/java/org/killbill/notificationq/api/NotificationQueue.java">NotificationQueue</a> abstraction that is already provided by Kill Bill framework.</p></div>
<div class="paragraph"><p>One needs to keep in mind that the use of such notification is rather internal to Kill Bill core but in some situations it is acceptable to use it from plugins with the following understanding:</p></div>
<div class="ulist"><ul><li><p>This is should not be used for high throughput/low latency kind of situations, as the mechanism fundamentally stores events into the database and allows to be dispatched to a specific handler</p></li><li><p>Improper use of such queue can have bad consequences for the rest of the system</p></li><li><p>It forces the plugin to know low level details (e.g <code>accountRecordId</code>)</p></li><li><p>Only a small number of queues should be created (1 or max 2 for a plugin) as they create some load on the system (each queue will have its own pool of thread for dispatching event notifications).</p></li></ul></div>
<div class="paragraph"><p>The goal of this documentation is to provide some guidelines on how to make it work.</p></div>
<div class="sect3"><h4 id="_queue_creation">Queue Creation</h4><div class="paragraph"><p>Services can <a href="https://github.com/killbill/killbill-commons/blob/master/queue/src/main/java/org/killbill/notificationq/api/NotificationQueueService.java#L72">create a new queue</a> and later use that queue to send (event) notifications and process such notifications.</p></div>
<div class="paragraph"><p>The creation of the queue will require the following parameters:</p></div>
<div class="ulist"><ul><li><p><code>svcName</code> : A string that identifies the service (a good convention is the plugin name)</p></li><li><p><code>queueName</code>: The name of the queue (a good convention is to use a string that describes its function)</p></li><li><p><code>handler</code> : The handler that will be called back each time a notification is dispatched. The handler should be idempotent as the system ensures <strong>at least one delivery</strong></p></li></ul></div>
<div class="paragraph"><p>The <a href="https://github.com/killbill/killbill-commons/blob/master/queue/src/main/java/org/killbill/notificationq/api/NotificationQueueService.java#L42">handler</a> takes the following form:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">interface</span> <span class="tok-nc">NotificationQueueHandler</span> <span class="tok-o">{</span>

    <span class="tok-cm">/**</span>
<span class="tok-cm">     * Called for each notification ready</span>
<span class="tok-cm">     *</span>
<span class="tok-cm">     * @param eventJson  the notification key associated to that notification entry</span>
<span class="tok-cm">     * @param userToken  user token associated with that notification entry</span>
<span class="tok-cm">     * @param searchKey1 the searchKey1 associated with that notification entry</span>
<span class="tok-cm">     * @param searchKey2 the searchKey2 associated with that notification entry</span>
<span class="tok-cm">     */</span>
    <span class="tok-kt">void</span> <span class="tok-nf">handleReadyNotification</span><span class="tok-o">(</span><span class="tok-n">NotificationEvent</span> <span class="tok-n">eventJson</span><span class="tok-o">,</span> <span class="tok-n">DateTime</span> <span class="tok-n">eventDateTime</span><span class="tok-o">,</span> <span class="tok-n">UUID</span> <span class="tok-n">userToken</span><span class="tok-o">,</span> <span class="tok-n">Long</span> <span class="tok-n">searchKey1</span><span class="tok-o">,</span> <span class="tok-n">Long</span> <span class="tok-n">searchKey2</span><span class="tok-o">);</span>
<span class="tok-o">}</span></code></pre></div></div>
<div class="ulist"><ul><li><p>The <code>NotificationEvent</code> interface is a marker interface; the class implementation <strong>must be</strong> serializable using json. An example can be found <a href="https://github.com/killbill/killbill-commons/blob/master/queue/src/main/java/org/killbill/notificationq/DefaultUUIDNotificationKey.java#L27">here</a>.</p></li><li><p><code>userToken</code> is a UUID of your choice that is passed when publishing events.</p></li><li><p><code>searchKey1</code> <strong>must be</strong> the <code>accountRecordId</code> attached to the account or null</p></li><li><p><code>searchKey2</code> <strong>must be</strong> the <code>tenantRecordId</code> attached to the tenant or null (if operations is cross tenant, but very unlikely)</p></li></ul></div>
<div class="paragraph"><p>Note that <code>accountRecordId</code> and <code>tenantRecordId</code> are usually not visible from plugins (instead the plugin will see the <code>accountId</code> and the <code>tenantId</code> which are UUID. However there is 1-1 mapping between those two ID (one being internal and the other being user visible) and info can be retrieved using the following APIs:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">final</span> <span class="tok-n">CallContext</span> <span class="tok-n">callContext</span> <span class="tok-o">=</span> <span class="tok-o">...</span>
<span class="tok-n">accountRecordId</span> <span class="tok-o">=</span> <span class="tok-n">osgiKillbillAPI</span><span class="tok-o">.</span><span class="tok-na">getRecordIdApi</span><span class="tok-o">().</span><span class="tok-na">getRecordId</span><span class="tok-o">(</span><span class="tok-n">killbillEvent</span><span class="tok-o">.</span><span class="tok-na">getAccountId</span><span class="tok-o">(),</span> <span class="tok-n">ObjectType</span><span class="tok-o">.</span><span class="tok-na">ACCOUNT</span><span class="tok-o">,</span> <span class="tok-n">callContext</span><span class="tok-o">);</span>
<span class="tok-n">tenantRecordId</span> <span class="tok-o">=</span> <span class="tok-n">osgiKillbillAPI</span><span class="tok-o">.</span><span class="tok-na">getRecordIdApi</span><span class="tok-o">().</span><span class="tok-na">getRecordId</span><span class="tok-o">(</span><span class="tok-n">killbillEvent</span><span class="tok-o">.</span><span class="tok-na">getTenantId</span><span class="tok-o">(),</span> <span class="tok-n">ObjectType</span><span class="tok-o">.</span><span class="tok-na">TENANT</span><span class="tok-o">,</span> <span class="tok-n">callContext</span><span class="tok-o">);</span></code></pre></div></div></div>
<div class="sect3"><h4 id="_queue_configuration">Queue Configuration</h4><div class="paragraph"><p>Each queue that is created at runtime by the system (whether a plugin or Kill Bill core), needs to have its own set of tables in the database. By convention, we usually name such tables in the following way:</p></div>
<div class="ulist"><ul><li><p><code>{tablename}_notifications</code></p></li><li><p><code>{tablename}_notifications_history</code></p></li></ul></div>
<div class="paragraph"><p>Where <code>tablename</code> is the name of the plugin or something related that will be unique and easily understood to be related to the given plugin. This value comes from the <a href="https://github.com/killbill/killbill-commons/blob/master/queue/src/main/java/org/killbill/notificationq/api/NotificationQueueConfig.java#L87">configuration</a> associated with that queue.</p></div>
<div class="paragraph"><p>A good example that shows how to wire things can be found in the <a href="https://github.com/killbill/killbill-analytics-plugin/blob/killbill-osgi-bundles-analytics-0.5.13/src/main/java/com/ning/billing/osgi/bundles/analytics/AnalyticsActivator.java#L64"><code>start</code> method of the analytics plugin</a>. We will see the following:</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>Create the <code>NotificationQueueConfig</code> by replacing the <code>instanceName</code> with the desired value (e.g plugin name)</p></li><li><p>Create the <code>DefaultNotificationQueueService</code> specifying the config for that queue</p></li><li><p>Create the handler</p></li><li><p>Create the queue</p></li></ol></div></div>
<div class="sect3"><h4 id="_lifecycle">Lifecycle</h4><div class="paragraph"><p>Before this can happen the queue needs to be properly <a href="https://github.com/killbill/killbill-commons/blob/master/queue/src/main/java/org/killbill/queue/api/QueueLifecycle.java#L22">started</a> and also <a href="https://github.com/killbill/killbill-commons/blob/master/queue/src/main/java/org/killbill/queue/api/QueueLifecycle.java#L27">stopped</a> when the plugin stops.</p></div>
<div class="paragraph"><p>Starting the queue will start the pool of thread that is attached to the queue. The system will print a trace showing that such threads were started. Such threads should be visible by running a <code>jstack</code> command and looking for the following name: <code>config.getTableName() + "-th"</code>.</p></div>
<div class="paragraph"><p>Of course such lifecycle operations should also match the lifecycle of the plugin, the <code>start</code> and <code>stop</code> function defined in the activator. Note that failure to start the queue will have the effect to see such events in the <code>IN_PROCESSING</code> state but handler will never be called.</p></div>
<div class="paragraph"><p>For more information on configuring the queue, please refer to this <a href="http://docs.killbill.io/0.20/userguide_deployment.html#_bus_and_notification_queues">document</a>.</p></div></div></div>
<div class="sect2"><h3 id="_ruby_snippets">Ruby snippets</h3><div class="sect3"><h4 id="_retrieve_account_information">Retrieve account information</h4><div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="ruby"><span class="tok-k">if</span> <span class="tok-n">lookup_key</span> <span class="tok-o">=~</span> <span class="tok-sr">/[A-Fa-f0-9]{8}-[A-Fa-f0-9]{4}-[A-Fa-f0-9]{4}-[A-Fa-f0-9]{4}-[A-Fa-f0-9]{12}/</span>
  <span class="tok-n">kb_account</span> <span class="tok-o">=</span> <span class="tok-vi">@kb_apis</span><span class="tok-o">.</span><span class="tok-n">account_user_api</span><span class="tok-o">.</span><span class="tok-n">get_account_by_id</span><span class="tok-p">(</span><span class="tok-n">lookup_key</span><span class="tok-p">,</span> <span class="tok-vi">@kb_apis</span><span class="tok-o">.</span><span class="tok-n">create_context</span><span class="tok-p">(</span><span class="tok-n">kb_tenant_id</span><span class="tok-p">))</span>
<span class="tok-k">else</span>
  <span class="tok-n">kb_account</span> <span class="tok-o">=</span> <span class="tok-vi">@kb_apis</span><span class="tok-o">.</span><span class="tok-n">account_user_api</span><span class="tok-o">.</span><span class="tok-n">get_account_by_key</span><span class="tok-p">(</span><span class="tok-n">lookup_key</span><span class="tok-p">,</span> <span class="tok-vi">@kb_apis</span><span class="tok-o">.</span><span class="tok-n">create_context</span><span class="tok-p">(</span><span class="tok-n">kb_tenant_id</span><span class="tok-p">))</span>
<span class="tok-k">end</span>

<span class="tok-vi">@logger</span><span class="tok-o">.</span><span class="tok-n">info</span> <span class="tok-s2">&quot;Account name=</span><span class="tok-si">#{</span><span class="tok-n">kb_account</span><span class="tok-o">.</span><span class="tok-n">name</span><span class="tok-si">}</span><span class="tok-s2">, address=</span><span class="tok-si">#{</span><span class="tok-n">kb_account</span><span class="tok-o">.</span><span class="tok-n">address1</span><span class="tok-si">}</span><span class="tok-s2">, city=</span><span class="tok-si">#{</span><span class="tok-n">kb_account</span><span class="tok-o">.</span><span class="tok-n">city</span><span class="tok-si">}</span><span class="tok-s2">, state=</span><span class="tok-si">#{</span><span class="tok-n">kb_account</span><span class="tok-o">.</span><span class="tok-n">state_or_province</span><span class="tok-si">}</span><span class="tok-s2">, country=</span><span class="tok-si">#{</span><span class="tok-n">kb_account</span><span class="tok-o">.</span><span class="tok-n">country</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span></code></pre></div></div></div>
<div class="sect3"><h4 id="_retrieve_subscription_information">Retrieve subscription information</h4><div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="ruby"><span class="tok-n">kb_subscription</span> <span class="tok-o">=</span> <span class="tok-vi">@kb_apis</span><span class="tok-o">.</span><span class="tok-n">subscription_api</span><span class="tok-o">.</span><span class="tok-n">get_subscription_for_entitlement_id</span><span class="tok-p">(</span><span class="tok-n">kb_subscription_id</span><span class="tok-p">,</span> <span class="tok-vi">@kb_apis</span><span class="tok-o">.</span><span class="tok-n">create_context</span><span class="tok-p">(</span><span class="tok-n">kb_tenant_id</span><span class="tok-p">))</span>

<span class="tok-vi">@logger</span><span class="tok-o">.</span><span class="tok-n">info</span> <span class="tok-o">&lt;&lt;-</span><span class="tok-no">eos</span>
<span class="tok-sh">Subscription details:</span>
<span class="tok-sh"> external_key=#{kb_subscription.external_key}</span>
<span class="tok-sh"> state=#{kb_subscription.state}</span>
<span class="tok-sh"> effective_start_date=#{kb_subscription.effective_start_date}</span>
<span class="tok-sh"> effective_end_date=#{kb_subscription.effective_end_date}</span>
<span class="tok-sh"> billing_start_date=#{kb_subscription.billing_start_date}</span>
<span class="tok-sh"> billing_end_date=#{kb_subscription.billing_end_date}</span>
<span class="tok-sh"> charged_through_date=#{kb_subscription.charged_through_date}</span>
<span class="tok-sh"> last_active_plan=#{kb_subscription.last_active_plan.name}</span>
<span class="tok-sh"> last_active_phase=#{kb_subscription.last_active_phase.name}</span>
<span class="tok-no">eos</span></code></pre></div></div>
<div class="paragraph"><p>Notes:</p></div>
<div class="ulist"><ul><li><p>For <code>SUBSCRIPTION</code> events, the subscription id can be found in <code>event.object_id</code> and the tenant in <code>event.tenant_id</code></p></li></ul></div></div>
<div class="sect3"><h4 id="_compute_fixed_length_phase_durations">Compute fixed-length phase durations</h4><div class="paragraph"><p>This will largely depend on your catalog configuration, but a common use case is to determine the length of a trial period:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="ruby"><span class="tok-n">trial_time_unit</span>  <span class="tok-o">=</span> <span class="tok-n">kb_phase</span><span class="tok-o">.</span><span class="tok-n">duration</span><span class="tok-o">.</span><span class="tok-n">unit</span>
<span class="tok-n">trial_duration</span>   <span class="tok-o">=</span> <span class="tok-n">kb_phase</span><span class="tok-o">.</span><span class="tok-n">duration</span><span class="tok-o">.</span><span class="tok-n">number</span>
<span class="tok-n">trial_end_date</span>   <span class="tok-o">=</span> <span class="tok-k">case</span> <span class="tok-n">trial_time_unit</span>
                     <span class="tok-k">when</span> <span class="tok-ss">:DAYS</span>
                       <span class="tok-n">trial_start_date</span><span class="tok-o">.</span><span class="tok-n">next_day</span><span class="tok-p">(</span><span class="tok-n">trial_duration</span><span class="tok-p">)</span>
                     <span class="tok-k">when</span> <span class="tok-ss">:MONTHS</span>
                       <span class="tok-n">trial_start_date</span><span class="tok-o">.</span><span class="tok-n">next_month</span><span class="tok-p">(</span><span class="tok-n">trial_duration</span><span class="tok-p">)</span>
                     <span class="tok-k">when</span> <span class="tok-ss">:YEARS</span>
                       <span class="tok-n">trial_start_date</span><span class="tok-o">.</span><span class="tok-n">next_year</span><span class="tok-p">(</span><span class="tok-n">trial_duration</span><span class="tok-p">)</span>
                     <span class="tok-k">else</span> <span class="tok-c1"># :UNLIMITED</span>
                       <span class="tok-kp">nil</span>
                   <span class="tok-k">end</span>
<span class="tok-vi">@logger</span><span class="tok-o">.</span><span class="tok-n">info</span> <span class="tok-s2">&quot;Trial start=</span><span class="tok-si">#{</span><span class="tok-n">trial_start_date</span><span class="tok-si">}</span><span class="tok-s2">, end=</span><span class="tok-si">#{</span><span class="tok-n">trial_end_date</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span></code></pre></div></div>
<div class="paragraph"><p>For a <code>SUBSCRIPTION_CREATION</code> event, assuming the trial is the first phase of the plan:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="ruby"><span class="tok-n">kb_phase</span> <span class="tok-o">=</span> <span class="tok-n">kb_subscription</span><span class="tok-o">.</span><span class="tok-n">last_active_phase</span>
<span class="tok-n">trial_start_date</span> <span class="tok-o">=</span> <span class="tok-no">Date</span><span class="tok-o">.</span><span class="tok-n">parse</span><span class="tok-p">(</span><span class="tok-n">kb_subscription</span><span class="tok-o">.</span><span class="tok-n">effective_start_date</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Notes:</p></div>
<div class="ulist"><ul><li><p>You can check the phase type via: <code>kb_phase.phase_type == :TRIAL</code></p></li></ul></div></div>
<div class="sect3"><h4 id="_retrieve_tags_for_an_account">Retrieve tags for an account</h4><div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="ruby"><span class="tok-n">kb_context</span>         <span class="tok-o">=</span> <span class="tok-vi">@kb_apis</span><span class="tok-o">.</span><span class="tok-n">create_context</span><span class="tok-p">(</span><span class="tok-n">kb_tenant_id</span><span class="tok-p">)</span>
<span class="tok-n">kb_tag_definitions</span> <span class="tok-o">=</span> <span class="tok-vi">@kb_apis</span><span class="tok-o">.</span><span class="tok-n">tag_user_api</span><span class="tok-o">.</span><span class="tok-n">get_tag_definitions</span><span class="tok-p">(</span><span class="tok-n">kb_context</span><span class="tok-p">)</span>
<span class="tok-n">kb_tags</span>            <span class="tok-o">=</span> <span class="tok-vi">@kb_apis</span><span class="tok-o">.</span><span class="tok-n">tag_user_api</span><span class="tok-o">.</span><span class="tok-n">get_tags_for_account</span><span class="tok-p">(</span><span class="tok-n">kb_account_id</span><span class="tok-p">,</span> <span class="tok-kp">false</span><span class="tok-p">,</span> <span class="tok-n">kb_context</span><span class="tok-p">)</span>
<span class="tok-n">kb_tags</span><span class="tok-o">.</span><span class="tok-n">each</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">kb_tag</span><span class="tok-o">|</span>
  <span class="tok-n">kb_tag_definition</span> <span class="tok-o">=</span> <span class="tok-n">kb_tag_definitions</span><span class="tok-o">.</span><span class="tok-n">select</span> <span class="tok-p">{</span> <span class="tok-o">|</span><span class="tok-n">td</span><span class="tok-o">|</span> <span class="tok-n">td</span><span class="tok-o">.</span><span class="tok-n">id</span> <span class="tok-o">==</span> <span class="tok-n">kb_tag</span><span class="tok-o">.</span><span class="tok-n">tag_definition_id</span> <span class="tok-p">}</span><span class="tok-o">.</span><span class="tok-n">first</span>
  <span class="tok-vi">@logger</span><span class="tok-o">.</span><span class="tok-n">info</span> <span class="tok-s2">&quot;Tag name=</span><span class="tok-si">#{</span><span class="tok-n">kb_tag_definition</span><span class="tok-o">.</span><span class="tok-n">name</span><span class="tok-si">}</span><span class="tok-s2">, description=&#39;</span><span class="tok-si">#{</span><span class="tok-n">kb_tag_definition</span><span class="tok-o">.</span><span class="tok-n">description</span><span class="tok-si">}</span><span class="tok-s2">&#39;, object_id=</span><span class="tok-si">#{</span><span class="tok-n">kb_tag</span><span class="tok-o">.</span><span class="tok-n">object_id</span><span class="tok-si">}</span><span class="tok-s2">, object_type=</span><span class="tok-si">#{</span><span class="tok-n">kb_tag</span><span class="tok-o">.</span><span class="tok-n">object_type</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span>
<span class="tok-k">end</span></code></pre></div></div>
<div class="paragraph"><p>Notes:</p></div>
<div class="ulist"><ul><li><p>For <code>TAG</code> events, the account id can be found in <code>event.account_id</code> and the tenant in <code>event.tenant_id</code></p></li></ul></div></div>
<div class="sect3"><h4 id="_retrieve_payment_and_payment_method_information">Retrieve payment and payment method information</h4><div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="ruby"><span class="tok-n">kb_context</span>        <span class="tok-o">=</span> <span class="tok-vi">@kb_apis</span><span class="tok-o">.</span><span class="tok-n">create_context</span><span class="tok-p">(</span><span class="tok-n">kb_tenant_id</span><span class="tok-p">)</span>
<span class="tok-n">kb_payment</span>        <span class="tok-o">=</span> <span class="tok-vi">@kb_apis</span><span class="tok-o">.</span><span class="tok-n">payment_api</span><span class="tok-o">.</span><span class="tok-n">get_payment</span><span class="tok-p">(</span><span class="tok-n">kb_payment_id</span><span class="tok-p">,</span> <span class="tok-kp">true</span><span class="tok-p">,</span> <span class="tok-kp">true</span><span class="tok-p">,</span> <span class="tok-o">[]</span><span class="tok-p">,</span> <span class="tok-n">kb_context</span><span class="tok-p">)</span>
<span class="tok-n">kb_payment_method</span> <span class="tok-o">=</span> <span class="tok-vi">@kb_apis</span><span class="tok-o">.</span><span class="tok-n">payment_api</span><span class="tok-o">.</span><span class="tok-n">get_payment_method_by_id</span><span class="tok-p">(</span><span class="tok-n">kb_payment</span><span class="tok-o">.</span><span class="tok-n">payment_method_id</span><span class="tok-p">,</span> <span class="tok-kp">false</span><span class="tok-p">,</span> <span class="tok-kp">true</span><span class="tok-p">,</span> <span class="tok-o">[]</span><span class="tok-p">,</span> <span class="tok-n">kb_context</span><span class="tok-p">)</span>

<span class="tok-n">kb_transaction</span> <span class="tok-o">=</span> <span class="tok-n">kb_payment</span><span class="tok-o">.</span><span class="tok-n">transactions</span><span class="tok-o">.</span><span class="tok-n">last</span>
<span class="tok-vi">@logger</span><span class="tok-o">.</span><span class="tok-n">info</span> <span class="tok-s2">&quot;Payment date=</span><span class="tok-si">#{</span><span class="tok-n">kb_transaction</span><span class="tok-o">.</span><span class="tok-n">effective_date</span><span class="tok-si">}</span><span class="tok-s2">, amount=</span><span class="tok-si">#{</span><span class="tok-n">kb_transaction</span><span class="tok-o">.</span><span class="tok-n">amount</span><span class="tok-si">}</span><span class="tok-s2">, currency=</span><span class="tok-si">#{</span><span class="tok-n">kb_transaction</span><span class="tok-o">.</span><span class="tok-n">currency</span><span class="tok-si">}</span><span class="tok-s2">, payment_detail=</span><span class="tok-si">#{</span><span class="tok-n">kb_transaction</span><span class="tok-o">.</span><span class="tok-n">payment_info_plugin</span><span class="tok-si">}</span><span class="tok-s2">, payment_method_detail=</span><span class="tok-si">#{</span><span class="tok-n">kb_payment_method</span><span class="tok-o">.</span><span class="tok-n">plugin_detail</span><span class="tok-o">.</span><span class="tok-n">properties</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span></code></pre></div></div>
<div class="paragraph"><p>Notes:</p></div>
<div class="ulist"><ul><li><p>For <code>PAYMENT</code> events, the payment id can be found in <code>event.object_id</code> and the tenant in <code>event.tenant_id</code></p></li></ul></div></div></div></div></div>
<div class="sect1"><h2 id="_deployment_3">Deployment</h2><div class="sectionbody"><div class="sect2"><h3 id="_overview">Overview</h3><div class="sect3"><h4 id="_plugin_layout">Plugin Layout</h4><div class="paragraph"><p>In its simplest form, deploying a plugin means placing the plugin binary at the right place on the filesystem. Kill Bill will scan the filesystem on startup and will start all the plugins that were detected.
Kill Bill will use the value of the system property <code>org.killbill.osgi.bundle.install.dir</code> to determine the root of plugin directory structure.
By default, this value is set to <code>/var/tmp/bundles</code>, as indicated by the <a href="https://github.com/killbill/killbill-platform/blob/killbill-platform-0.36.2/osgi/src/main/java/org/killbill/billing/osgi/config/OSGIConfig.java#L44">Kill Bill OSGIConfig file</a>.</p></div>
<div class="paragraph"><p>The directory structure looks like the following:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code>root (org.killbill.osgi.bundle.install.dir)
|_sha1.yml
|_platform
|_plugins
  |_java
  |_ruby
  |_plugin_identifiers.json</code></pre></div></div>
<div class="paragraph"><p>Under <code>platform</code>, we will find the following:</p></div>
<div class="ulist"><ul><li><p><code>jruby.jar</code> : the Runtime JRuby jar that is loaded into killbill for each ruby plugin</p></li><li><p>A set of <a href="http://felix.apache.org/downloads.cgi">pure OSGI bundles</a> (unrelated to Kill Bill plugins) and required for things like OSGI logging, OSGI console, &#8230;&#8203;</p></li></ul></div>
<div class="paragraph"><p>Under <code>java</code> and <code>ruby</code>, we will find one entry per plugin per version.
For instance, if we had installed two versions for the ruby <code>stripe</code> plugin, we would see the following (<code>SET_DEFAULT</code> is a symbolic link that point to the default active version):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code>ruby
|_killbill-stripe
  |_ 3.0.2
  |_ 3.0.1
  |_ SET_DEFAULT</code></pre></div></div>
<div class="paragraph"><p>The file <code>sha1.yml</code> is a used by the <code>KPM</code> tool to keep track of artifacts that were already downloaded to avoid dwonloading binaries already present on the filesystem. KPM also offers the <code>--force-download</code> to override that behavior.</p></div>
<div class="paragraph"><p>The file <code>plugin_identifiers.json</code> is used to keep a mapping between the <code>pluginKey</code> (the user visible plugin identifer), and the <code>pluginName</code> (runtime identifier used by Kill Bill when scanning the filesystem). The next section provides more details about those.</p></div></div>
<div class="sect3"><h4 id="_plugin_coordinates_plugin_key_plugin_name">Plugin Coordinates, Plugin Key, Plugin Name, &#8230;&#8203;</h4><div class="paragraph"><p>Today, both our <code>ruby</code> and <code>java</code> plugins are released through maven and are therefore identified through their maven coordinates. We might support other schemes in the future but today this is the only way we offer to download and install publicly released plugins. Plugin Coordinates are too cumbersome to manipulate though and are unsuitable for non-published plugins (typical use case for a plugin being developed), so we introduced some identifers.</p></div>
<div class="paragraph"><p>As mentioned earlier, Kill Bill will scan the filesystem (<code>org.killbill.osgi.bundle.install.dir</code>) on start-up to detect and then start all the plugins. The name on the filesystem (e.g. in our previous example <code>killbill-stripe</code>) constitutes what we call the <strong><code>pluginName</code></strong>.</p></div>
<div class="paragraph"><p>When installing using KPM, the <code>pluginName</code> is dependent on how the plugin was packaged and also differs between ruby and java. For well known publicly available Kill Bill plugins, we adopted a (sane) convention, but we have no way to enforce that convention for third party plugins. Also, note that we could change the name of <code>killbill-stripe</code> to <code>foo</code> on the filesystem (<code>mv killbill-stripe foo</code>) and then suddenly Kill Bill would see that plugin as being the <code>foo</code> plugin. Therefore, the <code>pluginName</code> is not a reliable way to identify the plugin, and is used solely by Kill Bill as an runtime identifier.</p></div>
<div class="paragraph"><p>The <code>pluginKey</code> is the identifier for the plugin and is used for all the user visible operations, whether through the KPM command line tool or whether using the <a href="http://docs.killbill.io/latest/plugin_management.html">Plugin Management APIs</a>.
There is a distinction to be made between publicly released Kill Bill plugins and third party plugins:</p></div>
<div class="ulist"><ul><li><p>(Publicly Released) Kill Bill Plugins: All the plugins developed by the Kill Bill core team are maintained in a <a href="https://github.com/killbill/killbill-cloud/blob/master/kpm/lib/kpm/plugins_directory.yml">repository</a> (we provide today a simple file-based repository, but this may change in the future as we start accepting certified third-party plugins).
Each entry in that repository is identified by a key, and that key is the <code>pluginKey</code>.</p></li><li><p>Third party plugins: For third party plugins, the key is specified at the time the plugin gets installed. The key must be of the form <code>&lt;prefix&gt;::&lt;something&gt;</code> to make sure there is no name collision with Kill Bill plugin keys.</p></li></ul></div></div></div>
<div class="sect2"><h3 id="_deploying_by_hand">Deploying by Hand</h3><div class="sect3"><h4 id="_java_plugins_2">Java Plugins</h4><div class="paragraph"><p>For <code>java</code> plugins, deploying by hand consists of building the self contained OSGI jar, and copying that jar at the right location. For example, the <code>adyen</code> plugin with a version with version <code>0.3.2</code> would show up as the following:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code>java
|_adyen-plugin
  |_ 0.3.2
    |_ adyen-plugin-0.3.2.jar</code></pre></div></div></div>
<div class="sect3"><h4 id="_ruby_plugins_2">Ruby Plugins</h4><div class="paragraph"><p>For <code>ruby</code> plugins, deploying by hand consists in building the package (<code>tar.gz</code>) and untaring that package at the right place: For example, the <code>stripe</code> plugin with a version <code>3.0.2</code> would show up as the following:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code>ruby
|_killbill-stripe
  |_ 3.0.2
    |_ ROOT
       |_ .... (ruby code and gems)
    |_ boot.rb
    |_ config.ru
    |_ killbill.properties
    |_tmp</code></pre></div></div>
<div class="paragraph"><p>In order to make it easy to deploy those plugins we created a special rake task that will copy and untar plugin entries at the right place:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="ruby"><span class="tok-c1"># Deploy the plugin (and clobber a previous version if needed) in /var/tmp/bundles.</span>
<span class="tok-c1"># Alternatively, you can manualy deploy the .tar.gz or .zip artifact from the pkg/ directory</span>
<span class="tok-n">bundle</span> <span class="tok-nb">exec</span> <span class="tok-n">rake</span> <span class="tok-ss">killbill</span><span class="tok-p">:</span><span class="tok-n">deploy</span><span class="tok-o">[</span><span class="tok-kp">true</span><span class="tok-o">]</span></code></pre></div></div>
<div class="paragraph"><p>Note that if you don&#8217;t need any custom configuration, make sure to delete the default YAML configuration file <code>/var/tmp/bundles/plugins/ruby/killbill-*/*/*.yml</code>. In development mode, i.e. when you are running tests outside of Kill Bill (see <code>rake test:spec</code> and <code>rake test:remote:spec</code>), the database configuration is specified in that YAML file (payment plugins rely on a couple of database tables, principally to keep the credit card tokens and gateway-specific details for transactions, such as reference codes). By default, the plugin will use SQLite. If you uncomment the part of the YAML file below the comment "In Kill Bill", this will tell the plugin to use the JNDI connection exposed by Kill Bill instead. This is the default in case the file isn&#8217;t present (or if the database section is missing).</p></div>
<div class="paragraph"><p>Also, in the case of <code>ruby</code> plugin (and as mentionned before), the correct version of the <code>jruby.jar</code> must exist (and be named that way) under the <code>platform</code> directory entry. The correct version must match the Kill Bill version (or more precisely the version of the <a href="https://github.com/killbill/killbill-platform">platform</a> used for the specific version of <a href="https://github.com/killbill/killbill">killbill</a>).</p></div></div>
<div class="sect3"><h4 id="_deployment_through_kpm">Deployment Through KPM</h4><div class="paragraph"><p>The standard way to deploy plugins is to rely on <a href="https://github.com/killbill/killbill-cloud/blob/master/kpm">KPM</a>.
The <a href="https://github.com/killbill/killbill-cloud/blob/master/kpm/README.md">KPM README</a> explains how to install KPM and also provides some guidance on how to deploy publicly released Kill Bill plugins.</p></div></div></div></div></div>
<div class="sect1"><h2 id="_plugin_configuration">Plugin Configuration</h2><div class="sectionbody"><div class="sect2"><h3 id="_system_properties">System Properties</h3><div class="paragraph"><p>Kill Bill plugins can access Kill Bill properties through the use of a special interface <a href="https://github.com/killbill/killbill-platform/blob/master/osgi-api/src/main/java/org/killbill/billing/osgi/api/OSGIConfigProperties.java">OSGIConfigProperties</a>. System properties passed to the JVM and properties from the <code>killbill.properties</code> configuration file are then accessible to the plugins and can be used to tweak the behavior of the plugin as needed.</p></div></div>
<div class="sect2"><h3 id="_configuration_file">Configuration File</h3><div class="paragraph"><p>Property files can be used to configure global settings for a plugin. Those property files need to be part of the archive (the OSGI mechanism will make sure these are only visible to the particular plugin):</p></div>
<div class="ulist"><ul><li><p>For <code>java</code> plugins, the property file needs to be on the classpath (<code>resource</code> directory)</p></li><li><p>For <code>ruby</code> plugins, the property file is often located at the root of the archive</p></li></ul></div>
<div class="paragraph"><p>There is no restriction on the format of the propery file, but typically <code>ruby</code> plugins will use <code>yml</code> files and <code>java</code> plugins will rely on <code>key-value</code> properties, <code>json</code> or <code>xml</code> files.</p></div></div>
<div class="sect2"><h3 id="_per_tenant_configuration">Per-tenant Configuration</h3><div class="paragraph"><p>The two previous mechanisms work well for global settings, but are inadequate to configure the plugins on a per-tenant fashion (e.g for a payment plugin interacting with a payment gateway, different credentials might be needed for different tenants). In those situations, Kill Bill provides APIs to upload/retrieve/delete per-tenant plugin configurations:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span class="tok-c"># Upload new config</span>
curl -v <span class="tok-se">\</span>
     -X POST <span class="tok-se">\</span>
     -u admin:password <span class="tok-se">\</span>
     -H <span class="tok-s1">&#39;X-Killbill-ApiKey: bob&#39;</span> <span class="tok-se">\</span>
     -H <span class="tok-s1">&#39;X-Killbill-ApiSecret: lazar&#39;</span> <span class="tok-se">\</span>
     -H <span class="tok-s1">&#39;X-Killbill-CreatedBy: admin&#39;</span> <span class="tok-se">\</span>
     -H <span class="tok-s1">&#39;Content-Type: text/plain&#39;</span> <span class="tok-se">\</span>
     -d <span class="tok-s1">&#39;&lt;CONFIG&gt;&#39;</span> <span class="tok-se">\</span>
     http://127.0.0.1:8080/1.0/kb/tenants/uploadPluginConfig/&lt;pluginName&gt;</code></pre></div></div>
<div class="paragraph"><p>The <code>&lt;CONFIG&gt;</code> is treaded as a string and it could be the content of an <code>xml</code> or <code>json</code> file, a list of <code>key-value</code> parameters, &#8230;&#8203;</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span class="tok-c"># Retrieve config</span>
curl -v <span class="tok-se">\</span>
     -u admin:password <span class="tok-se">\</span>
     -H <span class="tok-s1">&#39;X-Killbill-ApiKey: bob&#39;</span> <span class="tok-se">\</span>
     -H <span class="tok-s1">&#39;X-Killbill-ApiSecret: lazar&#39;</span> <span class="tok-se">\</span>
     -H <span class="tok-s1">&#39;X-Killbill-CreatedBy: admin&#39;</span> <span class="tok-se">\</span>
     -H <span class="tok-s1">&#39;Content-Type: application/json&#39;</span> <span class="tok-se">\</span>
     http://127.0.0.1:8080/1.0/kb/tenants/uploadPluginConfig/&lt;pluginName&gt;</code></pre></div></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="bash"><span class="tok-c"># Delete config</span>
curl -v <span class="tok-se">\</span>
     -X DELETE <span class="tok-se">\</span>
     -u admin:password <span class="tok-se">\</span>
     -H <span class="tok-s1">&#39;X-Killbill-ApiKey: bob&#39;</span> <span class="tok-se">\</span>
     -H <span class="tok-s1">&#39;X-Killbill-ApiSecret: lazar&#39;</span> <span class="tok-se">\</span>
     -H <span class="tok-s1">&#39;X-Killbill-CreatedBy: admin&#39;</span> <span class="tok-se">\</span>
     http://127.0.0.1:8080/1.0/kb/tenants/uploadPluginConfig/&lt;pluginName&gt;</code></pre></div></div>
<div class="paragraph"><p>At a high level, the mechanism works in the following way:</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>The administrator uses the kill bill API (or Kaui) to upload the configuration</p></li><li><p>Kill Bill stores the config in the <code>tenant_kvs</code> table using a <code>tenant_key</code> of <code>PLUGIN_CONFIG_&lt;pluginName&gt;</code> and sets the <code>tenant_value</code> with the config provided</p></li><li><p>Kill Bill broadcasts the change across the cluster of nodes and emits a configuration bus event: <code>TENANT_CONFIG_CHANGE</code> or <code>TENANT_CONFIG_DELETION</code></p></li><li><p>The plugin code is <strong>responsible to listen to these events</strong> and take appropriate action to reload/delete its configuration for that specific tenant.</p></li></ol></div>
<div class="paragraph"><p>Note that when relying on the plugin frameworks, some amount of work is already provided:</p></div>
<div class="ulist"><ul><li><p>For <code>java</code> plugins we can see the listener <a href="https://github.com/killbill/killbill-plugin-framework-java/blob/killbill-base-plugin-1.1.0/src/main/java/org/killbill/billing/plugin/api/notification/PluginConfigurationEventHandler.java#L37">here</a></p></li><li><p>For <code>ruby</code> plugins, this is done automatically for <a href="https://github.com/killbill/killbill-plugin-framework-ruby/blob/v8.3.1/lib/killbill/helpers/active_merchant/payment_plugin.rb#L48">ActiveMerchant payment plugins</a></p></li></ul></div></div></div></div>
<div class="sect1"><h2 id="_faq">FAQ</h2><div class="sectionbody"><div class="sect2"><h3 id="_org_apache_shiro_authz_unauthenticatedexception_this_subject_is_anonymous">org.apache.shiro.authz.UnauthenticatedException: This subject is anonymous</h3><div class="paragraph"><p>If you need to call back Kill Bill through an endpoint requiring authentication, you will need to use the <code>SecurityApi#login</code> API first.</p></div>
<div class="paragraph"><p>Here is how it can be used in a Servlet for instance:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="java"><span class="tok-kd">private</span> <span class="tok-kt">void</span> <span class="tok-nf">login</span><span class="tok-o">(</span><span class="tok-kd">final</span> <span class="tok-n">HttpServletRequest</span> <span class="tok-n">req</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-n">String</span> <span class="tok-n">authHeader</span> <span class="tok-o">=</span> <span class="tok-n">req</span><span class="tok-o">.</span><span class="tok-na">getHeader</span><span class="tok-o">(</span><span class="tok-s">&quot;Authorization&quot;</span><span class="tok-o">);</span>
    <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">authHeader</span> <span class="tok-o">==</span> <span class="tok-kc">null</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-kd">final</span> <span class="tok-n">String</span><span class="tok-o">[]</span> <span class="tok-n">authHeaderChunks</span> <span class="tok-o">=</span> <span class="tok-n">authHeader</span><span class="tok-o">.</span><span class="tok-na">split</span><span class="tok-o">(</span><span class="tok-s">&quot; &quot;</span><span class="tok-o">);</span>
    <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">authHeaderChunks</span><span class="tok-o">.</span><span class="tok-na">length</span> <span class="tok-o">&lt;</span> <span class="tok-mi">2</span><span class="tok-o">)</span> <span class="tok-o">{</span>
        <span class="tok-k">return</span><span class="tok-o">;</span>
    <span class="tok-o">}</span>

    <span class="tok-k">try</span> <span class="tok-o">{</span>
        <span class="tok-kd">final</span> <span class="tok-n">String</span> <span class="tok-n">credentials</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nf">String</span><span class="tok-o">(</span><span class="tok-n">BaseEncoding</span><span class="tok-o">.</span><span class="tok-na">base64</span><span class="tok-o">().</span><span class="tok-na">decode</span><span class="tok-o">(</span><span class="tok-n">authHeaderChunks</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">]),</span> <span class="tok-s">&quot;UTF-8&quot;</span><span class="tok-o">);</span>
        <span class="tok-kt">int</span> <span class="tok-n">p</span> <span class="tok-o">=</span> <span class="tok-n">credentials</span><span class="tok-o">.</span><span class="tok-na">indexOf</span><span class="tok-o">(</span><span class="tok-s">&quot;:&quot;</span><span class="tok-o">);</span>
        <span class="tok-k">if</span> <span class="tok-o">(</span><span class="tok-n">p</span> <span class="tok-o">==</span> <span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-o">)</span> <span class="tok-o">{</span>
            <span class="tok-k">return</span><span class="tok-o">;</span>
        <span class="tok-o">}</span>

        <span class="tok-kd">final</span> <span class="tok-n">String</span> <span class="tok-n">login</span> <span class="tok-o">=</span> <span class="tok-n">credentials</span><span class="tok-o">.</span><span class="tok-na">substring</span><span class="tok-o">(</span><span class="tok-mi">0</span><span class="tok-o">,</span> <span class="tok-n">p</span><span class="tok-o">).</span><span class="tok-na">trim</span><span class="tok-o">();</span>
        <span class="tok-kd">final</span> <span class="tok-n">String</span> <span class="tok-n">password</span> <span class="tok-o">=</span> <span class="tok-n">credentials</span><span class="tok-o">.</span><span class="tok-na">substring</span><span class="tok-o">(</span><span class="tok-n">p</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-o">).</span><span class="tok-na">trim</span><span class="tok-o">();</span>
        <span class="tok-n">killbillAPI</span><span class="tok-o">.</span><span class="tok-na">getSecurityApi</span><span class="tok-o">().</span><span class="tok-na">login</span><span class="tok-o">(</span><span class="tok-n">login</span><span class="tok-o">,</span> <span class="tok-n">password</span><span class="tok-o">);</span>
    <span class="tok-o">}</span> <span class="tok-k">catch</span> <span class="tok-o">(</span><span class="tok-n">UnsupportedEncodingException</span> <span class="tok-n">ignored</span><span class="tok-o">)</span> <span class="tok-o">{</span>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre></div></div></div></div></div></div></div><div class="col-sm-2 border-columns"></div><div id="footer"><div id="footer-text"><br>Last updated 2018-07-25 15:21:18 UTC</div><script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
          ga('create','UA-32705710-3','auto');
          ga('send','pageview');
          </script></div><script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script><script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.0/dist/bootstrap-toc.min.js"></script></body></html>